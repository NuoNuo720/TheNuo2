<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>实时聊天系统</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.8/dist/chart.umd.min.js" defer></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js" defer></script>
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js" defer></script>
  <script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.6/dist/purify.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/supabase@2.38.4/dist/umd/supabase.min.js"></script>
  
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: '#3B82F6',
            secondary: '#10B981',
            dark: '#1E293B',
            light: '#F8FAFC',
            accent: '#8B5CF6'
          },
          fontFamily: {
            sans: ['Inter', 'system-ui', 'sans-serif'],
          },
        },
      }
    }
  </script>
  
  <style type="text/tailwindcss">
    @layer utilities {
      .content-auto {
        content-visibility: auto;
      }
      .scrollbar-hide {
        scrollbar-width: none;
        -ms-overflow-style: none;
      }
      .scrollbar-hide::-webkit-scrollbar {
        display: none;
      }
      .message-in {
        animation: slideInLeft 0.3s ease-out;
      }
      .message-out {
        animation: slideInRight 0.3s ease-out;
      }
      @keyframes slideInLeft {
        from { transform: translateX(-10px); opacity: 0; }
        to { transform: translateX(0); opacity: 1; }
      }
      @keyframes slideInRight {
        from { transform: translateX(10px); opacity: 0; }
        to { transform: translateX(0); opacity: 1; }
      }
      .pulse-light {
        animation: pulseLight 2s infinite;
      }
      @keyframes pulseLight {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.6; }
      }
    }
  </style>
</head>

<body class="bg-gray-100 font-sans text-gray-800 h-screen flex flex-col overflow-hidden">
  <!-- 认证界面 -->
  <div id="authScreen" class="flex-1 flex flex-col items-center justify-center p-4">
    <div class="w-full max-w-md bg-white rounded-2xl shadow-xl overflow-hidden">
      <div class="p-6">
        <div class="text-center mb-6">
          <h1 class="text-[clamp(1.5rem,3vw,2rem)] font-bold text-primary">实时聊天</h1>
          <p class="text-gray-500">连接你我，畅所欲言</p>
        </div>
        
        <!-- 标签切换 -->
        <div class="flex border-b mb-6">
          <button id="loginTab" class="flex-1 py-2 px-4 font-medium text-primary border-b-2 border-primary">登录</button>
          <button id="registerTab" class="flex-1 py-2 px-4 font-medium text-gray-500 hover:text-gray-700">注册</button>
        </div>
        
        <!-- 登录表单 -->
        <form id="loginForm">
          <div class="mb-4">
            <label class="block text-sm font-medium text-gray-700 mb-1" for="loginEmail">邮箱</label>
            <div class="relative">
              <span class="absolute inset-y-0 left-0 flex items-center pl-3 text-gray-500">
                <i class="fa fa-envelope"></i>
              </span>
              <input type="email" id="loginEmail" class="w-full pl-10 pr-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary transition-all" required>
            </div>
          </div>
          
          <div class="mb-6">
            <label class="block text-sm font-medium text-gray-700 mb-1" for="loginPassword">密码</label>
            <div class="relative">
              <span class="absolute inset-y-0 left-0 flex items-center pl-3 text-gray-500">
                <i class="fa fa-lock"></i>
              </span>
              <input type="password" id="loginPassword" class="w-full pl-10 pr-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary transition-all" required>
              <button type="button" class="absolute inset-y-0 right-0 flex items-center pr-3 text-gray-500 hover:text-gray-700" onclick="togglePassword('loginPassword', this)">
                <i class="fa fa-eye-slash"></i>
              </button>
            </div>
          </div>
          
          <button type="submit" class="w-full bg-primary hover:bg-primary/90 text-white font-medium py-2.5 px-4 rounded-lg transition-all flex items-center justify-center gap-2">
            <span>登录</span>
            <i class="fa fa-sign-in"></i>
          </button>
        </form>
        
        <!-- 注册表单 (默认隐藏) -->
        <form id="registerForm" class="hidden">
          <div class="mb-4">
            <label class="block text-sm font-medium text-gray-700 mb-1" for="regUsername">用户名</label>
            <div class="relative">
              <span class="absolute inset-y-0 left-0 flex items-center pl-3 text-gray-500">
                <i class="fa fa-user"></i>
              </span>
              <input type="text" id="regUsername" class="w-full pl-10 pr-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary transition-all" required maxlength="20">
            </div>
          </div>
          
          <div class="mb-4">
            <label class="block text-sm font-medium text-gray-700 mb-1" for="regEmail">邮箱</label>
            <div class="relative">
              <span class="absolute inset-y-0 left-0 flex items-center pl-3 text-gray-500">
                <i class="fa fa-envelope"></i>
              </span>
              <input type="email" id="regEmail" class="w-full pl-10 pr-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary transition-all" required>
            </div>
          </div>
          
          <div class="mb-4">
            <label class="block text-sm font-medium text-gray-700 mb-1" for="regPassword">密码 (至少6位)</label>
            <div class="relative">
              <span class="absolute inset-y-0 left-0 flex items-center pl-3 text-gray-500">
                <i class="fa fa-lock"></i>
              </span>
              <input type="password" id="regPassword" class="w-full pl-10 pr-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary transition-all" required minlength="6">
              <button type="button" class="absolute inset-y-0 right-0 flex items-center pr-3 text-gray-500 hover:text-gray-700" onclick="togglePassword('regPassword', this)">
                <i class="fa fa-eye-slash"></i>
              </button>
            </div>
          </div>
          
          <div class="mb-6">
            <label class="block text-sm font-medium text-gray-700 mb-1" for="regBio">个性签名</label>
            <div class="relative">
              <span class="absolute inset-y-0 left-0 flex items-center pl-3 text-gray-500">
                <i class="fa fa-comment"></i>
              </span>
              <input type="text" id="regBio" class="w-full pl-10 pr-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary transition-all" maxlength="50">
            </div>
          </div>
          
          <button type="submit" class="w-full bg-secondary hover:bg-secondary/90 text-white font-medium py-2.5 px-4 rounded-lg transition-all flex items-center justify-center gap-2">
            <span>注册</span>
            <i class="fa fa-user-plus"></i>
          </button>
        </form>
      </div>
    </div>
  </div>

  <!-- 聊天界面 (默认隐藏) -->
  <div id="chatScreen" class="hidden flex flex-col h-full">
    <!-- 顶部导航 -->
    <header class="bg-white shadow-sm py-3 px-4 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <button id="toggleSidebar" class="md:hidden text-gray-600 hover:text-primary">
          <i class="fa fa-bars text-xl"></i>
        </button>
        <h1 class="text-xl font-bold text-primary">实时聊天</h1>
      </div>
      
      <div class="flex items-center gap-4">
        <button id="openStats" class="text-gray-600 hover:text-primary relative">
          <i class="fa fa-bar-chart text-xl"></i>
        </button>
        <button id="addFriendBtn" class="text-gray-600 hover:text-primary">
          <i class="fa fa-user-plus text-xl"></i>
        </button>
        <div class="relative group">
          <img id="userAvatar" src="https://picsum.photos/200" alt="用户头像" class="w-10 h-10 rounded-full object-cover border-2 border-primary cursor-pointer">
          <div class="absolute right-0 mt-2 w-48 bg-white rounded-lg shadow-lg py-2 hidden group-hover:block z-10">
            <button id="editProfile" class="w-full text-left px-4 py-2 hover:bg-gray-100 transition-colors">
              <i class="fa fa-edit mr-2 text-gray-500"></i>编辑资料
            </button>
            <button id="logoutBtn" class="w-full text-left px-4 py-2 hover:bg-gray-100 transition-colors text-red-500">
              <i class="fa fa-sign-out mr-2"></i>退出登录
            </button>
          </div>
        </div>
      </div>
    </header>

    <div class="flex flex-1 overflow-hidden">
      <!-- 侧边栏 -->
      <aside id="sidebar" class="w-80 bg-white border-r border-gray-200 flex-shrink-0 flex flex-col h-full transform -translate-x-full md:translate-x-0 transition-transform duration-300 fixed md:relative z-20">
        <!-- 搜索框 -->
        <div class="p-4 border-b border-gray-200">
          <div class="relative">
            <input type="text" id="friendSearch" placeholder="搜索好友..." class="w-full pl-10 pr-4 py-2 rounded-lg border border-gray-300 focus:ring-2 focus:ring-primary focus:border-primary transition-all">
            <i class="fa fa-search absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
          </div>
        </div>
        
        <!-- 侧边栏标签 -->
        <div class="flex border-b border-gray-200">
          <button class="flex-1 py-3 font-medium text-primary border-b-2 border-primary">好友</button>
          <button class="flex-1 py-3 font-medium text-gray-500 hover:text-gray-700">群聊</button>
        </div>
        
        <!-- 好友请求 -->
        <div class="p-3 border-b border-gray-200">
          <div class="flex justify-between items-center mb-2">
            <h3 class="font-medium text-gray-700">好友请求</h3>
            <span id="requestCount" class="bg-red-500 text-white text-xs rounded-full w-5 h-5 flex items-center justify-center">0</span>
          </div>
          <div id="friendRequests" class="max-h-32 overflow-y-auto scrollbar-hide space-y-2">
            <!-- 好友请求会动态添加到这里 -->
            <div class="text-gray-500 text-sm text-center py-2">暂无好友请求</div>
          </div>
        </div>
        
        <!-- 在线好友 -->
        <div class="flex-1 overflow-y-auto scrollbar-hide">
          <h3 class="font-medium text-gray-700 p-3 border-b border-gray-200">在线好友</h3>
          <div id="onlineFriends" class="space-y-1">
            <!-- 在线好友会动态添加到这里 -->
          </div>
          
          <h3 class="font-medium text-gray-700 p-3 border-b border-gray-200">离线好友</h3>
          <div id="offlineFriends" class="space-y-1">
            <!-- 离线好友会动态添加到这里 -->
          </div>
        </div>
      </aside>

      <!-- 聊天区域 -->
      <main class="flex-1 flex flex-col overflow-hidden">
        <!-- 未选择聊天对象时的提示 -->
        <div id="noChatSelected" class="flex-1 flex flex-col items-center justify-center text-gray-500">
          <i class="fa fa-comments text-6xl mb-4 opacity-30"></i>
          <p class="text-lg">选择一个好友开始聊天吧</p>
        </div>
        
        <!-- 聊天内容区域 (默认隐藏) -->
        <div id="chatArea" class="hidden flex flex-col h-full">
          <!-- 聊天对象信息 -->
          <div class="bg-white border-b border-gray-200 p-3 flex items-center gap-3">
            <img id="chatFriendAvatar" src="https://picsum.photos/200" alt="好友头像" class="w-10 h-10 rounded-full object-cover">
            <div>
              <h3 id="chatFriendName" class="font-medium"></h3>
              <p id="chatFriendStatus" class="text-xs text-gray-500">在线</p>
            </div>
            <div class="ml-auto flex gap-3">
              <button id="toggleBurnAfterRead" class="text-gray-500 hover:text-accent">
                <i class="fa fa-fire"></i>
              </button>
              <button id="exportChat" class="text-gray-500 hover:text-primary">
                <i class="fa fa-download"></i>
              </button>
            </div>
          </div>
          
          <!-- 消息区域 -->
          <div id="chatMessages" class="flex-1 p-4 overflow-y-auto scrollbar-hide bg-gray-50" onscroll="handleMessageScroll()">
            <div id="messagesContainer" class="space-y-4">
              <!-- 消息会动态添加到这里 -->
            </div>
            <div id="loadingMore" class="py-2 text-center hidden">
              <i class="fa fa-spinner fa-spin text-gray-400"></i>
            </div>
          </div>
          
          <!-- 输入区域 -->
          <div class="bg-white border-t border-gray-200 p-3">
            <div class="flex items-center gap-2 mb-2">
              <button id="openEmojiPicker" class="text-gray-500 hover:text-primary p-2">
                <i class="fa fa-smile-o"></i>
              </button>
              <button id="openGifPicker" class="text-gray-500 hover:text-primary p-2">
                <i class="fa fa-picture-o"></i>
              </button>
              <span id="typingIndicator" class="text-xs text-gray-500 hidden">对方正在输入...</span>
            </div>
            <div class="flex gap-2">
              <textarea id="messageInput" placeholder="输入消息..." class="flex-1 border border-gray-300 rounded-lg p-2 focus:ring-2 focus:ring-primary focus:border-primary transition-all resize-none" rows="3" maxlength="500"></textarea>
              <button id="sendMessageBtn" class="bg-primary hover:bg-primary/90 text-white rounded-lg p-3 transition-all">
                <i class="fa fa-paper-plane"></i>
              </button>
            </div>
          </div>
        </div>
      </main>
    </div>
  </div>

  <!-- 添加好友弹窗 -->
  <div id="addFriendModal" class="fixed inset-0 bg-black/50 z-50 hidden items-center justify-center p-4">
    <div class="bg-white rounded-xl w-full max-w-md p-6">
      <div class="flex justify-between items-center mb-4">
        <h3 class="text-xl font-bold">添加好友</h3>
        <button id="closeAddFriend" class="text-gray-500 hover:text-gray-700">
          <i class="fa fa-times"></i>
        </button>
      </div>
      <div class="mb-4">
        <label class="block text-sm font-medium text-gray-700 mb-1" for="friendEmail">好友邮箱</label>
        <input type="email" id="friendEmail" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary transition-all" placeholder="输入好友邮箱">
      </div>
      <div class="mb-6">
        <label class="block text-sm font-medium text-gray-700 mb-1" for="friendMessage">验证消息</label>
        <input type="text" id="friendMessage" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary transition-all" placeholder="请输入验证消息" maxlength="50">
      </div>
      <button id="sendFriendRequest" class="w-full bg-primary hover:bg-primary/90 text-white font-medium py-2.5 px-4 rounded-lg transition-all">
        发送请求
      </button>
    </div>
  </div>

  <!-- 数据看板弹窗 -->
  <div id="statsModal" class="fixed inset-0 bg-black/50 z-50 hidden items-center justify-center p-4">
    <div class="bg-white rounded-xl w-full max-w-3xl max-h-[90vh] overflow-y-auto p-6">
      <div class="flex justify-between items-center mb-6">
        <h3 class="text-xl font-bold">数据统计</h3>
        <button id="closeStats" class="text-gray-500 hover:text-gray-700">
          <i class="fa fa-times"></i>
        </button>
      </div>
      
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
        <div class="bg-blue-50 p-4 rounded-lg">
          <p class="text-gray-500 text-sm">总好友数</p>
          <p id="totalFriends" class="text-2xl font-bold text-primary">0</p>
        </div>
        <div class="bg-green-50 p-4 rounded-lg">
          <p class="text-gray-500 text-sm">今日消息</p>
          <p id="todayMessages" class="text-2xl font-bold text-secondary">0</p>
        </div>
        <div class="bg-purple-50 p-4 rounded-lg">
          <p class="text-gray-500 text-sm">总消息数</p>
          <p id="totalMessages" class="text-2xl font-bold text-accent">0</p>
        </div>
      </div>
      
      <div class="mb-6">
        <h4 class="font-medium mb-3">聊天趋势</h4>
        <div class="h-64">
          <canvas id="chatTrendChart"></canvas>
        </div>
      </div>
    </div>
  </div>

  <!-- 编辑资料弹窗 -->
  <div id="editProfileModal" class="fixed inset-0 bg-black/50 z-50 hidden items-center justify-center p-4">
    <div class="bg-white rounded-xl w-full max-w-md p-6">
      <div class="flex justify-between items-center mb-4">
        <h3 class="text-xl font-bold">编辑资料</h3>
        <button id="closeEditProfile" class="text-gray-500 hover:text-gray-700">
          <i class="fa fa-times"></i>
        </button>
      </div>
      
      <div class="flex justify-center mb-6">
        <div class="relative">
          <img id="profileAvatar" src="https://picsum.photos/200" alt="头像" class="w-24 h-24 rounded-full object-cover border-2 border-primary">
          <label class="absolute bottom-0 right-0 bg-primary text-white rounded-full w-8 h-8 flex items-center justify-center cursor-pointer">
            <i class="fa fa-camera"></i>
            <input type="file" id="avatarUpload" accept="image/*" class="hidden">
          </label>
        </div>
      </div>
      
      <div class="mb-4">
        <label class="block text-sm font-medium text-gray-700 mb-1" for="editUsername">用户名</label>
        <input type="text" id="editUsername" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary transition-all" maxlength="20">
      </div>
      
      <div class="mb-4">
        <label class="block text-sm font-medium text-gray-700 mb-1" for="editBio">个性签名</label>
        <input type="text" id="editBio" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary transition-all" maxlength="50">
      </div>
      
      <div class="mb-6">
        <label class="block text-sm font-medium text-gray-700 mb-1">在线状态</label>
        <select id="editStatus" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary transition-all">
          <option value="online">在线</option>
          <option value="away">离开</option>
          <option value="busy">忙碌</option>
          <option value="offline">离线</option>
        </select>
      </div>
      
      <button id="saveProfile" class="w-full bg-primary hover:bg-primary/90 text-white font-medium py-2.5 px-4 rounded-lg transition-all">
        保存修改
      </button>
    </div>
  </div>

  <!-- 加载提示 -->
  <div id="loadingIndicator" class="fixed inset-0 bg-black/30 z-50 hidden items-center justify-center">
    <div class="bg-white p-6 rounded-xl flex flex-col items-center">
      <div class="w-12 h-12 border-4 border-primary border-t-transparent rounded-full animate-spin mb-4"></div>
      <p id="loadingText" class="text-gray-700">加载中...</p>
    </div>
  </div>

  <script>
    // 全局状态管理
    const appState = {
      currentUser: null,
      selectedFriend: null,
      friends: [],
      messages: [],
      messagePage: 1,
      messagesPerPage: 20,
      hasMoreMessages: true,
      burnAfterRead: false,
      supabase: null,
      realtimeSubscriptions: {
        messages: null,
        friends: null,
        presence: null
      }
    };

    // Supabase服务封装
    const supabaseService = {
      init(url, key) {
        if (!url || !key) throw new Error('Supabase配置缺失');
        appState.supabase = window.supabase.createClient(url, key);
        return appState.supabase;
      },

      auth: {
        async login(email, password) {
          const { data, error } = await appState.supabase.auth.signInWithPassword({ email, password });
          if (error) throw error;
          return data;
        },

        async register(email, password, username, bio = '') {
          const { data, error } = await appState.supabase.auth.signUp({
            email,
            password,
            options: { data: { username, bio, avatar_url: `https://picsum.photos/seed/${username}/200`, status: 'online' } }
          });
          if (error) throw error;
          return data;
        },

        async logout() {
          const { error } = await appState.supabase.auth.signOut();
          if (error) throw error;
        },

        async updateUser(data) {
          const { error } = await appState.supabase.auth.updateUser({ data });
          if (error) throw error;
        }
      },

      messages: {
        async getHistory(senderId, receiverId, page = 1, limit = 20) {
          const from = (page - 1) * limit;
          const to = from + limit - 1;
          
          const { data, error, count } = await appState.supabase
            .from('chat_messages')
            .select('*', { count: 'exact' })
            .or(`and(sender_id.eq.${senderId},receiver_id.eq.${receiverId}),and(sender_id.eq.${receiverId},receiver_id.eq.${senderId})`)
            .order('created_at', { ascending: false })
            .range(from, to);

          if (error) throw error;
          return { messages: data ? data.reverse() : [], total: count || 0 };
        },

        async sendMessage(message) {
          const { data, error } = await appState.supabase
            .from('chat_messages')
            .insert([{
              ...message,
              created_at: new Date().toISOString(),
              status: 'sent'
            }])
            .select()
            .single();
          
          if (error) throw error;
          return data;
        },

        async markAsRead(messageIds) {
          const { error } = await appState.supabase
            .from('chat_messages')
            .update({ status: 'read' })
            .in('id', messageIds);
          
          if (error) throw error;
        }
      },

      friends: {
        async getList(userId) {
          const { data, error } = await appState.supabase
            .from('friend_relations')
            .select(`
              *,
              sender: sender_id(*),
              receiver: receiver_id(*)
            `)
            .or(`and(sender_id.eq.${userId},status.eq.accepted),and(receiver_id.eq.${userId},status.eq.accepted)`);
          
          if (error) throw error;
          return data || [];
        },

        async getRequests(userId) {
          const { data, error } = await appState.supabase
            .from('friend_relations')
            .select(`
              *,
              sender: sender_id(*),
              receiver: receiver_id(*)
            `)
            .eq('receiver_id', userId)
            .eq('status', 'pending');
          
          if (error) throw error;
          return data || [];
        },

        async sendRequest(senderId, receiverEmail, message) {
          // 先通过邮箱查询用户
          const { data: userData, error: userError } = await appState.supabase
            .from('profiles')
            .select('id')
            .eq('email', receiverEmail)
            .single();

          if (userError) throw userError;
          
          const { data, error } = await appState.supabase
            .from('friend_relations')
            .insert([{
              sender_id: senderId,
              receiver_id: userData.id,
              message,
              status: 'pending'
            }])
            .select()
            .single();
          
          if (error) throw error;
          return data;
        },

        async respondRequest(relationId, accept) {
          const { data, error } = await appState.supabase
            .from('friend_relations')
            .update({ status: accept ? 'accepted' : 'rejected' })
            .eq('id', relationId)
            .select()
            .single();
          
          if (error) throw error;
          return data;
        }
      },

      profiles: {
        async update(userId, data) {
          const { error } = await appState.supabase
            .from('profiles')
            .update(data)
            .eq('id', userId);
          
          if (error) throw error;
        },

        async getById(userId) {
          const { data, error } = await appState.supabase
            .from('profiles')
            .select('*')
            .eq('id', userId)
            .single();
          
          if (error) throw error;
          return data;
        }
      },

      stats: {
        async getMessageStats(userId) {
          const today = new Date();
          today.setHours(0, 0, 0, 0);
          const todayISO = today.toISOString();

          // 今日消息数
          const { count: todayCount } = await appState.supabase
            .from('chat_messages')
            .select('*', { count: 'exact', head: true })
            .eq('sender_id', userId)
            .gte('created_at', todayISO);

          // 总消息数
          const { count: totalCount } = await appState.supabase
            .from('chat_messages')
            .select('*', { count: 'exact', head: true })
            .eq('sender_id', userId);

          return { today: todayCount || 0, total: totalCount || 0 };
        },

        async getChatTrend(userId, days = 7) {
          const endDate = new Date();
          const startDate = new Date();
          startDate.setDate(startDate.getDate() - days);

          const { data, error } = await appState.supabase
            .from('chat_messages')
            .select(`
              created_at::date as date,
              count(*) as count
            `)
            .eq('sender_id', userId)
            .gte('created_at', startDate.toISOString())
            .lte('created_at', endDate.toISOString())
            .groupBy('date')
            .order('date');

          if (error) throw error;
          return data || [];
        }
      }
    };

    // 工具函数
    const utils = {
      showLoading(text = '加载中...') {
        document.getElementById('loadingText').textContent = text;
        document.getElementById('loadingIndicator').classList.remove('hidden');
        document.getElementById('loadingIndicator').classList.add('flex');
      },

      hideLoading() {
        document.getElementById('loadingIndicator').classList.add('hidden');
        document.getElementById('loadingIndicator').classList.remove('flex');
      },

      sanitizeInput(html) {
        return DOMPurify.sanitize(html, {
          ALLOWED_TAGS: ['b', 'i', 'em', 'strong', 'a', 'img'],
          ALLOWED_ATTR: ['href', 'src', 'alt']
        });
      },

      formatDate(dateString) {
        const date = new Date(dateString);
        return new Intl.DateTimeFormat('zh-CN', {
          hour: '2-digit',
          minute: '2-digit'
        }).format(date);
      },

      scrollToBottom() {
        const chatMessages = document.getElementById('chatMessages');
        chatMessages.scrollTop = chatMessages.scrollHeight;
      },

      async loadScript(src) {
        return new Promise((resolve, reject) => {
          if (document.querySelector(`script[src="${src}"]`)) {
            resolve();
            return;
          }

          const script = document.createElement('script');
          script.src = src;
          script.onload = resolve;
          script.onerror = reject;
          document.head.appendChild(script);
        });
      }
    };

    // 初始化应用
    async function initApp() {
      try {
        // 初始化Supabase（请替换为你的Supabase项目信息）
        await supabaseService.init(
          'https://nescdihlfasxjpzdpxso.supabase.co',
          'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5lc2NkaWhsZmFzeGpwemRweHNvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk2NjQ3MjIsImV4cCI6MjA3NTI0MDcyMn0.NzffNahuZKWV5voVE_sNo9CSV-GoL9tjmmT-8v-hcIM'
        );

        // 检查用户登录状态
        const { data: { session } } = await appState.supabase.auth.getSession();
        if (session) {
          appState.currentUser = session.user;
          await loadUserProfile();
          showChatScreen();
          await loadFriends();
          setupRealtimeSubscriptions();
        } else {
          showAuthScreen();
        }

        // 绑定事件监听
        bindEventListeners();
      } catch (error) {
        console.error('初始化失败:', error);
        alert('应用初始化失败，请刷新页面重试');
      }
    }

    // 加载用户资料
    async function loadUserProfile() {
      try {
        const profile = await supabaseService.profiles.getById(appState.currentUser.id);
        appState.currentUser.profile = profile;
        document.getElementById('userAvatar').src = profile.avatar_url || `https://picsum.photos/seed/${profile.username}/200`;
      } catch (error) {
        console.error('加载用户资料失败:', error);
      }
    }

    // 显示/隐藏界面
    function showAuthScreen() {
      document.getElementById('authScreen').classList.remove('hidden');
      document.getElementById('chatScreen').classList.add('hidden');
    }

    function showChatScreen() {
      document.getElementById('authScreen').classList.add('hidden');
      document.getElementById('chatScreen').classList.remove('hidden');
      document.getElementById('noChatSelected').classList.remove('hidden');
      document.getElementById('chatArea').classList.add('hidden');
    }

    // 加载好友列表
    async function loadFriends() {
      try {
        utils.showLoading('加载好友列表...');
        const friends = await supabaseService.friends.getList(appState.currentUser.id);
        appState.friends = friends.map(relation => {
          return relation.sender_id === appState.currentUser.id 
            ? { ...relation.receiver, relationId: relation.id }
            : { ...relation.sender, relationId: relation.id };
        });
        
        // 加载好友请求
        const requests = await supabaseService.friends.getRequests(appState.currentUser.id);
        renderFriendRequests(requests);
        
        // 渲染好友列表
        renderFriendsList();
        
        // 更新好友统计
        document.getElementById('totalFriends').textContent = appState.friends.length;
      } catch (error) {
        console.error('加载好友失败:', error);
        alert('加载好友失败，请重试');
      } finally {
        utils.hideLoading();
      }
    }

    // 渲染好友请求
    function renderFriendRequests(requests) {
      const container = document.getElementById('friendRequests');
      document.getElementById('requestCount').textContent = requests.length;
      
      if (requests.length === 0) {
        container.innerHTML = '<div class="text-gray-500 text-sm text-center py-2">暂无好友请求</div>';
        return;
      }
      
      container.innerHTML = '';
      requests.forEach(request => {
        const user = request.sender;
        const requestEl = document.createElement('div');
        requestEl.className = 'flex items-center justify-between p-2 hover:bg-gray-100 rounded-lg';
        requestEl.innerHTML = `
          <div class="flex items-center gap-2">
            <img src="${user.avatar_url || `https://picsum.photos/seed/${user.username}/200`}" alt="${user.username}" class="w-8 h-8 rounded-full">
            <div>
              <p class="text-sm font-medium">${user.username}</p>
              <p class="text-xs text-gray-500">${request.message || '请求添加你为好友'}</p>
            </div>
          </div>
          <div class="flex gap-1">
            <button onclick="handleRequestResponse(${request.id}, true)" class="text-green-500 hover:text-green-700">
              <i class="fa fa-check"></i>
            </button>
            <button onclick="handleRequestResponse(${request.id}, false)" class="text-red-500 hover:text-red-700">
              <i class="fa fa-times"></i>
            </button>
          </div>
        `;
        container.appendChild(requestEl);
      });
    }

    // 处理好友请求响应
    async function handleRequestResponse(relationId, accept) {
      try {
        utils.showLoading(accept ? '接受请求中...' : '拒绝请求中...');
        await supabaseService.friends.respondRequest(relationId, accept);
        await loadFriends();
      } catch (error) {
        console.error('处理请求失败:', error);
        alert('操作失败，请重试');
      } finally {
        utils.hideLoading();
      }
    }

    // 渲染好友列表
    function renderFriendsList() {
      const onlineContainer = document.getElementById('onlineFriends');
      const offlineContainer = document.getElementById('offlineFriends');
      
      onlineContainer.innerHTML = '';
      offlineContainer.innerHTML = '';
      
      // 按在线状态分类
      const onlineFriends = appState.friends.filter(friend => friend.status === 'online');
      const offlineFriends = appState.friends.filter(friend => friend.status !== 'online');
      
      if (onlineFriends.length === 0) {
        onlineContainer.innerHTML = '<div class="text-gray-500 text-sm text-center py-2">暂无在线好友</div>';
      } else {
        onlineFriends.forEach(friend => {
          onlineContainer.appendChild(createFriendElement(friend));
        });
      }
      
      if (offlineFriends.length === 0) {
        offlineContainer.innerHTML = '<div class="text-gray-500 text-sm text-center py-2">暂无离线好友</div>';
      } else {
        offlineFriends.forEach(friend => {
          offlineContainer.appendChild(createFriendElement(friend));
        });
      }
    }

    // 创建好友元素
    function createFriendElement(friend) {
      const el = document.createElement('div');
      el.className = `flex items-center gap-3 p-3 hover:bg-gray-100 cursor-pointer transition-colors ${appState.selectedFriend?.id === friend.id ? 'bg-primary/10' : ''}`;
      el.onclick = () => selectFriend(friend);
      
      const statusClass = friend.status === 'online' 
        ? 'bg-green-500' 
        : friend.status === 'away' 
          ? 'bg-yellow-500' 
          : friend.status === 'busy'
            ? 'bg-red-500'
            : 'bg-gray-300';
      
      el.innerHTML = `
        <div class="relative">
          <img src="${friend.avatar_url || `https://picsum.photos/seed/${friend.username}/200`}" alt="${friend.username}" class="w-10 h-10 rounded-full object-cover">
          <span class="absolute bottom-0 right-0 w-3 h-3 rounded-full ${statusClass} border-2 border-white"></span>
        </div>
        <div class="flex-1 min-w-0">
          <p class="font-medium text-sm truncate">${friend.username}</p>
          <p class="text-xs text-gray-500 truncate">${friend.bio || '暂无签名'}</p>
        </div>
      `;
      
      return el;
    }

    // 选择聊天好友
    async function selectFriend(friend) {
      appState.selectedFriend = friend;
      appState.messagePage = 1;
      appState.hasMoreMessages = true;
      
      // 更新UI
      document.getElementById('noChatSelected').classList.add('hidden');
      document.getElementById('chatArea').classList.remove('hidden');
      document.getElementById('chatFriendName').textContent = friend.username;
      document.getElementById('chatFriendAvatar').src = friend.avatar_url || `https://picsum.photos/seed/${friend.username}/200`;
      document.getElementById('chatFriendStatus').textContent = formatStatus(friend.status);
      
      // 重新渲染好友列表以高亮选中项
      renderFriendsList();
      
      // 加载聊天记录
      await loadChatHistory();
      
      // 在移动设备上隐藏侧边栏
      if (window.innerWidth < 768) {
        document.getElementById('sidebar').classList.add('-translate-x-full');
      }
    }

    // 格式化在线状态
    function formatStatus(status) {
      const statusMap = {
        'online': '在线',
        'away': '离开',
        'busy': '忙碌',
        'offline': '离线'
      };
      return statusMap[status] || '未知';
    }

    // 加载聊天历史
    async function loadChatHistory(page = 1) {
      if (!appState.currentUser || !appState.selectedFriend || !appState.hasMoreMessages) return;
      
      const container = document.getElementById('messagesContainer');
      const isFirstLoad = page === 1;
      
      if (isFirstLoad) {
        container.innerHTML = '';
        document.getElementById('loadingMore').classList.remove('hidden');
      } else {
        document.getElementById('loadingMore').classList.remove('hidden');
      }
      
      try {
        const { messages, total } = await supabaseService.messages.getHistory(
          appState.currentUser.id,
          appState.selectedFriend.id,
          page,
          appState.messagesPerPage
        );
        
        appState.messages = isFirstLoad ? messages : [...messages, ...appState.messages];
        appState.hasMoreMessages = (page * appState.messagesPerPage) < total;
        appState.messagePage = page;
        
        // 渲染消息
        messages.forEach(msg => {
          const messageEl = createMessageElement(msg);
          if (isFirstLoad) {
            container.appendChild(messageEl);
          } else {
            container.insertBefore(messageEl, container.firstChild);
          }
        });
        
        // 滚动到底部（首次加载）
        if (isFirstLoad) {
          utils.scrollToBottom();
        }
        
        // 标记未读消息为已读
        const unreadMessages = messages
          .filter(msg => msg.sender_id !== appState.currentUser.id && msg.status !== 'read')
          .map(msg => msg.id);
        
        if (unreadMessages.length > 0) {
          await supabaseService.messages.markAsRead(unreadMessages);
        }
      } catch (error) {
        console.error('加载聊天记录失败:', error);
      } finally {
        document.getElementById('loadingMore').classList.add('hidden');
      }
    }

    // 创建消息元素
    function createMessageElement(message) {
      const isOwnMessage = message.sender_id === appState.currentUser.id;
      const statusIcon = getMessageStatusIcon(message.status);
      const burnIcon = message.burn_after_read ? '<i class="fa fa-fire text-orange-500 ml-1 text-xs"></i>' : '';
      
      const el = document.createElement('div');
      el.className = `message ${isOwnMessage ? 'message-out' : 'message-in'} flex ${isOwnMessage ? 'justify-end' : 'justify-start'}`;
      el.dataset.id = message.id || message.tempId;
      
      el.innerHTML = `
        <div class="${isOwnMessage ? 'order-2' : 'order-1'} max-w-[80%]">
          <div class="${isOwnMessage ? 'bg-primary text-white' : 'bg-white text-gray-800'} p-3 rounded-lg shadow-sm relative">
            <p>${message.content}</p>
            <div class="flex items-center justify-end mt-1">
              <span class="text-xs opacity-70">${utils.formatDate(message.created_at)}</span>
              ${statusIcon}
              ${burnIcon}
            </div>
          </div>
        </div>
      `;
      
      return el;
    }

    // 获取消息状态图标
    function getMessageStatusIcon(status) {
      switch(status) {
        case 'sending':
          return '<i class="fa fa-circle-o-notch fa-spin ml-1 text-xs opacity-70"></i>';
        case 'sent':
          return '<i class="fa fa-check ml-1 text-xs opacity-70"></i>';
        case 'read':
          return '<i class="fa fa-check-circle ml-1 text-xs opacity-70"></i>';
        case 'failed':
          return '<i class="fa fa-exclamation-triangle ml-1 text-xs text-red-500"></i>';
        default:
          return '';
      }
    }

    // 发送消息
    async function sendMessage() {
      const input = document.getElementById('messageInput');
      let content = input.value.trim();
      
      if (!content || !appState.selectedFriend) return;
      
      // 安全过滤
      content = utils.sanitizeInput(content);
      
      // 限制长度
      if (content.length > 500) {
        alert('消息长度不能超过500字');
        return;
      }
      
      // 清空输入框
      input.value = '';
      
      // 创建临时消息
      const tempMessage = {
        tempId: `temp-${Date.now()}`,
        sender_id: appState.currentUser.id,
        receiver_id: appState.selectedFriend.id,
        content: content,
        created_at: new Date().toISOString(),
        status: 'sending',
        burn_after_read: appState.burnAfterRead
      };
      
      // 添加到DOM
      const container = document.getElementById('messagesContainer');
      const tempEl = createMessageElement(tempMessage);
      container.appendChild(tempEl);
      utils.scrollToBottom();
      
      try {
        // 实际发送
        const newMessage = await supabaseService.messages.sendMessage({
          sender_id: appState.currentUser.id,
          receiver_id: appState.selectedFriend.id,
          content: content,
          burn_after_read: appState.burnAfterRead
        });
        
        // 替换临时消息
        if (tempEl) {
          container.replaceChild(createMessageElement(newMessage), tempEl);
          utils.scrollToBottom();
        }
      } catch (error) {
        console.error('发送消息失败:', error);
        // 显示失败状态和重试按钮
        if (tempEl) {
          tempEl.querySelector('.text-xs.opacity-70').insertAdjacentHTML('afterend', `
            <button onclick="retrySendMessage(this, '${content}')" class="ml-1 text-xs text-red-500">重试</button>
          `);
          tempEl.querySelector('.fa-spin')?.replaceWith(
            document.createRange().createContextualFragment('<i class="fa fa-exclamation-triangle ml-1 text-xs text-red-500"></i>')
          );
        }
      }
    }

    // 重试发送消息
    async function retrySendMessage(button, content) {
      if (!appState.selectedFriend) return;
      
      button.innerHTML = '<i class="fa fa-circle-o-notch fa-spin"></i>';
      
      try {
        const newMessage = await supabaseService.messages.sendMessage({
          sender_id: appState.currentUser.id,
          receiver_id: appState.selectedFriend.id,
          content: content,
          burn_after_read: appState.burnAfterRead
        });
        
        // 找到临时消息并替换
        const tempEl = button.closest('.message');
        if (tempEl) {
          const container = document.getElementById('messagesContainer');
          container.replaceChild(createMessageElement(newMessage), tempEl);
          utils.scrollToBottom();
        }
      } catch (error) {
        console.error('重试发送失败:', error);
        button.innerHTML = '重试';
      }
    }

    // 处理消息滚动加载更多
    function handleMessageScroll() {
      const chatMessages = document.getElementById('chatMessages');
      if (chatMessages.scrollTop <= 10 && appState.hasMoreMessages) {
        loadChatHistory(appState.messagePage + 1);
      }
    }

    // 设置实时订阅
    function setupRealtimeSubscriptions() {
      // 消息实时订阅
      if (appState.realtimeSubscriptions.messages) {
        appState.realtimeSubscriptions.messages.unsubscribe();
      }
      
      appState.realtimeSubscriptions.messages = appState.supabase
        .channel('custom-filter-channel')
        .on(
          'postgres_changes',
          { 
            event: 'INSERT', 
            schema: 'public', 
            table: 'chat_messages',
            filter: `or(receiver_id=eq.${appState.currentUser.id},sender_id=eq.${appState.currentUser.id})`
          },
          (payload) => {
            const newMessage = payload.new;
            appState.messages.push(newMessage);
            
            // 如果是当前聊天对象的消息，直接显示
            if (appState.selectedFriend && 
                (newMessage.sender_id === appState.selectedFriend.id || 
                 newMessage.receiver_id === appState.selectedFriend.id)) {
              
              const container = document.getElementById('messagesContainer');
              container.appendChild(createMessageElement(newMessage));
              utils.scrollToBottom();
              
              // 标记为已读
              if (newMessage.sender_id !== appState.currentUser.id) {
                supabaseService.messages.markAsRead([newMessage.id]);
              }
            } else {
              // 非当前聊天的消息，可显示通知
              const friend = appState.friends.find(f => f.id === newMessage.sender_id);
              if (friend) {
                alert(`${friend.username} 发送了新消息`);
              }
            }
          }
        )
        .subscribe();

      // 好友状态实时订阅
      if (appState.realtimeSubscriptions.friends) {
        appState.realtimeSubscriptions.friends.unsubscribe();
      }
      
      appState.realtimeSubscriptions.friends = appState.supabase
        .channel('friends-status-channel')
        .on(
          'postgres_changes',
          { 
            event: 'UPDATE', 
            schema: 'public', 
            table: 'profiles',
            filter: `id=in.(${appState.friends.map(f => f.id).join(',')})`
          },
          async () => {
            await loadFriends();
          }
        )
        .subscribe();
    }

    // 导出聊天记录
    async function exportChatHistory() {
      if (!appState.selectedFriend) return;
      
      try {
        utils.showLoading('正在准备导出...');
        
        // 按需加载依赖
        await Promise.all([
          utils.loadScript('https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js'),
          utils.loadScript('https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js')
        ]);
        
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        const container = document.getElementById('messagesContainer');
        
        // 复制消息容器用于导出
        const clone = container.cloneNode(true);
        clone.style.width = '600px';
        clone.style.backgroundColor = 'white';
        clone.style.padding = '20px';
        document.body.appendChild(clone);
        
        // 生成PDF
        await html2canvas(clone, { scale: 2 }).then(canvas => {
          const imgData = canvas.toDataURL('image/jpeg', 1.0);
          const imgWidth = 210;
          const imgHeight = (canvas.height * imgWidth) / canvas.width;
          doc.addImage(imgData, 'JPEG', 0, 0, imgWidth, imgHeight);
          doc.save(`${appState.selectedFriend.username}_聊天记录.pdf`);
        });
        
        // 清理临时元素
        document.body.removeChild(clone);
      } catch (error) {
        console.error('导出失败:', error);
        alert('导出失败，请重试');
      } finally {
        utils.hideLoading();
      }
    }

    // 加载数据统计
    async function loadStats() {
      try {
        utils.showLoading('加载统计数据...');
        
        // 加载消息统计
        const messageStats = await supabaseService.stats.getMessageStats(appState.currentUser.id);
        document.getElementById('todayMessages').textContent = messageStats.today;
        document.getElementById('totalMessages').textContent = messageStats.total;
        
        // 加载聊天趋势
        const trendData = await supabaseService.stats.getChatTrend(appState.currentUser.id);
        
        // 初始化图表
        const ctx = document.getElementById('chatTrendChart').getContext('2d');
        if (window.chatTrendChartInstance) {
          window.chatTrendChartInstance.destroy();
        }
        
        window.chatTrendChartInstance = new Chart(ctx, {
          type: 'line',
          data: {
            labels: trendData.map(item => new Date(item.date).toLocaleDateString()),
            datasets: [{
              label: '消息数量',
              data: trendData.map(item => item.count),
              backgroundColor: 'rgba(59, 130, 246, 0.2)',
              borderColor: 'rgba(59, 130, 246, 1)',
              borderWidth: 2,
              tension: 0.3,
              fill: true
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
              y: {
                beginAtZero: true,
                ticks: { precision: 0 }
              }
            }
          }
        });
      } catch (error) {
        console.error('加载统计失败:', error);
      } finally {
        utils.hideLoading();
      }
    }

    // 绑定事件监听
    function bindEventListeners() {
      // 认证表单切换
      document.getElementById('loginTab').addEventListener('click', () => {
        document.getElementById('loginForm').classList.remove('hidden');
        document.getElementById('registerForm').classList.add('hidden');
        document.getElementById('loginTab').classList.add('text-primary', 'border-primary', 'border-b-2');
        document.getElementById('registerTab').classList.remove('text-primary', 'border-primary', 'border-b-2');
      });
      
      document.getElementById('registerTab').addEventListener('click', () => {
        document.getElementById('loginForm').classList.add('hidden');
        document.getElementById('registerForm').classList.remove('hidden');
        document.getElementById('registerTab').classList.add('text-primary', 'border-primary', 'border-b-2');
        document.getElementById('loginTab').classList.remove('text-primary', 'border-primary', 'border-b-2');
      });
      
      // 登录表单提交
      document.getElementById('loginForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const email = document.getElementById('loginEmail').value;
        const password = document.getElementById('loginPassword').value;
        
        try {
          utils.showLoading('登录中...');
          await supabaseService.auth.login(email, password);
          const { data: { session } } = await appState.supabase.auth.getSession();
          appState.currentUser = session.user;
          await loadUserProfile();
          showChatScreen();
          await loadFriends();
          setupRealtimeSubscriptions();
        } catch (error) {
          console.error('登录失败:', error);
          alert('登录失败: ' + error.message);
        } finally {
          utils.hideLoading();
        }
      });
      
      // 注册表单提交
      document.getElementById('registerForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const username = document.getElementById('regUsername').value;
        const email = document.getElementById('regEmail').value;
        const password = document.getElementById('regPassword').value;
        const bio = document.getElementById('regBio').value;
        
        try {
          utils.showLoading('注册中...');
          await supabaseService.auth.register(email, password, username, bio);
          alert('注册成功，请查收验证邮件并登录');
          document.getElementById('loginTab').click();
        } catch (error) {
          console.error('注册失败:', error);
          alert('注册失败: ' + error.message);
        } finally {
          utils.hideLoading();
        }
      });
      
      // 退出登录
      document.getElementById('logoutBtn').addEventListener('click', async () => {
        try {
          utils.showLoading('退出中...');
          await supabaseService.auth.logout();
          appState.currentUser = null;
          appState.selectedFriend = null;
          appState.friends = [];
          appState.messages = [];
          
          // 取消订阅
          Object.values(appState.realtimeSubscriptions).forEach(sub => {
            if (sub) sub.unsubscribe();
          });
          
          showAuthScreen();
        } catch (error) {
          console.error('退出失败:', error);
          alert('退出失败，请重试');
        } finally {
          utils.hideLoading();
        }
      });
      
      // 发送消息按钮
      document.getElementById('sendMessageBtn').addEventListener('click', sendMessage);
      
      // 回车发送消息
      document.getElementById('messageInput').addEventListener('keydown', (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
          e.preventDefault();
          sendMessage();
        }
      });
      
      // 侧边栏切换
      document.getElementById('toggleSidebar').addEventListener('click', () => {
        const sidebar = document.getElementById('sidebar');
        sidebar.classList.toggle('-translate-x-full');
      });
      
      // 添加好友弹窗
      document.getElementById('addFriendBtn').addEventListener('click', () => {
        document.getElementById('addFriendModal').classList.remove('hidden');
        document.getElementById('addFriendModal').classList.add('flex');
      });
      
      document.getElementById('closeAddFriend').addEventListener('click', () => {
        document.getElementById('addFriendModal').classList.add('hidden');
        document.getElementById('addFriendModal').classList.remove('flex');
      });
      
      // 发送好友请求
      document.getElementById('sendFriendRequest').addEventListener('click', async () => {
        const email = document.getElementById('friendEmail').value;
        const message = document.getElementById('friendMessage').value;
        
        if (!email) {
          alert('请输入好友邮箱');
          return;
        }
        
        try {
          utils.showLoading('发送请求中...');
          await supabaseService.friends.sendRequest(
            appState.currentUser.id,
            email,
            message
          );
          alert('好友请求已发送');
          document.getElementById('closeAddFriend').click();
          document.getElementById('friendEmail').value = '';
          document.getElementById('friendMessage').value = '';
        } catch (error) {
          console.error('发送请求失败:', error);
          alert('发送失败: ' + error.message);
        } finally {
          utils.hideLoading();
        }
      });
      
      // 数据看板
      document.getElementById('openStats').addEventListener('click', () => {
        document.getElementById('statsModal').classList.remove('hidden');
        document.getElementById('statsModal').classList.add('flex');
        loadStats();
      });
      
      document.getElementById('closeStats').addEventListener('click', () => {
        document.getElementById('statsModal').classList.add('hidden');
        document.getElementById('statsModal').classList.remove('flex');
      });
      
      // 编辑资料
      document.getElementById('editProfile').addEventListener('click', () => {
        if (!appState.currentUser?.profile) return;
        
        const profile = appState.currentUser.profile;
        document.getElementById('profileAvatar').src = profile.avatar_url || `https://picsum.photos/seed/${profile.username}/200`;
        document.getElementById('editUsername').value = profile.username || '';
        document.getElementById('editBio').value = profile.bio || '';
        document.getElementById('editStatus').value = profile.status || 'online';
        
        document.getElementById('editProfileModal').classList.remove('hidden');
        document.getElementById('editProfileModal').classList.add('flex');
      });
      
      document.getElementById('closeEditProfile').addEventListener('click', () => {
        document.getElementById('editProfileModal').classList.add('hidden');
        document.getElementById('editProfileModal').classList.remove('flex');
      });
      
      // 保存资料修改
      document.getElementById('saveProfile').addEventListener('click', async () => {
        const username = document.getElementById('editUsername').value;
        const bio = document.getElementById('editBio').value;
        const status = document.getElementById('editStatus').value;
        
        if (!username) {
          alert('请输入用户名');
          return;
        }
        
        try {
          utils.showLoading('保存中...');
          await supabaseService.profiles.update(appState.currentUser.id, {
            username,
            bio,
            status
          });
          
          // 更新本地缓存
          appState.currentUser.profile = {
            ...appState.currentUser.profile,
            username,
            bio,
            status
          };
          
          // 更新UI
          document.getElementById('userAvatar').src = appState.currentUser.profile.avatar_url || `https://picsum.photos/seed/${username}/200`;
          
          document.getElementById('closeEditProfile').click();
          await loadFriends(); // 刷新好友列表
        } catch (error) {
          console.error('保存失败:', error);
          alert('保存失败: ' + error.message);
        } finally {
          utils.hideLoading();
        }
      });
      
      // 阅后即焚切换
      document.getElementById('toggleBurnAfterRead').addEventListener('click', () => {
        appState.burnAfterRead = !appState.burnAfterRead;
        const btn = document.getElementById('toggleBurnAfterRead');
        btn.classList.toggle('text-accent');
        btn.classList.toggle('text-gray-500');
      });
      
      // 导出聊天记录
      document.getElementById('exportChat').addEventListener('click', exportChatHistory);
      
      // 头像上传预览
      document.getElementById('avatarUpload').addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (file) {
          const reader = new FileReader();
          reader.onload = (event) => {
            document.getElementById('profileAvatar').src = event.target.result;
          };
          reader.readAsDataURL(file);
        }
      });
    }

    // 密码显示切换
    function togglePassword(inputId, button) {
      const input = document.getElementById(inputId);
      const icon = button.querySelector('i');
      
      if (input.type === 'password') {
        input.type = 'text';
        icon.classList.remove('fa-eye-slash');
        icon.classList.add('fa-eye');
      } else {
        input.type = 'password';
        icon.classList.remove('fa-eye');
        icon.classList.add('fa-eye-slash');
      }
    }

    // 初始化应用
    window.addEventListener('DOMContentLoaded', initApp);
  </script>
</body>
</html>