<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>实时聊天系统</title>
    <!-- 引入外部资源 -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdn.staticfile.org/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.8/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/cropperjs@1.6.1/dist/cropper.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/cropperjs@1.6.1/dist/cropper.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/uuid@9.0.0/dist/umd/uuidv4.min.js"></script>
    
    <!-- Supabase JS SDK -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.38.4/dist/umd/supabase.min.js"></script>

    <!-- Tailwind 配置 -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#3B82F6',
                        secondary: '#10B981',
                        accent: '#8B5CF6',
                        dark: '#1E293B',
                        light: '#F8FAFC'
                    },
                    fontFamily: {
                        sans: ['Inter', 'system-ui', 'sans-serif'],
                    },
                }
            }
        }
    </script>

    <style type="text/tailwindcss">
        @layer utilities {
            .content-auto {
                content-visibility: auto;
            }
            .scrollbar-hide {
                scrollbar-width: none;
                -ms-overflow-style: none;
            }
            .scrollbar-hide::-webkit-scrollbar {
                display: none;
            }
            .chat-bubble-left {
                border-radius: 18px 18px 18px 0;
            }
            .chat-bubble-right {
                border-radius: 18px 18px 0 18px;
            }
            .typing-indicator {
                display: inline-flex;
                align-items: center;
                gap: 4px;
            }
            .typing-indicator span {
                width: 8px;
                height: 8px;
                background-color: #6B7280;
                border-radius: 50%;
                animation: typing 1.4s infinite ease-in-out both;
            }
            .typing-indicator span:nth-child(1) { animation-delay: -0.32s; }
            .typing-indicator span:nth-child(2) { animation-delay: -0.16s; }
            @keyframes typing {
                0%, 80%, 100% { transform: scale(0); }
                40% { transform: scale(1); }
            }
        }
    </style>
</head>
<body class="bg-gray-100 font-sans text-dark min-h-screen flex flex-col">
    <!-- 加载中遮罩 -->
    <div id="loading" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 hidden">
        <div class="bg-white p-6 rounded-xl shadow-2xl flex flex-col items-center">
            <div class="w-16 h-16 border-4 border-primary border-t-transparent rounded-full animate-spin mb-4"></div>
            <p class="text-gray-700 font-medium">加载中...</p>
        </div>
    </div>

    <!-- 主应用容器 -->
    <div id="app" class="flex flex-col h-screen overflow-hidden">
        <!-- 未登录状态 - 登录/注册页面 -->
        <div id="authScreen" class="flex-1 flex flex-col items-center justify-center p-4">
            <div class="w-full max-w-md bg-white rounded-2xl shadow-xl overflow-hidden">
                <div class="p-6 text-center bg-primary text-white">
                    <h1 class="text-[clamp(1.5rem,3vw,2rem)] font-bold">实时聊天系统</h1>
                    <p class="opacity-90 mt-1">连接你我，畅所欲言</p>
                </div>
                
                <div class="p-6">
                    <!-- 切换登录/注册的标签 -->
                    <div class="flex border-b mb-6">
                        <button id="loginTab" class="flex-1 py-2 px-4 font-medium text-primary border-b-2 border-primary">登录</button>
                        <button id="registerTab" class="flex-1 py-2 px-4 font-medium text-gray-500 hover:text-gray-700">注册</button>
                    </div>
                    
                    <!-- 登录表单 -->
                    <form id="loginForm" class="space-y-4">
                        <div>
                            <label for="loginUsername" class="block text-sm font-medium text-gray-700 mb-1">用户名</label>
                            <div class="relative">
                                <span class="absolute inset-y-0 left-0 flex items-center pl-3 text-gray-500">
                                    <i class="fa fa-user"></i>
                                </span>
                                <input type="text" id="loginUsername" 
                                    class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary transition-all"
                                    placeholder="请输入用户名" required>
                            </div>
                        </div>
                        
                        <div>
                            <label for="loginPassword" class="block text-sm font-medium text-gray-700 mb-1">密码</label>
                            <div class="relative">
                                <span class="absolute inset-y-0 left-0 flex items-center pl-3 text-gray-500">
                                    <i class="fa fa-lock"></i>
                                </span>
                                <input type="password" id="loginPassword" 
                                    class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary transition-all"
                                    placeholder="请输入密码" required>
                            </div>
                        </div>
                        
                        <button type="submit" 
                            class="w-full bg-primary hover:bg-primary/90 text-white font-medium py-2.5 px-4 rounded-lg transition-all flex items-center justify-center gap-2">
                            <span>登录</span>
                            <i class="fa fa-sign-in"></i>
                        </button>
                    </form>
                    
                    <!-- 注册表单 (默认隐藏) -->
                    <form id="registerForm" class="space-y-4 hidden">
                        <div>
                            <label for="registerUsername" class="block text-sm font-medium text-gray-700 mb-1">用户名</label>
                            <div class="relative">
                                <span class="absolute inset-y-0 left-0 flex items-center pl-3 text-gray-500">
                                    <i class="fa fa-user-plus"></i>
                                </span>
                                <input type="text" id="registerUsername" 
                                    class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary transition-all"
                                    placeholder="请设置用户名" required>
                            </div>
                        </div>
                        
                        <div>
                            <label for="registerPassword" class="block text-sm font-medium text-gray-700 mb-1">密码</label>
                            <div class="relative">
                                <span class="absolute inset-y-0 left-0 flex items-center pl-3 text-gray-500">
                                    <i class="fa fa-lock"></i>
                                </span>
                                <input type="password" id="registerPassword" 
                                    class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary transition-all"
                                    placeholder="请设置密码（至少6位）" minlength="6" required>
                            </div>
                        </div>
                        <div>
                            <label for="registerEmail" class="block text-sm font-medium text-gray-700 mb-1">邮箱</label>
                            <div class="relative">
                                <span class="absolute inset-y-0 left-0 flex items-center pl-3 text-gray-500">
                                    <i class="fa fa-envelope"></i>
                                </span>
                                <input type="email" id="registerEmail" 
                                    class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary transition-all"
                                    placeholder="请输入邮箱（用于登录验证）" required>
                            </div>
                        </div>
                        <div>
                            <label for="registerSignature" class="block text-sm font-medium text-gray-700 mb-1">个性签名（可选）</label>
                            <input type="text" id="registerSignature" 
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary transition-all"
                                placeholder="一句话介绍自己">
                        </div>
                        
                        <button type="submit" 
                            class="w-full bg-secondary hover:bg-secondary/90 text-white font-medium py-2.5 px-4 rounded-lg transition-all flex items-center justify-center gap-2">
                            <span>注册</span>
                            <i class="fa fa-user-plus"></i>
                        </button>
                    </form>
                </div>
            </div>
            
            <p class="mt-6 text-gray-500 text-sm">
                点击登录即表示同意我们的 <a href="#" class="text-primary hover:underline">服务条款</a> 和 <a href="#" class="text-primary hover:underline">隐私政策</a>
            </p>
        </div>
        
        <!-- 已登录状态 - 聊天主界面 (默认隐藏) -->
        <div id="chatScreen" class="flex flex-col h-full hidden">
            <!-- 顶部导航栏 -->
            <header class="bg-white shadow-sm px-4 py-3 flex items-center justify-between border-b">
                <div class="flex items-center gap-3">
                    <button id="toggleSidebar" class="lg:hidden p-2 rounded-full hover:bg-gray-100 transition-colors">
                        <i class="fa fa-bars text-gray-600"></i>
                    </button>
                    <h1 class="text-xl font-bold text-gray-800">实时聊天</h1>
                </div>
                
                <div class="flex items-center gap-4">
                    <button id="openDashboard" class="p-2 rounded-full hover:bg-gray-100 transition-colors relative">
                        <i class="fa fa-bar-chart text-gray-600"></i>
                    </button>
                    <div class="relative group">
                        <button id="profileMenuBtn" class="flex items-center gap-2 focus:outline-none">
                            <img id="headerAvatar" src="https://picsum.photos/200/200" alt="用户头像" 
                                class="w-9 h-9 rounded-full object-cover border-2 border-primary">
                            <span id="headerUsername" class="hidden md:inline font-medium">用户名</span>
                            <i class="fa fa-chevron-down text-xs text-gray-500 group-hover:rotate-180 transition-transform"></i>
                        </button>
                        
                        <!-- 个人菜单 (默认隐藏) -->
                        <div id="profileMenu" class="absolute right-0 mt-2 w-48 bg-white rounded-lg shadow-lg py-2 z-10 hidden">
                            <button id="editProfileBtn" class="w-full text-left px-4 py-2 hover:bg-gray-100 transition-colors flex items-center gap-2">
                                <i class="fa fa-user-circle text-gray-500"></i>
                                <span>编辑资料</span>
                            </button>
                            <button id="exportChatsBtn" class="w-full text-left px-4 py-2 hover:bg-gray-100 transition-colors flex items-center gap-2">
                                <i class="fa fa-download text-gray-500"></i>
                                <span>导出聊天记录</span>
                            </button>
                            <hr class="my-1 border-gray-200">
                            <button id="logoutBtn" class="w-full text-left px-4 py-2 hover:bg-gray-100 transition-colors flex items-center gap-2 text-red-500">
                                <i class="fa fa-sign-out"></i>
                                <span>退出登录</span>
                            </button>
                        </div>
                    </div>
                </div>
            </header>
            
            <!-- 主内容区 -->
            <div class="flex flex-1 overflow-hidden">
                <!-- 左侧边栏 - 好友列表和搜索 -->
                <aside id="sidebar" class="w-full lg:w-80 bg-white border-r flex flex-col h-full transition-all duration-300 -translate-x-full lg:translate-x-0 fixed lg:relative top-0 left-0 h-full z-30">
                    <!-- 侧边栏顶部 - 搜索和添加好友 -->
                    <div class="p-4 border-b">
                        <div class="relative">
                            <input type="text" id="searchFriends" placeholder="搜索好友..." 
                                class="w-full pl-10 pr-4 py-2 rounded-lg bg-gray-100 focus:bg-white border border-transparent focus:border-gray-300 focus:outline-none focus:ring-1 focus:ring-primary transition-all">
                            <i class="fa fa-search absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
                        </div>
                        
                        <div class="flex gap-2 mt-4">
                            <button id="showFriendsBtn" class="flex-1 py-2 bg-primary text-white rounded-lg font-medium">
                                好友
                            </button>
                            <button id="addFriendBtn" class="p-2 bg-gray-100 hover:bg-gray-200 rounded-lg transition-colors">
                                <i class="fa fa-plus text-gray-700"></i>
                            </button>
                        </div>
                    </div>
                    
                    <!-- 好友列表 -->
                    <div class="flex-1 overflow-y-auto scrollbar-hide">
                        <div class="p-2">
                            <p class="text-xs font-semibold text-gray-500 uppercase tracking-wider px-3 mb-2">在线好友</p>
                            <div id="onlineFriendsList" class="space-y-1">
                                <!-- 在线好友会动态加载到这里 -->
                            </div>
                        </div>
                        
                        <div class="p-2">
                            <p class="text-xs font-semibold text-gray-500 uppercase tracking-wider px-3 mb-2">离线好友</p>
                            <div id="offlineFriendsList" class="space-y-1">
                                <!-- 离线好友会动态加载到这里 -->
                            </div>
                        </div>
                        
                        <div class="p-2">
                            <p class="text-xs font-semibold text-gray-500 uppercase tracking-wider px-3 mb-2">好友请求</p>
                            <div id="friendRequestsList" class="space-y-1">
                                <!-- 好友请求会动态加载到这里 -->
                            </div>
                        </div>
                    </div>
                </aside>
                
                <!-- 遮罩层 (移动端侧边栏打开时显示) -->
                <div id="sidebarOverlay" class="fixed inset-0 bg-black/50 z-20 lg:hidden hidden" onclick="toggleSidebar()"></div>
                
                <!-- 右侧聊天区域 -->
                <main class="flex-1 flex flex-col overflow-hidden bg-gray-50">
                    <!-- 聊天对象信息栏 -->
                    <div id="chatHeader" class="bg-white border-b p-4 flex items-center justify-between hidden">
                        <div class="flex items-center gap-3">
                            <img id="currentFriendAvatar" src="https://picsum.photos/200/200" alt="好友头像" 
                                class="w-10 h-10 rounded-full object-cover">
                            <div>
                                <h2 id="currentFriendName" class="font-semibold">好友名称</h2>
                                <p id="currentFriendStatus" class="text-xs text-gray-500">在线</p>
                            </div>
                        </div>
                        
                        <div class="flex items-center gap-2">
                            <button id="viewFriendProfileBtn" class="p-2 rounded-full hover:bg-gray-100 transition-colors">
                                <i class="fa fa-user text-gray-600"></i>
                            </button>
                            <button id="clearChatBtn" class="p-2 rounded-full hover:bg-gray-100 transition-colors">
                                <i class="fa fa-trash text-gray-600"></i>
                            </button>
                        </div>
                    </div>
                    
                    <!-- 聊天消息区域 -->
                    <div id="chatMessages" class="flex-1 p-4 overflow-y-auto scrollbar-hide space-y-6">
                        <!-- 选择聊天对象提示 -->
                        <div id="noChatSelected" class="h-full flex flex-col items-center justify-center text-gray-400">
                            <div class="w-24 h-24 rounded-full bg-gray-100 flex items-center justify-center mb-4">
                                <i class="fa fa-comments text-4xl"></i>
                            </div>
                            <h3 class="text-lg font-medium">未选择聊天对象</h3>
                            <p class="text-sm mt-2 text-center max-w-xs">请从左侧列表选择一位好友开始聊天</p>
                        </div>
                        
                        <!-- 聊天消息会动态加载到这里 -->
                        <div id="messagesContainer" class="hidden space-y-4"></div>
                    </div>
                    
                    <!-- 输入区域 -->
                    <div id="messageInputArea" class="bg-white border-t p-4 hidden">
                        <div class="flex items-center gap-2 mb-2">
                            <button id="toggleEmojiBtn" class="p-2 rounded-full hover:bg-gray-100 transition-colors text-gray-600">
                                <i class="fa fa-smile-o"></i>
                            </button>
                            <button id="toggleGifBtn" class="p-2 rounded-full hover:bg-gray-100 transition-colors text-gray-600">
                                <i class="fa fa-film"></i>
                            </button>
                            <button id="toggleBurnAfterReadBtn" class="p-2 rounded-full hover:bg-gray-100 transition-colors text-gray-600">
                                <i class="fa fa-fire"></i>
                            </button>
                        </div>
                        
                        <!-- 表情选择器 (默认隐藏) -->
                        <div id="emojiPicker" class="hidden mb-3 bg-white rounded-lg shadow-lg p-2 border max-h-40 overflow-y-auto">
                            <div id="emojiContainer" class="grid grid-cols-7 gap-1">
                                <!-- 表情会动态加载到这里 -->
                            </div>
                        </div>
                        
                        <!-- GIF选择器 (默认隐藏) -->
                        <div id="gifPicker" class="hidden mb-3 bg-white rounded-lg shadow-lg p-2 border">
                            <input type="text" id="gifSearch" placeholder="搜索GIF..." 
                                class="w-full px-3 py-2 text-sm border border-gray-200 rounded-lg mb-2">
                            <div id="gifContainer" class="grid grid-cols-3 gap-2 max-h-40 overflow-y-auto">
                                <!-- GIF会动态加载到这里 -->
                            </div>
                        </div>
                        
                        <div class="flex items-end gap-2">
                            <textarea id="messageInput" placeholder="输入消息..." 
                                class="flex-1 border border-gray-300 rounded-lg p-3 focus:ring-2 focus:ring-primary focus:border-primary resize-none transition-all"
                                rows="1"></textarea>
                            <button id="sendMessageBtn" class="bg-primary hover:bg-primary/90 text-white p-3 rounded-lg transition-all disabled:opacity-50 disabled:cursor-not-allowed">
                                <i class="fa fa-paper-plane"></i>
                            </button>
                        </div>
                        
                        <!-- 正在输入提示 (默认隐藏) -->
                        <div id="typingIndicator" class="typing-indicator mt-2 ml-2 hidden">
                            <span></span>
                            <span></span>
                            <span></span>
                        </div>
                    </div>
                </main>
            </div>
        </div>
        
        <!-- 数据看板 (默认隐藏) -->
        <div id="dashboardModal" class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center p-4">
            <div class="bg-white rounded-2xl shadow-2xl w-full max-w-4xl max-h-[90vh] overflow-hidden flex flex-col">
                <div class="p-6 border-b flex items-center justify-between">
                    <h2 class="text-xl font-bold">数据看板</h2>
                    <button id="closeDashboard" class="p-2 hover:bg-gray-100 rounded-full transition-colors">
                        <i class="fa fa-times text-gray-600"></i>
                    </button>
                </div>
                
                <div class="flex-1 overflow-y-auto p-6">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                        <div class="bg-blue-50 p-5 rounded-xl">
                            <p class="text-sm text-blue-600 font-medium mb-1">本周发送消息</p>
                            <h3 id="weeklyMessageCount" class="text-3xl font-bold text-gray-800">0</h3>
                            <div class="mt-2 text-xs text-green-600 flex items-center">
                                <i class="fa fa-arrow-up mr-1"></i>
                                <span>较上周增长 12%</span>
                            </div>
                        </div>
                        
                        <div class="bg-green-50 p-5 rounded-xl">
                            <p class="text-sm text-green-600 font-medium mb-1">总好友数</p>
                            <h3 id="totalFriendsCount" class="text-3xl font-bold text-gray-800">0</h3>
                            <div class="mt-2 text-xs text-green-600 flex items-center">
                                <i class="fa fa-arrow-up mr-1"></i>
                                <span>较上月增长 5%</span>
                            </div>
                        </div>
                        
                        <div class="bg-purple-50 p-5 rounded-xl">
                            <p class="text-sm text-purple-600 font-medium mb-1">最常聊天好友</p>
                            <h3 id="mostChatFriend" class="text-xl font-bold text-gray-800">-</h3>
                            <div id="mostChatCount" class="mt-2 text-xs text-gray-500">
                                共发送 0 条消息
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-8">
                        <h3 class="text-lg font-semibold mb-4">消息发送趋势</h3>
                        <div class="bg-white border rounded-xl p-4 h-64">
                            <canvas id="messageTrendChart"></canvas>
                        </div>
                    </div>
                    
                    <div class="mb-8">
                        <h3 class="text-lg font-semibold mb-4">常用表情</h3>
                        <div id="frequentEmojis" class="flex gap-4 overflow-x-auto py-2">
                            <!-- 常用表情会动态加载到这里 -->
                        </div>
                    </div>
                    
                    <div>
                        <h3 class="text-lg font-semibold mb-4">可能认识的人</h3>
                        <div id="possibleFriends" class="space-y-3">
                            <!-- 可能认识的人会动态加载到这里 -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 添加好友弹窗 (默认隐藏) -->
        <div id="addFriendModal" class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center p-4">
            <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md overflow-hidden">
                <div class="p-6 border-b">
                    <h2 class="text-xl font-bold">添加好友</h2>
                </div>
                
                <div class="p-6">
                    <form id="addFriendForm" class="space-y-4">
                        <div>
                            <label for="friendUsername" class="block text-sm font-medium text-gray-700 mb-1">用户名</label>
                            <input type="text" id="friendUsername" 
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary transition-all"
                                placeholder="请输入好友用户名" required>
                        </div>
                        
                        <div>
                            <label for="friendRequestMessage" class="block text-sm font-medium text-gray-700 mb-1">申请消息（可选）</label>
                            <textarea id="friendRequestMessage" rows="2" 
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary transition-all"
                                placeholder="请输入申请消息"></textarea>
                        </div>
                        
                        <button type="submit" 
                            class="w-full bg-primary hover:bg-primary/90 text-white font-medium py-2.5 px-4 rounded-lg transition-all">
                            发送申请
                        </button>
                    </form>
                    
                    <div id="searchResults" class="mt-4 hidden">
                        <h3 class="text-sm font-medium text-gray-700 mb-2">搜索结果</h3>
                        <div id="searchResultsList" class="space-y-2">
                            <!-- 搜索结果会动态加载到这里 -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 个人资料编辑弹窗 (默认隐藏) -->
        <div id="profileModal" class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center p-4">
            <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md overflow-hidden">
                <div class="p-6 border-b">
                    <h2 class="text-xl font-bold">编辑个人资料</h2>
                </div>
                
                <div class="p-6">
                    <form id="profileForm" class="space-y-6">
                        <div class="flex flex-col items-center">
                            <div class="relative mb-3">
                                <img id="profileAvatar" src="https://picsum.photos/200/200" alt="当前头像" 
                                    class="w-24 h-24 rounded-full object-cover border-4 border-gray-100">
                                <label for="avatarInput" class="absolute bottom-0 right-0 w-8 h-8 bg-primary rounded-full flex items-center justify-center cursor-pointer">
                                    <i class="fa fa-camera text-white text-sm"></i>
                                </label>
                                <input type="file" id="avatarInput" accept="image/*" class="hidden" onchange="handleAvatarUpload(event)">
                            </div>
                            <p class="text-sm text-gray-500">点击更换头像</p>
                        </div>
                        
                        <div>
                            <label for="profileUsername" class="block text-sm font-medium text-gray-700 mb-1">用户名</label>
                            <input type="text" id="profileUsername" 
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary transition-all"
                                required>
                        </div>
                        
                        <div>
                            <label for="profileSignature" class="block text-sm font-medium text-gray-700 mb-1">个性签名</label>
                            <input type="text" id="profileSignature" 
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary transition-all">
                        </div>
                        
                        <div>
                            <label for="profileStatus" class="block text-sm font-medium text-gray-700 mb-1">在线状态</label>
                            <select id="profileStatus" 
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary transition-all">
                                <option value="online">在线</option>
                                <option value="busy">忙碌</option>
                                <option value="away">离开</option>
                                <option value="offline">离线</option>
                            </select>
                        </div>
                        
                        <div class="flex gap-3">
                            <button type="button" id="cancelProfileBtn" 
                                class="flex-1 bg-gray-100 hover:bg-gray-200 text-gray-800 font-medium py-2.5 px-4 rounded-lg transition-all">
                                取消
                            </button>
                            <button type="submit" 
                                class="flex-1 bg-primary hover:bg-primary/90 text-white font-medium py-2.5 px-4 rounded-lg transition-all">
                                保存修改
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        
        <!-- 头像裁剪弹窗 (默认隐藏) -->
        <div id="avatarCropper" class="fixed inset-0 bg-black/70 z-50 hidden flex items-center justify-center p-4">
            <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md overflow-hidden">
                <div class="p-6 border-b flex items-center justify-between">
                    <h2 class="text-xl font-bold">裁剪头像</h2>
                    <button onclick="cancelAvatarCrop()" class="p-2 hover:bg-gray-100 rounded-full transition-colors">
                        <i class="fa fa-times text-gray-600"></i>
                    </button>
                </div>
                
                <div class="p-6">
                    <div class="relative aspect-square bg-gray-100 rounded-lg overflow-hidden mb-4">
                        <img id="cropperImage" src="" alt="裁剪预览" class="w-full h-full object-contain">
                    </div>
                    
                    <div class="flex gap-3">
                        <button onclick="cancelAvatarCrop()" 
                            class="flex-1 bg-gray-100 hover:bg-gray-200 text-gray-800 font-medium py-2.5 px-4 rounded-lg transition-all">
                            取消
                        </button>
                        <button onclick="confirmAvatarCrop()" 
                            class="flex-1 bg-primary hover:bg-primary/90 text-white font-medium py-2.5 px-4 rounded-lg transition-all">
                            确认
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // 全局变量
        let supabase;
        let currentUser = null;
        let selectedFriend = null;
        let chatSubscription = null;
        let cropper = null;
        let typingTimeout = null;
        let messageTrendChart = null;
        
        // 初始化Supabase客户端
        function initSupabase() {
            const supabaseUrl = 'https://nescdihlfasxjpzdpxso.supabase.co'; // 替换为你的Supabase URL
            const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5lc2NkaWhsZmFzeGpwemRweHNvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk2NjQ3MjIsImV4cCI6MjA3NTI0MDcyMn0.NzffNahuZKWV5voVE_sNo9CSV-GoL9tjmmT-8v-hcIM'; // 替换为你的Supabase匿名密钥
            
            if (!supabaseUrl || !supabaseKey) {
                alert('请先配置Supabase URL和密钥');
                return null;
            }
            
            return window.supabase.createClient(supabaseUrl, supabaseKey);
        }
        
        // 显示加载中
        function showLoading() {
            document.getElementById('loading').classList.remove('hidden');
        }
        
        // 隐藏加载中
        function hideLoading() {
            document.getElementById('loading').classList.add('hidden');
        }
        
        // 初始化应用
        async function initApp() {
            // 初始化Supabase
            supabase = initSupabase();
            if (!supabase) return;
            
            showLoading();
            
            try {
                // 检查用户是否已登录
                const { data: { session } } = await supabase.auth.getSession();
                if (session) {
                    // 用户已登录，加载用户数据
                    await loadCurrentUser(session.user.id);
                    switchToChatScreen();
                    loadFriends();
                    setupPresenceTracking();
                } else {
                    // 用户未登录，显示登录界面
                    switchToAuthScreen();
                }
                
                // 初始化表情选择器
                initEmojiPicker();
                
                // 初始化事件监听
                initEventListeners();
            } catch (error) {
                console.error('初始化应用失败:', error);
                alert('初始化失败: ' + error.message);
            } finally {
                hideLoading();
            }
        }
        
        // 加载当前用户信息
        async function loadCurrentUser(authId) {
            const { data, error } = await supabase
                .from('users')
                .select('*')
                .eq('auth_id', authId)
                .single();
                
            if (error) {
                if (error.code === 'PGRST116') {
                    // 极端情况：触发器未生效，引导用户重新注册
                    alert('用户资料未同步，请重新登录');
                    await supabase.auth.signOut();
                }
                throw error;
            }
            currentUser = {
                ...data,
                avatar: data.avatar || 'https://default-avatar-url.png', // 默认头像
                signature: data.signature || '暂无个性签名' // 默认签名
            };
            
            // 更新UI
            document.getElementById('headerAvatar').src = currentUser.avatar || 'https://picsum.photos/200/200';
            document.getElementById('headerUsername').textContent = currentUser.username;
            document.getElementById('profileAvatar').src = currentUser.avatar || 'https://picsum.photos/200/200';
            document.getElementById('profileUsername').value = currentUser.username;
            document.getElementById('profileSignature').value = currentUser.signature || '';
            document.getElementById('profileStatus').value = currentUser.status || 'online';
            
            // 保存到本地存储
            localStorage.setItem('currentUser', JSON.stringify(currentUser));
        }
        
        // 加载好友列表
        async function loadFriends() {
            if (!currentUser) return;
            
            showLoading();
            
            try {
                // 获取所有好友关系
                const { data: friendRelations, error: relationsError } = await supabase
                    .from('friend_relations')
                    .select(`
                        *,
                        sender: sender_id(*),
                        receiver: receiver_id(*)
                    `)
                    .or(`sender_id.eq.${currentUser.id},receiver_id.eq.${currentUser.id}`);
                
                if (relationsError) throw relationsError;
                
                // 清空列表
                document.getElementById('onlineFriendsList').innerHTML = '';
                document.getElementById('offlineFriendsList').innerHTML = '';
                document.getElementById('friendRequestsList').innerHTML = '';
                
                // 处理好友关系
                const friends = [];
                const friendRequests = [];
                
                friendRelations.forEach(relation => {
                    // 确定好友对象（如果自己是发送者，则好友是接收者，反之亦然）
                    const isSender = relation.sender_id === currentUser.id;
                    const friend = isSender ? relation.receiver : relation.sender;
                    
                    // 添加关系信息到好友对象
                    friend.relation = {
                        id: relation.id,
                        status: relation.status,
                        isSender
                    };
                    
                    if (relation.status === 'accepted') {
                        friends.push(friend);
                    } else if (relation.status === 'pending' && !isSender) {
                        // 只有当自己是接收者时，才显示为好友请求
                        friendRequests.push(friend);
                    }
                });
                
                // 按在线状态排序好友
                friends.sort((a, b) => {
                    // 在线状态优先级：online > busy > away > offline
                    const statusPriority = { 'online': 4, 'busy': 3, 'away': 2, 'offline': 1 };
                    return statusPriority[b.status || 'offline'] - statusPriority[a.status || 'offline'];
                });
                
                // 渲染在线好友
                const onlineFriends = friends.filter(friend => friend.status === 'online');
                onlineFriends.forEach(friend => {
                    document.getElementById('onlineFriendsList').innerHTML += createFriendListItem(friend);
                });
                
                // 渲染离线好友
                const offlineFriends = friends.filter(friend => friend.status !== 'online');
                offlineFriends.forEach(friend => {
                    document.getElementById('offlineFriendsList').innerHTML += createFriendListItem(friend);
                });
                
                // 渲染好友请求
                friendRequests.forEach(request => {
                    document.getElementById('friendRequestsList').innerHTML += createFriendRequestItem(request);
                });
                
                // 如果有选中的好友，重新加载聊天记录
                if (selectedFriend) {
                    const updatedFriend = friends.find(f => f.id === selectedFriend.id);
                    if (updatedFriend) {
                        selectedFriend = updatedFriend;
                        updateChatHeader();
                    }
                }
            } catch (error) {
                console.error('加载好友失败:', error);
                alert('加载好友失败: ' + error.message);
            } finally {
                hideLoading();
            }
        }
        
        // 创建好友列表项
        function createFriendListItem(friend) {
            const isSelected = selectedFriend && selectedFriend.id === friend.id;
            const unreadCount = friend.unreadCount > 0 ? `<span class="absolute right-2 top-1/2 -translate-y-1/2 bg-red-500 text-white text-xs rounded-full w-5 h-5 flex items-center justify-center">${friend.unreadCount}</span>` : '';
            
            return `
                <div class="friend-item ${isSelected ? 'bg-primary/10' : 'hover:bg-gray-100'} rounded-lg p-2 flex items-center gap-3 cursor-pointer transition-all relative"
                     onclick="selectFriend('${friend.id}')">
                    <div class="relative">
                        <img src="${friend.avatar || 'https://picsum.photos/200/200'}" alt="${friend.username}" 
                            class="w-10 h-10 rounded-full object-cover">
                        <span class="absolute bottom-0 right-0 w-3 h-3 rounded-full border-2 border-white ${getStatusColor(friend.status)}"></span>
                    </div>
                    <div class="flex-1 min-w-0">
                        <p class="font-medium text-gray-800 truncate">${friend.username}</p>
                        <p class="text-xs text-gray-500 truncate">${friend.signature || '暂无签名'}</p>
                    </div>
                    ${unreadCount}
                </div>
            `;
        }
        
        // 创建好友请求项
        function createFriendRequestItem(request) {
            return `
                <div class="rounded-lg p-2 flex items-center gap-3 transition-all">
                    <img src="${request.avatar || 'https://picsum.photos/200/200'}" alt="${request.username}" 
                        class="w-10 h-10 rounded-full object-cover">
                    <div class="flex-1 min-w-0">
                        <p class="font-medium text-gray-800 truncate">${request.username}</p>
                        <p class="text-xs text-gray-500 truncate">请求添加你为好友</p>
                    </div>
                    <div class="flex gap-1">
                        <button onclick="handleFriendRequest('${request.relation.id}', 'accepted')" 
                            class="p-1.5 bg-green-100 hover:bg-green-200 text-green-600 rounded transition-colors">
                            <i class="fa fa-check"></i>
                        </button>
                        <button onclick="handleFriendRequest('${request.relation.id}', 'rejected')" 
                            class="p-1.5 bg-red-100 hover:bg-red-200 text-red-600 rounded transition-colors">
                            <i class="fa fa-times"></i>
                        </button>
                    </div>
                </div>
            `;
        }
        
        // 根据状态获取颜色
        function getStatusColor(status) {
            switch(status) {
                case 'online': return 'bg-green-500';
                case 'busy': return 'bg-red-500';
                case 'away': return 'bg-yellow-500';
                default: return 'bg-gray-400';
            }
        }
        
        // 选择好友开始聊天
        async function selectFriend(friendId) {
            if (!currentUser) return;
            
            // 移除之前的聊天监听
            if (chatSubscription) {
                supabase.removeChannel(chatSubscription);
            }
            
            showLoading();
            
            try {
                // 获取好友详情
                const { data: friend, error: friendError } = await supabase
                    .from('users')
                    .select('*')
                    .eq('id', friendId)
                    .single();
                
                if (friendError) throw friendError;
                selectedFriend = friend;
                
                // 更新聊天头部
                updateChatHeader();
                
                // 加载聊天记录
                await loadChatHistory();
                
                // 设置新的聊天监听
                setupChatListener();
                
                // 设置输入状态监听
                setupTypingListener();
                
                // 在移动设备上隐藏侧边栏
                if (window.innerWidth < 1024) {
                    toggleSidebar();
                }
                
                // 显示聊天区域
                document.getElementById('noChatSelected').classList.add('hidden');
                document.getElementById('messagesContainer').classList.remove('hidden');
                document.getElementById('messageInputArea').classList.remove('hidden');
                document.getElementById('chatHeader').classList.remove('hidden');
                
                // 聚焦到输入框
                document.getElementById('messageInput').focus();
            } catch (error) {
                console.error('选择好友失败:', error);
                alert('选择好友失败: ' + error.message);
            } finally {
                hideLoading();
            }
        }
        
        // 更新聊天头部信息
        function updateChatHeader() {
            if (!selectedFriend) return;
            
            document.getElementById('currentFriendAvatar').src = selectedFriend.avatar || 'https://picsum.photos/200/200';
            document.getElementById('currentFriendName').textContent = selectedFriend.username;
            document.getElementById('currentFriendStatus').textContent = formatStatus(selectedFriend.status);
        }
        
        // 格式化状态文本
        function formatStatus(status) {
            switch(status) {
                case 'online': return '在线';
                case 'busy': return '忙碌';
                case 'away': return '离开';
                default: return '离线';
            }
        }
        
        // 加载聊天记录
        async function loadChatHistory() {
            if (!currentUser || !selectedFriend) return;
            
            showLoading();
            
            try {
                // 获取聊天记录
                const { data: messages, error: messagesError } = await supabase
                    .from('chat_messages')
                    .select('*')
                    .or(`and(sender_id.eq.${currentUser.id},receiver_id.eq.${selectedFriend.id}),and(sender_id.eq.${selectedFriend.id},receiver_id.eq.${currentUser.id})`)
                    .order('created_at', { ascending: true });
                
                if (messagesError) throw messagesError;
                
                // 清空消息容器
                document.getElementById('messagesContainer').innerHTML = '';
                
                // 渲染消息
                messages.forEach(msg => {
                    addMessageToDOM(msg);
                });
                
                // 滚动到底部
                scrollToBottom();
                
                // 标记未读消息为已读
                await markMessagesAsRead();
            } catch (error) {
                console.error('加载聊天记录失败:', error);
                alert('加载聊天记录失败: ' + error.message);
            } finally {
                hideLoading();
            }
        }
        
        // 添加消息到DOM
        function addMessageToDOM(msg) {
            const isOwnMessage = msg.sender_id === currentUser.id;
            const isRead = msg.is_read && isOwnMessage ? '<span class="text-xs text-blue-400 ml-1"><i class="fa fa-check-circle"></i></span>' : '';
            const burnAfterReadBadge = msg.burn_after_read ? '<span class="absolute top-1 right-2 text-xs bg-red-500 text-white px-1 rounded">阅后即焚</span>' : '';
            const recalledBadge = msg.is_recalled ? '<div class="text-gray-400 text-sm italic">此消息已撤回</div>' : '';
            
            // 处理GIF内容
            let messageContent = msg.content;
            if (messageContent.startsWith('[gif]') && messageContent.endsWith('[/gif]')) {
                const gifUrl = messageContent.replace('[gif]', '').replace('[/gif]', '');
                messageContent = `<img src="${gifUrl}" alt="GIF动画" class="max-w-[200px] rounded-lg">`;
            }
            
            const messageHTML = `
                <div class="message ${isOwnMessage ? 'flex justify-end' : 'flex justify-start'}" data-id="${msg.id}">
                    <div class="${isOwnMessage ? 'flex items-end gap-2' : 'flex items-end gap-2'}">
                        ${!isOwnMessage ? `<img src="${selectedFriend.avatar || 'https://picsum.photos/200/200'}" alt="${selectedFriend.username}" class="w-8 h-8 rounded-full object-cover">` : ''}
                        <div class="${isOwnMessage ? 'bg-primary text-white chat-bubble-right' : 'bg-white chat-bubble-left border'} relative max-w-[80%] px-4 py-2.5">
                            ${!recalledBadge ? messageContent : ''}
                            ${recalledBadge}
                            ${burnAfterReadBadge}
                            <div class="${isOwnMessage ? 'text-right' : 'text-left'} mt-1">
                                <span class="text-xs text-gray-400">${formatMessageTime(msg.created_at)}</span>
                                ${isRead}
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('messagesContainer').innerHTML += messageHTML;
            
            // 如果是阅后即焚消息且是接收方，3秒后删除
            if (msg.burn_after_read && !isOwnMessage && !msg.is_recalled) {
                setTimeout(() => {
                    recallMessage(msg.id);
                }, 3000);
            }
        }
        
        // 格式化消息时间
        function formatMessageTime(timestamp) {
            const date = new Date(timestamp);
            return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        }
        
        // 滚动到消息底部
        function scrollToBottom() {
            const messagesContainer = document.getElementById('chatMessages');
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }
        
        // 发送消息
        async function sendMessage() {
            if (!currentUser || !selectedFriend) return;
            
            const messageInput = document.getElementById('messageInput');
            const content = messageInput.value.trim();
            
            if (!content) return;
            
            showLoading();
            
            try {
                // 检查是否启用了阅后即焚
                const burnAfterReadBtn = document.getElementById('toggleBurnAfterReadBtn');
                const burnAfterRead = burnAfterReadBtn.classList.contains('text-red-500');
                
                // 发送消息
                const { data: newMessage, error: messageError } = await supabase
                    .from('chat_messages')
                    .insert([{
                        sender_id: currentUser.id,
                        receiver_id: selectedFriend.id,
                        content: content,
                        burn_after_read: burnAfterRead
                    }])
                    .select()
                    .single();
                
                if (messageError) throw messageError;
                
                // 清空输入框并重置高度
                messageInput.value = '';
                messageInput.style.height = 'auto';
                
                // 重置阅后即焚状态
                if (burnAfterRead) {
                    burnAfterReadBtn.classList.remove('text-red-500');
                }
                
                // 停止输入状态
                stopTyping();
                
                // 滚动到底部
                scrollToBottom();
            } catch (error) {
                console.error('发送消息失败:', error);
                alert('发送消息失败: ' + error.message);
            } finally {
                hideLoading();
            }
        }
        
        // 标记消息为已读
        async function markMessagesAsRead() {
            if (!currentUser || !selectedFriend) return;
            
            try {
                const { error } = await supabase
                    .from('chat_messages')
                    .update({ 
                        is_read: true,
                        delivery_status: 'read'
                    })
                    .eq('sender_id', selectedFriend.id)
                    .eq('receiver_id', currentUser.id)
                    .eq('is_read', false);
                
                if (error) throw error;
            } catch (error) {
                console.error('标记消息为已读失败:', error);
            }
        }
        
        // 处理好友请求
        async function handleFriendRequest(relationId, status) {
            showLoading();
            
            try {
                const { error } = await supabase
                    .from('friend_relations')
                    .update({ status: status })
                    .eq('id', relationId);
                
                if (error) throw error;
                
                // 重新加载好友列表
                loadFriends();
            } catch (error) {
                console.error('处理好友请求失败:', error);
                alert('处理好友请求失败: ' + error.message);
            } finally {
                hideLoading();
            }
        }
        
        // 添加好友
        async function addFriend() {
            const username = document.getElementById('friendUsername').value.trim();
            if (!username) return;
            
            showLoading();
            
            try {
                // 搜索用户
                const { data: users, error: searchError } = await supabase
                    .from('users')
                    .select('*')
                    .eq('username', username)
                    .neq('id', currentUser.id); // 排除自己
                
                if (searchError) throw searchError;
                
                const searchResultsList = document.getElementById('searchResultsList');
                searchResultsList.innerHTML = '';
                
                if (users.length === 0) {
                    searchResultsList.innerHTML = '<p class="text-sm text-gray-500">未找到该用户</p>';
                } else {
                    users.forEach(user => {
                        // 检查是否已经是好友或已发送请求
                        checkFriendRelation(user.id).then(isRelated => {
                            if (isRelated) {
                                searchResultsList.innerHTML += `
                                    <div class="flex items-center justify-between p-2 hover:bg-gray-50 rounded-lg">
                                        <div class="flex items-center gap-2">
                                            <img src="${user.avatar || 'https://picsum.photos/200/200'}" alt="${user.username}" class="w-8 h-8 rounded-full">
                                            <span>${user.username}</span>
                                        </div>
                                        <span class="text-xs text-gray-500">已发送请求或已是好友</span>
                                    </div>
                                `;
                            } else {
                                searchResultsList.innerHTML += `
                                    <div class="flex items-center justify-between p-2 hover:bg-gray-50 rounded-lg">
                                        <div class="flex items-center gap-2">
                                            <img src="${user.avatar || 'https://picsum.photos/200/200'}" alt="${user.username}" class="w-8 h-8 rounded-full">
                                            <span>${user.username}</span>
                                        </div>
                                        <button onclick="sendFriendRequest('${user.id}')" class="px-2 py-1 bg-primary text-white text-xs rounded">
                                            发送请求
                                        </button>
                                    </div>
                                `;
                            }
                        });
                    });
                }
                
                document.getElementById('searchResults').classList.remove('hidden');
            } catch (error) {
                console.error('搜索用户失败:', error);
                alert('搜索用户失败: ' + error.message);
            } finally {
                hideLoading();
            }
        }
        
        // 检查是否已经是好友或已发送请求
        async function checkFriendRelation(userId) {
            if (!currentUser) return false;
            
            const { data: relations, error } = await supabase
                .from('friend_relations')
                .select('id')
                .or(`and(sender_id.eq.${currentUser.id},receiver_id.eq.${userId}),and(sender_id.eq.${userId},receiver_id.eq.${currentUser.id})`);
            
            if (error) {
                console.error('检查好友关系失败:', error);
                return false;
            }
            
            return relations.length > 0;
        }
        
        // 发送好友请求
        async function sendFriendRequest(receiverId) {
            if (!currentUser) return;
            
            showLoading();
            
            try {
                const message = document.getElementById('friendRequestMessage').value.trim() || '我想加你为好友';
                
                const { error } = await supabase
                    .from('friend_relations')
                    .insert([{
                        sender_id: currentUser.id,
                        receiver_id: receiverId,
                        status: 'pending'
                    }]);
                
                if (error) throw error;
                
                // 关闭弹窗并重新加载好友列表
                document.getElementById('addFriendModal').classList.add('hidden');
                document.getElementById('addFriendForm').reset();
                document.getElementById('searchResults').classList.add('hidden');
                loadFriends();
                
                alert('好友请求已发送');
            } catch (error) {
                console.error('发送好友请求失败:', error);
                alert('发送好友请求失败: ' + error.message);
            } finally {
                hideLoading();
            }
        }
        
        // 更新个人资料
        async function updateProfile() {
            if (!currentUser) return;
            
            const username = document.getElementById('profileUsername').value.trim();
            const signature = document.getElementById('profileSignature').value.trim();
            const status = document.getElementById('profileStatus').value;
            
            if (!username) return;
            
            showLoading();
            
            try {
                const { data: updatedUser, error } = await supabase
                    .from('users')
                    .update({
                        username: username,
                        signature: signature,
                        status: status,
                        last_active: new Date()
                    })
                    .eq('id', currentUser.id)
                    .select('*')
                    .single();
                
                if (error) throw error;
                
                // 更新当前用户信息
                currentUser = updatedUser;
                localStorage.setItem('currentUser', JSON.stringify(currentUser));
                
                // 更新UI
                document.getElementById('headerUsername').textContent = currentUser.username;
                
                // 关闭弹窗
                document.getElementById('profileModal').classList.add('hidden');
                
                // 重新加载好友列表
                loadFriends();
                
                alert('个人资料更新成功');
            } catch (error) {
                console.error('更新个人资料失败:', error);
                alert('更新个人资料失败: ' + error.message);
            } finally {
                hideLoading();
            }
        }
        
        // 切换到登录/注册界面
        function switchToAuthScreen() {
            document.getElementById('authScreen').classList.remove('hidden');
            document.getElementById('chatScreen').classList.add('hidden');
        }
        
        // 切换到聊天界面
        function switchToChatScreen() {
            document.getElementById('authScreen').classList.add('hidden');
            document.getElementById('chatScreen').classList.remove('hidden');
        }
        
        // 切换侧边栏
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebarOverlay');
            
            sidebar.classList.toggle('-translate-x-full');
            overlay.classList.toggle('hidden');
        }
        
        // 登录
        async function login() {
            if (!supabase) return;
            const loginInput = document.getElementById('loginUsername').value.trim();
            const password = document.getElementById('loginPassword').value.trim();
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            let email;
            if (emailRegex.test(loginInput)) {
                // 输入的是邮箱，直接使用
                email = loginInput;
            } else {
                // 输入的是用户名，需要先查询对应的邮箱（若想只支持邮箱登录，可删除此分支）
                const { data: user, error: userError } = await supabase
                    .from('users')
                    .select('auth_id') // 先获取 users 表中的 auth_id
                    .eq('username', loginInput)
                    .single();
        
                if (userError || !user?.auth_id) {
                    alert('用户名不存在');
                    return;
                }
                const { data: authUser, error: authError } = await supabase
                    .from('auth.users')
                    .select('email')
                    .eq('id', user.auth_id) // auth.users 的主键是 id，与 users.auth_id 匹配
                    .single();

                if (authError || !authUser?.email) {
                    alert('用户名未关联邮箱，请联系管理员');
                    return;
                }

                email = authUser.email;
            }
            showLoading();
            
            try {
                // 使用Supabase Auth登录
                const { data: authData, error: authError } = await supabase.auth.signInWithPassword({
                    email: email, // 使用用户名+固定域名作为邮箱
                    password: password
                });
                
                if (authError) throw authError;
                
                // 登录成功，加载用户数据
                await loadCurrentUser(authData.user.id);
                switchToChatScreen();
                loadFriends();
                setupPresenceTracking();
                
                // 重置表单
                document.getElementById('loginForm').reset();
            } catch (error) {
                console.error('登录失败:', error);
                alert('登录失败: ' + error.message);
            } finally {
                hideLoading();
            }
        }
        
        // 注册
        async function register() {
            if (!supabase) return;
            const username = document.getElementById('registerUsername').value.trim();
            const password = document.getElementById('registerPassword').value.trim();
            const email = document.getElementById('registerEmail').value.trim(); // 新增：获取用户输入的邮箱
            const signature = document.getElementById('registerSignature').value.trim();
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(email)) {
                alert('请输入有效的邮箱地址（例如：xxx@xxx.com）');
                return;
            }
            showLoading();
            
            try {
                // 检查用户名是否已存在
                const { data: existingUsers, error: userCheckError } = await supabase
                    .from('users')
                    .select('id')
                    .eq('username', username);
                
                if (userCheckError) throw userCheckError;
                if (existingUsers.length > 0) {
                    throw new Error('用户名已存在');
                }
                
                // 创建Supabase Auth用户
                const authPromise = new Promise((resolve, reject) => {
                    // 监听认证状态变化
                    const { data: { subscription } } = supabase.auth.onAuthStateChange(
                        async (event, session) => {
                            if (event === 'SIGNED_UP' || event === 'SIGNED_IN') {
                                subscription.unsubscribe(); // 只监听一次
                                resolve(session);
                            } else if (event === 'ERROR') {
                                subscription.unsubscribe();
                                reject(new Error('认证过程出错'));
                            }
                        }
                    );

                    // 5秒后如果没有状态变化则超时
                    setTimeout(() => {
                        subscription.unsubscribe();
                        reject(new Error('获取认证会话超时'));
                    }, 5000);
                });

                // 发起注册请求
                const { error: authError } = await supabase.auth.signUp({
                    email: email,
                    password: password,
                    options: { data: { username: username } }
                });

                if (authError) throw authError;

                // 等待认证状态变化，获取会话
                const session = await authPromise;
                if (!session || !session.user) {
                    throw new Error('未能获取有效的用户会话');
                }
                // 创建用户资料
                const { error: dbError } = await supabase
                    .from('users')
                    .insert([{
                        auth_id: session.user.id,
                        username: username,
                        signature: signature || '',
                        status: 'online'
                    }]);
                
                if (dbError) throw dbError;
                
                // 注册成功，切换到登录标签
                switchTab('login');
                
                // 重置表单
                document.getElementById('registerForm').reset();
                alert('注册成功！请查收邮箱验证链接后登录');
            } catch (error) {
                console.error('注册失败:', error);
                // 更具体的错误提示
                if (error.message.includes('会话')) {
                    alert('注册失败：无法完成身份验证，请检查网络或稍后重试');
                } else if (error.message.includes('row-level security')) {
                    alert('注册失败：权限配置错误，请检查Supabase策略');
                } else {
                    alert('注册失败: ' + error.message);
                }
            } finally {
                hideLoading();
            }
        }
        
        // 退出登录
        async function logout() {
            if (!supabase) return;
            
            showLoading();
            
            try {
                // 更新用户状态为离线
                if (currentUser) {
                    await supabase
                        .from('users')
                        .update({
                            status: 'offline',
                            last_active: new Date()
                        })
                        .eq('id', currentUser.id);
                }
                
                // 退出Supabase Auth
                const { error } = await supabase.auth.signOut();
                if (error) throw error;
                
                // 清除当前用户
                currentUser = null;
                selectedFriend = null;
                localStorage.removeItem('currentUser');
                
                // 移除聊天监听
                if (chatSubscription) {
                    supabase.removeChannel(chatSubscription);
                    chatSubscription = null;
                }
                
                // 切换到登录界面
                switchToAuthScreen();
            } catch (error) {
                console.error('退出登录失败:', error);
                alert('退出登录失败: ' + error.message);
            } finally {
                hideLoading();
            }
        }
        
        // 切换登录/注册标签
        function switchTab(tabName) {
            const loginTab = document.getElementById('loginTab');
            const registerTab = document.getElementById('registerTab');
            const loginForm = document.getElementById('loginForm');
            const registerForm = document.getElementById('registerForm');
            
            if (tabName === 'login') {
                loginTab.classList.add('text-primary', 'border-primary', 'border-b-2');
                loginTab.classList.remove('text-gray-500');
                registerTab.classList.remove('text-primary', 'border-primary', 'border-b-2');
                registerTab.classList.add('text-gray-500');
                loginForm.classList.remove('hidden');
                registerForm.classList.add('hidden');
            } else {
                registerTab.classList.add('text-primary', 'border-primary', 'border-b-2');
                registerTab.classList.remove('text-gray-500');
                loginTab.classList.remove('text-primary', 'border-primary', 'border-b-2');
                loginTab.classList.add('text-gray-500');
                registerForm.classList.remove('hidden');
                loginForm.classList.add('hidden');
            }
        }
        
        // 初始化表情选择器
        function initEmojiPicker() {
            const emojiContainer = document.getElementById('emojiContainer');
            const emojis = ['😀', '😂', '😍', '👍', '🎉', '😢', '😠', '🤔', '👏', '🙏', '❤️', '🔥', '🥳', '🤩', '🤗', '😴', '🤮', '😱', '🤯', '🥺', '😎', '🤓', '👻', '💩', '🤡'];
            
            emojis.forEach(emoji => {
                const emojiElement = document.createElement('button');
                emojiElement.className = 'p-2 hover:bg-gray-100 rounded-full transition-colors';
                emojiElement.innerHTML = emoji;
                emojiElement.onclick = () => {
                    document.getElementById('messageInput').value += emoji;
                    adjustTextareaHeight();
                    startTyping();
                };
                emojiContainer.appendChild(emojiElement);
            });
        }
        
        // 调整文本框高度
        function adjustTextareaHeight() {
            const textarea = document.getElementById('messageInput');
            textarea.style.height = 'auto';
            textarea.style.height = (textarea.scrollHeight) + 'px';
            
            // 限制最大高度
            if (textarea.scrollHeight > 120) {
                textarea.style.height = '120px';
                textarea.style.overflowY = 'auto';
            } else {
                textarea.style.overflowY = 'hidden';
            }
        }
        
        // 设置聊天监听
        function setupChatListener() {
            if (!currentUser || !selectedFriend) return;
            
            // 创建监听通道
            chatSubscription = supabase
                .channel(`chat_${currentUser.id}_${selectedFriend.id}`)
                .on(
                    'postgres_changes',
                    {
                        event: 'INSERT',
                        schema: 'public',
                        table: 'chat_messages',
                        filter: `sender_id=eq.${selectedFriend.id} and receiver_id=eq.${currentUser.id}`
                    },
                    (payload) => {
                        console.log('收到新消息:', payload);
                        addMessageToDOM(payload.new);
                        scrollToBottom();
                        markMessagesAsRead();
                        
                        // 显示通知
                        if (!document.hasFocus()) {
                            showNotification(
                                selectedFriend.username,
                                payload.new.content.length > 20 
                                    ? payload.new.content.substring(0, 20) + '...' 
                                    : payload.new.content,
                                selectedFriend.avatar
                            );
                        }
                    }
                )
                .subscribe();
        }
        
        // 设置输入状态监听
        function setupTypingListener() {
            if (!currentUser || !selectedFriend) return;
            
            // 监听对方输入状态
            supabase
                .channel(`typing_${currentUser.id}_${selectedFriend.id}`)
                .on(
                    'postgres_changes',
                    {
                        event: 'UPDATE',
                        schema: 'public',
                        table: 'typing_status',
                        filter: `user_id=eq.${selectedFriend.id} and target_user_id=eq.${currentUser.id}`
                    },
                    (payload) => {
                        const typingIndicator = document.getElementById('typingIndicator');
                        if (payload.new.is_typing) {
                            typingIndicator.classList.remove('hidden');
                        } else {
                            typingIndicator.classList.add('hidden');
                        }
                    }
                )
                .subscribe();
        }
        
        // 开始输入状态
        function startTyping() {
            if (!currentUser || !selectedFriend) return;
            
            // 清除之前的超时
            if (typingTimeout) {
                clearTimeout(typingTimeout);
            }
            
            // 更新输入状态为正在输入
            supabase
                .from('typing_status')
                .upsert([{
                    user_id: currentUser.id,
                    target_user_id: selectedFriend.id,
                    is_typing: true
                }]);
            
            // 5秒后自动设置为停止输入
            typingTimeout = setTimeout(stopTyping, 5000);
        }
        
        // 停止输入状态
        function stopTyping() {
            if (!currentUser || !selectedFriend) return;
            
            supabase
                .from('typing_status')
                .upsert([{
                    user_id: currentUser.id,
                    target_user_id: selectedFriend.id,
                    is_typing: false
                }]);
        }
        
        // 设置在线状态跟踪
        function setupPresenceTracking() {
            if (!currentUser) return;
            
            // 每30秒更新一次最后活跃时间
            setInterval(async () => {
                if (currentUser) {
                    try {
                        await supabase
                            .from('users')
                            .update({
                                last_active: new Date(),
                                status: currentUser.status || 'online'
                            })
                            .eq('id', currentUser.id);
                    } catch (error) {
                        console.error('更新在线状态失败:', error);
                    }
                }
            }, 30000);
            
            // 监听好友状态变化
            supabase
                .channel('user_status')
                .on(
                    'postgres_changes',
                    {
                        event: 'UPDATE',
                        schema: 'public',
                        table: 'users',
                        filter: 'status=in.(online,busy,away,offline)'
                    },
                    (payload) => {
                        console.log('用户状态更新:', payload.new);
                        // 如果正在聊天的好友状态更新，刷新聊天头部
                        if (selectedFriend && selectedFriend.id === payload.new.id) {
                            selectedFriend.status = payload.new.status;
                            updateChatHeader();
                        }
                        // 刷新好友列表
                        loadFriends();
                    }
                )
                .subscribe();
        }
        
        // 显示通知
        function showNotification(title, message, icon) {
            // 检查浏览器是否支持通知
            if (!('Notification' in window)) {
                return;
            }
            
            // 检查是否有权限
            if (Notification.permission === 'granted') {
                new Notification(title, {
                    body: message,
                    icon: icon || 'https://picsum.photos/200/200'
                });
            } 
            // 否则请求权限
            else if (Notification.permission !== 'denied') {
                Notification.requestPermission().then(permission => {
                    if (permission === 'granted') {
                        new Notification(title, {
                            body: message,
                            icon: icon || 'https://picsum.photos/200/200'
                        });
                    }
                });
            }
        }
        
        // 初始化事件监听
        function initEventListeners() {
            // 登录/注册标签切换
            document.getElementById('loginTab').addEventListener('click', () => switchTab('login'));
            document.getElementById('registerTab').addEventListener('click', () => switchTab('register'));
            
            // 登录表单提交
            document.getElementById('loginForm').addEventListener('submit', (e) => {
                e.preventDefault();
                login(); // 函数内自行获取输入值
            });
            
            // 注册表单提交
            document.getElementById('registerForm').addEventListener('submit', (e) => {
                e.preventDefault();
                register(); // 无需传参，函数内从DOM获取用户名、密码、邮箱、签名
            });
            
            // 添加好友表单提交
            document.getElementById('addFriendForm').addEventListener('submit', (e) => {
                e.preventDefault();
                addFriend();
            });
            
            // 个人资料表单提交
            document.getElementById('profileForm').addEventListener('submit', (e) => {
                e.preventDefault();
                updateProfile();
            });
            
            // 发送消息按钮
            document.getElementById('sendMessageBtn').addEventListener('click', sendMessage);
            
            // 消息输入框
            const messageInput = document.getElementById('messageInput');
            messageInput.addEventListener('input', () => {
                adjustTextareaHeight();
                startTyping();
            });
            messageInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });
            
            // 侧边栏切换
            document.getElementById('toggleSidebar').addEventListener('click', toggleSidebar);
            
            // 个人菜单切换
            document.getElementById('profileMenuBtn').addEventListener('click', () => {
                document.getElementById('profileMenu').classList.toggle('hidden');
            });
            
            // 点击其他区域关闭个人菜单
            document.addEventListener('click', (e) => {
                const profileMenuBtn = document.getElementById('profileMenuBtn');
                const profileMenu = document.getElementById('profileMenu');
                
                if (!profileMenuBtn.contains(e.target) && !profileMenu.contains(e.target)) {
                    profileMenu.classList.add('hidden');
                }
            });
            
            // 编辑个人资料
            document.getElementById('editProfileBtn').addEventListener('click', () => {
                document.getElementById('profileMenu').classList.add('hidden');
                document.getElementById('profileModal').classList.remove('hidden');
            });
            
            // 取消个人资料编辑
            document.getElementById('cancelProfileBtn').addEventListener('click', () => {
                document.getElementById('profileModal').classList.add('hidden');
            });
            
            // 退出登录
            document.getElementById('logoutBtn').addEventListener('click', () => {
                document.getElementById('profileMenu').classList.add('hidden');
                if (confirm('确定要退出登录吗？')) {
                    logout();
                }
            });
            
            // 打开添加好友弹窗
            document.getElementById('addFriendBtn').addEventListener('click', () => {
                document.getElementById('addFriendModal').classList.remove('hidden');
                document.getElementById('friendUsername').focus();
            });
            
            // 关闭添加好友弹窗（点击外部）
            document.getElementById('addFriendModal').addEventListener('click', (e) => {
                if (e.target === document.getElementById('addFriendModal')) {
                    document.getElementById('addFriendModal').classList.add('hidden');
                    document.getElementById('addFriendForm').reset();
                    document.getElementById('searchResults').classList.add('hidden');
                }
            });
            
            // 打开/关闭表情选择器
            document.getElementById('toggleEmojiBtn').addEventListener('click', () => {
                document.getElementById('emojiPicker').classList.toggle('hidden');
                document.getElementById('gifPicker').classList.add('hidden');
            });
            
            // 打开/关闭GIF选择器
            document.getElementById('toggleGifBtn').addEventListener('click', () => {
                document.getElementById('gifPicker').classList.toggle('hidden');
                document.getElementById('emojiPicker').classList.add('hidden');
                loadGifs();
            });
            
            // 切换阅后即焚
            document.getElementById('toggleBurnAfterReadBtn').addEventListener('click', (e) => {
                e.currentTarget.classList.toggle('text-red-500');
            });
            
            // 搜索GIF
            document.getElementById('gifSearch').addEventListener('input', debounce(loadGifs, 300));
            
            // 打开数据看板
            document.getElementById('openDashboard').addEventListener('click', () => {
                document.getElementById('dashboardModal').classList.remove('hidden');
                loadDataBoard();
            });
            
            // 关闭数据看板
            document.getElementById('closeDashboard').addEventListener('click', () => {
                document.getElementById('dashboardModal').classList.add('hidden');
            });
            
            // 关闭数据看板（点击外部）
            document.getElementById('dashboardModal').addEventListener('click', (e) => {
                if (e.target === document.getElementById('dashboardModal')) {
                    document.getElementById('dashboardModal').classList.add('hidden');
                }
            });
            
            // 清除聊天记录
            document.getElementById('clearChatBtn').addEventListener('click', () => {
                if (selectedFriend && confirm(`确定要清除与${selectedFriend.username}的聊天记录吗？`)) {
                    clearChatHistory();
                }
            });
            
            // 导出聊天记录
            document.getElementById('exportChatsBtn').addEventListener('click', () => {
                if (selectedFriend) {
                    exportChatHistory();
                } else {
                    alert('请先选择一个聊天对象');
                }
            });
            
            // 查看好友资料
            document.getElementById('viewFriendProfileBtn').addEventListener('click', () => {
                if (selectedFriend) {
                    alert(`${selectedFriend.username}\n${selectedFriend.signature || '暂无签名'}\n状态: ${formatStatus(selectedFriend.status)}`);
                }
            });
        }
        
        // 防抖函数
        function debounce(func, wait) {
            let timeout;
            return function(...args) {
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(this, args), wait);
            };
        }
        
        // 加载GIF
        async function loadGifs() {
            const searchTerm = document.getElementById('gifSearch').value.trim() || 'happy';
            const gifContainer = document.getElementById('gifContainer');
            
            // 使用picsum作为GIF占位图
            const tags = searchTerm.split(' ');
            const gifTags = tags.length > 0 ? tags : ['happy', 'funny', 'love', 'cool'];
            
            gifContainer.innerHTML = '';
            
            // 生成12个相关GIF
            for (let i = 0; i < 12; i++) {
                const tag = gifTags[i % gifTags.length];
                const url = `https://picsum.photos/seed/${tag}${i}/300/200`;
                
                const gifElement = document.createElement('div');
                gifElement.className = 'relative aspect-video overflow-hidden rounded-lg cursor-pointer hover:opacity-90 transition-opacity';
                gifElement.innerHTML = `
                    <img src="${url}" alt="${tag} GIF" class="w-full h-full object-cover">
                    <div class="absolute inset-0 bg-black/20 opacity-0 hover:opacity-100 transition-opacity flex items-center justify-center">
                        <i class="fa fa-plus text-white text-xl"></i>
                    </div>
                `;
                gifElement.onclick = () => {
                    document.getElementById('messageInput').value += `[gif]${url}[/gif]`;
                    adjustTextareaHeight();
                    startTyping();
                };
                gifContainer.appendChild(gifElement);
            }
        }
        
        // 清除聊天记录
        async function clearChatHistory() {
            if (!currentUser || !selectedFriend) return;
            
            showLoading();
            
            try {
                const { error } = await supabase
                    .from('chat_messages')
                    .delete()
                    .or(`and(sender_id.eq.${currentUser.id},receiver_id.eq.${selectedFriend.id}),and(sender_id.eq.${selectedFriend.id},receiver_id.eq.${currentUser.id})`);
                
                if (error) throw error;
                
                // 清空消息容器
                document.getElementById('messagesContainer').innerHTML = '';
            } catch (error) {
                console.error('清除聊天记录失败:', error);
                alert('清除聊天记录失败: ' + error.message);
            } finally {
                hideLoading();
            }
        }
        
        // 导出聊天记录
        async function exportChatHistory() {
            if (!currentUser || !selectedFriend) return;
            
            showLoading();
            
            try {
                // 加载最新的聊天记录
                const { data: messages, error: messagesError } = await supabase
                    .from('chat_messages')
                    .select('*')
                    .or(`and(sender_id.eq.${currentUser.id},receiver_id.eq.${selectedFriend.id}),and(sender_id.eq.${selectedFriend.id},receiver_id.eq.${currentUser.id})`)
                    .order('created_at', { ascending: true });
                
                if (messagesError) throw messagesError;
                
                // 创建PDF
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                // 设置标题
                doc.setFontSize(16);
                doc.setTextColor(0);
                doc.text(`与${selectedFriend.username}的聊天记录`, 10, 10);
                doc.setFontSize(10);
                doc.setTextColor(100);
                doc.text(`导出时间: ${new Date().toLocaleString()}`, 10, 20);
                doc.line(10, 25, 200, 25); // 水平线
                
                let yPos = 35; // 起始Y坐标
                
                // 遍历消息
                messages.forEach(msg => {
                    const isOwnMessage = msg.sender_id === currentUser.id;
                    const senderName = isOwnMessage ? currentUser.username : selectedFriend.username;
                    const date = new Date(msg.created_at);
                    const timeStr = date.toLocaleString();
                    
                    // 发送者和时间
                    doc.setFontSize(10);
                    doc.setTextColor(100);
                    doc.text(`${senderName} ${timeStr}`, 10, yPos);
                    yPos += 10;
                    
                    // 消息内容
                    doc.setFontSize(11);
                    doc.setTextColor(50);
                    
                    // 处理长文本换行
                    const content = msg.burn_after_read ? `${msg.content} (阅后即焚)` : msg.content;
                    const splitText = doc.splitTextToSize(content, 180); // 180是最大宽度
                    doc.text(splitText, 10, yPos);
                    
                    yPos += (splitText.length * 10) + 5; // 增加行高和间距
                    
                    // 分页处理
                    if (yPos > 280) {
                        doc.addPage();
                        yPos = 15;
                    }
                });
                
                // 保存PDF
                doc.save(`与${selectedFriend.name || selectedFriend.username}的聊天记录.pdf`);
            } catch (error) {
                console.error('导出聊天记录失败:', error);
                alert('导出失败: ' + error.message);
            } finally {
                hideLoading();
            }
        }
        
        // 加载数据看板
        async function loadDataBoard() {
            if (!currentUser) return;
            
            try {
                showLoading();
                
                // 1. 获取本周发送消息数量
                const weekAgo = new Date();
                weekAgo.setDate(weekAgo.getDate() - 7);
                
                const { data: weeklyMessages, error: msgError } = await supabase
                    .from('chat_messages')
                    .select('id')
                    .eq('sender_id', currentUser.id)
                    .gt('created_at', weekAgo.toISOString());
                
                if (msgError) throw msgError;
                
                document.getElementById('weeklyMessageCount').textContent = weeklyMessages?.length || 0;
                
                // 2. 获取总好友数
                const { data: friends, error: friendError } = await supabase
                    .from('friend_relations')
                    .select('id')
                    .or(`sender_id.eq.${currentUser.id},receiver_id.eq.${currentUser.id}`)
                    .eq('status', 'accepted');
                
                if (friendError) throw friendError;
                
                document.getElementById('totalFriendsCount').textContent = friends?.length || 0;
                
                // 3. 获取聊天最频繁好友
                if (friends?.length) {
                    // 获取所有好友ID
                    const friendIds = friends.map(rel => 
                        rel.sender_id === currentUser.id ? rel.receiver_id : rel.sender_id
                    );
                    
                    // 获取与每个好友的聊天数量
                    let mostChatFriendId = null;
                    let maxMessageCount = 0;
                    
                    for (const friendId of friendIds) {
                        const { data: messages, error: msgCountError } = await supabase
                            .from('chat_messages')
                            .select('id')
                            .or(`and(sender_id.eq.${currentUser.id},receiver_id.eq.${friendId}),and(sender_id.eq.${friendId},receiver_id.eq.${currentUser.id})`);
                        
                        if (msgCountError) continue;
                        
                        if (messages?.length > maxMessageCount) {
                            maxMessageCount = messages.length;
                            mostChatFriendId = friendId;
                        }
                    }
                    
                    // 获取最频繁聊天好友的名称
                    if (mostChatFriendId) {
                        const { data: friend, error: userError } = await supabase
                            .from('users')
                            .select('username')
                            .eq('id', mostChatFriendId)
                            .single();
                        
                        if (!userError && friend) {
                            document.getElementById('mostChatFriend').textContent = friend.username;
                            document.getElementById('mostChatCount').textContent = `共发送 ${maxMessageCount} 条消息`;
                        }
                    }
                }
                
                // 4. 获取常用表情
                const { data: allMessages, error: allMsgError } = await supabase
                    .from('chat_messages')
                    .select('content')
                    .eq('sender_id', currentUser.id);
                
                if (!allMsgError && allMessages?.length) {
                    const emojiCount = {};
                    const emojiRegex = /[\u{1F600}-\u{1F64F}\u{1F300}-\u{1F5FF}\u{1F680}-\u{1F6FF}\u{1F1E0}-\u{1F1FF}]/gu;
                    
                    // 统计表情使用次数
                    allMessages.forEach(msg => {
                        if (msg.content) {
                            const emojis = msg.content.match(emojiRegex);
                            if (emojis) {
                                emojis.forEach(emoji => {
                                    emojiCount[emoji] = (emojiCount[emoji] || 0) + 1;
                                });
                            }
                        }
                    });
                    
                    // 排序并显示前5个常用表情
                    const sortedEmojis = Object.entries(emojiCount)
                        .sort((a, b) => b[1] - a[1])
                        .slice(0, 5);
                    
                    const emojiContainer = document.getElementById('frequentEmojis');
                    
                    if (sortedEmojis.length) {
                        emojiContainer.innerHTML = sortedEmojis.map(([emoji, count]) => 
                            `<div class="text-center">
                                <div class="text-3xl">${emoji}</div>
                                <div class="text-xs text-gray-500">${count}次</div>
                            </div>`
                        ).join('');
                    } else {
                        emojiContainer.innerHTML = '<p class="text-gray-500">暂无常用表情</p>';
                    }
                }
                
                // 5. 消息发送趋势图表
                const labels = [];
                const data = [];
                
                // 获取过去7天的日期
                for (let i = 6; i >= 0; i--) {
                    const date = new Date();
                    date.setDate(date.getDate() - i);
                    const dateStr = date.toISOString().split('T')[0];
                    labels.push(date.toLocaleDateString());
                    
                    // 获取当天发送的消息数量
                    const nextDate = new Date(date);
                    nextDate.setDate(date.getDate() + 1);
                    const nextDateStr = nextDate.toISOString().split('T')[0];
                    
                    const { data: dailyMessages } = await supabase
                        .from('chat_messages')
                        .select('id')
                        .eq('sender_id', currentUser.id)
                        .gte('created_at', `${dateStr}T00:00:00`)
                        .lt('created_at', `${nextDateStr}T00:00:00`);
                    
                    data.push(dailyMessages?.length || 0);
                }
                
                // 初始化或更新图表
                const ctx = document.getElementById('messageTrendChart').getContext('2d');
                if (messageTrendChart) {
                    messageTrendChart.data.labels = labels;
                    messageTrendChart.data.datasets[0].data = data;
                    messageTrendChart.update();
                } else {
                    messageTrendChart = new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: labels,
                            datasets: [{
                                label: '消息数量',
                                data: data,
                                fill: true,
                                backgroundColor: 'rgba(59, 130, 246, 0.2)',
                                borderColor: 'rgba(59, 130, 246, 1)',
                                tension: 0.4
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    ticks: {
                                        precision: 0
                                    }
                                }
                            }
                        }
                    });
                }
                
                // 6. 推荐可能认识的人（基于共同好友）
                const { data: possibleFriends, error: possibleError } = await supabase
                    .rpc('find_possible_friends', { user_id: currentUser.id, limit: 3 });
                
                if (!possibleError && possibleFriends?.length) {
                    const container = document.getElementById('possibleFriends');
                    container.innerHTML = possibleFriends.map(friend => `
                        <div class="flex items-center justify-between p-3 bg-white rounded-lg hover:bg-gray-50 transition-all border border-gray-100">
                            <div class="flex items-center gap-3">
                                <img src="${friend.avatar}" alt="${friend.username}" class="w-10 h-10 rounded-full object-cover">
                                <div>
                                    <p class="font-medium">${friend.username}</p>
                                    <p class="text-xs text-gray-500">${friend.common_friends}个共同好友</p>
                                </div>
                            </div>
                            <button onclick="sendFriendRequest('${friend.id}')" class="px-3 py-1 bg-primary text-white text-sm rounded-lg hover:bg-primary/90">
                                添加
                            </button>
                        </div>
                    `).join('');
                } else {
                    document.getElementById('possibleFriends').innerHTML = '<p class="text-gray-500">暂无推荐好友</p>';
                }
                
            } catch (error) {
                console.error('加载数据看板失败:', error);
            } finally {
                hideLoading();
            }
        }
        
        // 处理头像上传
        function handleAvatarUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            // 检查文件类型
            if (!file.type.match('image.*')) {
                alert('请选择图片文件');
                return;
            }
            
            // 读取图片并显示裁剪器
            const reader = new FileReader();
            reader.onload = function(e) {
                const cropperContainer = document.getElementById('avatarCropper');
                const cropperImage = document.getElementById('cropperImage');
                
                cropperImage.src = e.target.result;
                cropperContainer.classList.remove('hidden');
                
                // 初始化裁剪器
                if (cropper) {
                    cropper.destroy();
                }
                
                cropper = new Cropper(cropperImage, {
                    aspectRatio: 1, // 1:1比例
                    viewMode: 1,
                    autoCropArea: 0.8 // 默认裁剪区域
                });
            };
            reader.readAsDataURL(file);
        }
        
        // 取消头像裁剪
        function cancelAvatarCrop() {
            if (cropper) {
                cropper.destroy();
                cropper = null;
            }
            document.getElementById('avatarCropper').classList.add('hidden');
            document.getElementById('avatarInput').value = '';
        }
        
        // 确认头像裁剪并上传
        async function confirmAvatarCrop() {
            if (!cropper || !currentUser) return;
            
            try {
                showLoading();
                
                // 获取裁剪后的图片数据
                const canvas = cropper.getCroppedCanvas({
                    width: 200,
                    height: 200
                });
                
                // 转换为DataURL
                const avatarDataUrl = canvas.toDataURL('image/jpeg');
                
                // 更新数据库中的头像URL
                const { data: updatedUser, error: updateError } = await supabase
                    .from('users')
                    .update({ 
                        avatar: avatarDataUrl,
                        last_active: new Date()
                    })
                    .eq('id', currentUser.id)
                    .select('*')
                    .single();
                
                if (updateError) throw updateError;
                
                // 更新本地用户数据和界面
                currentUser = updatedUser;
                localStorage.setItem('currentUser', JSON.stringify(currentUser));
                document.getElementById('profileAvatar').src = avatarDataUrl;
                document.getElementById('headerAvatar').src = avatarDataUrl;
                
                alert('头像更新成功');
                
                // 关闭裁剪器
                cancelAvatarCrop();
                document.getElementById('profileModal').classList.add('hidden');
            } catch (error) {
                console.error('更新头像失败:', error);
                alert('更新失败: ' + error.message);
            } finally {
                hideLoading();
            }
        }
        
        // 撤回消息
        async function recallMessage(messageId) {
            if (!currentUser) return;
            
            try {
                const { data: message, error: fetchError } = await supabase
                    .from('chat_messages')
                    .select('sender_id')
                    .eq('id', messageId)
                    .single();
                
                if (fetchError) throw fetchError;
                
                // 只有自己发送的消息才能撤回
                if (message.sender_id === currentUser.id) {
                    const { error } = await supabase
                        .from('chat_messages')
                        .update({ is_recalled: true })
                        .eq('id', messageId);
                    
                    if (error) throw error;
                    
                    // 更新UI
                    const messageElement = document.querySelector(`.message[data-id="${messageId}"]`);
                    if (messageElement) {
                        const contentElement = messageElement.querySelector('.chat-bubble-left, .chat-bubble-right');
                        if (contentElement) {
                            contentElement.innerHTML = '<div class="text-gray-400 text-sm italic">此消息已撤回</div>';
                        }
                    }
                }
            } catch (error) {
                console.error('撤回消息失败:', error);
            }
        }
        
        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>
</html>
