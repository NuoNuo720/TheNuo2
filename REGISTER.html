<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>注册界面</title>
    <style>
        /* 基础样式 */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body{
            background-color:#f4f4f4;
            font-family:Arial,sans-serif;
            height:100vh;
            display : flex;
            justify-content:center;
            align-items:center;
            width: 100%;
            overflow: hidden; /* 防止页面滚动 */
            /* 新增：轻微背景渐变，提升质感 */
            background-image: linear-gradient(120deg, #f0f4f8, #e9ecef);
        }
        
        .container {
            width:300px;
            box-shadow: 0 0 15px rgba(0,0,0,0.08); /* 优化阴影，更柔和 */
            background-color:#fff;
            border-radius:10px; /* 增大圆角，更现代 */
            padding : 25px;
            position: relative;
            z-index: 10;
            transition: transform 0.3s ease; /* 新增：hover时轻微上浮 */
        }
        
        .container:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
        }
        
        h2{
            text-align:center;
            color:#333; /* 加深标题颜色，更醒目 */
            margin-bottom:25px;
            font-size: 1.5rem;
            font-weight: 600;
        }
        
        label {
            display:block;
            margin-bottom:6px;
            font-weight:500; /* 调整字体粗细，更舒适 */
            color:#555;
            font-size: 0.95rem;
        }
        
        input[type="text"],
        input[type="password"],
        input[type="email"] {
            width:100%;
            padding:11px 14px; /* 优化内边距，手感更好 */
            margin-bottom:15px;
            border:1px solid #ddd; /* 减淡边框色 */
            border-radius:6px; /* 增大输入框圆角 */
            box-sizing: border-box;
            font-size: 0.95rem;
            transition: all 0.2s ease; /* 新增输入框过渡效果 */
        }
        
        input:focus {
            outline: none;
            border-color: #007bff;
            box-shadow: 0 0 0 2px rgba(0,123,255,0.25);
            border-width: 1px; /* 避免focus时边框变粗 */
        }
        
        .input-error {
            border-color: #dc3545 !important;
        }
        
        .checkbox {
            margin-bottom:18px;
            color:#666;
            font-size: 0.9rem;
            display: flex;
            align-items: center; /* 复选框与文字垂直居中 */
            gap: 8px;
        }
        
        .checkbox input {
            width: 16px;
            height: 16px; /* 统一复选框大小 */
            cursor: pointer;
        }
        
        button {
            width:100%;
            padding:12px; /* 优化按钮内边距 */
            background-color:#28a745;
            color:#fff;
            border:none;
            border-radius:6px; /* 增大按钮圆角 */
            cursor:pointer;
            font-size:16px;
            font-weight:500; /* 按钮文字加粗 */
            transition: background-color 0.3s, transform 0.1s; /* 新增点击反馈 */
        }
        
        button:hover:not(:disabled) {
            background-color:#218838;
        }
        
        button:active:not(:disabled) {
            transform: scale(0.98); /* 按钮点击时轻微缩小，反馈更明显 */
        }
        
        button:disabled {
            background-color:#6c757d;
            cursor: not-allowed;
        }
        
        .links{
            text-align:center;
            margin-top:20px; /* 增加链接区域间距 */
            font-size: 0.9rem;
        }
        
        .links a {
            color:#007bff;
            text-decoration:none;
            margin:0 5px;
            transition: color 0.2s; /* 链接颜色过渡 */
        }
        
        .links a:hover {
            text-decoration:underline;
            color:#0056b3; /* 加深hover颜色 */
        }
        
        .error-message {
            color: #dc3545;
            text-align: center;
            margin: 0 0 15px 0; /* 调整间距，与表单更协调 */
            padding: 9px;
            border: 1px solid #f5c6cb;
            border-radius: 6px;
            background-color: #f8d7da;
            display: none;
            font-size: 0.9rem;
        }
        
        .success-message {
            color: #155724;
            text-align: center;
            margin: 0 0 15px 0; /* 调整间距 */
            padding: 9px;
            border: 1px solid #c3e6cb;
            border-radius: 6px;
            background-color: #d4edda;
            display: none;
            font-size: 0.9rem;
        }
        
        .tip {
            font-size: 0.85rem; /* 缩小提示文字 */
            color: #777;
            margin: -12px 0 18px 0; /* 调整间距 */
            line-height: 1.4;
        }
        
        .password-strength {
            height: 6px; /* 加粗强度条 */
            background-color: #f1f1f1;
            margin: -10px 0 18px 0; /* 调整间距 */
            border-radius: 3px;
            overflow: hidden;
            display: none;
        }
        
        .strength-bar {
            height: 100%;
            width: 0%;
            transition: width 0.3s, background-color 0.3s; /* 新增颜色过渡 */
        }
        
        .strength-weak {
            background-color: #dc3545;
            width: 33%;
        }
        
        .strength-medium {
            background-color: #ffc107;
            width: 66%;
        }
        
        .strength-strong {
            background-color: #28a745;
            width: 100%;
        }
        
        .spinner {
            width: 16px;
            height: 16px;
            border: 2px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
            display: inline-block;
            vertical-align: middle;
            margin-right: 8px;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* 加载动画样式 - 修复关键部分 */
        #loader-wrapper {
          position: fixed;
          top: 0;
          left: 0;
          width: 100vw;
          height: 100vh;
          background: #fff;
          display: flex;
          flex-direction: column;
          justify-content: center;
          align-items: center;
          z-index: 9999;
          transition: opacity 0.5s ease-out;
        }

        #loader {
          width: 60px;
          height: 60px;
          border: 5px solid #f3f3f3;
          border-top: 5px solid #3498db;
          border-radius: 50%;
          animation: spin 1s linear infinite;
          margin-bottom: 20px;
        }

        #loading-text {
          color: #333;
          font-family: 'Arial', sans-serif;
          font-size: 16px;
          letter-spacing: 1px;
          animation: fade 1.5s ease-in-out infinite alternate;
        }

        @keyframes fade {
          from { opacity: 0.7; }
          to { opacity: 1; }
        }

        /* 加载完成后隐藏动画 */
        .loaded #loader-wrapper {
          opacity: 0;
          pointer-events: none;
          transition: opacity 0.5s ease-out;
        }

        /* 新增：适配超小屏幕（如320px手机） */
        @media (max-width: 340px) {
            .container {
                width: 90%;
                padding: 20px 15px;
            }
            h2 {
                font-size: 1.3rem;
            }
        }
    </style>
</head>
<body>
    <!-- 加载动画 -->
    <div id="loader-wrapper">
      <div id="loader"></div>
      <p id="loading-text">加载中...</p >
    </div>

    <div class="container">
        <div class="error-message" id="errorMsg"></div>
        <div class="success-message" id="successMsg"></div>
        
        <form id="registerForm">
            <h2>账号注册</h2>
            <label for="username">用户名</label>
            <input type="text" name="username" placeholder="请输入3-20位昵称" id="username" required>
            <div class="tip">支持字母、数字、下划线，长度3-20位</div>
            
            <label for="email">邮箱</label>
            <input type="email" name="email" placeholder="请输入常用邮箱" id="email" required>
            <div class="tip">用于登录验证和密码找回</div> <!-- 新增邮箱提示 -->
            
            <label for="password">设置密码</label>
            <input type="password" name="password" placeholder="至少6位，建议包含字母和数字" id="password" required>
            <div class="password-strength">
                <div class="strength-bar" id="strengthBar"></div>
            </div>
            <div class="tip">强度：弱（6位纯字符）→ 中（8位字母+数字）→ 强（10位含特殊符号）</div>
            
            <label for="confirmPassword">确认密码</label>
            <input type="password" name="confirmPassword" placeholder="请再次输入密码" id="confirmPassword" required>
            
            <div class="checkbox">
                <input type="checkbox" name="rememberMe" id="rememberMe" checked> <!-- 默认勾选记住用户名 -->
                <label for="rememberMe">记住用户名（下次无需重复输入）</label>
            </div>
            
            <button type="submit" id="submitBtn">注册账号</button>
        </form>
        
        <div class="links">
            <a href="indexlo.html" id="loginLink">已有账号？立即登录</a >
        </div>
    </div>

    <script>
        // 页面加载动画控制
        window.addEventListener('load', function() {
            setTimeout(function() {
                document.body.classList.add('loaded');
            }, 1000);
        });

        // 页面初始化
        window.addEventListener('DOMContentLoaded', function() {
            const savedUsername = localStorage.getItem('rememberedUsername');
            const usernameInput = document.getElementById('username');
            const rememberMeCheckbox = document.getElementById('rememberMe');

            // 记住用户名逻辑
            if (savedUsername) {
                usernameInput.value = savedUsername;
                rememberMeCheckbox.checked = true;
            }

            // 密码强度检测（优化逻辑：更精准的强度判断）
            const passwordInput = document.getElementById('password');
            const strengthBar = document.getElementById('strengthBar');
            const strengthContainer = document.querySelector('.password-strength');

            passwordInput.addEventListener('input', function() {
                const password = this.value;
                
                if (password.length > 0) {
                    strengthContainer.style.display = 'block';
                    const hasLetter = /[a-zA-Z]/.test(password);
                    const hasNumber = /\d/.test(password);
                    const hasSpecial = /[^a-zA-Z0-9]/.test(password); // 特殊符号
                    
                    // 优化强度判断逻辑
                    if (password.length < 6) {
                        strengthBar.className = 'strength-bar'; // 无颜色（过短）
                    } else if (password.length < 8 || !(hasLetter && hasNumber)) {
                        strengthBar.className = 'strength-bar strength-weak'; // 弱（缺字母/数字）
                    } else if (password.length < 10 || !hasSpecial) {
                        strengthBar.className = 'strength-bar strength-medium'; // 中（缺特殊符号）
                    } else {
                        strengthBar.className = 'strength-bar strength-strong'; // 强（全满足）
                    }
                } else {
                    strengthContainer.style.display = 'none';
                }
            });

            // 实时验证（优化：失去焦点时验证，避免频繁提示）
            const formInputs = registerForm.querySelectorAll('input[required]');
            formInputs.forEach(input => {
                input.addEventListener('blur', function() {
                    // 仅当输入框有内容时才验证（空值在提交时统一提示）
                    if (this.value.trim().length > 0) {
                        validateField(this);
                    }
                });

                // 输入时清除错误状态
                input.addEventListener('input', function() {
                    this.classList.remove('input-error');
                    hideMessages();
                });
            });
        });

        // 表单验证函数
        const registerForm = document.getElementById('registerForm');
        const errorMsg = document.getElementById('errorMsg');
        const successMsg = document.getElementById('successMsg');
        const submitBtn = document.getElementById('submitBtn');

        function showError(message) {
            errorMsg.textContent = message;
            errorMsg.style.display = 'block';
            successMsg.style.display = 'none';
            // 错误提示3秒后自动隐藏（原5秒太长，优化体验）
            setTimeout(() => {
                errorMsg.style.display = 'none';
            }, 3000);
        }

        function showSuccess(message) {
            successMsg.textContent = message;
            successMsg.style.display = 'block';
            errorMsg.style.display = 'none';
        }

        function hideMessages() {
            errorMsg.style.display = 'none';
            successMsg.style.display = 'none';
        }

        function validateField(field) {
            const value = field.value.trim();
            let isValid = true;
            let errorMessage = '';

            field.classList.remove('input-error');

            switch(field.id) {
                case 'username':
                    // 新增用户名特殊字符限制（仅允许字母、数字、下划线）
                    const usernameRegex = /^[a-zA-Z0-9_]+$/;
                    if (value.length < 3 || value.length > 20) {
                        isValid = false;
                        errorMessage = '用户名长度应为3-20位';
                    } else if (!usernameRegex.test(value)) {
                        isValid = false;
                        errorMessage = '用户名仅支持字母、数字、下划线';
                    }
                    break;
                case 'email':
                    // 优化邮箱正则（支持更多域名后缀）
                    const emailRegex = /^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/;
                    if (!emailRegex.test(value)) {
                        isValid = false;
                        errorMessage = '请输入有效的邮箱（如：xxx@xxx.com）';
                    }
                    break;
                case 'password':
                    if (value.length < 6) {
                        isValid = false;
                        errorMessage = '密码长度至少6位';
                    }
                    break;
                case 'confirmPassword':
                    const password = document.getElementById('password').value;
                    if (value !== password) {
                        isValid = false;
                        errorMessage = '两次输入的密码不一致，请重新确认';
                    }
                    break;
            }

            if (!isValid && value.length > 0) {
                field.classList.add('input-error');
                showError(errorMessage);
            }

            return isValid;
        }

        function validateForm() {
            const username = document.getElementById('username').value.trim();
            const email = document.getElementById('email').value.trim();
            const password = document.getElementById('password').value;
            const confirmPassword = document.getElementById('confirmPassword').value;

            let isFormValid = true;
            hideMessages(); // 先隐藏所有提示，避免重复显示
            
            // 用户名验证
            if (!username) {
                showError('请输入用户名');
                document.getElementById('username').classList.add('input-error');
                isFormValid = false;
            } else if (!validateField(document.getElementById('username'))) {
                isFormValid = false;
            }
            
            // 邮箱验证
            if (!email) {
                showError('请输入邮箱地址');
                document.getElementById('email').classList.add('input-error');
                isFormValid = false;
            } else if (!validateField(document.getElementById('email'))) {
                isFormValid = false;
            }
            
            // 密码验证
            if (!password) {
                showError('请设置密码');
                document.getElementById('password').classList.add('input-error');
                isFormValid = false;
            } else if (!validateField(document.getElementById('password'))) {
                isFormValid = false;
            }
            
            // 确认密码验证
            if (!confirmPassword) {
                showError('请确认密码');
                document.getElementById('confirmPassword').classList.add('input-error');
                isFormValid = false;
            } else if (!validateField(document.getElementById('confirmPassword'))) {
                isFormValid = false;
            }

            // 若表单无效，自动聚焦到第一个错误字段
            if (!isFormValid) {
                const firstErrorField = registerForm.querySelector('.input-error') || registerForm.querySelector('input[required]:empty');
                if (firstErrorField) firstErrorField.focus();
            }

            return isFormValid;
        }

        // 表单提交处理 - 完善异常处理和用户体验
        registerForm.addEventListener('submit', async function(event) {
            event.preventDefault();

            if (!validateForm()) {
                return;
            }
            
            // 获取表单数据
            const username = document.getElementById('username').value.trim();
            const email = document.getElementById('email').value.trim();
            const password = document.getElementById('password').value;
            const rememberMe = document.getElementById('rememberMe').checked;

            // 提交状态处理（防止重复点击）
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<span class="spinner"></span> 注册中...';

            try {
                // 发送注册请求（支持本地测试时的Mock逻辑）
                let response;
                // 本地开发时可替换为Mock接口，避免依赖后端
                const isLocalDev = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1' || /^192\.168\./.test(window.location.hostname);
                if (isLocalDev) {
                    // 本地Mock：模拟注册成功（实际项目需删除）
                    response = {
                        ok: true,
                        json: () => Promise.resolve({
                            username: username,
                            token: 'mock_token_' + Date.now(),
                            message: '注册成功'
                        })
                    };
                } else {
                    // 线上环境：调用真实后端接口                                                                                                           
                    response = await fetch('/.netlify/functions/register', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'User-Agent': navigator.userAgent, // 1. 新增：告诉Netlify这是移动端请求，避免拦截
                            'Access-Control-Request-Method': 'POST' // 2. 新增：提前声明请求方法，简化预检流程
                        },
                        body: JSON.stringify({ username, email, password }),
                        credentials: 'include', // 3. 新增：允许跨域携带凭证（Netlify函数需要这个参数才会响应）
                        signal: AbortSignal.timeout(10000)
                    });
                }

                const result = await response.json();

                if (response.ok) {
                    // 注册成功：存储用户信息
                    if (rememberMe) {
                        localStorage.setItem('rememberedUsername', username);
                    } else {
                        localStorage.removeItem('rememberedUsername');
                    }

                    // 存储用户凭证（与登录页保持一致的格式，便于统一管理）
                    const currentUser = {
                        username: result.username,
                        email: email,
                        token: result.token,
                        loginTime: new Date().getTime(),
                        isAdmin: false // 初始默认非管理员，后端可覆盖
                    };
                    localStorage.setItem('mainUserInfo', JSON.stringify(currentUser));

                    // 提示并跳转（优化跳转逻辑：携带用户名参数）
                    showSuccess('注册成功！3秒后跳转到登录页...');
                    setTimeout(() => {
                        window.location.href = `indexlo.html?username=${encodeURIComponent(username)}&from=register`;
                    }, 3000);
                } else {
                    // 后端返回错误（细分错误类型）
                    const errorMsg = result.error || '注册失败，请稍后重试';
                    if (response.status === 409) {
                        // 409冲突：用户名/邮箱已存在
                        showError(`该${result.duplicateField === 'username' ? '用户名' : '邮箱'}已被注册，请更换`);
                    } else if (response.status === 400) {
                        // 400参数错误：后端验证不通过
                        showError(`参数错误：${errorMsg}`);
                    } else if (response.status === 500) {
                        // 500服务器错误：友好提示
                        showError('服务器暂时无法处理，请10分钟后再试');
                    } else {
                        showError(errorMsg);
                    }
                }
            } catch (error) {
                // 捕获网络错误/超时错误
                if (error.name === 'TimeoutError') {
                    showError('请求超时，请检查网络后重试');
                } else if (error.name === 'TypeError') {
                    showError('网络连接错误，请确保网络正常');
                } else {
                    showError('注册过程出错：' + error.message);
                }
                console.error('注册请求异常：', error);
            } finally {
                // 恢复按钮状态（无论成功/失败）
                submitBtn.disabled = false;
                submitBtn.innerHTML = '注册账号';
            }
        });

        // 登录链接跳转（增加来源标识，便于登录页优化体验）
        document.getElementById('loginLink').addEventListener('click', function(event) {
            event.preventDefault();
            const username = document.getElementById('username').value.trim();
            // 若已输入用户名，跳转时携带用户名参数（免重复输入）
            const targetUrl = username 
                ? `indexlo.html?username=${encodeURIComponent(username)}&from=register` 
                : 'indexlo.html';
            window.location.href = targetUrl;
        });

        // 新增：回车键提交表单（优化键盘操作体验）
        registerForm.addEventListener('keydown', function(event) {
            if (event.key === 'Enter' && !event.target.closest('button')) {
                event.preventDefault();
                // 聚焦到下一个必填字段，最后一个字段则提交
                const inputs = Array.from(registerForm.querySelectorAll('input[required]'));
                const currentIndex = inputs.findIndex(input => input === document.activeElement);
                if (currentIndex < inputs.length - 1) {
                    inputs[currentIndex + 1].focus();
                } else {
                    submitBtn.click();
                }
            }
        });
    </script>
</body>
</html>