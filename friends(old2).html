<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>好友列表 - 多功能导航中心</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* 基础样式继承主页面风格 */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: #f0f4f8;
            color: #333;
            min-height: 100vh;
            padding: 0;
            line-height: 1.6;
        }

        .navbar {
            width: 100%;
            background-color: #333;
            padding: 15px 20px;
            box-sizing: border-box;
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .navbar-title {
            color: white;
            font-size: 1.2em;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 10px;
            text-decoration: none;
        }

        .navbar-title i {
            font-size: 1.4em;
        }

        .user-area {
            display: flex;
            align-items: center;
            gap: 15px;
            color: white;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid white;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .user-avatar:hover {
            transform: scale(1.1);
            box-shadow: 0 0 10px rgba(255,255,255,0.3);
        }

        .username {
            white-space: nowrap;
            font-weight: 500;
        }

        .logout-btn {
            background: #555;
            border: none;
            color: white;
            padding: 5px 10px;
            border-radius: 3px;
            cursor: pointer;
            transition: background 0.2s, transform 0.2s;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .logout-btn:hover {
            background: #777;
            transform: translateY(-2px);
        }

        .login-link {
            color: white;
            text-decoration: none;
            transition: color 0.2s;
        }

        .login-link:hover {
            text-decoration: underline;
            color: #3498db;
        }

        .title-badge {
            background: linear-gradient(135deg, #3498db, #9b59b6);
            color: white;
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 0.8rem;
            margin-left: 10px;
            white-space: nowrap;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }

        header {
            text-align: center;
            margin-bottom: 40px;
            padding: 0 20px;
        }

        h1 {
            color: #2c3e50;
            margin-bottom: 10px;
            font-size: 2.2rem;
            position: relative;
            display: inline-block;
        }

        h1::after {
            content: '';
            position: absolute;
            bottom: -8px;
            left: 10%;
            width: 80%;
            height: 3px;
            background-color: #3498db;
            border-radius: 3px;
        }

        .subtitle {
            color: #667580;
            font-size: 1.1rem;
            max-width: 600px;
            margin: 0 auto;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 0 20px;
        }

        .tabs {
            display: flex;
            background-color: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            margin-bottom: 30px;
        }

        .tab {
            flex: 1;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
            color: #7f8c8d;
            border-bottom: 3px solid transparent;
        }

        .tab.active {
            color: #3498db;
            border-bottom: 3px solid #3498db;
        }

        .tab:hover:not(.active) {
            background-color: #f8f9fa;
            color: #2c3e50;
        }

        .tab i {
            margin-right: 8px;
        }

        .search-bar {
            display: flex;
            margin-bottom: 20px;
        }

        .search-input {
            flex: 1;
            padding: 12px 15px;
            border: 1px solid #ddd;
            border-radius: 6px 0 0 6px;
            font-size: 1rem;
            transition: border 0.3s ease;
        }

        .search-input:focus {
            outline: none;
            border-color: #3498db;
        }

        .search-btn {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 0 20px;
            border-radius: 0 6px 6px 0;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }

        .search-btn:hover {
            background-color: #2980b9;
        }

        .add-friend-btn {
            background-color: #2ecc71;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 20px;
        }

        .add-friend-btn:hover {
            background-color: #27ae60;
            transform: translateY(-2px);
        }

        .friend-list {
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
            overflow: hidden;
        }

        .friend-item {
            display: flex;
            align-items: center;
            padding: 15px 20px;
            border-bottom: 1px solid #f1f1f1;
            transition: background-color 0.2s ease;
        }

        .friend-item:last-child {
            border-bottom: none;
        }

        .friend-item:hover {
            background-color: #f8f9fa;
        }

        .friend-avatar {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            object-fit: cover;
            margin-right: 15px;
            border: 2px solid #eee;
        }

        .friend-info {
            flex: 1;
        }

        .friend-name {
            font-weight: 600;
            font-size: 1.1rem;
            margin-bottom: 3px;
            color: #2c3e50;
        }

        .friend-status {
            font-size: 0.9rem;
            color: #7f8c8d;
        }

        .friend-actions {
            display: flex;
            gap: 10px;
        }

        .action-btn {
            background-color: #f1f5f9;
            border: none;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
            color: #64748b;
        }

        .action-btn:hover {
            background-color: #e2e8f0;
            transform: translateY(-2px);
        }

        .message-btn:hover {
            color: #3498db;
        }

        .remove-btn:hover {
            color: #e74c3c;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #94a3b8;
        }

        .empty-state i {
            font-size: 5rem;
            margin-bottom: 20px;
            color: #cbd5e1;
        }

        .empty-state h3 {
            margin-bottom: 10px;
            font-size: 1.5rem;
            color: #64748b;
        }

        .empty-state p {
            max-width: 400px;
            margin: 0 auto 20px;
        }

        footer {
            text-align: center;
            margin-top: 60px;
            color: #95a5a6;
            font-size: 0.9rem;
            padding: 20px 0;
            border-top: 1px solid #e1e8ed;
        }

        /* 模态框样式 */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .modal.active {
            opacity: 1;
        }

        .modal-content {
            background-color: white;
            padding: 30px;
            border-radius: 10px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            position: relative;
            transform: translateY(20px);
            transition: transform 0.3s ease;
        }

        .modal.active .modal-content {
            transform: translateY(0);
        }

        .close-modal {
            position: absolute;
            top: 15px;
            right: 20px;
            font-size: 1.5rem;
            cursor: pointer;
            color: #666;
            transition: color 0.2s, transform 0.2s;
        }

        .close-modal:hover {
            color: #e74c3c;
            transform: rotate(90deg);
        }

        .modal-title {
            text-align: center;
            margin-bottom: 25px;
            color: #2c3e50;
            font-size: 1.5rem;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #3498db;
        }

        .form-input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 1rem;
        }

        .form-input:focus {
            outline: none;
            border-color: #3498db;
        }

        .modal-btn {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1rem;
            width: 100%;
            transition: background-color 0.2s, transform 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
        }

        .modal-btn:hover {
            background-color: #2980b9;
            transform: translateY(-2px);
        }

        .cancel-btn {
            background-color: #95a5a6;
            margin-top: 10px;
        }

        .cancel-btn:hover {
            background-color: #7f8c8d;
        }

        /* 聊天窗口样式 */
        .chat-modal {
            max-width: 800px;
            width: 95%;
            max-height: 80vh;
            display: flex;
            flex-direction: column;
        }

        .chat-header {
            padding-bottom: 15px;
            margin-bottom: 15px;
            border-bottom: 1px solid #eee;
            display: flex;
            align-items: center;
        }

        .chat-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            margin-right: 15px;
        }

        .chat-name {
            font-weight: 600;
            font-size: 1.2rem;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
            margin-bottom: 20px;
            background-color: #f9fafb;
            border-radius: 8px;
            min-height: 300px;
        }

        .message {
            margin-bottom: 15px;
            max-width: 70%;
        }

        .message.received {
            margin-right: auto;
        }

        .message.sent {
            margin-left: auto;
        }

        .message-content {
            padding: 10px 15px;
            border-radius: 18px;
            position: relative;
        }

        .received .message-content {
            background-color: #e2e8f0;
            border-top-left-radius: 4px;
        }

        .sent .message-content {
            background-color: #3498db;
            color: white;
            border-top-right-radius: 4px;
        }

        .message-time {
            font-size: 0.75rem;
            color: #94a3b8;
            margin-top: 5px;
            text-align: right;
        }

        .message-status {
            font-size: 0.7rem;
            margin-left: 5px;
        }

        .chat-input-area {
            display: flex;
            gap: 10px;
        }

        .chat-input {
            flex: 1;
            padding: 12px 15px;
            border: 1px solid #ddd;
            border-radius: 25px;
            font-size: 1rem;
        }

        .send-btn {
            background-color: #3498db;
            color: white;
            border: none;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .send-btn:hover {
            background-color: #2980b9;
        }

        /* 通知组件 */
        .notification {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 15px 20px;
            background-color: #3498db;
            color: white;
            border-radius: 5px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.2);
            transform: translateX(120%);
            transition: transform 0.3s ease;
            z-index: 1000;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .notification.show {
            transform: translateX(0);
        }

        .notification.success {
            background-color: #2ecc71;
        }

        .notification.error {
            background-color: #e74c3c;
        }

        /* 个人信息模态框样式 */
        .profile-modal .modal-content {
            max-width: 500px;
        }

        .profile-title {
            text-align: center;
            margin-bottom: 25px;
            color: #2c3e50;
            font-size: 1.5rem;
        }

        .profile-section {
            margin-bottom: 20px;
        }

        .profile-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #3498db;
        }

        .profile-value {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 1rem;
            background-color: #f9f9f9;
        }

        .error-message {
            color: #dc3545;
            text-align: center;
            padding: 10px;
            margin: 10px 0;
            background-color: #f8d7da;
            border-radius: 5px;
            display: none;
        }

        /* 轮询状态指示器 */
        .poll-status {
            position: fixed;
            bottom: 20px;
            left: 20px;
            padding: 5px 10px;
            border-radius: 20px;
            background-color: rgba(0,0,0,0.7);
            color: white;
            font-size: 0.8rem;
            display: flex;
            align-items: center;
            gap: 5px;
            z-index: 999;
        }

        .poll-status .indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: #ccc;
        }

        .poll-status.active .indicator {
            background-color: #2ecc71;
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        @media (max-width: 768px) {
            h1 {
                font-size: 1.8rem;
            }

            .navbar-title {
                font-size: 1rem;
            }

            .username {
                display: none;
            }

            .user-area {
                gap: 10px;
            }
            
            .title-badge {
                display: none;
            }

            .friend-actions {
                gap: 5px;
            }

            .action-btn {
                width: 32px;
                height: 32px;
            }

            .message {
                max-width: 85%;
            }
        }

        @media (max-width: 480px) {
            .tabs {
                flex-direction: column;
            }

            .friend-item {
                flex-direction: column;
                align-items: flex-start;
            }

            .friend-avatar {
                margin-bottom: 10px;
            }

            .friend-actions {
                margin-top: 10px;
                align-self: flex-end;
            }

            .chat-modal {
                max-height: 90vh;
            }

            .chat-messages {
                min-height: 200px;
            }
        }
    </style>
</head>
<body>
    <!-- 导航栏（复用主页面样式） -->
    <div class="navbar">
        <a href="indexdaohang.html" class="navbar-title">
            <i class="fas fa-compass"></i>
            返回多功能导航中心 
        </a>
        <div class="user-area" id="userArea">
            <a href="indexlo.html" class="login-link">登录/注册</a>
        </div>
    </div>

    <header>
        <h1>好友列表</h1>
        <p class="subtitle">管理您的好友，随时保持联系</p>
    </header>

    <div class="error-message" id="errorMsg"></div>

    <div class="container">
        <div class="tabs">
            <div class="tab active" data-tab="friends">
                <i class="fas fa-user-friends"></i> 我的好友
            </div>
            <div class="tab" data-tab="requests">
                <i class="fas fa-user-plus"></i> 好友请求
                <span class="badge" id="requestCount">0</span>
            </div>
        </div>

        <button class="add-friend-btn" id="addFriendBtn">
            <i class="fas fa-plus"></i> 添加好友
        </button>

        <div class="search-bar">
            <input type="text" class="search-input" placeholder="搜索好友...">
            <button class="search-btn">
                <i class="fas fa-search"></i>
            </button>
        </div>

        <div class="friend-list" id="friendList">
            <!-- 好友列表内容将通过JavaScript动态生成 -->
            <div class="empty-state">
                <i class="fas fa-search"></i>
                <h3>暂无好友</h3>
                <p>添加好友，开始互动吧！</p>
                <button class="add-friend-btn">
                    <i class="fas fa-plus"></i> 添加第一个好友
                </button>
            </div>
        </div>
    </div>

    <!-- 轮询状态指示器 -->
    <div class="poll-status active" id="pollStatus">
        <span class="indicator"></span>
        <span id="pollStatusText">消息同步中</span>
    </div>

    <!-- 添加好友模态框 -->
    <div class="modal" id="addFriendModal">
        <div class="modal-content">
            <span class="close-modal" onclick="closeAddFriendModal()">&times;</span>
            <h2 class="modal-title">添加好友</h2>
            <div class="form-group">
                <label class="form-label">用户名</label>
                <input type="text" class="form-input" id="friendUsername" placeholder="请输入好友的用户名">
            </div>
            <div class="form-group">
                <label class="form-label">验证消息</label>
                <input type="text" class="form-input" id="friendMessage" placeholder="请输入验证消息（选填）" value="你好，我想添加你为好友">
            </div>
            <button class="modal-btn" onclick="sendFriendRequest()">
                <i class="fas fa-paper-plane"></i> 发送请求
            </button>
            <button class="modal-btn cancel-btn" onclick="closeAddFriendModal()">
                <i class="fas fa-times"></i> 取消
            </button>
        </div>
    </div>

    <!-- 聊天模态框 -->
    <div class="modal" id="chatModal">
        <div class="modal-content chat-modal">
            <span class="close-modal" onclick="closeChatModal()">&times;</span>
            <div class="chat-header">
                <img src="" alt="好友头像" class="chat-avatar" id="chatAvatar">
                <div>
                    <div class="chat-name" id="chatName"></div>
                    <div class="friend-status" id="chatStatus">在线</div>
                </div>
            </div>
            <div class="chat-messages" id="chatMessages">
                <!-- 聊天消息将通过JavaScript动态生成 -->
            </div>
            <div class="chat-input-area">
                <input type="text" class="chat-input" id="chatInput" placeholder="输入消息...">
                <button class="send-btn" onclick="sendMessage()">
                    <i class="fas fa-paper-plane"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- 个人信息模态框 -->
    <div class="modal profile-modal" id="profileModal">
        <div class="modal-content">
            <span class="close-modal" onclick="closeProfileModal()">&times;</span>
            <h2 class="profile-title">个人信息</h2>
            
            <div class="profile-section">
                <label class="profile-label">用户名</label>
                <div id="usernameDisplay" class="profile-value"></div>
            </div>
            
            <div class="profile-section">
                <label class="profile-label">登录时间</label>
                <div id="loginTimeDisplay" class="profile-value"></div>
            </div>
            
            <div class="profile-section">
                <label class="profile-label">账号状态</label>
                <div id="accountStatus" class="profile-value">正常</div>
            </div>
        </div>
    </div>

    <!-- 通知组件 -->
    <div class="notification" id="notification">
        <i class="fas fa-info-circle"></i>
        <span id="notificationText"></span>
    </div>

    <footer>
        <p>多功能导航中心 &copy; 2025 | 持续更新中</p>
    </footer>

    <script>
        // 当前聊天对象
        let currentChatFriend = null;
        // 轮询相关变量
        let pollInterval;
        let lastMessageTime = new Date().toISOString();
        let pollActive = true;
        let pollRetryCount = 0;
        const MAX_RETRY_COUNT = 5;
        const BASE_POLL_INTERVAL = 3000; // 基础轮询间隔3秒
        
        // 当前用户信息
        let currentUser = null;

        // 页面加载时初始化
        window.onload = function() {
            // 复用主页面的用户验证逻辑
            checkLoginStatus();
            
            // 初始化事件监听
            initEventListeners();
            
            // 如果用户已登录，加载好友列表并初始化轮询
            if (currentUser) {
                loadFriends();
                initPolling();
            }
            
            // 监听页面可见性变化，优化轮询
            document.addEventListener('visibilitychange', handleVisibilityChange);
        };

        // 复用主页面的用户验证逻辑
        function checkLoginStatus() {
            const userInfoStr = localStorage.getItem('mainUserInfo');
            console.log("读取到的用户信息：", userInfoStr);
            
            if (!userInfoStr) {
                handleUnauthorizedAccess();
                return false;
            }
            
            try {
                let userInfo;
                try {
                    userInfo = JSON.parse(userInfoStr);
                } catch (parseError) {
                    console.error("用户信息解析失败：", parseError);
                    throw new Error("用户信息格式错误，请重新登录");
                }
        
                // 验证必要字段
                const requiredFields = ['username', 'loginTime'];
                const missingFields = requiredFields.filter(field => !userInfo[field]);
        
                if (missingFields.length > 0) {
                    if (missingFields.includes('username')) {
                        throw new Error("用户身份信息不完整，缺少用户名，请重新登录");
                    } else {
                        throw new Error(`用户信息不完整，缺少: ${missingFields.join(', ')}，请重新登录`);
                    }
                }
        
                // 验证登录时间是否有效（1天内）
                const loginTime = new Date(userInfo.loginTime);
                if (isNaN(loginTime.getTime())) {
                    throw new Error("登录时间格式无效，请重新登录");
                }
        
                const oneDayAgo = new Date();
                oneDayAgo.setDate(oneDayAgo.getDate() - 1);
                if (loginTime < oneDayAgo) {
                    throw new Error("登录已超过1天，请重新登录");
                }
        
                // 保存当前用户信息
                currentUser = userInfo;
                
                // 更新用户显示
                updateUserDisplay(userInfo);
                
                // 验证用户有效性
                checkUserValidity(userInfo);
                
                return true;
            } catch (err) {
                console.error("用户信息验证失败：", err);
                localStorage.removeItem('mainUserInfo');
                handleUnauthorizedAccess(err.message);
                return false;
            }
        }

        // 复用主页面的用户有效性检查
        async function checkUserValidity(userInfo) {
            const isLocalDev = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';
            
            if (isLocalDev) {
                console.log('本地开发模式，跳过用户验证');
                return;
            }
            
            try {
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 10000);
        
                const response = await fetch('/.netlify/functions/verifyUser', {
                    method: 'POST',
                    headers: {
                        'X-Username': userInfo.username,
                        'Content-Type': 'application/json'
                    },
                    signal: controller.signal
                });
        
                clearTimeout(timeoutId);
        
                if (!response.ok) {
                    if (response.status === 401) {
                        throw new Error('用户身份已失效，请重新登录');
                    }
                    throw new Error(`验证失败: ${response.statusText}`);
                }
        
                const result = await response.json();
                if (result.valid) {
                    // 更新登录时间
                    userInfo.loginTime = new Date().toISOString();
                    localStorage.setItem('mainUserInfo', JSON.stringify(userInfo));
                    currentUser = userInfo;
                }
            } catch (error) {
                console.error('用户验证失败:', error);
                if (error.name !== 'AbortError') {
                    showNotification(error.message, 'error');
                    setTimeout(() => {
                        if (confirm('登录状态已失效，是否重新登录？')) {
                            localStorage.removeItem('mainUserInfo');
                            window.location.href = 'indexlo.html?sessionExpired=true';
                        }
                    }, 3000);
                }
            }
        }

        // 复用主页面的用户信息显示
        function updateUserDisplay(userInfo) {
            const userAreaEl = document.getElementById('userArea');
            const avatarUrl = userInfo.avatar || 'https://picsum.photos/200';
            
            const loginTime = new Date(userInfo.loginTime);
            const formattedTime = loginTime.toLocaleString();
            
            let titleBadge = '';
            if (userInfo.currentTitle) {
                titleBadge = `<span class="title-badge">
                    <i class="fas fa-${userInfo.currentTitle.icon || 'medal'}"></i>
                    ${userInfo.currentTitle.name}
                </span>`;
            }
            
            // 更新导航栏用户信息
            userAreaEl.innerHTML = `
                <span class="username">${decodeURIComponent(userInfo.username)}</span>
                ${titleBadge}
                <img src="${avatarUrl}" alt="用户头像" class="user-avatar" onclick="openProfileModal()">
                <button class="logout-btn" onclick="logout()">
                    <i class="fas fa-sign-out-alt"></i> 退出
                </button>
            `;
            
            // 更新个人信息模态框
            document.getElementById('usernameDisplay').textContent = decodeURIComponent(userInfo.username);
            document.getElementById('loginTimeDisplay').textContent = formattedTime;
        }

        // 初始化事件监听
        function initEventListeners() {
            // 标签切换
            const tabs = document.querySelectorAll('.tab');
            tabs.forEach(tab => {
                tab.addEventListener('click', function() {
                    tabs.forEach(t => t.classList.remove('active'));
                    this.classList.add('active');
                    
                    const tabType = this.getAttribute('data-tab');
                    if (tabType === 'friends') {
                        loadFriends();
                    } else {
                        loadFriendRequests();
                    }
                });
            });
            
            // 添加好友按钮
            document.getElementById('addFriendBtn').addEventListener('click', openAddFriendModal);
            
            // 聊天输入框回车发送
            document.getElementById('chatInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    sendMessage();
                }
            });
        }

        // 初始化轮询机制
        function initPolling() {
            if (!currentUser) return;
            
            // 清除可能存在的旧轮询
            if (pollInterval) {
                clearInterval(pollInterval);
            }
            
            // 立即执行一次检查
            checkForNewMessages();
            
            // 设置轮询定时器
            pollInterval = setInterval(checkForNewMessages, BASE_POLL_INTERVAL);
            pollActive = true;
            pollRetryCount = 0;
            
            updatePollStatus(true, "消息同步中");
            showNotification("消息功能已启动（轮询模式）", "success");
        }

        // 检查新消息
        async function checkForNewMessages() {
            if (!currentUser || !pollActive) return;
            
            try {
                updatePollStatus(true, "正在同步...");
                
                // 构建请求URL，包含最后一条消息的时间戳以获取增量更新
                const url = `/api/messages?username=${encodeURIComponent(currentUser.username)}&since=${encodeURIComponent(lastMessageTime)}`;
                
                // 设置请求超时（5秒）
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 5000);
                
                const response = await fetch(url, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${currentUser.token}`,
                        'Content-Type': 'application/json'
                    },
                    signal: controller.signal
                });
                
                clearTimeout(timeoutId);
                
                if (response.ok) {
                    // 重置重试计数器
                    pollRetryCount = 0;
                    
                    const data = await response.json();
                    if (data.messages && data.messages.length > 0) {
                        // 更新最后消息时间
                        lastMessageTime = new Date().toISOString();
                        
                        // 处理每条新消息
                        data.messages.forEach(msg => handleMessage(msg));
                    }
                    
                    updatePollStatus(true, "消息同步中");
                } else {
                    handlePollError(`服务器错误: ${response.status}`);
                }
            } catch (error) {
                if (error.name === 'AbortError') {
                    handlePollError("请求超时");
                } else {
                    handlePollError(`获取消息失败: ${error.message}`);
                }
            }
        }

        // 处理轮询错误
        function handlePollError(errorMessage) {
            console.error("轮询错误:", errorMessage);
            pollRetryCount++;
            
            // 更新状态显示
            updatePollStatus(false, `同步失败 (${pollRetryCount}/${MAX_RETRY_COUNT})`);
            
            // 显示错误通知
            if (pollRetryCount === 1 || pollRetryCount % 3 === 0) {
                showNotification(`消息同步失败: ${errorMessage}`, "error");
            }
            
            // 如果达到最大重试次数，尝试重新初始化轮询
            if (pollRetryCount >= MAX_RETRY_COUNT) {
                showNotification("多次同步失败，尝试重新连接...", "error");
                
                // 清除现有轮询
                if (pollInterval) {
                    clearInterval(pollInterval);
                }
                
                // 5秒后重新初始化
                setTimeout(initPolling, 5000);
            }
        }

        // 更新轮询状态指示器
        function updatePollStatus(isActive, message) {
            const pollStatusEl = document.getElementById('pollStatus');
            const pollStatusTextEl = document.getElementById('pollStatusText');
            
            if (isActive) {
                pollStatusEl.classList.add('active');
                pollStatusEl.classList.remove('error');
            } else {
                pollStatusEl.classList.remove('active');
                pollStatusEl.classList.add('error');
            }
            
            pollStatusTextEl.textContent = message;
        }

        // 处理页面可见性变化
        function handleVisibilityChange() {
            if (document.hidden) {
                // 页面不可见时，延长轮询间隔
                if (pollInterval) {
                    clearInterval(pollInterval);
                    pollInterval = setInterval(checkForNewMessages, BASE_POLL_INTERVAL * 3); // 延长到3倍
                    updatePollStatus(true, "后台同步中");
                }
            } else {
                // 页面可见时，恢复正常轮询间隔
                if (pollInterval) {
                    clearInterval(pollInterval);
                    pollInterval = setInterval(checkForNewMessages, BASE_POLL_INTERVAL);
                    updatePollStatus(true, "消息同步中");
                    
                    // 立即检查一次新消息
                    checkForNewMessages();
                }
            }
        }

        // 处理接收到的消息
        function handleMessage(data) {
            console.log('收到消息:', data);
            
            switch (data.type) {
                case 'message':
                    // 收到新消息
                    addMessageToChat(data.sender, data.content, new Date(data.timestamp), data.sender !== currentUser.username);
                    
                    // 如果聊天窗口未打开，显示通知
                    if (!document.getElementById('chatModal').classList.contains('active') || currentChatFriend !== data.sender) {
                        showNotification(`收到来自 ${data.sender} 的消息: ${data.content}`, 'info');
                    }
                    break;
                    
                case 'friendRequest':
                    // 收到好友请求
                    showNotification(`收到来自 ${data.sender} 的好友请求`, 'info');
                    loadFriendRequests(); // 刷新请求列表
                    break;
                    
                case 'requestAccepted':
                    // 好友请求被接受
                    showNotification(`${data.sender} 接受了你的好友请求`, 'success');
                    loadFriends(); // 刷新好友列表
                    break;
                    
                case 'status':
                    // 状态更新
                    updateFriendStatus(data.username, data.status);
                    break;
                    
                case 'error':
                    // 错误消息
                    showNotification(`服务器错误: ${data.message}`, 'error');
                    break;
            }
        }

        // 加载好友列表
        function loadFriends() {
            if (!currentUser) return;
            
            // 从本地存储获取好友列表（实际应用中应从服务器获取）
            const uniqueKey = `friends_${currentUser.username}`;
            const friends = JSON.parse(localStorage.getItem(uniqueKey) || '[]');
            
            const friendListEl = document.getElementById('friendList');
            
            if (friends.length === 0) {
                friendListEl.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-search"></i>
                        <h3>暂无好友</h3>
                        <p>添加好友，开始互动吧！</p>
                        <button class="add-friend-btn" onclick="openAddFriendModal()">
                            <i class="fas fa-plus"></i> 添加第一个好友
                        </button>
                    </div>
                `;
                return;
            }
            
            // 生成好友列表HTML
            let friendsHTML = '';
            friends.forEach(friend => {
                friendsHTML += `
                    <div class="friend-item">
                        <img src="${friend.avatar || 'https://picsum.photos/200?random=' + friend.username}" alt="${friend.username}" class="friend-avatar">
                        <div class="friend-info">
                            <div class="friend-name">${friend.username}</div>
                            <div class="friend-status ${friend.status === 'online' ? 'text-success' : ''}">
                                ${friend.status === 'online' ? '<i class="fas fa-circle"></i> 在线' : '<i class="fas fa-circle"></i> 离线'}
                            </div>
                        </div>
                        <div class="friend-actions">
                            <button class="action-btn message-btn" onclick="openChatModal('${friend.username}', '${friend.avatar || ''}')">
                                <i class="fas fa-comment"></i>
                            </button>
                            <button class="action-btn remove-btn" onclick="removeFriend('${friend.username}')">
                                <i class="fas fa-user-minus"></i>
                            </button>
                        </div>
                    </div>
                `;
            });
            
            friendListEl.innerHTML = friendsHTML;
        }

        // 加载好友请求
        function loadFriendRequests() {
            if (!currentUser) return;
            
            // 从本地存储获取好友请求（实际应用中应从服务器获取）
            const uniqueKey = `friendRequests_${currentUser.username}`;
            const requests = JSON.parse(localStorage.getItem(uniqueKey) || '[]');
            
            const friendListEl = document.getElementById('friendList');
            const requestCountEl = document.getElementById('requestCount');
            
            // 更新请求数量
            requestCountEl.textContent = requests.length;
            
            if (requests.length === 0) {
                friendListEl.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-envelope-open"></i>
                        <h3>暂无好友请求</h3>
                        <p>当有新的好友请求时，会显示在这里</p>
                    </div>
                `;
                return;
            }
            
            // 生成请求列表HTML
            let requestsHTML = '';
            requests.forEach(request => {
                requestsHTML += `
                    <div class="friend-item">
                        <img src="${request.avatar || 'https://picsum.photos/200?random=' + request.username}" alt="${request.username}" class="friend-avatar">
                        <div class="friend-info">
                            <div class="friend-name">${request.username}</div>
                            <div class="friend-status">${request.message || '想添加你为好友'}</div>
                        </div>
                        <div class="friend-actions">
                            <button class="action-btn message-btn" onclick="acceptFriendRequest('${request.username}', '${request.avatar || ''}')">
                                <i class="fas fa-check"></i>
                            </button>
                            <button class="action-btn remove-btn" onclick="declineFriendRequest('${request.username}')">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>
                `;
            });
            
            friendListEl.innerHTML = requestsHTML;
        }

        // 发送好友请求
        function sendFriendRequest() {
            if (!currentUser) return;
            
            const friendUsername = document.getElementById('friendUsername').value.trim();
            const message = document.getElementById('friendMessage').value.trim() || '你好，我想添加你为好友';
            
            if (!friendUsername) {
                showNotification('请输入好友用户名', 'error');
                return;
            }
            
            if (friendUsername === currentUser.username) {
                showNotification('不能添加自己为好友', 'error');
                return;
            }
            
            // 检查是否已经是好友
            const friendsKey = `friends_${currentUser.username}`;
            const friends = JSON.parse(localStorage.getItem(friendsKey) || '[]');
            const isAlreadyFriend = friends.some(f => f.username === friendUsername);
            
            if (isAlreadyFriend) {
                showNotification('该用户已经是你的好友', 'error');
                closeAddFriendModal();
                return;
            }
            
            // 检查是否已经发送过请求
            const recipientRequestsKey = `friendRequests_${friendUsername}`;
            const recipientRequests = JSON.parse(localStorage.getItem(recipientRequestsKey) || '[]');
            const requestExists = recipientRequests.some(r => r.username === currentUser.username);
            
            if (requestExists) {
                showNotification('已经向该用户发送过好友请求', 'error');
                return;
            }
            
            // 构建请求数据
            const requestData = {
                username: currentUser.username,
                avatar: currentUser.avatar,
                message: message,
                timestamp: new Date().toISOString()
            };
            
            // 发送请求到服务器
            sendFriendRequestToServer(friendUsername, requestData)
                .then(success => {
                    if (success) {
                        // 本地保存请求（作为备份）
                        recipientRequests.push(requestData);
                        localStorage.setItem(recipientRequestsKey, JSON.stringify(recipientRequests));
                        
                        showNotification('好友请求已发送', 'success');
                        closeAddFriendModal();
                        
                        // 清空输入框
                        document.getElementById('friendUsername').value = '';
                        document.getElementById('friendMessage').value = '你好，我想添加你为好友';
                    }
                });
        }

        // 发送好友请求到服务器
        async function sendFriendRequestToServer(recipient, requestData) {
            try {
                const response = await fetch('/api/sendFriendRequest', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${currentUser.token}`
                    },
                    body: JSON.stringify({
                        recipient: recipient,
                        requestData: requestData
                    })
                });
                
                if (response.ok) {
                    return true;
                } else {
                    const error = await response.text();
                    showNotification(`发送请求失败: ${error}`, 'error');
                    return false;
                }
            } catch (error) {
                console.error("发送好友请求失败:", error);
                showNotification("发送请求失败，请检查网络连接", 'error');
                
                // 在本地模拟成功，以便在离线环境下也能使用
                return true;
            }
        }

        // 接受好友请求
        function acceptFriendRequest(username, avatar) {
            if (!currentUser) return;
            
            // 发送接受请求到服务器
            acceptFriendRequestOnServer(username)
                .then(success => {
                    if (success) {
                        // 从请求列表中移除
                        const requestsKey = `friendRequests_${currentUser.username}`;
                        let requests = JSON.parse(localStorage.getItem(requestsKey) || '[]');
                        requests = requests.filter(r => r.username !== username);
                        localStorage.setItem(requestsKey, JSON.stringify(requests));
                        
                        // 添加到好友列表
                        const myFriendsKey = `friends_${currentUser.username}`;
                        const myFriends = JSON.parse(localStorage.getItem(myFriendsKey) || '[]');
                        
                        // 检查是否已经在好友列表中
                        if (!myFriends.some(f => f.username === username)) {
                            myFriends.push({
                                username: username,
                                avatar: avatar,
                                status: 'offline',
                                addedTime: new Date().toISOString()
                            });
                            localStorage.setItem(myFriendsKey, JSON.stringify(myFriends));
                        }
                        
                        showNotification(`已添加 ${username} 为好友`, 'success');
                        loadFriendRequests();
                        loadFriends();
                    }
                });
        }

        // 在服务器上接受好友请求
        async function acceptFriendRequestOnServer(username) {
            try {
                const response = await fetch('/api/acceptFriendRequest', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${currentUser.token}`
                    },
                    body: JSON.stringify({
                        friendUsername: username
                    })
                });
                
                if (response.ok) {
                    return true;
                } else {
                    const error = await response.text();
                    showNotification(`操作失败: ${error}`, 'error');
                    return false;
                }
            } catch (error) {
                console.error("接受好友请求失败:", error);
                showNotification("操作失败，请检查网络连接", 'error');
                
                // 在本地模拟成功，以便在离线环境下也能使用
                return true;
            }
        }

        // 拒绝好友请求
        function declineFriendRequest(username) {
            if (!currentUser) return;
            
            // 发送拒绝请求到服务器
            declineFriendRequestOnServer(username)
                .then(success => {
                    if (success) {
                        // 从请求列表中移除
                        const requestsKey = `friendRequests_${currentUser.username}`;
                        let requests = JSON.parse(localStorage.getItem(requestsKey) || '[]');
                        requests = requests.filter(r => r.username !== username);
                        localStorage.setItem(requestsKey, JSON.stringify(requests));
                        
                        showNotification(`已拒绝 ${username} 的好友请求`, 'info');
                        loadFriendRequests();
                    }
                });
        }

        // 在服务器上拒绝好友请求
        async function declineFriendRequestOnServer(username) {
            try {
                const response = await fetch('/api/declineFriendRequest', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${currentUser.token}`
                    },
                    body: JSON.stringify({
                        friendUsername: username
                    })
                });
                
                if (response.ok) {
                    return true;
                } else {
                    const error = await response.text();
                    showNotification(`操作失败: ${error}`, 'error');
                    return false;
                }
            } catch (error) {
                console.error("拒绝好友请求失败:", error);
                showNotification("操作失败，请检查网络连接", 'error');
                
                // 在本地模拟成功，以便在离线环境下也能使用
                return true;
            }
        }

        // 移除好友
        function removeFriend(username) {
            if (!currentUser) return;
            
            if (!confirm(`确定要移除好友 ${username} 吗？`)) {
                return;
            }
            
            // 发送移除请求到服务器
            removeFriendOnServer(username)
                .then(success => {
                    if (success) {
                        // 从我的好友列表中移除
                        const myFriendsKey = `friends_${currentUser.username}`;
                        let myFriends = JSON.parse(localStorage.getItem(myFriendsKey) || '[]');
                        myFriends = myFriends.filter(f => f.username !== username);
                        localStorage.setItem(myFriendsKey, JSON.stringify(myFriends));
                        
                        // 如果正在和该好友聊天，关闭聊天窗口
                        if (currentChatFriend === username) {
                            closeChatModal();
                        }
                        
                        showNotification(`已移除好友 ${username}`, 'info');
                        loadFriends();
                    }
                });
        }

        // 在服务器上移除好友
        async function removeFriendOnServer(username) {
            try {
                const response = await fetch('/api/removeFriend', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${currentUser.token}`
                    },
                    body: JSON.stringify({
                        friendUsername: username
                    })
                });
                
                if (response.ok) {
                    return true;
                } else {
                    const error = await response.text();
                    showNotification(`操作失败: ${error}`, 'error');
                    return false;
                }
            } catch (error) {
                console.error("移除好友失败:", error);
                showNotification("操作失败，请检查网络连接", 'error');
                
                // 在本地模拟成功，以便在离线环境下也能使用
                return true;
            }
        }

        // 打开聊天窗口
        function openChatModal(friendUsername, friendAvatar) {
            if (!currentUser) return;
            
            currentChatFriend = friendUsername;
            
            // 更新聊天窗口信息
            document.getElementById('chatName').textContent = friendUsername;
            document.getElementById('chatAvatar').src = friendAvatar || `https://picsum.photos/200?random=${friendUsername}`;
            
            // 加载历史消息
            loadChatHistory(friendUsername);
            
            // 显示聊天窗口
            const modal = document.getElementById('chatModal');
            modal.style.display = 'flex';
            setTimeout(() => modal.classList.add('active'), 10);
            
            // 自动聚焦到输入框
            document.getElementById('chatInput').focus();
        }

        // 关闭聊天窗口
        function closeChatModal() {
            const modal = document.getElementById('chatModal');
            modal.classList.remove('active');
            setTimeout(() => modal.style.display = 'none', 300);
            currentChatFriend = null;
        }

        // 发送消息
        function sendMessage() {
            if (!currentUser || !currentChatFriend) return;
            
            const inputEl = document.getElementById('chatInput');
            const message = inputEl.value.trim();
            
            if (!message) {
                return;
            }
            
            const timestamp = new Date();
            const messageId = `msg_${Date.now()}`; // 生成临时消息ID
            
            // 先在本地显示消息，标记为"发送中"
            const tempMessageEl = addMessageToChat(
                currentUser.username, 
                message, 
                timestamp, 
                false, 
                true // 标记为发送中
            );
            
            // 发送消息到服务器
            sendMessageToServer(currentChatFriend, message, timestamp)
                .then(success => {
                    if (success) {
                        // 更新消息状态为"已发送"
                        if (tempMessageEl && tempMessageEl.querySelector('.message-status')) {
                            tempMessageEl.querySelector('.message-status').textContent = '✓';
                        }
                        
                        // 保存到本地历史记录
                        saveMessageToHistory(currentUser.username, currentChatFriend, message, timestamp);
                        inputEl.value = '';
                    } else {
                        // 更新消息状态为"发送失败"
                        if (tempMessageEl && tempMessageEl.querySelector('.message-status')) {
                            tempMessageEl.querySelector('.message-status').textContent = '✗';
                            tempMessageEl.querySelector('.message-status').style.color = '#e74c3c';
                        }
                        showNotification("消息发送失败，请重试", "error");
                    }
                });
        }

        // 发送消息到服务器
        async function sendMessageToServer(recipient, message, timestamp) {
            try {
                const response = await fetch('/api/sendMessage', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${currentUser.token}`
                    },
                    body: JSON.stringify({
                        sender: currentUser.username,
                        recipient: recipient,
                        content: message,
                        timestamp: timestamp.toISOString()
                    })
                });
                
                if (response.ok) {
                    return true;
                } else {
                    const error = await response.text();
                    console.error("发送消息失败:", error);
                    return false;
                }
            } catch (error) {
                console.error("发送消息出错:", error);
                return false;
            }
        }

        // 添加消息到聊天窗口
        function addMessageToChat(sender, content, timestamp, isReceived, isSending = false) {
            // 如果不是当前聊天对象的消息，不添加到窗口
            if (currentChatFriend && sender !== currentChatFriend && sender !== currentUser.username) {
                return null;
            }
            
            const chatMessagesEl = document.getElementById('chatMessages');
            const timeString = timestamp.toLocaleTimeString();
            
            // 消息状态指示（发送中/已发送/发送失败）
            const statusIndicator = isSending ? 
                '<span class="message-status">...</span>' : 
                '<span class="message-status">✓</span>';
            
            const messageHTML = `
                <div class="message ${isReceived ? 'received' : 'sent'}">
                    <div class="message-content">${content}</div>
                    <div class="message-time">
                        ${timeString}
                        ${!isReceived ? statusIndicator : ''}
                    </div>
                </div>
            `;
            
            chatMessagesEl.insertAdjacentHTML('beforeend', messageHTML);
            
            // 滚动到底部
            chatMessagesEl.scrollTop = chatMessagesEl.scrollHeight;
            
            // 返回刚创建的消息元素
            return chatMessagesEl.lastChild;
        }

        // 加载聊天历史
        function loadChatHistory(friendUsername) {
            if (!currentUser) return;
            
            const chatMessagesEl = document.getElementById('chatMessages');
            chatMessagesEl.innerHTML = ''; // 清空现有消息
            
            // 先从服务器加载历史消息
            loadChatHistoryFromServer(friendUsername)
                .then(messages => {
                    if (messages && messages.length > 0) {
                        // 服务器加载成功，显示服务器消息
                        messages.forEach(msg => {
                            addMessageToChat(
                                msg.sender,
                                msg.content,
                                new Date(msg.timestamp),
                                msg.sender !== currentUser.username
                            );
                        });
                        
                        // 更新最后消息时间
                        if (messages.length > 0) {
                            lastMessageTime = new Date(messages[messages.length - 1].timestamp).toISOString();
                        }
                    } else {
                        // 服务器加载失败或无消息，加载本地历史
                        const historyKey = `chatHistory_${currentUser.username}_${friendUsername}`;
                        const history = JSON.parse(localStorage.getItem(historyKey) || '[]');
                        
                        // 添加历史消息
                        history.forEach(msg => {
                            addMessageToChat(
                                msg.sender,
                                msg.content,
                                new Date(msg.timestamp),
                                msg.sender !== currentUser.username
                            );
                        });
                    }
                });
        }

        // 从服务器加载聊天历史
        async function loadChatHistoryFromServer(friendUsername) {
            try {
                const response = await fetch(`/api/chatHistory?with=${encodeURIComponent(friendUsername)}`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${currentUser.token}`
                    }
                });
                
                if (response.ok) {
                    return await response.json();
                }
            } catch (error) {
                console.error("加载聊天历史失败:", error);
            }
            
            return null;
        }

        // 保存消息到本地历史记录
        function saveMessageToHistory(sender, recipient, content, timestamp) {
            if (!currentUser) return;
            
            const historyKey = `chatHistory_${currentUser.username}_${recipient}`;
            const history = JSON.parse(localStorage.getItem(historyKey) || '[]');
            
            // 添加新消息
            history.push({
                sender: sender,
                content: content,
                timestamp: timestamp.toISOString()
            });
            
            // 限制历史记录数量（最多100条）
            if (history.length > 100) {
                history.splice(0, history.length - 100);
            }
            
            localStorage.setItem(historyKey, JSON.stringify(history));
        }

        // 更新好友状态
        function updateFriendStatus(username, status) {
            // 更新好友列表中的状态
            const friendItems = document.querySelectorAll('.friend-item');
            friendItems.forEach(item => {
                const friendNameEl = item.querySelector('.friend-name');
                if (friendNameEl && friendNameEl.textContent === username) {
                    const statusEl = item.querySelector('.friend-status');
                    if (statusEl) {
                        statusEl.innerHTML = status === 'online' 
                            ? '<i class="fas fa-circle"></i> 在线' 
                            : '<i class="fas fa-circle"></i> 离线';
                        statusEl.className = `friend-status ${status === 'online' ? 'text-success' : ''}`;
                    }
                }
            });
            
            // 更新聊天窗口中的状态
            if (currentChatFriend === username) {
                const chatStatusEl = document.getElementById('chatStatus');
                if (chatStatusEl) {
                    chatStatusEl.textContent = status === 'online' ? '在线' : '离线';
                }
            }
            
            // 更新本地存储中的状态
            const friendsKey = `friends_${currentUser.username}`;
            let friends = JSON.parse(localStorage.getItem(friendsKey) || '[]');
            friends = friends.map(friend => {
                if (friend.username === username) {
                    friend.status = status;
                }
                return friend;
            });
            localStorage.setItem(friendsKey, JSON.stringify(friends));
        }

        // 打开添加好友模态框
        function openAddFriendModal() {
            const modal = document.getElementById('addFriendModal');
            modal.style.display = 'flex';
            setTimeout(() => modal.classList.add('active'), 10);
            document.getElementById('friendUsername').focus();
        }

        // 关闭添加好友模态框
        function closeAddFriendModal() {
            const modal = document.getElementById('addFriendModal');
            modal.classList.remove('active');
            setTimeout(() => modal.style.display = 'none', 300);
        }

        // 打开个人信息模态框
        function openProfileModal() {
            const modal = document.getElementById('profileModal');
            modal.style.display = 'flex';
            setTimeout(() => modal.classList.add('active'), 10);
        }

        // 关闭个人信息模态框
        function closeProfileModal() {
            const modal = document.getElementById('profileModal');
            modal.classList.remove('active');
            setTimeout(() => modal.style.display = 'none', 300);
        }

        // 显示通知
        function showNotification(message, type = 'info') {
            const notification = document.getElementById('notification');
            const notificationText = document.getElementById('notificationText');
            
            notificationText.textContent = message;
            notification.className = 'notification';
            notification.classList.add(type);
            
            notification.classList.add('show');
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }

        // 退出登录
        function logout() {
            if (confirm('确定要退出登录吗？')) {
                // 停止轮询
                if (pollInterval) {
                    clearInterval(pollInterval);
                    pollActive = false;
                    updatePollStatus(false, "已停止");
                }
                
                localStorage.removeItem('mainUserInfo');
                window.location.href = 'indexlo.html';
            }
        }

        // 处理未授权访问
        function handleUnauthorizedAccess(errorMessage = "请先登录") {
            if (window.location.pathname.includes('indexlo.html')) {
                showNotification(errorMessage, 'error');
                return;
            }
    
            localStorage.setItem('redirectUrl', window.location.href);
    
            showNotification(errorMessage + '，即将跳转到登录页', 'error');
            setTimeout(() => {
                window.location.href = 'indexlo.html?needLogin=true';
            }, 2000);
        }

        // 页面关闭时清理
        window.onbeforeunload = function() {
            // 停止轮询
            if (pollInterval) {
                clearInterval(pollInterval);
            }
        };
    </script>
</body>
</html>