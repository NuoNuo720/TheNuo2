<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <!-- å¼ºåˆ¶æ¨ªå±æ˜¾ç¤º -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="screen-orientation" content="landscape">
    <meta name="full-screen" content="yes">
    <meta name="x5-fullscreen" content="true">
    <meta name="x5-orientation" content="landscape">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <title>è´¨å­VSç”µå­ | é‡å­è¿·å®«å¯¹å†³</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        /* ====== åŸºç¡€é‡ç½® ====== */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        /* ç¦æ­¢é¡µé¢æ»šåŠ¨ï¼Œå¼ºåˆ¶æ¨ªå± */
        html, body {
            overflow: hidden;
            width: 100%;
            height: 100%;
            position: fixed;
            touch-action: none;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            user-select: none;
            background: #0f172a;
        }
        
        /* å¼ºåˆ¶æ¨ªå±æç¤º */
        #orientationWarning {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #0f172a;
            z-index: 9999;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: white;
            text-align: center;
            padding: 2rem;
        }
        
        #orientationWarning.show {
            display: flex;
        }
        
        /* ====== é¢œè‰²å˜é‡ ====== */
        :root {
            --primary-blue: #3b82f6;
            --primary-red: #ef4444;
            --neon-cyan: #00f7ff;
            --dark-bg: #0f172a;
            --card-bg: #1e293b;
            --text-light: #e2e8f0;
            --text-dim: #94a3b8;
        }
        
        /* ====== ä¸»å®¹å™¨ ====== */
        #app {
            width: 100vw;
            height: 100vh;
            background: var(--dark-bg);
            color: var(--text-light);
            font-family: 'Segoe UI', system-ui, sans-serif;
            overflow: hidden;
        }
        
        /* æ¨ªå±æ ·å¼ä¼˜åŒ– */
        @media (orientation: landscape) {
            #app {
                min-height: 100vh;
            }
            
            /* æ¸¸æˆåœºæ™¯ç‰¹å®šæ ·å¼ */
            #gameScene {
                position: relative;
                width: 100vw;
                height: 100vh;
                background: #000;
            }
            
            #gameCanvas {
                width: 100% !important;
                height: 100% !important;
                object-fit: contain;
            }
        }
        
        /* ç«–å±è­¦å‘Š */
        @media (orientation: portrait) {
            #app {
                display: none;
            }
            
            #orientationWarning {
                display: flex;
            }
        }
        
        /* ====== åœºæ™¯åŸºç¡€æ ·å¼ ====== */
        .scene {
            width: 100%;
            height: 100%;
            position: absolute;
            top: 0;
            left: 0;
            display: none;
            overflow: hidden;
        }
        
        .active {
            display: block;
        }
        
        /* ====== ç§»åŠ¨è®¾å¤‡ä¼˜åŒ– ====== */
        @media (max-width: 768px), (max-height: 500px) {
            /* æ–‡å­—å¤§å°è°ƒæ•´ */
            .game-title {
                font-size: 2.2rem !important;
            }
            
            .game-subtitle {
                font-size: 0.95rem !important;
                padding: 0 1rem;
            }
            
            .logo {
                font-size: 2.8rem !important;
            }
            
            /* æŒ‰é’®å¤§å°è°ƒæ•´ */
            .btn {
                padding: 0.9rem 1.5rem !important;
                font-size: 1rem !important;
                min-width: 180px !important;
            }
            
            /* æ¸¸æˆå¤§å…å¡ç‰‡è°ƒæ•´ */
            #player1Card, #player2Card {
                min-width: 180px !important;
                padding: 1.5rem !important;
            }
            
            /* æ¸¸æˆUIè°ƒæ•´ */
            #gameUI {
                padding: 0.75rem !important;
            }
            
            /* å°åœ°å›¾ä½ç½®è°ƒæ•´ */
            #gameUI > div:has(#miniMapCanvas) {
                position: absolute !important;
                bottom: 140px !important;
                left: 10px !important;
                width: 120px !important;
                height: 120px !important;
                padding: 6px !important;
            }
            
            #miniMapCanvas {
                width: 108px !important;
                height: 108px !important;
            }
            
            /* æ§åˆ¶è¯´æ˜ä½ç½®è°ƒæ•´ */
            #gameUI > div:last-child {
                position: absolute !important;
                bottom: 140px !important;
                right: 10px !important;
                max-width: 200px !important;
                padding: 0.75rem !important;
            }
            
            /* æ‰‹æœºæ§åˆ¶æŒ‰é’®ä¼˜åŒ– */
            #mobileControls {
                padding: 1rem !important;
            }
            
            .mobile-btn {
                width: 65px !important;
                height: 65px !important;
                font-size: 1.6rem !important;
            }
            
            .mobile-btn.attack-btn {
                width: 90px !important;
                height: 90px !important;
                font-size: 2.2rem !important;
            }
        }
        
        /* è¶…å°å±å¹•ä¼˜åŒ– */
        @media (max-width: 360px) {
            .game-title {
                font-size: 1.8rem !important;
            }
            
            .btn {
                min-width: 160px !important;
            }
            
            .mobile-btn {
                width: 55px !important;
                height: 55px !important;
                font-size: 1.4rem !important;
            }
            
            .mobile-btn.attack-btn {
                width: 75px !important;
                height: 75px !important;
                font-size: 1.8rem !important;
            }
        }
        /* ====== 1. ä¸»èœå•åœºæ™¯ ====== */
        #menuScene {
            background: linear-gradient(135deg, 
                rgba(15, 23, 42, 0.95) 0%, 
                rgba(30, 41, 59, 0.9) 100%),
                url("data:image/svg+xml,%3Csvg width='100' height='100' viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M11 18c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm48 25c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm-43-7c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm63 31c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM34 90c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm56-76c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM12 86c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm28-65c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm23-11c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-6 60c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm29 22c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zM32 63c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm57-13c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-9-21c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM60 91c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM35 41c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM12 60c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2z' fill='%233b82f6' fill-opacity='0.05' fill-rule='evenodd'/%3E%3C/svg%3E");
        }
        
        .menu-header {
            text-align: center;
            padding: 2rem 1rem 1rem;
        }
        
        .logo {
            font-size: 3.5rem;
            margin-bottom: 0.5rem;
            background: linear-gradient(90deg, var(--primary-blue), var(--primary-red));
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            display: inline-block;
        }
        
        .game-title {
            font-size: 2.8rem;
            font-weight: 800;
            margin-bottom: 0.5rem;
            color: white;
            animation: textGlow 3s ease-in-out infinite alternate;
        }
        
        .game-subtitle {
            font-size: 1.1rem;
            color: var(--text-dim);
            max-width: 500px;
            margin: 0 auto 2rem;
            line-height: 1.6;
        }
        
        /* ====== æŒ‰é’®æ ·å¼ ====== */
        .btn {
            padding: 1rem 2rem;
            border: none;
            border-radius: 12px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            margin: 0.5rem;
            min-width: 200px;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, var(--primary-blue), #2563eb);
            color: white;
            box-shadow: 0 4px 15px rgba(59, 130, 246, 0.3);
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(59, 130, 246, 0.4);
        }
        
        .btn-primary:active {
            transform: translateY(0);
        }
        
        .btn-danger {
            background: linear-gradient(135deg, var(--primary-red), #dc2626);
            color: white;
            box-shadow: 0 4px 15px rgba(239, 68, 68, 0.3);
        }
        
        .btn-secondary {
            background: transparent;
            color: var(--primary-blue);
            border: 2px solid var(--primary-blue);
        }
        
        .btn-secondary:hover {
            background: rgba(59, 130, 246, 0.1);
        }
        
        .btn-primary, .btn-danger {
            position: relative;
            overflow: hidden;
        }

        .btn-primary::after, .btn-danger::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
            transform: translate(-50%, -50%);
            transition: width 0.3s, height 0.3s;
        }
        
        /* ====== èœå•å†…å®¹ ====== */
        .menu-content {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: calc(100% - 200px);
            padding: 1rem;
        }
        
        .btn-group {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 1rem;
            margin: 2rem 0;
        }
        
        .game-stats {
            display: flex;
            gap: 2rem;
            margin-top: 2rem;
            color: var(--text-dim);
            font-size: 0.9rem;
        }
        
        .stat-item {
            text-align: center;
        }
        
        .stat-value {
            display: block;
            font-size: 1.5rem;
            font-weight: bold;
            color: white;
            margin-top: 0.25rem;
        }
        
        /* ====== é¡µè„š ====== */
        .footer {
            position: absolute;
            bottom: 1rem;
            width: 100%;
            text-align: center;
            color: var(--text-dim);
            font-size: 0.85rem;
            padding: 0 1rem;
        }
        
        /* ====== åŠ¨ç”»å®šä¹‰ ====== */
        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.7; transform: scale(1.05); }
        }
        
        @keyframes searchingDot {
            0%, 100% { transform: scale(1); opacity: 0.3; }
            50% { transform: scale(1.2); opacity: 1; }
        }
        
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        
        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }
        
        @keyframes matchProgressBar {
            0%, 100% { width: 10%; }
            50% { width: 90%; }
        }
        
        @keyframes glow {
            0%, 100% { filter: drop-shadow(0 0 5px currentColor); }
            50% { filter: drop-shadow(0 0 20px currentColor); }
        }
        
        @keyframes slideIn {
            from { transform: translateY(50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        /* ====== æ–°å¢åŠ¨ç”» ====== */
        @keyframes textGlow {
            from {
                text-shadow: 0 0 10px rgba(59, 130, 246, 0.5),
                             0 0 20px rgba(59, 130, 246, 0.3);
            }
            to {
                text-shadow: 0 0 20px rgba(59, 130, 246, 0.8),
                             0 0 40px rgba(59, 130, 246, 0.5),
                             0 0 60px rgba(59, 130, 246, 0.3);
            }
        }

        @keyframes modulePulse {
            0% {
                transform: scale(1);
                box-shadow: 0 0 10px rgba(59, 130, 246, 0.3);
            }
            100% {
                transform: scale(1.05);
                box-shadow: 0 0 20px rgba(59, 130, 246, 0.5);
            }
        }
        
        /* ====== æ¸¸æˆç•Œé¢ç‰¹å®šæ ·å¼ ====== */
        .mobile-btn {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.15);
            border: 2px solid rgba(255, 255, 255, 0.3);
            color: white;
            font-size: 1.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.1s;
            user-select: none;
            touch-action: manipulation;
        }
        
        .mobile-btn:active {
            background: rgba(255, 255, 255, 0.25);
            transform: scale(0.95);
        }
        
        .attack-btn {
            background: rgba(239, 68, 68, 0.2);
            border-color: rgba(239, 68, 68, 0.5);
        }
        
        .attack-btn:active {
            background: rgba(239, 68, 68, 0.3);
        }
        
        /* è§¦æ‘¸è®¾å¤‡æ ·å¼ */
        @media (hover: none) and (pointer: coarse) {
            #mobileControls {
                display: flex !important;
            }
            
            .mobile-btn {
                width: 70px;
                height: 70px;
                font-size: 1.8rem;
            }
        }
    </style>
</head>
<body>
    <!-- æ¨ªå±æç¤º -->
    <div id="orientationWarning">
        <div style="font-size: 4rem; margin-bottom: 2rem;">ğŸ“±</div>
        <h1 style="font-size: 2rem; margin-bottom: 1rem; color: #3b82f6;">è¯·å°†è®¾å¤‡æ¨ªå±æ”¾ç½®</h1>
        <p style="color: #94a3b8; max-width: 300px; line-height: 1.6;">
            ä¸ºäº†è·å¾—æœ€ä½³æ¸¸æˆä½“éªŒï¼Œè¯·å°†æ‚¨çš„æ‰‹æœºæ—‹è½¬è‡³æ¨ªå±æ¨¡å¼ã€‚
            <br><br>
            æ¸¸æˆéœ€è¦æ›´å¤§çš„è§†é‡èŒƒå›´æ¥æ˜¾ç¤ºå®Œæ•´çš„è¿·å®«å’Œå¯¹æ‰‹ã€‚
        </p>
        <div style="margin-top: 3rem; animation: spin 2s infinite;">
            <div style="font-size: 3rem;">â†»</div>
        </div>
    </div>

    <div id="app">
        <!-- åœºæ™¯1: ä¸»èœå• -->
        <div id="menuScene" class="scene active">
            <div class="menu-header">
                <div class="logo">âš›ï¸</div>
                <h1 class="game-title">è´¨å­VSç”µå­</h1>
                <p class="game-subtitle">
                    åœ¨é‡å­è¿·å®«ä¸­å±•å¼€å¾®è§‚å¯¹å†³ï¼å‘å°„ç²’å­ï¼Œèº²é¿å¢™å£ï¼Œå‡»è´¥å¯¹æ‰‹ã€‚
                    å®æ—¶åŒ¹é…ï¼Œå…¬å¹³ç«æŠ€ï¼Œä½“éªŒç‰©ç†æˆ˜æ–—çš„ä¹è¶£ã€‚
                </p>
            </div>
            
            <div class="menu-content">
                <div class="btn-group">
                    <button id="matchBtn" class="btn btn-primary" onclick="startMatchmaking()">
                        <span>ğŸ®</span> å¼€å§‹åŒ¹é…
                    </button>
                    <button id="howToPlayBtn" class="btn btn-secondary" onclick="showHowToPlay()">
                        <span>â“</span> æ¸¸æˆè¯´æ˜
                    </button>
                </div>
                
                <div class="game-stats">
                    <div class="stat-item">
                        <span>åœ¨çº¿ç©å®¶</span>
                        <span class="stat-value" id="onlineCount">128</span>
                    </div>
                    <div class="stat-item">
                        <span>ä»Šæ—¥å¯¹æˆ˜</span>
                        <span class="stat-value" id="dailyMatches">892</span>
                    </div>
                    <div class="stat-item">
                        <span>åŒ¹é…é€Ÿåº¦</span>
                        <span class="stat-value" id="matchSpeed">3.2s</span>
                    </div>
                </div>
            </div>
            
            <div class="footer">
                <p>é‡å­è¿·å®«å¯¹å†³ v1.0 | â¥è‡ªç”±ç”µå­å¥½è¯„ | åŠçŒ«è¯ºä¸·åˆ¶ä½œ</p>
            </div>
        </div>
        <!-- åœºæ™¯2: åŒ¹é…ä¸­ -->
        <div id="matchingScene" class="scene">
            <div style="
                width: 100%;
                height: 100%;
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
                padding: 2rem;
                text-align: center;
            ">
                <div style="margin-bottom: 2rem;">
                    <div style="
                        font-size: 4rem;
                        margin-bottom: 1rem;
                        animation: pulse 1.5s infinite;
                    ">ğŸ”</div>
                    <h2 style="
                        font-size: 2rem;
                        margin-bottom: 0.5rem;
                        color: white;
                    ">å¯»æ‰¾å¯¹æ‰‹ä¸­</h2>
                    <p style="color: var(--text-dim); max-width: 400px; margin: 0 auto 2rem;">
                        æ­£åœ¨ä¸ºä½ å¯»æ‰¾å®åŠ›ç›¸å½“çš„å¯¹æ‰‹...
                        é‡å­ç½‘ç»œæ­£åœ¨æ‰«æå¯ç”¨ç©å®¶ã€‚
                    </p>
                </div>
                
                <div style="
                    background: rgba(30, 41, 59, 0.8);
                    border-radius: 16px;
                    padding: 2rem;
                    border: 1px solid rgba(59, 130, 246, 0.3);
                    max-width: 500px;
                    width: 100%;
                    margin-bottom: 2rem;
                ">
                    <div style="
                        display: flex;
                        justify-content: space-between;
                        margin-bottom: 1rem;
                        color: var(--text-dim);
                    ">
                        <span>åŒ¹é…æ—¶é—´</span>
                        <span id="matchTimer" style="color: white; font-weight: bold;">0</span>
                    </div>
                    
                    <div style="
                        height: 8px;
                        background: rgba(255, 255, 255, 0.1);
                        border-radius: 4px;
                        overflow: hidden;
                        margin-bottom: 1.5rem;
                    ">
                        <div id="matchProgress" style="
                            height: 100%;
                            width: 0%;
                            background: linear-gradient(90deg, var(--primary-blue), #60a5fa);
                            border-radius: 4px;
                            transition: width 0.3s;
                        "></div>
                    </div>
                    
                    <div style="
                        display: flex;
                        flex-wrap: wrap;
                        gap: 0.5rem;
                        justify-content: center;
                        margin-bottom: 1.5rem;
                    ">
                        <div style="
                            width: 12px;
                            height: 12px;
                            border-radius: 50%;
                            background: rgba(59, 130, 246, 0.3);
                            animation: searchingDot 1s infinite;
                        "></div>
                        <div style="
                            width: 12px;
                            height: 12px;
                            border-radius: 50%;
                            background: rgba(59, 130, 246, 0.5);
                            animation: searchingDot 1s infinite 0.2s;
                        "></div>
                        <div style="
                            width: 12px;
                            height: 12px;
                            border-radius: 50%;
                            background: rgba(59, 130, 246, 0.7);
                            animation: searchingDot 1s infinite 0.4s;
                        "></div>
                    </div>
                    
                    <p id="matchStatus" style="color: var(--text-dim); font-size: 0.9rem;">
                        æ‰«æç©å®¶... æ£€æŸ¥ç½‘ç»œå»¶è¿Ÿ... ä¼˜åŒ–åŒ¹é…...
                    </p>
                </div>
                
                <div style="
                    display: flex;
                    gap: 1rem;
                    flex-wrap: wrap;
                    justify-content: center;
                ">
                    <button onclick="cancelMatchmaking()" class="btn btn-danger">
                        <span>âŒ</span> å–æ¶ˆåŒ¹é…
                    </button>
                </div>
                
                <div style="
                    margin-top: 2rem;
                    color: var(--text-dim);
                    font-size: 0.85rem;
                    max-width: 400px;
                ">
                    <p>ğŸ’¡ åŒ¹é…æç¤ºï¼šé«˜å³°æ—¶æ®µåŒ¹é…æ›´å¿«ï¼Œä¿æŒç½‘ç»œç¨³å®š</p>
                </div>
            </div>
        </div>

        <!-- åœºæ™¯3: æ¸¸æˆå¤§å… -->
        <div id="lobbyScene" class="scene">
            <div style="
                width: 100%;
                height: 100%;
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
                padding: 2rem;
                text-align: center;
            ">
                <div style="margin-bottom: 2rem;">
                    <h2 style="
                        font-size: 2rem;
                        margin-bottom: 0.5rem;
                        color: white;
                    ">æ¸¸æˆå¤§å…</h2>
                    <p style="color: var(--text-dim); max-width: 500px; margin: 0 auto;">
                        å·²æ‰¾åˆ°å¯¹æ‰‹ï¼åŒæ–¹ç¡®è®¤å‡†å¤‡åï¼Œæ¸¸æˆå°†åœ¨5ç§’åå¼€å§‹ã€‚
                    </p>
                </div>
                
                <div style="
                    display: flex;
                    flex-wrap: wrap;
                    gap: 2rem;
                    justify-content: center;
                    margin-bottom: 3rem;
                    width: 100%;
                    max-width: 800px;
                ">
                    <!-- ç©å®¶1å¡ç‰‡ï¼ˆä½ ï¼‰ -->
                    <div id="player1Card" style="
                        flex: 1;
                        min-width: 250px;
                        background: rgba(30, 41, 59, 0.9);
                        border-radius: 16px;
                        padding: 2rem;
                        border: 2px solid var(--primary-blue);
                        backdrop-filter: blur(10px);
                    ">
                        <div style="
                            font-size: 3rem;
                            margin-bottom: 1rem;
                        ">âš›ï¸</div>
                        <h3 style="
                            font-size: 1.5rem;
                            margin-bottom: 0.5rem;
                            color: white;
                        " id="player1Role">è´¨å­</h3>
                        <p style="color: var(--text-dim); margin-bottom: 1rem;">
                            ç©å®¶ (ä½ )
                        </p>
                        
                        <div style="
                            margin: 1.5rem 0;
                            padding: 1rem;
                            background: rgba(59, 130, 246, 0.1);
                            border-radius: 8px;
                        ">
                            <div style="
                                display: flex;
                                align-items: center;
                                justify-content: center;
                                gap: 0.5rem;
                                margin-bottom: 0.5rem;
                            ">
                                <div id="player1StatusDot" style="
                                    width: 12px;
                                    height: 12px;
                                    border-radius: 50%;
                                    background: #64748b;
                                "></div>
                                <span id="player1StatusText">æœªå‡†å¤‡</span>
                            </div>
                            <button id="player1ReadyBtn" onclick="togglePlayerReady()" 
                                    style="
                                        padding: 0.75rem 2rem;
                                        background: var(--primary-blue);
                                        color: white;
                                        border: none;
                                        border-radius: 8px;
                                        font-weight: 600;
                                        cursor: pointer;
                                        width: 100%;
                                        transition: all 0.2s;
                                    "
                                    onmouseover="this.style.background='#2563eb'"
                                    onmouseout="this.style.background='var(--primary-blue)'">
                                ç‚¹å‡»å‡†å¤‡
                            </button>
                        </div>
                        
                        <div style="
                            color: var(--text-dim);
                            font-size: 0.9rem;
                            text-align: left;
                            margin-top: 1.5rem;
                        ">
                            <p>ğŸ’¡ è§’è‰²ç‰¹æ€§ï¼š</p>
                            <ul style="padding-left: 1rem; margin-top: 0.5rem;">
                                <li id="player1Trait1">å¸¦æ­£ç”µè·</li>
                                <li id="player1Trait2">è“è‰²ç²’å­</li>
                                <li id="player1Trait3">è´¨é‡è¾ƒå¤§</li>
                            </ul>
                        </div>
                    </div>
                    
                    <!-- VS æ ‡å¿— -->
                    <div style="
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        min-width: 100px;
                    ">
                        <div style="
                            font-size: 2.5rem;
                            color: var(--text-dim);
                            background: rgba(255, 255, 255, 0.05);
                            padding: 1rem;
                            border-radius: 50%;
                        ">âš¡</div>
                    </div>
                    
                    <!-- ç©å®¶2å¡ç‰‡ï¼ˆå¯¹æ‰‹ï¼‰ -->
                    <div id="player2Card" style="
                        flex: 1;
                        min-width: 250px;
                        background: rgba(30, 41, 59, 0.9);
                        border-radius: 16px;
                        padding: 2rem;
                        border: 2px solid var(--primary-red);
                        backdrop-filter: blur(10px);
                    ">
                        <div style="
                            font-size: 3rem;
                            margin-bottom: 1rem;
                        ">âš¡</div>
                        <h3 style="
                            font-size: 1.5rem;
                            margin-bottom: 0.5rem;
                            color: white;
                        " id="player2Role">ç”µå­</h3>
                        <p style="color: var(--text-dim); margin-bottom: 1rem;">
                            å¯¹æ‰‹
                        </p>
                        
                        <div style="
                            margin: 1.5rem 0;
                            padding: 1rem;
                            background: rgba(239, 68, 68, 0.1);
                            border-radius: 8px;
                        ">
                            <div style="
                                display: flex;
                                align-items: center;
                                justify-content: center;
                                gap: 0.5rem;
                                margin-bottom: 1rem;
                            ">
                                <div id="player2StatusDot" style="
                                    width: 12px;
                                    height: 12px;
                                    border-radius: 50%;
                                    background: #64748b;
                                "></div>
                                <span id="player2StatusText">ç­‰å¾…ä¸­</span>
                            </div>
                            <div style="
                                padding: 0.75rem;
                                background: rgba(239, 68, 68, 0.2);
                                border-radius: 8px;
                                color: var(--text-dim);
                            ">
                                <span id="opponentAction">ç­‰å¾…å¯¹æ‰‹å‡†å¤‡...</span>
                            </div>
                        </div>
                        
                        <div style="
                            color: var(--text-dim);
                            font-size: 0.9rem;
                            text-align: left;
                            margin-top: 1.5rem;
                        ">
                            <p>ğŸ’¡ è§’è‰²ç‰¹æ€§ï¼š</p>
                            <ul style="padding-left: 1rem; margin-top: 0.5rem;">
                                <li id="player2Trait1">å¸¦è´Ÿç”µè·</li>
                                <li id="player2Trait2">çº¢è‰²ç²’å­</li>
                                <li id="player2Trait3">è´¨é‡è¾ƒå°</li>
                            </ul>
                        </div>
                    </div>
                </div>
                
                <!-- å€’è®¡æ—¶æ˜¾ç¤º -->
                <div id="lobbyCountdown" style="
                    display: none;
                    background: linear-gradient(135deg, var(--primary-blue), var(--primary-red));
                    padding: 2rem 3rem;
                    border-radius: 16px;
                    margin-bottom: 2rem;
                    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
                ">
                    <div style="
                        font-size: 1.2rem;
                        margin-bottom: 1rem;
                        color: white;
                    ">æ¸¸æˆå³å°†å¼€å§‹</div>
                    <div id="countdownNumber" style="
                        font-size: 4rem;
                        font-weight: bold;
                        color: white;
                        animation: pulse 1s infinite;
                    ">5</div>
                </div>
                
                <!-- æ¸¸æˆæç¤º -->
                <div style="
                    max-width: 600px;
                    background: rgba(59, 130, 246, 0.1);
                    border-radius: 12px;
                    padding: 1.5rem;
                    margin-top: 2rem;
                    border: 1px solid rgba(59, 130, 246, 0.3);
                ">
                    <h4 style="color: white; margin-bottom: 0.5rem;">ğŸ® æ¸¸æˆå‡†å¤‡æç¤º</h4>
                    <p style="color: var(--text-dim); font-size: 0.95rem;">
                        ç¡®è®¤å‡†å¤‡åæ— æ³•å–æ¶ˆã€‚ç¡®ä¿ç½‘ç»œç¨³å®šï¼Œè°ƒæ•´å¥½è®¾å¤‡å§¿åŠ¿ã€‚
                        ç”µè„‘ç©å®¶ä½¿ç”¨é”®ç›˜æ§åˆ¶ï¼Œæ‰‹æœºç©å®¶ä½¿ç”¨å±å¹•æŒ‰é’®ã€‚
                    </p>
                </div>
            </div>
        </div>
        <!-- åœºæ™¯4: åŠ è½½ä¸­ -->
        <div id="loadingScene" class="scene">
            <div style="
                width: 100%;
                height: 100%;
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
                padding: 2rem;
                text-align: center;
                background: linear-gradient(135deg, 
                    rgba(15, 23, 42, 0.98) 0%, 
                    rgba(30, 41, 59, 0.95) 100%);
            ">
                <div style="margin-bottom: 3rem;">
                    <div style="
                        font-size: 4rem;
                        margin-bottom: 1rem;
                        animation: spin 2s linear infinite;
                    ">âš™ï¸</div>
                    <h2 style="
                        font-size: 2rem;
                        margin-bottom: 0.5rem;
                        color: white;
                    ">é‡å­æˆ˜åœºç”Ÿæˆä¸­</h2>
                    <p style="color: var(--text-dim); max-width: 400px; margin: 0 auto;">
                        æ­£åœ¨åˆ›å»ºè¿·å®«ï¼Œåˆå§‹åŒ–ç²’å­ç³»ç»Ÿï¼Œè¯·ç¨å€™...
                    </p>
                </div>
                
                <div style="
                    width: 100%;
                    max-width: 500px;
                    margin-bottom: 2rem;
                ">
                    <div style="
                        display: flex;
                        justify-content: space-between;
                        margin-bottom: 0.5rem;
                        color: var(--text-dim);
                    ">
                        <span id="loadingStep">åˆå§‹åŒ–æ¸¸æˆå¼•æ“</span>
                        <span id="loadingPercent">0%</span>
                    </div>
                    
                    <div style="
                        height: 12px;
                        background: rgba(255, 255, 255, 0.1);
                        border-radius: 6px;
                        overflow: hidden;
                        margin-bottom: 2rem;
                    ">
                        <div id="loadingBar" style="
                            height: 100%;
                            width: 0%;
                            background: linear-gradient(90deg, 
                                var(--primary-blue), 
                                var(--neon-cyan),
                                var(--primary-red));
                            border-radius: 6px;
                            transition: width 0.5s ease-out;
                        "></div>
                    </div>
                    
                    <div style="
                        display: grid;
                        grid-template-columns: repeat(4, 1fr);
                        gap: 0.5rem;
                        margin-bottom: 2rem;
                    ">
                        <div style="
                            padding: 1rem;
                            background: rgba(59, 130, 246, 0.1);
                            border-radius: 8px;
                            border: 1px solid rgba(59, 130, 246, 0.3);
                        ">
                            <div style="font-size: 1.5rem; margin-bottom: 0.5rem;">ğŸ§±</div>
                            <div style="font-size: 0.9rem; color: var(--text-dim);">è¿·å®«ç”Ÿæˆ</div>
                        </div>
                        <div style="
                            padding: 1rem;
                            background: rgba(0, 247, 255, 0.1);
                            border-radius: 8px;
                            border: 1px solid rgba(0, 247, 255, 0.3);
                        ">
                            <div style="font-size: 1.5rem; margin-bottom: 0.5rem;">âš¡</div>
                            <div style="font-size: 0.9rem; color: var(--text-dim);">ç²’å­ç³»ç»Ÿ</div>
                        </div>
                        <div style="
                            padding: 1rem;
                            background: rgba(239, 68, 68, 0.1);
                            border-radius: 8px;
                            border: 1px solid rgba(239, 68, 68, 0.3);
                        ">
                            <div style="font-size: 1.5rem; margin-bottom: 0.5rem;">ğŸ¯</div>
                            <div style="font-size: 0.9rem; color: var(--text-dim);">ç¢°æ’æ£€æµ‹</div>
                        </div>
                        <div style="
                            padding: 1rem;
                            background: rgba(139, 92, 246, 0.1);
                            border-radius: 8px;
                            border: 1px solid rgba(139, 92, 246, 0.3);
                        ">
                            <div style="font-size: 1.5rem; margin-bottom: 0.5rem;">ğŸŒ</div>
                            <div style="font-size: 0.9rem; color: var(--text-dim);">ç½‘ç»œåŒæ­¥</div>
                        </div>
                    </div>
                    
                    <div id="loadingTips" style="
                        color: var(--text-dim);
                        font-size: 0.9rem;
                        max-width: 400px;
                        margin: 0 auto;
                        padding: 1rem;
                        background: rgba(255, 255, 255, 0.05);
                        border-radius: 8px;
                        border-left: 3px solid var(--primary-blue);
                    ">
                        <p>ğŸ’¡ æç¤ºï¼šæ¸¸æˆå®Œå…¨åœ¨æµè§ˆå™¨ä¸­è¿è¡Œï¼Œæ— éœ€ä¸‹è½½é¢å¤–æ’ä»¶</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- åœºæ™¯5: æ¸¸æˆä¸­ -->
        <div id="gameScene" class="scene">
            <!-- æ¸¸æˆç”»å¸ƒå®¹å™¨ -->
            <div style="
                position: relative;
                width: 100%;
                height: 100%;
                overflow: hidden;
                background: #000;
            ">
                <!-- æ¸¸æˆç”»å¸ƒ -->
                <canvas id="gameCanvas" style="
                    display: block;
                    background: #000;
                "></canvas>
                
                <!-- æ¸¸æˆUIè¦†ç›–å±‚ -->
                <div id="gameUI" style="
                    position: absolute;
                    top: 0;
                    left: 0;
                    width: 100%;
                    padding: 1rem;
                    pointer-events: none;
                    z-index: 100;
                ">
                    <!-- é¡¶éƒ¨çŠ¶æ€æ  -->
                    <div style="
                        display: flex;
                        justify-content: space-between;
                        align-items: flex-start;
                        flex-wrap: wrap;
                        gap: 1rem;
                        margin-bottom: 1rem;
                    ">
                        <!-- å·¦ï¼šç©å®¶ä¿¡æ¯ -->
                        <div style="
                            background: rgba(15, 23, 42, 0.85);
                            padding: 0.75rem 1.5rem;
                            border-radius: 12px;
                            backdrop-filter: blur(10px);
                            border: 1px solid rgba(59, 130, 246, 0.5);
                            min-width: 200px;
                            pointer-events: auto;
                        ">
                            <div style="
                                display: flex;
                                align-items: center;
                                gap: 0.75rem;
                                margin-bottom: 0.5rem;
                            ">
                                <div style="
                                    width: 12px;
                                    height: 12px;
                                    border-radius: 50%;
                                    background: var(--primary-blue);
                                "></div>
                                <span style="color: white; font-weight: 600;" id="playerName">
                                    è´¨å­
                                </span>
                                <span style="
                                    background: rgba(59, 130, 246, 0.2);
                                    color: var(--primary-blue);
                                    padding: 0.25rem 0.5rem;
                                    border-radius: 4px;
                                    font-size: 0.8rem;
                                ">ä½ </span>
                            </div>
                            
                            <div style="margin-bottom: 0.5rem;">
                                <div style="
                                    display: flex;
                                    justify-content: space-between;
                                    margin-bottom: 0.25rem;
                                    font-size: 0.9rem;
                                    color: var(--text-dim);
                                ">
                                    <span>ç”Ÿå‘½å€¼</span>
                                    <span id="playerHP">100</span>
                                </div>
                                <div style="
                                    height: 8px;
                                    background: rgba(255, 255, 255, 0.1);
                                    border-radius: 4px;
                                    overflow: hidden;
                                ">
                                    <div id="playerHealthBar" style="
                                        height: 100%;
                                        width: 100%;
                                        background: linear-gradient(90deg, var(--primary-blue), #60a5fa);
                                        border-radius: 4px;
                                        transition: width 0.3s;
                                    "></div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- ä¸­ï¼šæ¸¸æˆçŠ¶æ€ -->
                        <div style="
                            background: rgba(15, 23, 42, 0.85);
                            padding: 0.75rem 1.5rem;
                            border-radius: 12px;
                            backdrop-filter: blur(10px);
                            border: 1px solid rgba(255, 255, 255, 0.2);
                            text-align: center;
                            pointer-events: auto;
                        ">
                            <div style="
                                font-size: 1.5rem;
                                font-weight: bold;
                                color: white;
                                margin-bottom: 0.25rem;
                            " id="gameTimer">90</div>
                            <div style="
                                font-size: 0.9rem;
                                color: var(--text-dim);
                            ">å‰©ä½™æ—¶é—´</div>
                            
                            <div style="
                                margin-top: 0.75rem;
                                padding-top: 0.75rem;
                                border-top: 1px solid rgba(255, 255, 255, 0.1);
                            ">
                                <div style="
                                    display: flex;
                                    justify-content: center;
                                    gap: 2rem;
                                    color: white;
                                    font-weight: 600;
                                ">
                                    <span id="playerScore">0</span>
                                    <span style="color: var(--text-dim);">:</span>
                                    <span id="opponentScore">0</span>
                                </div>
                                <div style="
                                    font-size: 0.8rem;
                                    color: var(--text-dim);
                                ">åˆ†æ•°</div>
                            </div>
                        </div>
                        
                        <!-- å³ï¼šå¯¹æ‰‹ä¿¡æ¯ -->
                        <div style="
                            background: rgba(15, 23, 42, 0.85);
                            padding: 0.75rem 1.5rem;
                            border-radius: 12px;
                            backdrop-filter: blur(10px);
                            border: 1px solid rgba(239, 68, 68, 0.5);
                            min-width: 200px;
                            pointer-events: auto;
                        ">
                            <div style="
                                display: flex;
                                align-items: center;
                                gap: 0.75rem;
                                margin-bottom: 0.5rem;
                                justify-content: flex-end;
                            ">
                                <span style="
                                    background: rgba(239, 68, 68, 0.2);
                                    color: var(--primary-red);
                                    padding: 0.25rem 0.5rem;
                                    border-radius: 4px;
                                    font-size: 0.8rem;
                                ">å¯¹æ‰‹</span>
                                <span style="color: white; font-weight: 600;" id="opponentName">
                                    ç”µå­
                                </span>
                                <div style="
                                    width: 12px;
                                    height: 12px;
                                    border-radius: 50%;
                                    background: var(--primary-red);
                                "></div>
                            </div>
                            
                            <div style="margin-bottom: 0.5rem;">
                                <div style="
                                    display: flex;
                                    justify-content: space-between;
                                    margin-bottom: 0.25rem;
                                    font-size: 0.9rem;
                                    color: var(--text-dim);
                                ">
                                    <span>ç”Ÿå‘½å€¼</span>
                                    <span id="opponentHP">100</span>
                                </div>
                                <div style="
                                    height: 8px;
                                    background: rgba(255, 255, 255, 0.1);
                                    border-radius: 4px;
                                    overflow: hidden;
                                ">
                                    <div id="opponentHealthBar" style="
                                        height: 100%;
                                        width: 100%;
                                        background: linear-gradient(90deg, var(--primary-red), #f87171);
                                        border-radius: 4px;
                                        transition: width 0.3s;
                                    "></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- å°åœ°å›¾ -->
                    <div style="
                        position: absolute;
                        bottom: 120px;
                        left: 20px;
                        background: rgba(0, 0, 0, 0.7);
                        border: 2px solid rgba(255, 255, 255, 0.3);
                        border-radius: 8px;
                        padding: 8px;
                        width: 150px;
                        height: 150px;
                        pointer-events: auto;
                    ">
                        <canvas id="miniMapCanvas" width="134" height="134"></canvas>
                    </div>
                    
                    <!-- æ¸¸æˆæç¤º -->
                    <div style="
                        position: absolute;
                        bottom: 120px;
                        right: 20px;
                        background: rgba(15, 23, 42, 0.85);
                        padding: 1rem;
                        border-radius: 12px;
                        backdrop-filter: blur(10px);
                        border: 1px solid rgba(255, 255, 255, 0.2);
                        max-width: 250px;
                        pointer-events: auto;
                    ">
                        <div style="
                            font-size: 0.9rem;
                            color: white;
                            margin-bottom: 0.5rem;
                        ">ğŸ® æ§åˆ¶è¯´æ˜</div>
                        <div style="
                            font-size: 0.8rem;
                            color: var(--text-dim);
                            line-height: 1.4;
                        ">
                            <div>ğŸ–±ï¸ ç”µè„‘: WASDç§»åŠ¨ï¼Œç©ºæ ¼æ”»å‡»</div>
                            <div>ğŸ“± æ‰‹æœº: ä½¿ç”¨ä¸‹æ–¹æŒ‰é’®</div>
                            <div>ğŸ¯ ç›®æ ‡: å‘å°„ç²’å­å‡»ä¸­å¯¹æ‰‹</div>
                        </div>
                    </div>
                </div>
                
                <!-- æ‰‹æœºæ§åˆ¶æŒ‰é’® -->
                <div id="mobileControls" style="
                    position: absolute;
                    bottom: 0;
                    left: 0;
                    width: 100%;
                    padding: 1.5rem;
                    display: none;
                    justify-content: space-between;
                    pointer-events: none;
                    z-index: 90;
                ">
                    <!-- ç§»åŠ¨æ§åˆ¶åŒº -->
                    <div style="
                        display: grid;
                        grid-template-columns: repeat(3, 1fr);
                        grid-template-rows: repeat(3, 1fr);
                        gap: 10px;
                        width: 180px;
                        height: 180px;
                        pointer-events: auto;
                    ">
                        <div style="grid-column: 2; grid-row: 1;">
                            <button class="mobile-btn" data-action="up">
                                <span>â†‘</span>
                            </button>
                        </div>
                        <div style="grid-column: 1; grid-row: 2;">
                            <button class="mobile-btn" data-action="left">
                                <span>â†</span>
                            </button>
                        </div>
                        <div style="grid-column: 2; grid-row: 2;">
                            <button class="mobile-btn" data-action="stop">
                                <span>â—</span>
                            </button>
                        </div>
                        <div style="grid-column: 3; grid-row: 2;">
                            <button class="mobile-btn" data-action="right">
                                <span>â†’</span>
                            </button>
                        </div>
                        <div style="grid-column: 2; grid-row: 3;">
                            <button class="mobile-btn" data-action="down">
                                <span>â†“</span>
                            </button>
                        </div>
                    </div>
                    
                    <!-- æ”»å‡»æ§åˆ¶åŒº -->
                    <div style="
                        display: flex;
                        flex-direction: column;
                        gap: 15px;
                        align-items: center;
                        pointer-events: auto;
                    ">
                        <button class="mobile-btn attack-btn" data-action="shoot" style="
                            width: 100px;
                            height: 100px;
                            font-size: 2.5rem;
                        ">
                            <span>âš¡</span>
                        </button>
                        <div style="
                            color: white;
                            font-size: 0.9rem;
                            background: rgba(239, 68, 68, 0.3);
                            padding: 0.5rem 1rem;
                            border-radius: 20px;
                        ">
                            å‘å°„ç²’å­
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- åœºæ™¯6: æ¸¸æˆç»“æŸ -->
        <div id="gameOverScene" class="scene">
            <div style="
                width: 100%;
                height: 100%;
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
                padding: 2rem;
                text-align: center;
                background: linear-gradient(135deg, 
                    rgba(15, 23, 42, 0.95) 0%, 
                    rgba(30, 41, 59, 0.9) 100%);
            ">
                <div id="resultContent" style="
                    max-width: 600px;
                    width: 100%;
                ">
                    <!-- ç»“æœå†…å®¹å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                </div>
                
                <div style="
                    margin-top: 3rem;
                    display: flex;
                    gap: 1rem;
                    flex-wrap: wrap;
                    justify-content: center;
                ">
                    <button id="playAgainBtn" class="btn btn-primary" onclick="playAgain()">
                        <span>ğŸ”„</span> å†ç©ä¸€æ¬¡
                    </button>
                    <button id="backToMenuBtn" class="btn btn-secondary" onclick="backToMenu()">
                        <span>ğŸ </span> è¿”å›ä¸»èœå•
                    </button>
                    <button id="shareResultBtn" class="btn btn-secondary" onclick="shareResult()">
                        <span>ğŸ“¤</span> åˆ†äº«ç»“æœ
                    </button>
                </div>
                
                <div style="
                    margin-top: 2rem;
                    max-width: 500px;
                    width: 100%;
                ">
                    <div style="
                        background: rgba(255, 255, 255, 0.05);
                        border-radius: 12px;
                        padding: 1.5rem;
                        margin-bottom: 1rem;
                    ">
                        <h4 style="color: white; margin-bottom: 0.75rem;">ğŸ“Š æ¸¸æˆç»Ÿè®¡</h4>
                        <div style="
                            display: grid;
                            grid-template-columns: repeat(2, 1fr);
                            gap: 1rem;
                            text-align: left;
                        ">
                            <div>
                                <div style="color: var(--text-dim); font-size: 0.9rem;">æ€»åˆ†æ•°</div>
                                <div style="color: white; font-size: 1.5rem; font-weight: bold;" id="totalScore">0</div>
                            </div>
                            <div>
                                <div style="color: var(--text-dim); font-size: 0.9rem;">å‰©ä½™æ—¶é—´</div>
                                <div style="color: white; font-size: 1.5rem; font-weight: bold;" id="timeLeft">0s</div>
                            </div>
                            <div>
                                <div style="color: var(--text-dim); font-size: 0.9rem;">å‡†ç¡®ç‡</div>
                                <div style="color: white; font-size: 1.5rem; font-weight: bold;" id="accuracy">0%</div>
                            </div>
                            <div>
                                <div style="color: var(--text-dim); font-size: 0.9rem;">è·å¾—ç§¯åˆ†</div>
                                <div style="color: #10b981; font-size: 1.5rem; font-weight: bold;" id="pointsEarned">+0</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

<script>
// ==================== ç¬¬ä¸€éƒ¨åˆ†ï¼šæ¨ªå±æ£€æµ‹å’ŒåŸºç¡€çŠ¶æ€ ====================

// æ£€æµ‹å±å¹•æ–¹å‘
function checkOrientation() {
    const warning = document.getElementById('orientationWarning');
    const app = document.getElementById('app');
    
    if (!warning || !app) return;
    
    const isPortrait = window.innerHeight > window.innerWidth;
    
    if (isPortrait) {
        warning.classList.add('show');
        app.style.display = 'none';
    } else {
        warning.classList.remove('show');
        app.style.display = 'block';
        
        // é‡æ–°è°ƒæ•´æ¸¸æˆç”»å¸ƒå°ºå¯¸
        if (window.game && window.game.canvas) {
            resizeGameCanvas();
        }
    }
}

// ç›‘å¬æ–¹å‘å˜åŒ–
window.addEventListener('resize', checkOrientation);
window.addEventListener('orientationchange', checkOrientation);
window.addEventListener('load', checkOrientation);

// å…¨å±€é”™è¯¯æ•è·
window.onerror = function(msg, url, lineNo, columnNo, error) {
    console.error('ğŸš¨ å…¨å±€JavaScripté”™è¯¯:', msg);
    console.error('ğŸ“ ä½ç½®:', url, lineNo, columnNo);
    if (error) console.error('ğŸ“„ é”™è¯¯å¯¹è±¡:', error);
    
    return false;
};

// æ•è·æœªå¤„ç†çš„Promiseé”™è¯¯
window.addEventListener('unhandledrejection', function(event) {
    console.error('ğŸš¨ æœªå¤„ç†çš„Promiseé”™è¯¯:', event.reason);
});

// ==================== æ¸¸æˆçŠ¶æ€ç®¡ç† ====================
const GameState = {
    MENU: 'menu',
    MATCHING: 'matching',
    LOBBY: 'lobby',
    LOADING: 'loading',
    PLAYING: 'playing',
    GAME_OVER: 'game_over'
};

let currentState = GameState.MENU;
let playerRole = null; // 'proton' æˆ– 'electron'
let matchTimer = 0;
let matchInterval = null;

// ==================== æ¸¸æˆå¼•æ“å˜é‡ ====================
let game = {
    canvas: null,
    ctx: null,
    miniMapCanvas: null,
    miniMapCtx: null,
    width: 0,
    height: 0,
    
    // æ¸¸æˆçŠ¶æ€
    players: {
        player1: null,
        player2: null
    },
    projectiles: [],
    maze: [],
    mazeCols: 0,
    mazeRows: 0,
    cellSize: 40,
    
    // è¾“å…¥æ§åˆ¶
    keys: {},
    touchControls: {},
    
    // æ¸¸æˆè®¡æ—¶
    gameTime: 90,
    gameTimer: null,
    lastUpdateTime: 0,
    
    // æ¸¸æˆçŠ¶æ€
    isGameActive: false,
    playerScore: 0,
    opponentScore: 0,
    
    // è¿·å®«ç§å­ï¼ˆç”¨äºå¤šäººæ¸¸æˆåŒæ­¥ï¼‰
    mazeSeed: Date.now()
};

// ==================== åœºæ™¯åˆ‡æ¢ ====================
function switchScene(sceneId) {
    console.log(`ğŸ”„ åˆ‡æ¢åœºæ™¯åˆ°: ${sceneId}`);
    
    // éšè—æ‰€æœ‰åœºæ™¯
    document.querySelectorAll('.scene').forEach(scene => {
        scene.classList.remove('active');
    });
    
    // æ˜¾ç¤ºç›®æ ‡åœºæ™¯
    const targetScene = document.getElementById(sceneId);
    if (targetScene) {
        targetScene.classList.add('active');
    } else {
        console.error(`âŒ æ‰¾ä¸åˆ°åœºæ™¯: ${sceneId}`);
    }
    
    // æ›´æ–°çŠ¶æ€
    currentState = sceneId.replace('Scene', '').toUpperCase();
    console.log(`âœ… å½“å‰çŠ¶æ€: ${currentState}`);
}

// ==================== åŒ¹é…ç³»ç»Ÿ ====================
function startMatchmaking() {
    console.log('ğŸ” å¼€å§‹åŒ¹é…çœŸäººå¯¹æ‰‹...');
    
    // åˆ‡æ¢åˆ°åŒ¹é…åœºæ™¯
    switchScene('matchingScene');
    
    // å¦‚æœå·²ç»åˆå§‹åŒ–è¿‡ï¼Œç›´æ¥å¼€å§‹åŒ¹é…
    if (window.MultiplayerGame && window.MultiplayerGame.supabase) {
        console.log('ä½¿ç”¨å·²æœ‰çš„è¿æ¥å¼€å§‹åŒ¹é…');
        window.MultiplayerGame.startMatchmaking();
    } else {
        // åˆå§‹åŒ–å¤šäººæ¸¸æˆç³»ç»Ÿ
        console.log('åˆå§‹åŒ–å¤šäººæ¸¸æˆç³»ç»Ÿ...');
        if (!window.MultiplayerGame) {
            alert('å¤šäººæ¸¸æˆç³»ç»ŸæœªåŠ è½½ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•');
            return;
        }
        window.MultiplayerGame.init().then(() => {
            window.MultiplayerGame.startMatchmaking();
        }).catch(error => {
            console.error('åˆå§‹åŒ–å¤±è´¥:', error);
            alert('å¤šäººæ¸¸æˆç³»ç»Ÿåˆå§‹åŒ–å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•');
        });
    }
}

function cancelMatchmaking() {
    console.log('âŒ å–æ¶ˆåŒ¹é…');
    
    if (window.MultiplayerGame && window.MultiplayerGame.cancelMatchmaking) {
        window.MultiplayerGame.cancelMatchmaking();
    } else {
        switchScene('menuScene');
    }
}

// ==================== æ¸¸æˆè¯´æ˜ ====================
function showHowToPlay() {
    alert(`ğŸ® ã€æ¸¸æˆè¯´æ˜ã€‘\n\nğŸƒã€ç§»åŠ¨æ§åˆ¶ã€‘\nâ€¢ ç”µè„‘: WASD æˆ– æ–¹å‘é”®\nâ€¢ æ‰‹æœº: å±å¹•è™šæ‹ŸæŒ‰é’®\n\nâš¡ã€æ”»å‡»æ§åˆ¶ã€‘\nâ€¢ ç”µè„‘: ç©ºæ ¼é”®\nâ€¢ æ‰‹æœº: å‘å°„æŒ‰é’®\n\nğŸ¯ã€æ¸¸æˆè§„åˆ™ã€‘\n1. æ‰®æ¼”è´¨å­(è“)æˆ–ç”µå­(çº¢)\n2. åœ¨è¿·å®«ä¸­ç§»åŠ¨å¹¶å‘å°„ç²’å­\n3. ç²’å­ç¢°åˆ°å¢™å£ä¼šåå¼¹\n4. å‡»ä¸­æ•Œäººé€ æˆ25ç‚¹ä¼¤å®³\n5. å…ˆå‡»è´¥å¯¹æ‰‹æˆ–æ—¶é—´ç»“æŸå¾—åˆ†é«˜è€…è·èƒœ\n\nâ±ï¸ã€æ—¶é—´é™åˆ¶ã€‘\nâ€¢ æ¯å±€90ç§’\nâ€¢ è¶…æ—¶æŒ‰å‰©ä½™è¡€é‡åˆ¤æ–­èƒœè´Ÿ\n\nğŸš«ã€æ³¨æ„äº‹é¡¹ã€‘\nâ€¢ å±å¹•é”å®šï¼Œæ— æ³•æ»šåŠ¨\nâ€¢ éœ€è¦åŒæ–¹éƒ½ç¡®è®¤å‡†å¤‡\nâ€¢ å®æ—¶åŒ¹é…ï¼Œå…¬å¹³å¯¹æˆ˜`);
}
</script>
<script>
// ==================== ç¬¬äºŒéƒ¨åˆ†ï¼šæ¸¸æˆå¤§å…çŠ¶æ€å˜é‡ ====================
let isPlayerReady = false;
let isOpponentReady = false;
let lobbyCountdownValue = 5;
let lobbyCountdownInterval = null;

// ==================== æ¸¸æˆå¤§å…é€»è¾‘ ====================
function initializeLobby() {
    console.log('ğŸª åˆå§‹åŒ–æ¸¸æˆå¤§å…');
    
    // æ¸…é™¤ä¹‹å‰çš„å€’è®¡æ—¶
    if (lobbyCountdownInterval) {
        clearInterval(lobbyCountdownInterval);
        lobbyCountdownInterval = null;
    }
    
    // é‡ç½®çŠ¶æ€
    isPlayerReady = false;
    isOpponentReady = false;
    lobbyCountdownValue = 5;
    
    // æ›´æ–°è§’è‰²æ˜¾ç¤º
    updateRoleDisplay();
    
    // æ›´æ–°çŠ¶æ€æ˜¾ç¤º
    updatePlayerStatus();
    updateOpponentStatus();
    
    // éšè—å€’è®¡æ—¶
    const countdownElement = document.getElementById('lobbyCountdown');
    if (countdownElement) {
        countdownElement.style.display = 'none';
    }
    
    // é‡ç½®å‡†å¤‡æŒ‰é’®
    const readyBtn = document.getElementById('player1ReadyBtn');
    if (readyBtn) {
        readyBtn.textContent = 'ç‚¹å‡»å‡†å¤‡';
        readyBtn.style.background = playerRole === 'proton' ? 'var(--primary-blue)' : 'var(--primary-red)';
        readyBtn.onclick = togglePlayerReady;
    }
    
    console.log('âœ… æ¸¸æˆå¤§å…åˆå§‹åŒ–å®Œæˆï¼Œç©å®¶è§’è‰²:', playerRole);
}

function updateRoleDisplay() {
    const player1RoleElement = document.getElementById('player1Role');
    const player2RoleElement = document.getElementById('player2Role');
    
    if (!player1RoleElement || !player2RoleElement) return;
    
    if (playerRole === 'proton') {
        // ç©å®¶æ˜¯è´¨å­
        player1RoleElement.textContent = 'è´¨å­';
        
        const player1Card = document.getElementById('player1Card');
        if (player1Card) {
            player1Card.style.borderColor = 'var(--primary-blue)';
        }
        
        const player1ReadyBtn = document.getElementById('player1ReadyBtn');
        if (player1ReadyBtn) {
            player1ReadyBtn.style.background = 'var(--primary-blue)';
        }
        
        player2RoleElement.textContent = 'ç”µå­';
        
        const player2Card = document.getElementById('player2Card');
        if (player2Card) {
            player2Card.style.borderColor = 'var(--primary-red)';
        }
        
        // æ›´æ–°ç‰¹æ€§
        const traitElements = [
            'player1Trait1', 'player1Trait2', 'player1Trait3',
            'player2Trait1', 'player2Trait2', 'player2Trait3'
        ].map(id => document.getElementById(id));
        
        if (traitElements[0]) traitElements[0].textContent = 'å¸¦æ­£ç”µè·';
        if (traitElements[1]) traitElements[1].textContent = 'è“è‰²ç²’å­';
        if (traitElements[2]) traitElements[2].textContent = 'è´¨é‡è¾ƒå¤§';
        if (traitElements[3]) traitElements[3].textContent = 'å¸¦è´Ÿç”µè·';
        if (traitElements[4]) traitElements[4].textContent = 'çº¢è‰²ç²’å­';
        if (traitElements[5]) traitElements[5].textContent = 'è´¨é‡è¾ƒå°';
    } else {
        // ç©å®¶æ˜¯ç”µå­
        player1RoleElement.textContent = 'ç”µå­';
        
        const player1Card = document.getElementById('player1Card');
        if (player1Card) {
            player1Card.style.borderColor = 'var(--primary-red)';
        }
        
        const player1ReadyBtn = document.getElementById('player1ReadyBtn');
        if (player1ReadyBtn) {
            player1ReadyBtn.style.background = 'var(--primary-red)';
        }
        
        player2RoleElement.textContent = 'è´¨å­';
        
        const player2Card = document.getElementById('player2Card');
        if (player2Card) {
            player2Card.style.borderColor = 'var(--primary-blue)';
        }
        
        // æ›´æ–°ç‰¹æ€§
        const traitElements = [
            'player1Trait1', 'player1Trait2', 'player1Trait3',
            'player2Trait1', 'player2Trait2', 'player2Trait3'
        ].map(id => document.getElementById(id));
        
        if (traitElements[0]) traitElements[0].textContent = 'å¸¦è´Ÿç”µè·';
        if (traitElements[1]) traitElements[1].textContent = 'çº¢è‰²ç²’å­';
        if (traitElements[2]) traitElements[2].textContent = 'è´¨é‡è¾ƒå°';
        if (traitElements[3]) traitElements[3].textContent = 'å¸¦æ­£ç”µè·';
        if (traitElements[4]) traitElements[4].textContent = 'è“è‰²ç²’å­';
        if (traitElements[5]) traitElements[5].textContent = 'è´¨é‡è¾ƒå¤§';
    }
}

function updatePlayerStatus() {
    const statusDot = document.getElementById('player1StatusDot');
    const statusText = document.getElementById('player1StatusText');
    
    if (!statusDot || !statusText) return;
    
    if (isPlayerReady) {
        statusDot.style.background = '#10b981';
        statusText.textContent = 'å·²å‡†å¤‡';
    } else {
        statusDot.style.background = '#64748b';
        statusText.textContent = 'æœªå‡†å¤‡';
    }
}

function updateOpponentStatus() {
    const statusDot = document.getElementById('player2StatusDot');
    const statusText = document.getElementById('player2StatusText');
    const actionText = document.getElementById('opponentAction');
    
    if (!statusDot || !statusText || !actionText) return;
    
    if (isOpponentReady) {
        statusDot.style.background = '#10b981';
        statusText.textContent = 'å·²å‡†å¤‡';
        actionText.textContent = 'å¯¹æ‰‹å·²å‡†å¤‡ï¼';
    } else {
        statusDot.style.background = '#64748b';
        statusText.textContent = 'æœªå‡†å¤‡';
        actionText.textContent = 'ç­‰å¾…å¯¹æ‰‹å‡†å¤‡...';
    }
}

function togglePlayerReady() {
    console.log('ğŸ”„ åˆ‡æ¢å‡†å¤‡çŠ¶æ€ï¼Œå½“å‰:', isPlayerReady);
    
    isPlayerReady = !isPlayerReady;
    updatePlayerStatus();
    
    const readyBtn = document.getElementById('player1ReadyBtn');
    if (!readyBtn) return;
    
    if (isPlayerReady) {
        readyBtn.textContent = 'å–æ¶ˆå‡†å¤‡';
        readyBtn.style.background = '#64748b';
        
        console.log('âœ… ç©å®¶å·²å‡†å¤‡ï¼Œç­‰å¾…å¯¹æ‰‹...');
        
        // å¦‚æœæ˜¯å¤šäººæ¸¸æˆï¼Œå‘é€å‡†å¤‡çŠ¶æ€
        if (window.MultiplayerGame && window.MultiplayerGame.currentRoom) {
            window.MultiplayerGame.sendPlayerReady(true);
        } else {
            // å•äººæ¸¸æˆï¼šæ¨¡æ‹Ÿå¯¹æ‰‹åœ¨1-3ç§’åå‡†å¤‡
            setTimeout(() => {
                if (!isOpponentReady) {
                    isOpponentReady = true;
                    updateOpponentStatus();
                    
                    console.log('âœ… å¯¹æ‰‹å·²å‡†å¤‡');
                    
                    // åŒæ–¹éƒ½å‡†å¤‡å¥½åå¼€å§‹å€’è®¡æ—¶
                    if (isPlayerReady && isOpponentReady) {
                        console.log('ğŸš€ åŒæ–¹å‡†å¤‡å®Œæˆï¼Œå¼€å§‹å€’è®¡æ—¶');
                        startLobbyCountdown();
                    }
                }
            }, Math.random() * 2000 + 1000);
        }
    } else {
        readyBtn.textContent = 'ç‚¹å‡»å‡†å¤‡';
        readyBtn.style.background = playerRole === 'proton' ? 'var(--primary-blue)' : 'var(--primary-red)';
        
        console.log('âŒ ç©å®¶å–æ¶ˆå‡†å¤‡');
        
        // å¦‚æœæ˜¯å¤šäººæ¸¸æˆï¼Œå‘é€å–æ¶ˆå‡†å¤‡çŠ¶æ€
        if (window.MultiplayerGame && window.MultiplayerGame.currentRoom) {
            window.MultiplayerGame.sendPlayerReady(false);
        }
        
        // å¦‚æœæ­£åœ¨å€’è®¡æ—¶ï¼Œå–æ¶ˆå®ƒ
        if (lobbyCountdownInterval) {
            clearInterval(lobbyCountdownInterval);
            lobbyCountdownInterval = null;
            
            const countdownElement = document.getElementById('lobbyCountdown');
            if (countdownElement) {
                countdownElement.style.display = 'none';
            }
            
            console.log('â¹ï¸ å·²å–æ¶ˆå€’è®¡æ—¶');
        }
    }
}

function startLobbyCountdown() {
    console.log('â±ï¸ å¼€å§‹å¤§å…å€’è®¡æ—¶');
    
    // æ˜¾ç¤ºå€’è®¡æ—¶
    const countdownElement = document.getElementById('lobbyCountdown');
    const countdownNumber = document.getElementById('countdownNumber');
    
    if (!countdownElement || !countdownNumber) {
        console.error('âŒ å€’è®¡æ—¶å…ƒç´ æœªæ‰¾åˆ°');
        return;
    }
    
    countdownElement.style.display = 'block';
    lobbyCountdownValue = 5;
    countdownNumber.textContent = lobbyCountdownValue;
    
    // æ¸…é™¤ä¹‹å‰çš„å€’è®¡æ—¶
    if (lobbyCountdownInterval) {
        clearInterval(lobbyCountdownInterval);
    }
    
    // å¼€å§‹å€’è®¡æ—¶
    lobbyCountdownInterval = setInterval(() => {
        lobbyCountdownValue--;
        countdownNumber.textContent = lobbyCountdownValue;
        
        console.log('â±ï¸ å€’è®¡æ—¶:', lobbyCountdownValue);
        
        if (lobbyCountdownValue <= 0) {
            clearInterval(lobbyCountdownInterval);
            lobbyCountdownInterval = null;
            console.log('âœ… å€’è®¡æ—¶ç»“æŸï¼Œå¼€å§‹æ¸¸æˆåŠ è½½');
            startGameLoading();
        }
    }, 1000);
}

function startGameLoading() {
    console.log('ğŸ”§ è¿›å…¥æ¸¸æˆåŠ è½½...');
    switchScene('loadingScene');
    
    // å¦‚æœæ˜¯å¤šäººæ¸¸æˆï¼Œå‘é€æ¸¸æˆå¼€å§‹ä¿¡å·
    if (window.MultiplayerGame && window.MultiplayerGame.currentRoom) {
        window.MultiplayerGame.sendAction('game_starting', {
            timestamp: Date.now()
        });
    }
    
    // æ¨¡æ‹ŸåŠ è½½è¿‡ç¨‹
    let loadProgress = 0;
    const loadingInterval = setInterval(() => {
        loadProgress += 10;
        const loadingBar = document.getElementById('loadingBar');
        const loadingPercent = document.getElementById('loadingPercent');
        
        if (loadingBar) loadingBar.style.width = `${loadProgress}%`;
        if (loadingPercent) loadingPercent.textContent = `${loadProgress}%`;
        
        if (loadProgress >= 100) {
            clearInterval(loadingInterval);
            console.log('âœ… åŠ è½½å®Œæˆï¼Œå‡†å¤‡åˆå§‹åŒ–æ¸¸æˆ');
            
            // å»¶è¿Ÿä¸€å°æ®µæ—¶é—´ç¡®ä¿UIæ›´æ–°
            setTimeout(() => {
                console.log('ğŸš€ è°ƒç”¨ initializeGame');
                initializeGame();
            }, 300);
        }
    }, 100);
}
</script>
<script>
// ==================== æ¸¸æˆåˆå§‹åŒ– ====================
function initializeGame() {
    console.log('ğŸ® ==================== initializeGame å¼€å§‹ ====================');
    
    try {
        // 1. ç¡®ä¿åˆ‡æ¢åˆ°æ¸¸æˆåœºæ™¯
        console.log('ğŸ”„ åˆ‡æ¢åˆ°æ¸¸æˆåœºæ™¯');
        switchScene('gameScene');
        
        // 2. åˆå§‹åŒ–ç”»å¸ƒ
        console.log('ğŸ¨ åˆå§‹åŒ–ç”»å¸ƒ...');
        game.canvas = document.getElementById('gameCanvas');
        if (!game.canvas) {
            throw new Error('æ‰¾ä¸åˆ° gameCanvas å…ƒç´ ');
        }
        
        game.ctx = game.canvas.getContext('2d');
        if (!game.ctx) {
            throw new Error('æ— æ³•è·å–ç”»å¸ƒä¸Šä¸‹æ–‡');
        }
        console.log('âœ… ç”»å¸ƒä¸Šä¸‹æ–‡è·å–æˆåŠŸ');
        
        // 3. è®¾ç½®ç”»å¸ƒå°ºå¯¸
        console.log('ğŸ“ è®¾ç½®ç”»å¸ƒå°ºå¯¸...');
        resizeGameCanvas();
        
        // 4. ç”Ÿæˆè¿·å®«
        console.log('ğŸ§± ç”Ÿæˆè¿·å®«...');
        generateMaze();
        
        // 5. åˆå§‹åŒ–ç©å®¶
        console.log('ğŸ‘¥ åˆå§‹åŒ–ç©å®¶...');
        initializePlayers();
        
        // 6. æ›´æ–°UIæ˜¾ç¤º
        console.log('ğŸ“± æ›´æ–°UI...');
        updatePlayerDisplay();
        
        // 7. è®¾ç½®æ¸¸æˆçŠ¶æ€
        console.log('âš™ï¸ è®¾ç½®æ¸¸æˆçŠ¶æ€...');
        game.isGameActive = true;
        game.lastUpdateTime = Date.now();
        game.playerScore = 0;
        game.opponentScore = 0;
        game.gameTime = 90;
        
        // 8. é‡ç½®æ‰€æœ‰æ§åˆ¶çŠ¶æ€
        game.keys = {};
        game.touchControls = {};
        game.projectiles = [];
        
        // 9. åˆå§‹åŒ–è¾“å…¥æ§åˆ¶
        console.log('ğŸ® åˆå§‹åŒ–è¾“å…¥æ§åˆ¶...');
        initializeInputControls();
        
        // 10. å¯åŠ¨æ¸¸æˆè®¡æ—¶å™¨
        console.log('â±ï¸ å¯åŠ¨æ¸¸æˆè®¡æ—¶å™¨...');
        startGameTimer();
        
        // 11. æ˜¾ç¤ºç§»åŠ¨æ§åˆ¶ï¼ˆå¦‚æœæ˜¯ç§»åŠ¨è®¾å¤‡ï¼‰
        checkMobileControls();
        
        // 12. å¯åŠ¨æ¸¸æˆå¾ªç¯
        console.log('ğŸš€ å¯åŠ¨æ¸¸æˆå¾ªç¯...');
        console.log('ğŸ“Š å½“å‰æ¸¸æˆçŠ¶æ€:', {
            isGameActive: game.isGameActive,
            projectiles: game.projectiles.length,
            players: Object.keys(game.players).length
        });
        
        // å¼ºåˆ¶å¯åŠ¨æ¸¸æˆå¾ªç¯
        requestAnimationFrame(function() {
            console.log('ğŸ¬ requestAnimationFrame å›è°ƒæ‰§è¡Œ');
            gameLoop();
        });
        
        console.log('âœ… initializeGame æ‰§è¡Œå®Œæˆ');
        
    } catch (error) {
        console.error('âŒ initializeGame å‡ºé”™:', error);
        console.error('é”™è¯¯å †æ ˆ:', error.stack);
        
        // æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
        alert('æ¸¸æˆåˆå§‹åŒ–å¤±è´¥: ' + error.message + '\nè¯·æ£€æŸ¥æ§åˆ¶å°æŸ¥çœ‹è¯¦æƒ…');
    }
}

function resizeGameCanvas() {
    const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
    
    if (isMobile) {
        // ç§»åŠ¨è®¾å¤‡ï¼šç¡®ä¿æ¨ªå±å°ºå¯¸
        game.width = Math.max(window.innerWidth, window.innerHeight);
        game.height = Math.min(window.innerWidth, window.innerHeight);
    } else {
        // æ¡Œé¢è®¾å¤‡ï¼šä½¿ç”¨å®é™…å°ºå¯¸
        game.width = window.innerWidth;
        game.height = window.innerHeight;
    }
    
    game.canvas.width = game.width;
    game.canvas.height = game.height;
    
    // é‡æ–°è®¡ç®—è¿·å®«å°ºå¯¸
    game.mazeCols = Math.floor(game.width / game.cellSize);
    game.mazeRows = Math.floor(game.height / game.cellSize);
    
    console.log(`ğŸ“ ç”»å¸ƒå°ºå¯¸: ${game.width}x${game.height}, è¿·å®«: ${game.mazeCols}x${game.mazeRows}, ç§»åŠ¨è®¾å¤‡: ${isMobile}`);
}

function generateMaze() {
    console.log('ğŸ§± ç”Ÿæˆè¿·å®«ä¸­...');
    
    // ä½¿ç”¨ç§å­ç”Ÿæˆè¿·å®«ï¼ˆç¡®ä¿å¤šäººæ¸¸æˆåŒæ­¥ï¼‰
    const seed = game.mazeSeed || Date.now();
    Math.seedrandom(seed);
    
    game.mazeCols = Math.floor(game.width / game.cellSize);
    game.mazeRows = Math.floor(game.height / game.cellSize);
    
    // åˆå§‹åŒ–è¿·å®«æ•°ç»„
    game.maze = [];
    for (let y = 0; y < game.mazeRows; y++) {
        game.maze[y] = [];
        for (let x = 0; x < game.mazeCols; x++) {
            // è¾¹ç•Œæ˜¯å¢™å£
            if (x === 0 || x === game.mazeCols - 1 || 
                y === 0 || y === game.mazeRows - 1) {
                game.maze[y][x] = 1;
            } else {
                // éšæœºç”Ÿæˆå¢™å£ï¼ˆ25%çš„æ¦‚ç‡ï¼‰
                game.maze[y][x] = Math.random() < 0.25 ? 1 : 0;
            }
        }
    }
    
    // ç¡®ä¿èµ·ç‚¹å’Œç»ˆç‚¹æ˜¯ç©ºçš„
    const startX = Math.floor(game.mazeCols * 0.2);
    const startY = Math.floor(game.mazeRows * 0.5);
    const endX = Math.floor(game.mazeCols * 0.8);
    const endY = Math.floor(game.mazeRows * 0.5);
    
    // æ¸…ç†èµ·ç‚¹å’Œç»ˆç‚¹åŒºåŸŸ
    for (let dy = -2; dy <= 2; dy++) {
        for (let dx = -2; dx <= 2; dx++) {
            const x = startX + dx;
            const y = startY + dy;
            if (x >= 0 && x < game.mazeCols && y >= 0 && y < game.mazeRows) {
                game.maze[y][x] = 0;
            }
            
            const x2 = endX + dx;
            const y2 = endY + dy;
            if (x2 >= 0 && x2 < game.mazeCols && y2 >= 0 && y2 < game.mazeRows) {
                game.maze[y2][x2] = 0;
            }
        }
    }
    
    // é‡ç½®éšæœºç§å­
    Math.seedrandom();
    
    console.log(`âœ… è¿·å®«ç”Ÿæˆå®Œæˆ: ${game.mazeCols}x${game.mazeRows}, ç§å­: ${seed}`);
}

function initializePlayers() {
    console.log('ğŸ‘¥ åˆå§‹åŒ–ç©å®¶...');
    
    // æ‰¾åˆ°èµ·å§‹ä½ç½®
    const startX = Math.floor(game.mazeCols * 0.2) * game.cellSize + game.cellSize / 2;
    const startY = Math.floor(game.mazeRows * 0.5) * game.cellSize + game.cellSize / 2;
    const endX = Math.floor(game.mazeCols * 0.8) * game.cellSize + game.cellSize / 2;
    const endY = Math.floor(game.mazeRows * 0.5) * game.cellSize + game.cellSize / 2;
    
    console.log(`ğŸ“ èµ·å§‹ä½ç½®: (${startX}, ${startY})`);
    console.log(`ğŸ“ ç»“æŸä½ç½®: (${endX}, ${endY})`);
    
    // æ ¹æ®ç©å®¶è§’è‰²è®¾ç½®ç©å®¶ä½ç½®
    if (playerRole === 'proton') {
        // ç©å®¶æ˜¯è´¨å­ï¼ˆè“è‰²ï¼‰ï¼Œåœ¨å·¦ä¾§
        game.players.player1 = {
            x: startX,
            y: startY,
            radius: 16,
            color: '#3b82f6',
            hp: 100,
            maxHp: 100,
            speed: 5,
            direction: 0,
            lastShot: 0,
            shotCooldown: 500, // 0.5ç§’å†·å´
            score: 0
        };
        
        // å¯¹æ‰‹æ˜¯ç”µå­ï¼ˆçº¢è‰²ï¼‰ï¼Œåœ¨å³ä¾§
        game.players.player2 = {
            x: endX,
            y: endY,
            radius: 16,
            color: '#ef4444',
            hp: 100,
            maxHp: 100,
            speed: 5,
            direction: Math.PI,
            isAI: false, // å¤šäººæ¸¸æˆä¸­ä¸æ˜¯AI
            aiDirectionChangeTime: 0,
            score: 0
        };
    } else {
        // ç©å®¶æ˜¯ç”µå­ï¼ˆçº¢è‰²ï¼‰ï¼Œåœ¨å³ä¾§
        game.players.player1 = {
            x: endX,
            y: endY,
            radius: 16,
            color: '#ef4444',
            hp: 100,
            maxHp: 100,
            speed: 5,
            direction: Math.PI,
            lastShot: 0,
            shotCooldown: 500,
            score: 0
        };
        
        // å¯¹æ‰‹æ˜¯è´¨å­ï¼ˆè“è‰²ï¼‰ï¼Œåœ¨å·¦ä¾§
        game.players.player2 = {
            x: startX,
            y: startY,
            radius: 16,
            color: '#3b82f6',
            hp: 100,
            maxHp: 100,
            speed: 5,
            direction: 0,
            isAI: false,
            aiDirectionChangeTime: 0,
            score: 0
        };
    }
    
    console.log('âœ… ç©å®¶åˆå§‹åŒ–å®Œæˆ');
    console.log('ç©å®¶1:', game.players.player1);
    console.log('ç©å®¶2:', game.players.player2);
}

function updatePlayerDisplay() {
    console.log('ğŸ“± æ›´æ–°ç©å®¶æ˜¾ç¤º...');
    
    // æ›´æ–°ç©å®¶åç§°
    const playerNameElement = document.getElementById('playerName');
    const opponentNameElement = document.getElementById('opponentName');
    
    if (playerNameElement) {
        playerNameElement.textContent = playerRole === 'proton' ? 'è´¨å­' : 'ç”µå­';
    }
    
    if (opponentNameElement) {
        opponentNameElement.textContent = playerRole === 'proton' ? 'ç”µå­' : 'è´¨å­';
    }
    
    // æ›´æ–°è¡€é‡æ˜¾ç¤º
    updateHealthBars();
    updateScores();
    
    console.log('âœ… ç©å®¶æ˜¾ç¤ºæ›´æ–°å®Œæˆ');
}

function checkMobileControls() {
    // æ£€æµ‹æ˜¯å¦ä¸ºç§»åŠ¨è®¾å¤‡
    const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
    const mobileControls = document.getElementById('mobileControls');
    
    if (isMobile && mobileControls) {
        mobileControls.style.display = 'flex';
        console.log('ğŸ“± ç§»åŠ¨æ§åˆ¶å·²å¯ç”¨');
    } else {
        console.log('ğŸ’» æ¡Œé¢è®¾å¤‡ï¼Œä½¿ç”¨é”®ç›˜æ§åˆ¶');
    }
}
</script>
<script>
// ==================== ç¬¬ä¸‰éƒ¨åˆ†ï¼šè¾“å…¥æ§åˆ¶ ====================
function initializeInputControls() {
    console.log('ğŸ® åˆå§‹åŒ–è¾“å…¥æ§åˆ¶...');
    
    // é”®ç›˜æ§åˆ¶
    window.addEventListener('keydown', (e) => {
        const key = e.key.toLowerCase();
        game.keys[key] = true;
        
        // é˜²æ­¢ç©ºæ ¼é”®æ»šåŠ¨é¡µé¢
        if (e.key === ' ') {
            e.preventDefault();
        }
        
        // è°ƒè¯•ï¼šæ˜¾ç¤ºæŒ‰ä¸‹çš„é”®
        if (key === ' ') {
            console.log('ğŸ”« ç©ºæ ¼é”®æŒ‰ä¸‹ï¼Œå°è¯•å‘å°„');
        }
    });
    
    window.addEventListener('keyup', (e) => {
        const key = e.key.toLowerCase();
        game.keys[key] = false;
    });
    
    // è§¦æ‘¸æ§åˆ¶
    const mobileButtons = document.querySelectorAll('.mobile-btn');
    mobileButtons.forEach(btn => {
        const action = btn.getAttribute('data-action');
        
        // è§¦æ‘¸å¼€å§‹
        btn.addEventListener('touchstart', (e) => {
            e.preventDefault();
            game.touchControls[action] = true;
            btn.style.background = action === 'shoot' ? 
                'rgba(239, 68, 68, 0.3)' : 
                'rgba(255, 255, 255, 0.25)';
        });
        
        // è§¦æ‘¸ç»“æŸ
        btn.addEventListener('touchend', (e) => {
            e.preventDefault();
            game.touchControls[action] = false;
            btn.style.background = action === 'shoot' ? 
                'rgba(239, 68, 68, 0.2)' : 
                'rgba(255, 255, 255, 0.15)';
        });
        
        // é¼ æ ‡æ§åˆ¶ï¼ˆç”¨äºæµ‹è¯•ï¼‰
        btn.addEventListener('mousedown', (e) => {
            e.preventDefault();
            game.touchControls[action] = true;
            btn.style.background = action === 'shoot' ? 
                'rgba(239, 68, 68, 0.3)' : 
                'rgba(255, 255, 255, 0.25)';
        });
        
        btn.addEventListener('mouseup', (e) => {
            e.preventDefault();
            game.touchControls[action] = false;
            btn.style.background = action === 'shoot' ? 
                'rgba(239, 68, 68, 0.2)' : 
                'rgba(255, 255, 255, 0.15)';
        });
        
        btn.addEventListener('mouseleave', (e) => {
            game.touchControls[action] = false;
            btn.style.background = action === 'shoot' ? 
                'rgba(239, 68, 68, 0.2)' : 
                'rgba(255, 255, 255, 0.15)';
        });
    });
    
    // é˜²æ­¢å³é”®èœå•
    if (game.canvas) {
        game.canvas.addEventListener('contextmenu', (e) => e.preventDefault());
    }
    
    console.log('âœ… è¾“å…¥æ§åˆ¶åˆå§‹åŒ–å®Œæˆ');
}

// ==================== æ¸¸æˆå¾ªç¯ ====================
let loopFrameCount = 0;
let gameLoopRunning = false;

function gameLoop() {
    loopFrameCount++;
    
    if (!game.isGameActive) {
        console.log('â¸ï¸ æ¸¸æˆæœªæ¿€æ´»ï¼Œåœæ­¢å¾ªç¯');
        gameLoopRunning = false;
        return;
    }
    
    gameLoopRunning = true;
    
    try {
        const currentTime = Date.now();
        const deltaTime = currentTime - (game.lastUpdateTime || currentTime);
        
        // æ¯éš”60å¸§è¾“å‡ºä¸€æ¬¡è°ƒè¯•ä¿¡æ¯
        if (loopFrameCount % 60 === 0) {
            console.log(`ğŸ” gameLoop è¿è¡Œä¸­ï¼Œå¸§: ${loopFrameCount}, ç²’å­: ${game.projectiles.length}`);
        }
        
        // æ›´æ–°æ¸¸æˆçŠ¶æ€
        updateGame(deltaTime);
        
        // æ¸²æŸ“æ¸¸æˆ
        renderGame();
        
        // ç»§ç»­å¾ªç¯
        game.lastUpdateTime = currentTime;
        requestAnimationFrame(gameLoop);
        
    } catch (error) {
        console.error('âŒ gameLoop å‡ºé”™:', error);
        console.error('é”™è¯¯å †æ ˆ:', error.stack);
        gameLoopRunning = false;
        
        // å°è¯•é‡å¯æ¸¸æˆå¾ªç¯
        setTimeout(() => {
            console.log('ğŸ”„ å°è¯•é‡å¯æ¸¸æˆå¾ªç¯...');
            if (game.isGameActive) {
                gameLoop();
            }
        }, 100);
    }
}

// ==================== æ¸¸æˆæ›´æ–°é€»è¾‘ ====================
function updateGame(deltaTime) {
    // æ›´æ–°ç©å®¶
    updatePlayer(game.players.player1, true); // ç©å®¶
    updatePlayer(game.players.player2, false); // å¯¹æ‰‹ï¼ˆAIæˆ–çœŸå®ç©å®¶ï¼‰
    
    // æ›´æ–°å­å¼¹
    updateProjectiles(deltaTime);
    
    // æ£€æŸ¥ç¢°æ’
    checkCollisions();
    
    // å¦‚æœæ˜¯AIå¯¹æ‰‹æ‰æ›´æ–°AI
    if (game.players.player2 && game.players.player2.isAI) {
        updateAI(game.players.player2, deltaTime);
    }
}

function updatePlayer(player, isControlled) {
    if (!player || player.hp <= 0) return;
    
    let dx = 0, dy = 0;
    
    if (isControlled) {
        // ç©å®¶æ§åˆ¶
        if (game.keys['w'] || game.keys['arrowup'] || game.touchControls['up']) dy = -1;
        if (game.keys['s'] || game.keys['arrowdown'] || game.touchControls['down']) dy = 1;
        if (game.keys['a'] || game.keys['arrowleft'] || game.touchControls['left']) dx = -1;
        if (game.keys['d'] || game.keys['arrowright'] || game.touchControls['right']) dx = 1;
        
        // åœæ­¢æŒ‰é’®
        if (game.touchControls['stop']) {
            dx = 0;
            dy = 0;
        }
        
        // å°„å‡»æ§åˆ¶
        const currentTime = Date.now();
        if ((game.keys[' '] || game.touchControls['shoot']) && 
            currentTime - player.lastShot > player.shotCooldown) {
            shootProjectile(player);
            player.lastShot = currentTime;
            
            // å¤šäººæ¸¸æˆï¼šå‘é€å°„å‡»åŠ¨ä½œ
            if (window.MultiplayerGame && window.MultiplayerGame.currentRoom) {
                window.MultiplayerGame.sendAction('shoot', {
                    x: player.x,
                    y: player.y,
                    direction: player.direction
                });
            }
        }
    }
    
    // å½’ä¸€åŒ–å¯¹è§’çº¿ç§»åŠ¨
    if (dx !== 0 && dy !== 0) {
        dx *= 0.7071;
        dy *= 0.7071;
    }
    
    // è®¡ç®—æ–°ä½ç½®
    const newX = player.x + dx * player.speed;
    const newY = player.y + dy * player.speed;
    
    // æ£€æŸ¥å¢™å£ç¢°æ’
    if (!checkWallCollision(newX, player.y, player.radius)) {
        player.x = newX;
    }
    if (!checkWallCollision(player.x, newY, player.radius)) {
        player.y = newY;
    }
    
    // æ›´æ–°æ–¹å‘
    if (dx !== 0 || dy !== 0) {
        player.direction = Math.atan2(dy, dx);
        
        // å¤šäººæ¸¸æˆï¼šå®šæœŸå‘é€ä½ç½®æ›´æ–°
        if (isControlled && window.MultiplayerGame && window.MultiplayerGame.currentRoom) {
            const currentTime = Date.now();
            if (!player.lastPositionUpdate || currentTime - player.lastPositionUpdate > 100) {
                window.MultiplayerGame.sendAction('move', {
                    x: player.x,
                    y: player.y,
                    direction: player.direction
                });
                player.lastPositionUpdate = currentTime;
            }
        }
    }
    
    // é™åˆ¶åœ¨å±å¹•å†…
    player.x = Math.max(player.radius, Math.min(game.width - player.radius, player.x));
    player.y = Math.max(player.radius, Math.min(game.height - player.radius, player.y));
}

function updateAI(aiPlayer, deltaTime) {
    if (!aiPlayer || aiPlayer.hp <= 0) return;
    
    const currentTime = Date.now();
    
    // æ¯2ç§’æ”¹å˜ä¸€æ¬¡æ–¹å‘
    if (currentTime - aiPlayer.aiDirectionChangeTime > 2000) {
        aiPlayer.direction = Math.random() * Math.PI * 2;
        aiPlayer.aiDirectionChangeTime = currentTime;
    }
    
    // ç§»åŠ¨AI
    const aiDx = Math.cos(aiPlayer.direction);
    const aiDy = Math.sin(aiPlayer.direction);
    
    const newAiX = aiPlayer.x + aiDx * aiPlayer.speed * 0.5; // AIé€Ÿåº¦è¾ƒæ…¢
    const newAiY = aiPlayer.y + aiDy * aiPlayer.speed * 0.5;
    
    if (!checkWallCollision(newAiX, aiPlayer.y, aiPlayer.radius)) {
        aiPlayer.x = newAiX;
    }
    if (!checkWallCollision(aiPlayer.x, newAiY, aiPlayer.radius)) {
        aiPlayer.y = newAiY;
    }
    
    // AIéšæœºå°„å‡»
    if (Math.random() < 0.02 && currentTime - aiPlayer.lastShot > aiPlayer.shotCooldown) {
        shootProjectile(aiPlayer);
        aiPlayer.lastShot = currentTime;
    }
}

function checkWallCollision(x, y, radius) {
    const cellX = Math.floor(x / game.cellSize);
    const cellY = Math.floor(y / game.cellSize);
    
    // æ£€æŸ¥å‘¨å›´9ä¸ªæ ¼å­
    for (let dy = -1; dy <= 1; dy++) {
        for (let dx = -1; dx <= 1; dx++) {
            const checkX = cellX + dx;
            const checkY = cellY + dy;
            
            if (checkX >= 0 && checkX < game.mazeCols &&
                checkY >= 0 && checkY < game.mazeRows &&
                game.maze[checkY][checkX] === 1) {
                
                // è®¡ç®—å¢™å£è¾¹ç•Œ
                const wallLeft = checkX * game.cellSize;
                const wallRight = wallLeft + game.cellSize;
                const wallTop = checkY * game.cellSize;
                const wallBottom = wallTop + game.cellSize;
                
                // æ‰¾åˆ°æœ€è¿‘çš„ç‚¹
                const closestX = Math.max(wallLeft, Math.min(x, wallRight));
                const closestY = Math.max(wallTop, Math.min(y, wallBottom));
                
                // è®¡ç®—è·ç¦»
                const distance = Math.sqrt(
                    Math.pow(x - closestX, 2) + Math.pow(y - closestY, 2)
                );
                
                if (distance < radius) {
                    return true;
                }
            }
        }
    }
    return false;
}
</script>
<script>
// ==================== ç²’å­ç³»ç»Ÿ ====================
function shootProjectile(shooter) {
    console.log('ğŸ”« å‘å°„ç²’å­ï¼Œå‘å°„è€…:', shooter === game.players.player1 ? 'ç©å®¶' : 'å¯¹æ‰‹');
    
    const projectile = {
        x: shooter.x,
        y: shooter.y,
        radius: 6,
        color: shooter.color,
        speed: 8,
        direction: shooter.direction,
        dx: Math.cos(shooter.direction) * 8, // ç›´æ¥è®¡ç®—é€Ÿåº¦åˆ†é‡
        dy: Math.sin(shooter.direction) * 8,
        owner: shooter === game.players.player1 ? 'player1' : 'player2',
        bounceCount: 3,
        lifeTime: 5000,
        active: true
    };
    
    game.projectiles.push(projectile);
    console.log('âœ… ç²’å­å·²åˆ›å»ºï¼Œæ–¹å‘:', shooter.direction, 'é€Ÿåº¦åˆ†é‡:', projectile.dx, projectile.dy);
    
    // æ’­æ”¾å°„å‡»éŸ³æ•ˆ
    playSound('shoot');
}

function updateProjectiles(deltaTime) {
    if (!game.isGameActive) return;
    
    for (let i = game.projectiles.length - 1; i >= 0; i--) {
        const p = game.projectiles[i];
        
        if (!p.active) {
            game.projectiles.splice(i, 1);
            continue;
        }
        
        // æ›´æ–°ä½ç½® - ä½¿ç”¨é€Ÿåº¦åˆ†é‡
        p.x += p.dx;
        p.y += p.dy;
        
        // å‡å°‘å¯¿å‘½
        p.lifeTime -= deltaTime;
        if (p.lifeTime <= 0) {
            game.projectiles.splice(i, 1);
            continue;
        }
        
        // æ£€æŸ¥å¢™å£ç¢°æ’
        if (checkWallCollision(p.x, p.y, p.radius)) {
            // è®¡ç®—åå¼¹
            const normal = getWallNormal(p.x, p.y);
            if (normal) {
                // åå°„å…¬å¼: R = V - 2*(VÂ·N)*N
                const dot = p.dx * normal.x + p.dy * normal.y;
                
                // æ›´æ–°é€Ÿåº¦åˆ†é‡
                p.dx = p.dx - 2 * dot * normal.x;
                p.dy = p.dy - 2 * dot * normal.y;
                
                p.bounceCount--;
                
                // æ’­æ”¾éŸ³æ•ˆ
                playSound('bounce');
            }
            
            if (p.bounceCount <= 0) {
                game.projectiles.splice(i, 1);
                continue;
            }
        }
        
        // æ£€æŸ¥æ˜¯å¦é£å‡ºå±å¹•
        if (p.x < -100 || p.x > game.width + 100 || 
            p.y < -100 || p.y > game.height + 100) {
            game.projectiles.splice(i, 1);
        }
    }
}

function getWallNormal(x, y) {
    const cellX = Math.floor(x / game.cellSize);
    const cellY = Math.floor(y / game.cellSize);
    
    for (let dy = -1; dy <= 1; dy++) {
        for (let dx = -1; dx <= 1; dx++) {
            const checkX = cellX + dx;
            const checkY = cellY + dy;
            
            if (checkX >= 0 && checkX < game.mazeCols &&
                checkY >= 0 && checkY < game.mazeRows &&
                game.maze[checkY][checkX] === 1) {
                
                const wallCenterX = (checkX + 0.5) * game.cellSize;
                const wallCenterY = (checkY + 0.5) * game.cellSize;
                
                const dxToCenter = x - wallCenterX;
                const dyToCenter = y - wallCenterY;
                
                // è®¡ç®—æ³•çº¿ï¼ˆä»å¢™å£ä¸­å¿ƒæŒ‡å‘ç¢°æ’ç‚¹ï¼‰
                const distance = Math.sqrt(dxToCenter * dxToCenter + dyToCenter * dyToCenter);
                
                return {
                    x: dxToCenter / distance,
                    y: dyToCenter / distance
                };
            }
        }
    }
    return null;
}

// ==================== ç¢°æ’æ£€æµ‹ ====================
function checkCollisions() {
    // æ£€æŸ¥å­å¼¹ä¸ç©å®¶çš„ç¢°æ’
    for (let i = game.projectiles.length - 1; i >= 0; i--) {
        const p = game.projectiles[i];
        
        for (const [playerKey, player] of Object.entries(game.players)) {
            if (p.owner !== playerKey && player && player.hp > 0) {
                const distance = Math.sqrt(
                    Math.pow(p.x - player.x, 2) + Math.pow(p.y - player.y, 2)
                );
                
                if (distance < p.radius + player.radius) {
                    console.log(`ğŸ’¥ å‡»ä¸­ ${playerKey}ï¼`);
                    
                    // å‡»ä¸­ç©å®¶
                    player.hp -= 25;
                    
                    // æ›´æ–°åˆ†æ•°
                    if (p.owner === 'player1') {
                        game.players.player1.score += 10;
                        game.playerScore = game.players.player1.score;
                    } else {
                        game.players.player2.score += 10;
                        game.opponentScore = game.players.player2.score;
                    }
                    
                    // æ›´æ–°UI
                    updateHealthBars();
                    updateScores();
                    
                    // ç§»é™¤å­å¼¹
                    game.projectiles.splice(i, 1);
                    
                    // æ’­æ”¾å‡»ä¸­éŸ³æ•ˆ
                    playSound('hit');
                    
                    // å¤šäººæ¸¸æˆï¼šå‘é€å‡»ä¸­äº‹ä»¶
                    if (window.MultiplayerGame && window.MultiplayerGame.currentRoom) {
                        if (p.owner === 'player1' && playerKey === 'player2') {
                            // ç©å®¶å‡»ä¸­å¯¹æ‰‹
                            window.MultiplayerGame.sendAction('player_hit', {
                                target: 'player2',
                                damage: 25,
                                hp: game.players.player2.hp
                            });
                        }
                    }
                    
                    // æ£€æŸ¥æ¸¸æˆç»“æŸ
                    if (player.hp <= 0) {
                        player.hp = 0;
                        console.log(`ğŸ® æ¸¸æˆç»“æŸï¼${p.owner === 'player1' ? 'ç©å®¶' : 'å¯¹æ‰‹'}è·èƒœ`);
                        endGame(p.owner === 'player1' ? 'player1' : 'player2');
                    }
                    
                    break;
                }
            }
        }
    }
}

function updateHealthBars() {
    const playerHealthBar = document.getElementById('playerHealthBar');
    const opponentHealthBar = document.getElementById('opponentHealthBar');
    const playerHP = document.getElementById('playerHP');
    const opponentHP = document.getElementById('opponentHP');
    
    if (playerHealthBar && game.players.player1) {
        const percent = (game.players.player1.hp / game.players.player1.maxHp) * 100;
        playerHealthBar.style.width = `${percent}%`;
        if (playerHP) playerHP.textContent = game.players.player1.hp;
    }
    
    if (opponentHealthBar && game.players.player2) {
        const percent = (game.players.player2.hp / game.players.player2.maxHp) * 100;
        opponentHealthBar.style.width = `${percent}%`;
        if (opponentHP) opponentHP.textContent = game.players.player2.hp;
    }
}

function updateScores() {
    const playerScoreElement = document.getElementById('playerScore');
    const opponentScoreElement = document.getElementById('opponentScore');
    
    if (playerScoreElement) {
        playerScoreElement.textContent = game.playerScore;
    }
    
    if (opponentScoreElement) {
        opponentScoreElement.textContent = game.opponentScore;
    }
}

// ==================== æ¸¸æˆè®¡æ—¶å™¨ ====================
function startGameTimer() {
    console.log('â±ï¸ å¯åŠ¨æ¸¸æˆè®¡æ—¶å™¨...');
    
    if (game.gameTimer) {
        clearInterval(game.gameTimer);
    }
    
    game.gameTimer = setInterval(() => {
        if (!game.isGameActive) return;
        
        game.gameTime--;
        const gameTimerElement = document.getElementById('gameTimer');
        if (gameTimerElement) {
            gameTimerElement.textContent = game.gameTime;
        }
        
        if (game.gameTime <= 0) {
            clearInterval(game.gameTimer);
            console.log('â° æ—¶é—´åˆ°ï¼æ¸¸æˆç»“æŸ');
            endGame('timeout');
        }
    }, 1000);
    
    console.log('âœ… æ¸¸æˆè®¡æ—¶å™¨å·²å¯åŠ¨');
}

// ==================== éŸ³æ•ˆç³»ç»Ÿ ====================
function playSound(type) {
    const sounds = {
        shoot: 'ğŸ”« å°„å‡»éŸ³æ•ˆ',
        bounce: 'â†ªï¸ åå¼¹éŸ³æ•ˆ',
        hit: 'ğŸ’¥ å‡»ä¸­éŸ³æ•ˆ',
        win: 'ğŸ† èƒœåˆ©éŸ³æ•ˆ',
        lose: 'ğŸ’€ å¤±è´¥éŸ³æ•ˆ'
    };
    
    console.log(sounds[type] || 'ğŸ”Š éŸ³æ•ˆæ’­æ”¾');
}
</script>
<script>
// ==================== ç¬¬äº”éƒ¨åˆ†ï¼šå¤šäººå®æ—¶å¯¹æˆ˜ç³»ç»Ÿ ====================

const SUPABASE_CONFIG = {
  url: 'https://hxvpzskevjxkjmnsorcu.supabase.co',
  anonKey: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imh4dnB6c2tldmp4a2ptbnNvcmN1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk4MTAyNjgsImV4cCI6MjA4NTM4NjI2OH0.pZRITqs0y2HK2NbOPY8PjAxGniq16hGHBWvgm7VtO2E'
};

// æ¸…ç†æ—§çš„ localStorage ID
function cleanupOldIds() {
  const oldPlayerId = localStorage.getItem('player_id');
  const oldClientId = localStorage.getItem('multiplayer_client_id');
  
  if (oldPlayerId && oldPlayerId.startsWith('player_')) {
    localStorage.removeItem('player_id');
    console.log('æ¸…ç†æ—§çš„ player_id:', oldPlayerId);
  }
  
  if (oldClientId && oldClientId.startsWith('client_')) {
    localStorage.removeItem('multiplayer_client_id');
    console.log('æ¸…ç†æ—§çš„ client_id:', oldClientId);
  }
}

// ç”ŸæˆUUIDå‡½æ•°
function generateUUID() {
  return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
    const r = Math.random() * 16 | 0;
    const v = c === 'x' ? r : (r & 0x3 | 0x8);
    return v.toString(16);
  });
}

// éšæœºç§å­ç”Ÿæˆå™¨ï¼ˆç¡®ä¿å¤šäººæ¸¸æˆè¿·å®«ä¸€è‡´ï¼‰
Math.seedrandom = function(seed) {
  const mask = 0xffffffff;
  let m_w = (typeof seed !== 'undefined') ? seed : new Date().getTime();
  let m_z = 987654321;
  
  return function() {
    m_z = (36969 * (m_z & 65535) + (m_z >> 16)) & mask;
    m_w = (18000 * (m_w & 65535) + (m_w >> 16)) & mask;
    let result = ((m_z << 16) + m_w) & mask;
    result /= 4294967296;
    return result + 0.5;
  };
};

const MultiplayerGame = {
  supabase: null,
  playerId: null,
  clientId: null,
  currentRoom: null,
  playerRole: null,
  mazeSeed: null,
  opponentId: null,
  opponentName: 'æœªçŸ¥å¯¹æ‰‹',
  isMatching: false,
  
  // è¿æ¥çŠ¶æ€
  isConnected: false,
  isInitialized: false,
  heartbeatInterval: null,
  initializationPromise: null,
  
  // æ¸¸æˆçŠ¶æ€åŒæ­¥
  pendingActions: [],
  lastProcessedSequence: 0,
  isPlayerReady: false,
  lastPositionUpdate: 0,
  
  // åˆå§‹åŒ–
  async init() {
    console.log('ğŸ® åˆå§‹åŒ–å¤šäººæ¸¸æˆç³»ç»Ÿ');
    
    // é¿å…é‡å¤åˆå§‹åŒ–
    if (this.isInitialized && this.supabase) {
      console.log('å¤šäººæ¸¸æˆç³»ç»Ÿå·²åˆå§‹åŒ–ï¼Œè·³è¿‡é‡å¤åˆå§‹åŒ–');
      return Promise.resolve();
    }
    
    // å¦‚æœæœ‰æ­£åœ¨è¿›è¡Œçš„åˆå§‹åŒ–ï¼Œè¿”å›è¯¥Promise
    if (this.initializationPromise) {
      console.log('æ­£åœ¨åˆå§‹åŒ–ä¸­ï¼Œç­‰å¾…å®Œæˆ...');
      return this.initializationPromise;
    }
    
    this.initializationPromise = (async () => {
      try {
        // æ¸…ç†æ—§çš„ID
        cleanupOldIds();
        
        // æ£€æŸ¥Supabase SDKæ˜¯å¦å·²åŠ è½½
        if (!window.supabase) {
          await this.loadSupabaseSDK();
        }
        
        // åˆå§‹åŒ–Supabaseå®¢æˆ·ç«¯
        this.supabase = window.supabase.createClient(SUPABASE_CONFIG.url, SUPABASE_CONFIG.anonKey, {
          realtime: {
            params: { eventsPerSecond: 30 }
          }
        });
        
        // ç”Ÿæˆå®¢æˆ·ç«¯ID
        this.clientId = generateUUID();
        console.log('å®¢æˆ·ç«¯ID:', this.clientId);
        localStorage.setItem('multiplayer_client_id', this.clientId);
        
        // è®¾ç½®ç©å®¶IDï¼ˆè®¿å®¢æ¨¡å¼ï¼‰
        this.playerId = this.getPlayerId();
        
        // å¯åŠ¨å¿ƒè·³
        this.startHeartbeat();
        
        // è®¾ç½®å®æ—¶ç›‘å¬
        this.setupRealtimeListeners();
        
        this.isInitialized = true;
        this.isConnected = true;
        console.log('âœ… å¤šäººæ¸¸æˆç³»ç»Ÿåˆå§‹åŒ–å®Œæˆ');
        
        return true;
        
      } catch (error) {
        console.error('åˆå§‹åŒ–å¤±è´¥:', error);
        this.initializationPromise = null;
        throw error;
      }
    })();
    
    return this.initializationPromise;
  },
  
  // è·å–ç©å®¶IDï¼ˆè®¿å®¢æ¨¡å¼ï¼‰
  getPlayerId() {
    let playerId = localStorage.getItem('player_id');
    if (!playerId) {
      playerId = 'player_' + generateUUID();
      localStorage.setItem('player_id', playerId);
    }
    return playerId;
  },
  
  // è·å–ç©å®¶åç§°
  getPlayerName() {
    return 'ç©å®¶_' + this.playerId.substr(-6);
  },
  
  // åŠ è½½SDK
  loadSupabaseSDK() {
    return new Promise((resolve, reject) => {
      if (window.supabase) {
        resolve();
        return;
      }
      
      // æ£€æŸ¥æ˜¯å¦å·²ç»åŠ è½½è¿‡
      const existingScript = document.querySelector('script[src*="supabase-js"]');
      if (existingScript) {
        // ç­‰å¾…SDKåŠ è½½
        const checkInterval = setInterval(() => {
          if (window.supabase) {
            clearInterval(checkInterval);
            resolve();
          }
        }, 100);
        return;
      }
      
      const script = document.createElement('script');
      script.src = 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js';
      script.onload = () => {
        setTimeout(resolve, 100); // ç»™SDKä¸€ç‚¹æ—¶é—´åˆå§‹åŒ–
      };
      script.onerror = reject;
      document.head.appendChild(script);
    });
  },
  
  // ==================== åŒ¹é…ç³»ç»Ÿ ====================
  
  // å¼€å§‹åŒ¹é…
  async startMatchmaking() {
    console.log('ğŸ” å¼€å§‹åŒ¹é…çœŸäººç©å®¶...');
    
    if (!this.supabase) {
      console.error('Supabaseæœªåˆå§‹åŒ–');
      alert('å¤šäººæ¸¸æˆç³»ç»Ÿæœªå°±ç»ªï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•');
      return;
    }
    
    // è®¾ç½®åŒ¹é…çŠ¶æ€
    this.isMatching = true;
    
    try {
      // å…ˆåˆ›å»ºç©å®¶èµ„æ–™
      await this.createGuestProfile();
      
      // æ¸…ç†å¯èƒ½çš„æ—§åŒ¹é…è®°å½•
      await this.supabase
        .from('matchmaking_queue')
        .delete()
        .eq('user_id', this.playerId);
      
      // åŠ å…¥åŒ¹é…é˜Ÿåˆ—
      const { error } = await this.supabase
        .from('matchmaking_queue')
        .insert({
          user_id: this.playerId,
          elo: 1000,
          region: 'asia',
          client_id: this.clientId,
          player_data: {
            username: this.getPlayerName(),
            client_id: this.clientId
          },
          connection_status: 'waiting',
          created_at: new Date().toISOString()
        });
      
      if (error) {
        console.error('åŠ å…¥åŒ¹é…é˜Ÿåˆ—å¤±è´¥:', error);
        throw error;
      }
      
      console.log('âœ… å·²åŠ å…¥åŒ¹é…é˜Ÿåˆ—');
      
      // å¼€å§‹åŒ¹é…å¾ªç¯
      this.matchmakingLoop();
      
    } catch (error) {
      console.error('å¼€å§‹åŒ¹é…å¤±è´¥:', error);
      this.isMatching = false;
      alert('åŒ¹é…å¤±è´¥: ' + error.message);
    }
  },
  
  // åˆ›å»ºè®¿å®¢èµ„æ–™
  async createGuestProfile() {
    try {
      const { error } = await this.supabase
        .from('profiles')
        .upsert({
          id: this.playerId,
          username: this.getPlayerName(),
          elo: 1000,
          total_games: 0,
          wins: 0,
          losses: 0,
          kills: 0,
          deaths: 0,
          accuracy: 0,
          updated_at: new Date().toISOString()
        }, { 
          onConflict: 'id'
        });
      
      if (error) {
        console.log('åˆ›å»ºè®¿å®¢èµ„æ–™å¤±è´¥:', error);
        // éè‡´å‘½é”™è¯¯ï¼Œç»§ç»­
      } else {
        console.log('è®¿å®¢èµ„æ–™åˆ›å»º/æ›´æ–°æˆåŠŸ');
      }
    } catch (error) {
      console.log('åˆ›å»ºè®¿å®¢èµ„æ–™å¼‚å¸¸:', error);
    }
  },
  
  // åŒ¹é…å¾ªç¯
  async matchmakingLoop() {
    console.log('å¼€å§‹åŒ¹é…å¾ªç¯...');
    let matchAttempts = 0;
    const maxAttempts = 30; // æœ€å¤šå°è¯•30ç§’
    
    // å…ˆæ¸…é™¤æ—§çš„æ¸¸æˆä¼šè¯
    try {
      await this.supabase
        .from('game_sessions')
        .delete()
        .or(`player1_id.eq.${this.playerId},player2_id.eq.${this.playerId}`)
        .eq('status', 'waiting');
    } catch (error) {
      console.log('æ¸…ç†æ—§ä¼šè¯å¤±è´¥:', error.message);
    }
    
    const matchInterval = setInterval(async () => {
      if (!this.isMatching) {
        clearInterval(matchInterval);
        console.log('åŒ¹é…å·²å–æ¶ˆ');
        return;
      }
      
      matchAttempts++;
      
      try {
        // å°è¯•åˆ›å»ºæˆ–åŠ å…¥æ¸¸æˆä¼šè¯
        const { data: matchResult, error: matchError } = await this.supabase
          .rpc('find_or_create_match', {
            p_user_id: this.playerId,
            p_client_id: this.clientId,
            p_username: this.getPlayerName()
          });
        
        if (matchError) {
          console.log('åŒ¹é…RPCé”™è¯¯:', matchError.message);
        }
        
        if (matchResult && matchResult.success) {
          const gameSession = matchResult.session;
          
          clearInterval(matchInterval);
          console.log('ğŸ¯ åŒ¹é…æˆåŠŸ!', gameSession);
          
          // è®¾ç½®æ¸¸æˆä¿¡æ¯
          this.currentRoom = gameSession.room_id;
          this.mazeSeed = gameSession.maze_seed || Date.now();
          
          // ç¡®å®šç©å®¶è§’è‰²å’Œå¯¹æ‰‹
          if (gameSession.player1_id === this.playerId) {
            this.playerRole = gameSession.player1_role;
            this.opponentId = gameSession.player2_id;
          } else {
            this.playerRole = gameSession.player2_role;
            this.opponentId = gameSession.player1_id;
          }
          
          // è®¾ç½®å¯¹æ‰‹åç§°
          this.opponentName = gameSession.player1_id === this.playerId ? 
            (gameSession.player2_name || 'å¯¹æ‰‹_' + (this.opponentId ? this.opponentId.substr(-6) : 'æœªçŸ¥')) :
            (gameSession.player1_name || 'å¯¹æ‰‹_' + (this.opponentId ? this.opponentId.substr(-6) : 'æœªçŸ¥'));
          
          // ä¿å­˜ç©å®¶è§’è‰²åˆ°å…¨å±€å˜é‡
          window.playerRole = this.playerRole;
          
          // ä»åŒ¹é…é˜Ÿåˆ—ä¸­ç§»é™¤
          await this.supabase
            .from('matchmaking_queue')
            .delete()
            .eq('user_id', this.playerId);
          
          // åˆ‡æ¢åˆ°æ¸¸æˆå¤§å…
          this.enterLobby(gameSession);
          
        } else if (matchAttempts >= maxAttempts) {
          clearInterval(matchInterval);
          console.log('â° åŒ¹é…è¶…æ—¶');
          
          // æ¸…ç†åŒ¹é…é˜Ÿåˆ—
          await this.cancelMatchmaking();
          
          // æ˜¾ç¤ºè¶…æ—¶æ¶ˆæ¯
          setTimeout(() => {
            if (this.isMatching) {
              alert('åŒ¹é…è¶…æ—¶ï¼Œæ²¡æœ‰æ‰¾åˆ°åˆé€‚çš„å¯¹æ‰‹');
              switchScene('menuScene');
            }
          }, 100);
        }
        
        // æ›´æ–°åŒ¹é…UI
        this.updateMatchmakingUI(matchAttempts);
        
      } catch (error) {
        console.log('åŒ¹é…æ£€æŸ¥é”™è¯¯:', error.message);
      }
    }, 1000); // æ¯ç§’æ£€æŸ¥ä¸€æ¬¡
  },
  
  // æ›´æ–°åŒ¹é…UI
  updateMatchmakingUI(attempts) {
    const timerElement = document.getElementById('matchTimer');
    const progressElement = document.getElementById('matchProgress');
    const statusElement = document.getElementById('matchStatus');
    
    if (timerElement) {
      timerElement.textContent = attempts;
    }
    
    if (progressElement) {
      const progressPercent = Math.min(100, (attempts / 30) * 100);
      progressElement.style.width = `${progressPercent}%`;
    }
    
    if (statusElement) {
      const statuses = [
        "æ‰«æåœ¨çº¿ç©å®¶...",
        "æ£€æŸ¥ç½‘ç»œå»¶è¿Ÿ...",
        "ä¼˜åŒ–åŒ¹é…å‚æ•°...",
        "åˆ†æç©å®¶æ°´å¹³...",
        "å¯»æ‰¾æœ€ä½³å¯¹æ‰‹...",
        "é‡å­çº ç¼ å»ºç«‹ä¸­..."
      ];
      statusElement.textContent = statuses[attempts % statuses.length];
    }
  },
  
  // å–æ¶ˆåŒ¹é…
  async cancelMatchmaking() {
    try {
      this.isMatching = false;
      
      // ä»åŒ¹é…é˜Ÿåˆ—ä¸­ç§»é™¤
      await this.supabase
        .from('matchmaking_queue')
        .delete()
        .eq('user_id', this.playerId);
      
      // æ¸…ç†ç­‰å¾…ä¸­çš„æ¸¸æˆä¼šè¯
      await this.supabase
        .from('game_sessions')
        .delete()
        .or(`player1_id.eq.${this.playerId},player2_id.eq.${this.playerId}`)
        .eq('status', 'waiting');
      
      console.log('âœ… å·²å–æ¶ˆåŒ¹é…');
      
    } catch (error) {
      console.error('å–æ¶ˆåŒ¹é…å¤±è´¥:', error);
    } finally {
      switchScene('menuScene');
    }
  },
  
  // è¿›å…¥æ¸¸æˆå¤§å…
  async enterLobby(gameSession) {
    console.log('ğŸª è¿›å…¥æ¸¸æˆå¤§å…ï¼Œæˆ¿é—´:', this.currentRoom);
    console.log('ç©å®¶è§’è‰²:', this.playerRole, 'å¯¹æ‰‹:', this.opponentId);
    
    // åˆ‡æ¢åˆ°å¤§å…åœºæ™¯
    switchScene('lobbyScene');
    
    // æ›´æ–°UIæ˜¾ç¤ºå¯¹æ‰‹ä¿¡æ¯
    this.updateLobbyUI(gameSession);
    
    // ç›‘å¬å¯¹æ‰‹å‡†å¤‡çŠ¶æ€
    this.listenToOpponentReady();
    
    // ç›‘å¬æ¸¸æˆå¼€å§‹ä¿¡å·
    this.listenToGameStart();
    
    // å‘é€è‡ªå·±çš„å‡†å¤‡çŠ¶æ€ï¼ˆåˆå§‹ä¸ºæœªå‡†å¤‡ï¼‰
    await this.sendPlayerReady(false);
    
    // åˆå§‹åŒ–åŸæœ‰çš„æ¸¸æˆå¤§å…
    if (typeof initializeLobby === 'function') {
      initializeLobby();
    }
    
    // è®¾ç½®ç©å®¶è§’è‰²åˆ°å…¨å±€
    window.playerRole = this.playerRole;
    console.log('ğŸ® è®¾ç½®ç©å®¶è§’è‰²:', window.playerRole);
  },
  
  // æ›´æ–°å¤§å…UI
  updateLobbyUI(gameSession) {
    // è®¾ç½®ç©å®¶è§’è‰²
    const playerRoleElement = document.getElementById('player1Role');
    const opponentRoleElement = document.getElementById('player2Role');
    
    if (playerRoleElement && opponentRoleElement) {
      if (this.playerRole === 'proton') {
        playerRoleElement.textContent = 'è´¨å­ (ä½ )';
        opponentRoleElement.textContent = 'ç”µå­ (å¯¹æ‰‹)';
        
        // æ›´æ–°å¡ç‰‡è¾¹æ¡†é¢œè‰²
        const playerCard = document.getElementById('player1Card');
        const opponentCard = document.getElementById('player2Card');
        if (playerCard) playerCard.style.borderColor = 'var(--primary-blue)';
        if (opponentCard) opponentCard.style.borderColor = 'var(--primary-red)';
        
        // æ›´æ–°ç‰¹æ€§
        const playerTraits = ['player1Trait1', 'player1Trait2', 'player1Trait3'];
        const opponentTraits = ['player2Trait1', 'player2Trait2', 'player2Trait3'];
        
        playerTraits.forEach((id, index) => {
          const el = document.getElementById(id);
          if (el) {
            const traits = ['å¸¦æ­£ç”µè·', 'è“è‰²ç²’å­', 'è´¨é‡è¾ƒå¤§'];
            el.textContent = traits[index];
          }
        });
        
        opponentTraits.forEach((id, index) => {
          const el = document.getElementById(id);
          if (el) {
            const traits = ['å¸¦è´Ÿç”µè·', 'çº¢è‰²ç²’å­', 'è´¨é‡è¾ƒå°'];
            el.textContent = traits[index];
          }
        });
        
      } else {
        playerRoleElement.textContent = 'ç”µå­ (ä½ )';
        opponentRoleElement.textContent = 'è´¨å­ (å¯¹æ‰‹)';
        
        // æ›´æ–°å¡ç‰‡è¾¹æ¡†é¢œè‰²
        const playerCard = document.getElementById('player1Card');
        const opponentCard = document.getElementById('player2Card');
        if (playerCard) playerCard.style.borderColor = 'var(--primary-red)';
        if (opponentCard) opponentCard.style.borderColor = 'var(--primary-blue)';
        
        // æ›´æ–°ç‰¹æ€§
        const playerTraits = ['player1Trait1', 'player1Trait2', 'player1Trait3'];
        const opponentTraits = ['player2Trait1', 'player2Trait2', 'player2Trait3'];
        
        playerTraits.forEach((id, index) => {
          const el = document.getElementById(id);
          if (el) {
            const traits = ['å¸¦è´Ÿç”µè·', 'çº¢è‰²ç²’å­', 'è´¨é‡è¾ƒå°'];
            el.textContent = traits[index];
          }
        });
        
        opponentTraits.forEach((id, index) => {
          const el = document.getElementById(id);
          if (el) {
            const traits = ['å¸¦æ­£ç”µè·', 'è“è‰²ç²’å­', 'è´¨é‡è¾ƒå¤§'];
            el.textContent = traits[index];
          }
        });
      }
    }
    
    // æ›´æ–°å‡†å¤‡æŒ‰é’®é¢œè‰²
    const readyBtn = document.getElementById('player1ReadyBtn');
    if (readyBtn) {
      readyBtn.style.background = this.playerRole === 'proton' ? 'var(--primary-blue)' : 'var(--primary-red)';
    }
  },
  
  // ç›‘å¬å¯¹æ‰‹å‡†å¤‡çŠ¶æ€
  listenToOpponentReady() {
    if (!this.supabase || !this.currentRoom) return;
    
    console.log('ğŸ‘‚ ç›‘å¬å¯¹æ‰‹å‡†å¤‡çŠ¶æ€ï¼Œæˆ¿é—´:', this.currentRoom);
    
    // å…ˆæ¸…ç†æ—§çš„ç›‘å¬
    this.supabase.removeChannel('lobby_updates');
    
    // åˆ›å»ºæ–°çš„é¢‘é“ç›‘å¬
    this.supabase
      .channel(`lobby_updates:${this.currentRoom}`)
      .on('postgres_changes', {
        event: 'INSERT',
        schema: 'public',
        table: 'game_state_updates',
        filter: `room_id=eq.${this.currentRoom}`
      }, (payload) => {
        const action = payload.new;
        
        // åªå¤„ç†å¯¹æ‰‹çš„åŠ¨ä½œ
        if (action.player_id === this.playerId) return;
        
        console.log('æ”¶åˆ°å¯¹æ‰‹åŠ¨ä½œ:', action.action_type, action.action_data);
        
        if (action.action_type === 'player_ready') {
          const isReady = action.action_data.ready;
          console.log('å¯¹æ‰‹å‡†å¤‡çŠ¶æ€:', isReady);
          
          // æ›´æ–°UI
          this.updateOpponentReadyUI(isReady);
          
          // å¦‚æœåŒæ–¹éƒ½å‡†å¤‡ï¼Œå¼€å§‹å€’è®¡æ—¶
          if (isReady && this.isPlayerReady) {
            console.log('ğŸš€ åŒæ–¹å‡†å¤‡å®Œæˆï¼Œå¼€å§‹å€’è®¡æ—¶');
            this.startGameCountdown();
          }
        }
      })
      .subscribe((status) => {
        console.log('å¤§å…ç›‘å¬çŠ¶æ€:', status);
      });
  },
  
  // å‘é€ç©å®¶å‡†å¤‡çŠ¶æ€
  async sendPlayerReady(isReady) {
    this.isPlayerReady = isReady;
    
    if (!this.supabase || !this.currentRoom) {
      console.error('æ— æ³•å‘é€å‡†å¤‡çŠ¶æ€: æœªè¿æ¥æˆ–æœªåœ¨æˆ¿é—´ä¸­');
      return;
    }
    
    try {
      const { error } = await this.supabase
        .from('game_state_updates')
        .insert({
          room_id: this.currentRoom,
          player_id: this.playerId,
          action_type: 'player_ready',
          action_data: { ready: isReady },
          created_at: new Date().toISOString()
        });
      
      if (error) throw error;
      
      console.log('å‡†å¤‡çŠ¶æ€å·²å‘é€:', isReady);
      
      // æ›´æ–°è‡ªå·±çš„UI
      this.updatePlayerReadyUI(isReady);
      
    } catch (error) {
      console.error('å‘é€å‡†å¤‡çŠ¶æ€å¤±è´¥:', error);
    }
  },
  
  // æ›´æ–°ç©å®¶å‡†å¤‡UI
  updatePlayerReadyUI(isReady) {
    const statusDot = document.getElementById('player1StatusDot');
    const statusText = document.getElementById('player1StatusText');
    const readyBtn = document.getElementById('player1ReadyBtn');
    
    if (statusDot && statusText) {
      if (isReady) {
        statusDot.style.background = '#10b981';
        statusText.textContent = 'å·²å‡†å¤‡';
        if (readyBtn) readyBtn.textContent = 'å–æ¶ˆå‡†å¤‡';
      } else {
        statusDot.style.background = '#64748b';
        statusText.textContent = 'æœªå‡†å¤‡';
        if (readyBtn) {
          readyBtn.textContent = 'ç‚¹å‡»å‡†å¤‡';
          readyBtn.style.background = this.playerRole === 'proton' ? 'var(--primary-blue)' : 'var(--primary-red)';
        }
      }
    }
  },
  
  // æ›´æ–°å¯¹æ‰‹å‡†å¤‡UI
  updateOpponentReadyUI(isReady) {
    const statusDot = document.getElementById('player2StatusDot');
    const statusText = document.getElementById('player2StatusText');
    const actionText = document.getElementById('opponentAction');
    
    if (statusDot && statusText && actionText) {
      if (isReady) {
        statusDot.style.background = '#10b981';
        statusText.textContent = 'å·²å‡†å¤‡';
        actionText.textContent = 'å¯¹æ‰‹å·²å‡†å¤‡ï¼';
      } else {
        statusDot.style.background = '#64748b';
        statusText.textContent = 'æœªå‡†å¤‡';
        actionText.textContent = 'ç­‰å¾…å¯¹æ‰‹å‡†å¤‡...';
      }
    }
  },
  
  // ç›‘å¬æ¸¸æˆå¼€å§‹ä¿¡å·
  listenToGameStart() {
    if (!this.supabase || !this.currentRoom) return;
    
    console.log('ğŸ‘‚ ç›‘å¬æ¸¸æˆå¼€å§‹ä¿¡å·');
    
    // æ¸…ç†æ—§çš„ç›‘å¬
    this.supabase.removeChannel('game_start_listener');
    
    this.supabase
      .channel(`game_start_listener:${this.currentRoom}`)
      .on('postgres_changes', {
        event: 'UPDATE',
        schema: 'public',
        table: 'game_sessions',
        filter: `room_id=eq.${this.currentRoom}`
      }, (payload) => {
        const session = payload.new;
        console.log('æ¸¸æˆä¼šè¯æ›´æ–°:', session.status);
        
        if (session.status === 'active') {
          console.log('æ¸¸æˆä¼šè¯å·²æ¿€æ´»ï¼Œå¼€å§‹æ¸¸æˆ');
          this.startMultiplayerGame();
        }
      })
      .subscribe();
  },
  
  // å¼€å§‹æ¸¸æˆå€’è®¡æ—¶
  startGameCountdown() {
    console.log('ğŸš€ åŒæ–¹å·²å‡†å¤‡ï¼Œå¼€å§‹æ¸¸æˆå€’è®¡æ—¶');
    
    // æ˜¾ç¤ºå€’è®¡æ—¶UI
    const countdownElement = document.getElementById('lobbyCountdown');
    const countdownNumber = document.getElementById('countdownNumber');
    
    if (countdownElement) {
      countdownElement.style.display = 'block';
    }
    
    let countdown = 5;
    
    const countdownInterval = setInterval(() => {
      if (countdownNumber) {
        countdownNumber.textContent = countdown;
      }
      
      countdown--;
      
      if (countdown < 0) {
        clearInterval(countdownInterval);
        this.activateGameSession();
      }
    }, 1000);
  },
  
  // æ¿€æ´»æ¸¸æˆä¼šè¯
  async activateGameSession() {
    console.log('ğŸ® æ¿€æ´»æ¸¸æˆä¼šè¯');
    
    try {
      // æ›´æ–°æ¸¸æˆä¼šè¯çŠ¶æ€ä¸ºactive
      const { error } = await this.supabase
        .from('game_sessions')
        .update({ 
          status: 'active',
          started_at: new Date().toISOString()
        })
        .eq('room_id', this.currentRoom);
      
      if (error) throw error;
      
      console.log('âœ… æ¸¸æˆä¼šè¯å·²æ¿€æ´»');
      
    } catch (error) {
      console.error('æ¿€æ´»æ¸¸æˆä¼šè¯å¤±è´¥:', error);
      // å°è¯•ç›´æ¥å¼€å§‹æ¸¸æˆ
      setTimeout(() => {
        this.startMultiplayerGame();
      }, 500);
    }
  },
  
  // å¼€å§‹å¤šäººæ¸¸æˆ
  async startMultiplayerGame() {
    console.log('ğŸ® å¼€å§‹å¤šäººæ¸¸æˆ');
    
    try {
      // ç¡®ä¿æ¸¸æˆä¼šè¯çŠ¶æ€æ˜¯æœ€æ–°çš„
      const { data: session, error } = await this.supabase
        .from('game_sessions')
        .select('*')
        .eq('room_id', this.currentRoom)
        .single();
      
      if (error) throw error;
      
      if (session.status !== 'active') {
        console.log('æ¸¸æˆä¼šè¯çŠ¶æ€ä¸æ˜¯activeï¼Œç­‰å¾…...');
        setTimeout(() => this.startMultiplayerGame(), 500);
        return;
      }
      
      // åˆ‡æ¢åˆ°æ¸¸æˆåœºæ™¯
      switchScene('gameScene');
      
      // åˆå§‹åŒ–æ¸¸æˆï¼ˆä½¿ç”¨ç›¸åŒçš„è¿·å®«ç§å­ï¼‰
      this.initializeMultiplayerGame(session);
      
      // å¼€å§‹æ¸¸æˆçŠ¶æ€åŒæ­¥
      this.startGameSync();
      
    } catch (error) {
      console.error('å¼€å§‹æ¸¸æˆå¤±è´¥:', error);
      // å°è¯•ç›´æ¥åˆå§‹åŒ–æ¸¸æˆ
      setTimeout(() => {
        this.initializeMultiplayerGame();
        this.startGameSync();
      }, 500);
    }
  },
  
  // åˆå§‹åŒ–å¤šäººæ¸¸æˆ
  initializeMultiplayerGame(session = null) {
    console.log('ğŸ® åˆå§‹åŒ–å¤šäººæ¸¸æˆ - å®¢æˆ·ç«¯:', this.clientId);
    
    // è®¾ç½®ç©å®¶è§’è‰²
    if (!window.playerRole && this.playerRole) {
      window.playerRole = this.playerRole;
    }
    
    console.log('ç©å®¶è§’è‰²è®¾ç½®ä¸º:', window.playerRole);
    
    // è®¾ç½®è¿·å®«ç§å­
    if (session && session.maze_seed) {
      this.mazeSeed = session.maze_seed;
    } else if (this.mazeSeed) {
      // ä½¿ç”¨å·²æœ‰çš„ç§å­
    } else {
      this.mazeSeed = Date.now();
    }
    
    // è®¾ç½®æ¸¸æˆå¯¹è±¡ä¸­çš„ç§å­
    if (window.game) {
      window.game.mazeSeed = this.mazeSeed;
    }
    
    console.log('è¿·å®«ç§å­:', this.mazeSeed);
    
    // ç¡®ä¿æ¸¸æˆå¼•æ“å·²å‡†å¤‡
    if (!window.game) {
      console.error('æ¸¸æˆå¼•æ“æœªåˆå§‹åŒ–');
      return;
    }
    
    // è®¾ç½®å¯¹æ‰‹ä¸æ˜¯AI
    if (window.game.players && window.game.players.player2) {
      window.game.players.player2.isAI = false;
    }
    
    // å»¶è¿Ÿä¸€ç‚¹æ—¶é—´ç¡®ä¿UIå·²åˆ‡æ¢
    setTimeout(() => {
      console.log('ğŸš€ å¼ºåˆ¶åˆå§‹åŒ–æ¸¸æˆ...');
      if (typeof window.initializeGame === 'function') {
        try {
          window.initializeGame();
        } catch (error) {
          console.error('initializeGameè°ƒç”¨å¤±è´¥:', error);
          // å°è¯•ç›´æ¥å¯åŠ¨æ¸¸æˆå¾ªç¯
          if (window.gameLoop && typeof window.gameLoop === 'function') {
            window.requestAnimationFrame(window.gameLoop);
          }
        }
      } else {
        console.error('æ‰¾ä¸åˆ° initializeGame å‡½æ•°');
        alert('æ¸¸æˆåˆå§‹åŒ–å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•');
      }
    }, 300);
  },
  
  // ==================== æ¸¸æˆçŠ¶æ€åŒæ­¥ ====================
  
  // å¼€å§‹æ¸¸æˆåŒæ­¥
  startGameSync() {
    console.log('ğŸ”„ å¼€å§‹æ¸¸æˆçŠ¶æ€åŒæ­¥');
    
    // ç›‘å¬å¯¹æ‰‹åŠ¨ä½œ
    this.listenToOpponentActions();
    
    // å¼€å§‹å‘é€æœ¬åœ°åŠ¨ä½œ
    this.startSendingActions();
  },
  
  // ç›‘å¬å¯¹æ‰‹åŠ¨ä½œ
  listenToOpponentActions() {
    if (!this.supabase || !this.currentRoom) {
      console.error('æ— æ³•ç›‘å¬å¯¹æ‰‹åŠ¨ä½œ: æœªè¿æ¥æˆ–æœªåœ¨æˆ¿é—´ä¸­');
      return;
    }
    
    console.log('ğŸ‘‚ ç›‘å¬å¯¹æ‰‹åŠ¨ä½œï¼Œæˆ¿é—´:', this.currentRoom);
    
    // æ¸…ç†æ—§çš„ç›‘å¬
    this.supabase.removeChannel('game_actions');
    
    // åˆ›å»ºæ–°çš„æ¸¸æˆåŠ¨ä½œç›‘å¬é¢‘é“
    this.supabase
      .channel(`game_actions:${this.currentRoom}`)
      .on('postgres_changes', {
        event: 'INSERT',
        schema: 'public',
        table: 'game_state_updates',
        filter: `room_id=eq.${this.currentRoom}`
      }, async (payload) => {
        const action = payload.new;
        
        // å¿½ç•¥è‡ªå·±çš„åŠ¨ä½œ
        if (action.player_id === this.playerId) return;
        
        console.log('æ”¶åˆ°å¯¹æ‰‹æ¸¸æˆåŠ¨ä½œ:', action.action_type, action.action_data);
        
        // å¤„ç†å¯¹æ‰‹åŠ¨ä½œ
        await this.processOpponentAction(action);
      })
      .subscribe((status) => {
        console.log('æ¸¸æˆåŠ¨ä½œç›‘å¬çŠ¶æ€:', status);
      });
  },
  
  // å¤„ç†å¯¹æ‰‹åŠ¨ä½œ
  async processOpponentAction(action) {
    if (!window.game || !window.game.isGameActive) {
      console.log('æ¸¸æˆæœªæ¿€æ´»ï¼Œå¿½ç•¥å¯¹æ‰‹åŠ¨ä½œ');
      return;
    }
    
    console.log('å¤„ç†å¯¹æ‰‹åŠ¨ä½œ:', action.action_type, action.action_data);
    
    try {
      switch (action.action_type) {
        case 'move':
          await this.updateOpponentPosition(action.action_data);
          break;
        case 'shoot':
          await this.createOpponentProjectile(action.action_data);
          break;
        case 'player_hit':
          await this.handlePlayerHit(action.action_data);
          break;
        case 'game_over':
          await this.handleGameOver(action.action_data);
          break;
      }
      
      // æ ‡è®°ä¸ºå·²å¤„ç†ï¼ˆå¯é€‰ï¼‰
      try {
        await this.supabase
          .from('game_state_updates')
          .update({ processed: true })
          .eq('id', action.id);
      } catch (error) {
        console.error('æ ‡è®°åŠ¨ä½œä¸ºå·²å¤„ç†å¤±è´¥:', error);
      }
      
    } catch (error) {
      console.error('å¤„ç†å¯¹æ‰‹åŠ¨ä½œå¤±è´¥:', error);
    }
  },
  
  // æ›´æ–°å¯¹æ‰‹ä½ç½®
  async updateOpponentPosition(position) {
    if (!window.game || !window.game.players || !window.game.players.player2) {
      console.log('æ¸¸æˆæˆ–å¯¹æ‰‹æœªåˆå§‹åŒ–ï¼Œå¿½ç•¥ä½ç½®æ›´æ–°');
      return;
    }
    
    // å¹³æ»‘æ’å€¼æ›´æ–°ä½ç½®
    const opponent = window.game.players.player2;
    const targetX = position.x;
    const targetY = position.y;
    const targetDirection = position.direction;
    
    // ç®€å•ç›´æ¥è®¾ç½®ä½ç½®ï¼ˆå¯ä»¥æ”¹ä¸ºæ’å€¼å®ç°å¹³æ»‘ç§»åŠ¨ï¼‰
    opponent.x = targetX;
    opponent.y = targetY;
    opponent.direction = targetDirection;
    
    // æ ‡è®°å¯¹æ‰‹ä¸ºçœŸå®ç©å®¶ï¼ˆä¸æ˜¯AIï¼‰
    opponent.isAI = false;
    
    console.log('æ›´æ–°å¯¹æ‰‹ä½ç½®:', { x: targetX, y: targetY, direction: targetDirection });
  },
  
  // åˆ›å»ºå¯¹æ‰‹å­å¼¹
  async createOpponentProjectile(projectileData) {
    if (!window.game || !window.game.projectiles) {
      console.log('æ¸¸æˆæˆ–å­å¼¹æ•°ç»„æœªåˆå§‹åŒ–');
      return;
    }
    
    const projectile = {
      x: projectileData.x,
      y: projectileData.y,
      radius: 6,
      color: this.playerRole === 'proton' ? '#ef4444' : '#3b82f6', // å¯¹æ‰‹é¢œè‰²ä¸ç©å®¶ç›¸å
      speed: 8,
      direction: projectileData.direction,
      dx: Math.cos(projectileData.direction) * 8,
      dy: Math.sin(projectileData.direction) * 8,
      owner: 'player2', // å¯¹æ‰‹çš„å­å¼¹
      bounceCount: 3,
      lifeTime: 5000,
      active: true
    };
    
    window.game.projectiles.push(projectile);
    console.log('åˆ›å»ºå¯¹æ‰‹å­å¼¹:', projectile);
  },
  
  // å¤„ç†ç©å®¶è¢«å‡»ä¸­
  async handlePlayerHit(hitData) {
    if (!window.game || !window.game.players || !window.game.players.player1) {
      return;
    }
    
    const player = window.game.players.player1;
    const damage = hitData.damage || 25;
    
    // åº”ç”¨ä¼¤å®³
    player.hp = Math.max(0, player.hp - damage);
    
    console.log(`ç©å®¶è¢«å‡»ä¸­ï¼Œä¼¤å®³: ${damage}, å‰©ä½™HP: ${player.hp}`);
    
    // æ›´æ–°UI
    if (typeof window.updateHealthBars === 'function') {
      window.updateHealthBars();
    }
    
    // æ›´æ–°åˆ†æ•°æ˜¾ç¤º
    if (window.game && window.game.opponentScore !== undefined) {
      window.game.opponentScore += 10; // å¯¹æ‰‹å¾—åˆ†
      if (typeof window.updateScores === 'function') {
        window.updateScores();
      }
    }
    
    // æ£€æŸ¥æ¸¸æˆç»“æŸ
    if (player.hp <= 0) {
      player.hp = 0;
      console.log('ç©å®¶è¢«å‡»è´¥ï¼');
      
      if (window.game) {
        window.game.isGameActive = false;
        
        // è°ƒç”¨æ¸¸æˆç»“æŸ
        if (typeof window.endGame === 'function') {
          window.endGame('player2'); // å¯¹æ‰‹èƒœåˆ©
        }
      }
    }
  },
  
  // å¤„ç†æ¸¸æˆç»“æŸ
  async handleGameOver(result) {
    console.log('æ”¶åˆ°æ¸¸æˆç»“æŸä¿¡å·:', result);
    
    if (window.game) {
      window.game.isGameActive = false;
      
      // è°ƒç”¨ç°æœ‰çš„æ¸¸æˆç»“æŸå‡½æ•°
      if (typeof window.endGame === 'function') {
        window.endGame(result.winner);
      }
    }
  },
  
  // å¼€å§‹å‘é€æœ¬åœ°åŠ¨ä½œ
  startSendingActions() {
    console.log('ğŸ“¤ å¼€å§‹å‘é€æœ¬åœ°åŠ¨ä½œ');
    
    // æ‹¦æˆªåŸæœ‰çš„æ¸¸æˆæ›´æ–°é€»è¾‘
    this.interceptGameActions();
    
    // å®šæœŸå‘é€ä½ç½®æ›´æ–°
    this.positionUpdateInterval = setInterval(() => {
      if (!window.game || !window.game.isGameActive || !window.game.players || !window.game.players.player1) {
        return;
      }
      
      const player = window.game.players.player1;
      const currentTime = Date.now();
      
      // æ¯100mså‘é€ä¸€æ¬¡ä½ç½®ï¼Œæˆ–è€…å½“ä½ç½®å˜åŒ–è¾ƒå¤§æ—¶
      if (currentTime - this.lastPositionUpdate > 100) {
        this.sendAction('move', {
          x: player.x,
          y: player.y,
          direction: player.direction,
          hp: player.hp,
          timestamp: currentTime
        });
        this.lastPositionUpdate = currentTime;
      }
    }, 100);
  },
  
  // æ‹¦æˆªæ¸¸æˆåŠ¨ä½œ
  interceptGameActions() {
    console.log('ğŸ”„ æ‹¦æˆªæ¸¸æˆåŠ¨ä½œ');
    
    // ä¿å­˜åŸå§‹å‡½æ•°
    const originalShootProjectile = window.shootProjectile;
    
    // é‡å†™å°„å‡»å‡½æ•°
    if (originalShootProjectile) {
      window.shootProjectile = (shooter) => {
        // è°ƒç”¨åŸå§‹å‡½æ•°
        originalShootProjectile(shooter);
        
        // å‘é€å°„å‡»åŠ¨ä½œåˆ°æœåŠ¡å™¨ï¼ˆåªæœ‰ç©å®¶è‡ªå·±å°„å‡»æ—¶æ‰å‘é€ï¼‰
        if (window.game && shooter === window.game.players.player1) {
          this.sendAction('shoot', {
            x: shooter.x,
            y: shooter.y,
            direction: shooter.direction,
            timestamp: Date.now()
          });
        }
      };
    }
    
    // é‡å†™æ¸¸æˆç»“æŸå‡½æ•°
    const originalEndGame = window.endGame;
    if (originalEndGame) {
      window.endGame = (winner) => {
        // å‘é€æ¸¸æˆç»“æŸä¿¡å·
        if (this.currentRoom && winner !== 'timeout') {
          this.sendAction('game_over', {
            winner: winner,
            playerScore: window.game?.playerScore || 0,
            opponentScore: window.game?.opponentScore || 0,
            timestamp: Date.now()
          });
        }
        
        // è°ƒç”¨åŸå§‹å‡½æ•°
        originalEndGame(winner);
      };
    }
  },
  
  // å‘é€åŠ¨ä½œ
  async sendAction(actionType, actionData) {
    if (!this.supabase || !this.currentRoom) {
      console.log('æ— æ³•å‘é€åŠ¨ä½œ: æœªè¿æ¥æˆ–æœªåœ¨æˆ¿é—´ä¸­');
      return;
    }
    
    try {
      const { error } = await this.supabase
        .from('game_state_updates')
        .insert({
          room_id: this.currentRoom,
          player_id: this.playerId,
          action_type: actionType,
          action_data: actionData,
          created_at: new Date().toISOString()
        });
      
      if (error) {
        console.error('å‘é€åŠ¨ä½œå¤±è´¥:', error);
        // å¦‚æœè¿æ¥å¤±è´¥ï¼Œå°è¯•é‡æ–°è¿æ¥
        if (error.message.includes('JWT') || error.message.includes('auth')) {
          this.isConnected = false;
          this.reconnect();
        }
      } else {
        console.log(`åŠ¨ä½œå·²å‘é€: ${actionType}`);
      }
    } catch (error) {
      console.error('å‘é€åŠ¨ä½œå¼‚å¸¸:', error);
    }
  },
  
  // å‘é€æ¸¸æˆç»“æŸ
  async sendGameOver(winner) {
    await this.sendAction('game_over', {
      winner: winner,
      playerScore: window.game?.playerScore || 0,
      opponentScore: window.game?.opponentScore || 0,
      timestamp: Date.now()
    });
  },
  
  // ==================== å·¥å…·å‡½æ•° ====================
  
  // å¯åŠ¨å¿ƒè·³
  startHeartbeat() {
    // å…ˆæ¸…é™¤æ—§çš„å¿ƒè·³
    if (this.heartbeatInterval) {
      clearInterval(this.heartbeatInterval);
    }
  
    this.heartbeatInterval = setInterval(async () => {
      try {
        // åªæœ‰åœ¨åŒ¹é…ä¸­æˆ–æ¸¸æˆä¸­æœ‰æˆ¿é—´æ—¶æ‰å‘é€å¿ƒè·³
        if ((this.currentRoom || this.isMatching) && this.supabase) {
          await this.supabase.rpc('update_player_heartbeat', {
            p_player_id: this.playerId,
            p_client_id: this.clientId,
            p_room_id: this.currentRoom || null
          });
        
          this.isConnected = true;
        } else {
          // ä¸åœ¨åŒ¹é…æˆ–æ¸¸æˆä¸­ï¼Œä¸å‘å¿ƒè·³
          this.isConnected = false;
        }
      } catch (error) {
        console.error('å¿ƒè·³å¤±è´¥:', error);
        this.isConnected = false;
        
        // å¦‚æœå¿ƒè·³å¤±è´¥ï¼Œå°è¯•é‡æ–°è¿æ¥
        if (error.message.includes('JWT expired') || error.message.includes('Not authorized')) {
          this.reconnect();
        }
      }
    }, 10000); // æ¯10ç§’ä¸€æ¬¡
  },
  
  // é‡æ–°è¿æ¥
  async reconnect() {
    console.log('ğŸ”„ å°è¯•é‡æ–°è¿æ¥...');
    
    this.isConnected = false;
    this.isInitialized = false;
    
    try {
      // é‡æ–°åˆå§‹åŒ–
      await this.init();
      
      // å¦‚æœä¹‹å‰æ­£åœ¨åŒ¹é…ï¼Œé‡æ–°åŠ å…¥åŒ¹é…
      if (this.isMatching && !this.currentRoom) {
        console.log('é‡æ–°åŠ å…¥åŒ¹é…...');
        this.startMatchmaking();
      }
      
      // å¦‚æœä¹‹å‰æ­£åœ¨æ¸¸æˆä¸­ï¼Œå°è¯•é‡æ–°åŠ å…¥æˆ¿é—´
      else if (this.currentRoom) {
        console.log('å°è¯•é‡æ–°åŠ å…¥æ¸¸æˆæˆ¿é—´:', this.currentRoom);
        this.listenToOpponentActions();
        this.listenToOpponentReady();
      }
      
    } catch (error) {
      console.error('é‡æ–°è¿æ¥å¤±è´¥:', error);
    }
  },
  
  // è®¾ç½®å®æ—¶ç›‘å¬
  setupRealtimeListeners() {
    console.log('ğŸ‘‚ è®¾ç½®å®æ—¶ç›‘å¬å™¨');
    
    // ç›‘å¬è¿æ¥çŠ¶æ€å˜åŒ–
    this.supabase.realtime.onOpen(() => {
      console.log('âœ… Supabaseå®æ—¶è¿æ¥å·²å»ºç«‹');
      this.isConnected = true;
    });
    
    this.supabase.realtime.onClose(() => {
      console.log('âš ï¸ Supabaseå®æ—¶è¿æ¥å·²å…³é—­');
      this.isConnected = false;
    });
    
    this.supabase.realtime.onError((error) => {
      console.error('âŒ Supabaseå®æ—¶è¿æ¥é”™è¯¯:', error);
      this.isConnected = false;
    });
  },
  
  // æ¸…ç†èµ„æº
  cleanup() {
    console.log('ğŸ§¹ æ¸…ç†å¤šäººæ¸¸æˆèµ„æº');
    
    if (this.heartbeatInterval) {
      clearInterval(this.heartbeatInterval);
      this.heartbeatInterval = null;
    }
    
    if (this.positionUpdateInterval) {
      clearInterval(this.positionUpdateInterval);
      this.positionUpdateInterval = null;
    }
    
    if (this.supabase) {
      this.supabase.removeAllChannels();
    }
    
    this.isConnected = false;
    this.isInitialized = false;
    this.currentRoom = null;
    this.isMatching = false;
    this.initializationPromise = null;
  }
};

// å…¨å±€å¯¼å‡º
window.MultiplayerGame = MultiplayerGame;

// ==================== ä¿®æ”¹åŸæœ‰çš„ togglePlayerReady å‡½æ•°ä»¥æ”¯æŒå¤šäººæ¸¸æˆ ====================

// ä¿å­˜åŸå§‹å‡½æ•°
const originalTogglePlayerReady = window.togglePlayerReady;

// é‡å†™å‡½æ•°
window.togglePlayerReady = function() {
  // æ£€æŸ¥æ˜¯å¦åœ¨å¤šäººæ¸¸æˆæ¨¡å¼
  if (window.MultiplayerGame && window.MultiplayerGame.currentRoom) {
    console.log('å¤šäººæ¸¸æˆæ¨¡å¼: åˆ‡æ¢å‡†å¤‡çŠ¶æ€');
    
    const readyBtn = document.getElementById('player1ReadyBtn');
    if (!readyBtn) return;
    
    // æ ¹æ®æŒ‰é’®æ–‡æœ¬åˆ¤æ–­å½“å‰çŠ¶æ€
    const isReady = readyBtn.textContent === 'ç‚¹å‡»å‡†å¤‡';
    
    if (isReady) {
      readyBtn.textContent = 'å–æ¶ˆå‡†å¤‡';
      readyBtn.style.background = '#64748b';
      
      // å‘é€å‡†å¤‡çŠ¶æ€
      window.MultiplayerGame.sendPlayerReady(true);
    } else {
      readyBtn.textContent = 'ç‚¹å‡»å‡†å¤‡';
      readyBtn.style.background = window.playerRole === 'proton' ? 'var(--primary-blue)' : 'var(--primary-red)';
      
      // å‘é€å–æ¶ˆå‡†å¤‡çŠ¶æ€
      window.MultiplayerGame.sendPlayerReady(false);
    }
  } else {
    // å•äººæ¸¸æˆæ¨¡å¼ï¼Œè°ƒç”¨åŸæœ‰å‡½æ•°
    console.log('å•äººæ¸¸æˆæ¨¡å¼: åˆ‡æ¢å‡†å¤‡çŠ¶æ€');
    if (originalTogglePlayerReady) {
      originalTogglePlayerReady();
    }
  }
};

// ==================== é¡µé¢åŠ è½½åˆå§‹åŒ– ====================

// ä¿®æ”¹é¡µé¢åŠ è½½å®Œæˆåçš„åˆå§‹åŒ–
document.addEventListener('DOMContentLoaded', function() {
  console.log('âœ… DOMåŠ è½½å®Œæˆ');
  
  // åˆå§‹æ¨ªå±æ£€æŸ¥
  if (typeof checkOrientation === 'function') {
    checkOrientation();
  }
  
  // æ¸…ç†æ—§çš„ID
  cleanupOldIds();
  
  // åˆå§‹åŒ– MultiplayerGame å¯¹è±¡åˆ°å…¨å±€
  window.MultiplayerGame = MultiplayerGame;
  
  // ç§»åŠ¨è®¾å¤‡ç‰¹æ®Šå¤„ç†
  const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
  
  if (isMobile) {
    console.log('ğŸ“± ç§»åŠ¨è®¾å¤‡æ£€æµ‹åˆ°ï¼Œå¯ç”¨æ¨ªå±æ¨¡å¼');
    
    // æ·»åŠ è§¦æ‘¸äº‹ä»¶æ”¯æŒ
    document.addEventListener('touchmove', function(e) {
      if (e.scale !== 1) {
        e.preventDefault();
      }
    }, { passive: false });
    
    // ç§»åŠ¨è®¾å¤‡é»˜è®¤æ˜¾ç¤ºç§»åŠ¨æ§åˆ¶æŒ‰é’®
    const mobileControls = document.getElementById('mobileControls');
    if (mobileControls) {
      mobileControls.style.display = 'flex';
    }
  }
  
  // é˜»æ­¢ç§»åŠ¨ç«¯åŒå‡»ç¼©æ”¾
  let lastTouchEnd = 0;
  document.addEventListener('touchend', function(event) {
    const now = Date.now();
    if (now - lastTouchEnd <= 300) {
      event.preventDefault();
    }
    lastTouchEnd = now;
  }, false);
  
  // æ¨¡æ‹Ÿåœ¨çº¿ç©å®¶æ•°æ›´æ–°
  setInterval(() => {
    const onlineCount = document.getElementById('onlineCount');
    const dailyMatches = document.getElementById('dailyMatches');
    const matchSpeed = document.getElementById('matchSpeed');
    
    if (onlineCount) {
      const current = parseInt(onlineCount.textContent) || 128;
      const change = Math.floor(Math.random() * 11) - 5;
      onlineCount.textContent = Math.max(100, current + change);
    }
    
    if (dailyMatches) {
      const current = parseInt(dailyMatches.textContent) || 892;
      dailyMatches.textContent = current + Math.floor(Math.random() * 10);
    }
    
    if (matchSpeed) {
      const speeds = ['2.8s', '3.0s', '3.2s', '3.5s', '3.8s'];
      matchSpeed.textContent = speeds[Math.floor(Math.random() * speeds.length)];
    }
    
  }, 5000);
  
  console.log('ğŸ® æ¸¸æˆåˆå§‹åŒ–å®Œæˆï¼Œå¯ä»¥å¼€å§‹æ¸¸æˆï¼');
});

// æ·»åŠ çª—å£å…³é—­æ—¶çš„æ¸…ç†
window.addEventListener('beforeunload', function() {
  if (window.MultiplayerGame) {
    window.MultiplayerGame.cleanup();
  }
});

// æ·»åŠ æµ‹è¯•è¿æ¥æŒ‰é’®
function addTestButtons() {
  const menuContent = document.querySelector('.menu-content');
  if (menuContent) {
    const testButton = document.createElement('button');
    testButton.className = 'btn btn-secondary';
    testButton.innerHTML = '<span>ğŸ§ª</span> æµ‹è¯•è¿æ¥';
    testButton.onclick = testMultiplayerConnection;
    testButton.style.marginTop = '1rem';
    
    const btnGroup = menuContent.querySelector('.btn-group');
    if (btnGroup) {
      btnGroup.appendChild(testButton);
    }
  }
}

async function testMultiplayerConnection() {
  try {
    alert('æ­£åœ¨æµ‹è¯•å¤šäººæ¸¸æˆè¿æ¥...');
    
    if (!window.MultiplayerGame.supabase) {
      alert('æ­£åœ¨åˆå§‹åŒ–å¤šäººæ¸¸æˆç³»ç»Ÿ...');
      await window.MultiplayerGame.init();
    }
    
    // æµ‹è¯•ç®€å•çš„æŸ¥è¯¢
    const { data, error } = await window.MultiplayerGame.supabase
      .from('profiles')
      .select('count')
      .limit(1);
    
    if (error) throw error;
    
    alert('âœ… å¤šäººæ¸¸æˆè¿æ¥æµ‹è¯•æˆåŠŸï¼\nå¯ä»¥å¼€å§‹åŒ¹é…çœŸäººç©å®¶äº†ã€‚\n\nå½“å‰è¿æ¥çŠ¶æ€: ' + (window.MultiplayerGame.isConnected ? 'å·²è¿æ¥' : 'æœªè¿æ¥'));
    
  } catch (error) {
    alert('âŒ è¿æ¥æµ‹è¯•å¤±è´¥: ' + error.message + '\n\nè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥æˆ–åˆ·æ–°é¡µé¢é‡è¯•ã€‚');
  }
}

// å»¶è¿Ÿæ·»åŠ æµ‹è¯•æŒ‰é’®
setTimeout(addTestButtons, 3000);
</script>
</body>
</html>