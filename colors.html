<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>色盲派对 - 色彩挑战游戏</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    
    <!-- 配置Tailwind -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#6366F1',
                        success: '#10B981',
                        warning: '#F59E0B',
                        danger: '#EF4444',
                        dark: '#1F2937'
                    },
                    fontFamily: {
                        game: ['"Poppins"', 'sans-serif']
                    }
                }
            }
        }
    </script>
    
    <!-- 自定义工具类 -->
    <style type="text/tailwindcss">
        @layer utilities {
            .content-auto {
                content-visibility: auto;
            }
            .color-tile {
                transition: all 0.2s ease;
            }
            .color-tile:hover {
                transform: scale(1.05);
                box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1);
            }
            .color-tile:active {
                transform: scale(0.98); /* 增加触摸/点击反馈 */
            }
            .pulse {
                animation: pulse 1.5s infinite;
            }
            @keyframes pulse {
                0%, 100% {
                    transform: scale(1);
                }
                50% {
                    transform: scale(1.05);
                }
            }
            .shake {
                animation: shake 0.5s;
            }
            @keyframes shake {
                0%, 100% {
                    transform: translateX(0);
                }
                25% {
                    transform: translateX(-10px);
                }
                75% {
                    transform: translateX(10px);
                }
            }
            .fade-in {
                animation: fadeIn 0.5s ease-in;
            }
            @keyframes fadeIn {
                from {
                    opacity: 0;
                }
                to {
                    opacity: 1;
                }
            }
        }
    </style>
    
    <!-- 导入字体 -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        body {
            touch-action: manipulation;
            background-color: #f9fafb;
        }
        .tile-container {
            display: grid;
            grid-template-columns: repeat(var(--columns, 5), 1fr);
            gap: clamp(8px, 2vw, 16px);
        }
        @media (max-width: 640px) {
            .tile-container {
                --columns: 4;
            }
        }
        @media (max-width: 480px) {
            .tile-container {
                --columns: 3;
            }
            /* 移动端顶部导航优化：换行显示 */
            .header-mobile-wrap {
                flex-wrap: wrap;
                gap: 10px;
            }
            .header-mobile-wrap > div {
                width: 100%;
                justify-content: center !important;
            }
        }
        @media (max-width: 360px) {
            .tile-container {
                --columns: 2; /* 超小屏显示2列，避免色块过小 */
            }
            /* 移动端按钮优化：堆叠显示 */
            .btn-wrap {
                flex-direction: column;
                padding: 0 20px;
            }
            .btn-wrap button {
                width: 100% !important;
            }
        }

        /* 返回按钮样式优化：固定底部、视觉突出且不遮挡游戏区域 */
        .back-container {
            position: fixed;
            bottom: 20px;
            left: 50%; /* 完全水平居中 */
            transform: translateX(-50%);
            z-index: 10; /* 确保在游戏区域之上，但低于模态框 */
            width: 100%;
            max-width: 300px; /* 限制最大宽度 */
            padding: 0 20px;
        }
        .back-to-home {
            width: 100%;
            background-color: rgba(245, 158, 11, 0.9); /* 半透明黄色，突出且不刺眼 */
            color: white;
            border: none;
            border-radius: 50px; /* 圆形按钮，更美观 */
            padding: 12px 20px;
            font-family: 'Poppins', sans-serif;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            box-shadow: 0 4px 15px rgba(245, 158, 11, 0.3);
        }
        .back-to-home:hover {
            background-color: #F59E0B; /* hover时加深颜色 */
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(245, 158, 11, 0.4);
        }
        .back-to-home:active {
            transform: translateY(0); /* 点击反馈 */
        }
    </style>
</head>
<body class="font-game min-h-screen flex flex-col">
    <!-- 顶部导航：优化移动端换行显示 -->
    <header class="bg-white shadow-md py-4 px-6">
        <div class="container mx-auto flex header-mobile-wrap justify-between items-center">
            <div class="flex items-center gap-2">
                <i class="fa fa-paint-brush text-primary text-2xl"></i>
                <h1 class="text-[clamp(1.5rem,3vw,2rem)] font-bold text-dark">色盲派对</h1>
            </div>
            <div class="flex items-center gap-6">
                <div class="flex items-center gap-2">
                    <i class="fa fa-trophy text-warning"></i>
                    <span class="font-semibold">得分: <span id="score" class="text-primary">0</span></span>
                </div>
                <div class="flex items-center gap-2">
                    <i class="fa fa-clock-o text-danger"></i>
                    <span class="font-semibold">时间: <span id="time" class="text-primary">30</span>s</span>
                </div>
            </div>
        </div>
    </header>
    
    <!-- 主游戏区域 -->
    <main class="flex-grow container mx-auto px-4 py-8 pb-24"> <!-- 增加底部内边距，避免被返回按钮遮挡 -->
        <!-- 游戏状态显示 -->
        <div class="mb-8 text-center">
            <div class="inline-block px-6 py-3 bg-primary/10 rounded-full mb-4">
                <h2 class="text-[clamp(1.2rem,2vw,1.5rem)] font-semibold text-primary">
                    级别: <span id="level">1</span> - 找出不同的颜色
                </h2>
            </div>
            <p class="text-gray-600 max-w-md mx-auto">
                在下方色块中，有一个颜色与其他不同。快速找到并点击它！
                难度会随着级别提升而增加。
            </p>
        </div>
        
        <!-- 游戏区域 -->
        <div class="max-w-3xl mx-auto">
            <!-- 颜色方块容器 -->
            <div id="gameBoard" class="tile-container mb-8 fade-in"></div>
            
            <!-- 提示信息 -->
            <div id="message" class="text-center py-4 px-6 rounded-lg mb-8 hidden"></div>
            
            <!-- 控制按钮：优化移动端堆叠显示 -->
            <div class="flex btn-wrap flex-wrap justify-center gap-4">
                <button id="startBtn" class="bg-primary hover:bg-primary/90 text-white font-semibold py-3 px-8 rounded-full transition-all flex items-center gap-2 pulse">
                    <i class="fa fa-play"></i>
                    <span>开始游戏</span>
                </button>
                <button id="restartBtn" class="bg-warning hover:bg-warning/90 text-white font-semibold py-3 px-8 rounded-full transition-all flex items-center gap-2 hidden">
                    <i class="fa fa-refresh"></i>
                    <span>重新开始</span>
                </button>
                <button id="nextLevelBtn" class="bg-success hover:bg-success/90 text-white font-semibold py-3 px-8 rounded-full transition-all flex items-center gap-2 hidden">
                    <i class="fa fa-arrow-right"></i>
                    <span>下一级别</span>
                </button>
            </div>
        </div>
    </main>
    
    <!-- 游戏说明 -->
    <footer class="bg-dark text-white py-6 px-4">
        <div class="container mx-auto text-center">
            <h3 class="text-lg font-semibold mb-2">游戏说明</h3>
            <p class="text-gray-300 max-w-md mx-auto mb-4">
                这是一个考验色彩分辨能力的游戏，适合朋友间互相挑战。
                每一级别都会生成一组相似的颜色，其中有一个颜色不同，
                你需要在限定时间内找到它。
            </p>
            <div class="flex justify-center gap-6 text-sm text-gray-400 flex-wrap"> <!-- 移动端换行 -->
                <div class="mb-2 sm:mb-0">
                    <i class="fa fa-keyboard-o mr-1"></i> 点击色块选择
                </div>
                <div class="mb-2 sm:mb-0">
                    <i class="fa fa-signal mr-1"></i> 级别越高难度越大
                </div>
                <div>
                    <i class="fa fa-users mr-1"></i> 适合多人竞赛
                </div>
            </div>
        </div>
    </footer>
    
    <!-- 游戏结束模态框 -->
    <div id="gameOverModal" class="fixed inset-0 bg-black/70 flex items-center justify-center z-50 hidden fade-in">
        <div class="bg-white rounded-2xl p-8 max-w-md w-full mx-4 text-center">
            <div class="mb-6">
                <i class="fa fa-trophy text-6xl text-warning mb-4"></i>
                <h2 class="text-2xl font-bold text-dark mb-2">游戏结束!</h2>
                <p class="text-gray-600">你的最终成绩</p>
            </div>
            <div class="bg-gray-100 rounded-xl p-6 mb-6">
                <div class="flex justify-between items-center mb-4">
                    <span class="text-gray-600">最高级别</span>
                    <span id="finalLevel" class="text-xl font-bold text-primary">1</span>
                </div>
                <div class="flex justify-between items-center">
                    <span class="text-gray-600">总得分</span>
                    <span id="finalScore" class="text-xl font-bold text-primary">0</span>
                </div>
            </div>
            <button id="playAgainBtn" class="bg-primary hover:bg-primary/90 text-white font-semibold py-3 px-8 rounded-full transition-all w-full">
                再玩一次
            </button>
        </div>
    </div>

    <!-- 返回导航页面按钮：优化样式和位置 -->
    <div class="back-container">
        <button class="back-to-home" onclick="window.location.href='indexdaohang.html'">
            <i class="fa fa-arrow-left"></i>
            <span>返回导航页面</span>
        </button>
    </div>

    <script>
        // 游戏状态：新增isAnswered状态锁，防止重复点击正确答案加分
        const gameState = {
            isPlaying: false,
            isAnswered: false, // 关键：标记当前回合是否已提交答案（true=已提交，禁止再次点击）
            level: 1,
            score: 0,
            timeLeft: 30,
            timer: null,
            tilesCount: 12, // 色块数量
            targetIndex: -1 // 目标色块索引
        };
        
        // DOM 元素
        const gameBoard = document.getElementById('gameBoard');
        const scoreDisplay = document.getElementById('score');
        const timeDisplay = document.getElementById('time');
        const levelDisplay = document.getElementById('level');
        const messageDisplay = document.getElementById('message');
        const startBtn = document.getElementById('startBtn');
        const restartBtn = document.getElementById('restartBtn');
        const nextLevelBtn = document.getElementById('nextLevelBtn');
        const gameOverModal = document.getElementById('gameOverModal');
        const finalLevelDisplay = document.getElementById('finalLevel');
        const finalScoreDisplay = document.getElementById('finalScore');
        const playAgainBtn = document.getElementById('playAgainBtn');
        const backBtn = document.querySelector('.back-to-home'); // 返回按钮
        
        // 初始化游戏
        function initGame() {
            setupEventListeners();
            // 生成初始颜色板（非游戏状态）
            generateColorTiles(true);
        }
        
        // 设置事件监听器
        function setupEventListeners() {
            startBtn.addEventListener('click', startGame);
            restartBtn.addEventListener('click', restartGame);
            nextLevelBtn.addEventListener('click', goToNextLevel);
            playAgainBtn.addEventListener('click', restartGame);
            // 游戏进行中点击返回按钮：增加确认提示
            backBtn.addEventListener('click', function(e) {
                if (gameState.isPlaying) {
                    const confirmLeave = confirm('当前游戏正在进行中，确定要返回导航页吗？');
                    if (!confirmLeave) {
                        e.preventDefault(); // 取消跳转
                    }
                }
            });
        }
        
        // 开始游戏：重置isAnswered状态
        function startGame() {
            gameState.isPlaying = true;
            gameState.isAnswered = false; // 初始化为“未提交答案”
            gameState.level = 1;
            gameState.score = 0;
            gameState.timeLeft = 30;
            
            updateGameInfo();
            generateColorTiles();
            
            // 更新按钮状态
            startBtn.classList.add('hidden');
            restartBtn.classList.remove('hidden');
            nextLevelBtn.classList.add('hidden');
            
            // 开始计时
            startTimer();
        }
        
        // 重新开始游戏：重置isAnswered状态
        function restartGame() {
            // 清除计时器
            if (gameState.timer) {
                clearInterval(gameState.timer);
            }
            
            // 隐藏模态框
            gameOverModal.classList.add('hidden');
            
            startGame();
        }
        
        // 进入下一级别：重置isAnswered状态
        function goToNextLevel() {
            gameState.level++;
            gameState.isAnswered = false; // 进入下一级前重置为“未提交答案”
            // 优化时间递减逻辑：最低保留8秒，避免时间过短无法操作
            gameState.timeLeft = Math.max(8, 30 - (gameState.level - 1) * 2); 
            // 优化色块数量：最高20个（避免过多导致色块过小）
            gameState.tilesCount = Math.min(20, 12 + (gameState.level - 1)); 
            
            updateGameInfo();
            generateColorTiles();
            
            // 更新按钮状态
            nextLevelBtn.classList.add('hidden');
            
            // 开始计时
            startTimer();
        }
        
        // 开始计时器
        function startTimer() {
            if (gameState.timer) {
                clearInterval(gameState.timer);
            }
            
            gameState.timer = setInterval(() => {
                gameState.timeLeft--;
                timeDisplay.textContent = gameState.timeLeft;
                
                // 时间到，游戏结束
                if (gameState.timeLeft <= 0) {
                    endGame();
                }
                
                // 最后5秒警告：增加闪烁动画
                if (gameState.timeLeft <= 5) {
                    timeDisplay.classList.add('text-danger', 'animate-pulse');
                } else {
                    timeDisplay.classList.remove('text-danger', 'animate-pulse');
                }
            }, 1000);
        }
        
        // 生成颜色方块：优化难度梯度，避免早期难度过高
        function generateColorTiles(isPreview = false) {
            gameBoard.innerHTML = '';
            
            // 难度梯度优化：级别1-5差异较大，后续逐步减小差异
            let difficulty;
            if (gameState.level <= 5) {
                difficulty = 30 - (gameState.level - 1) * 4; // 级别1-5：差异从30降至14，难度平缓提升
            } else if (gameState.level <= 10) {
                difficulty = 14 - (gameState.level - 6) * 2; // 级别6-10：差异从14降至4，难度稳步增加
            } else {
                difficulty = Math.max(2, 4 - (gameState.level - 11) * 0.5); // 级别11+：差异最低2，避免难度过高无法分辨
            }

            // 随机生成基础颜色的HSL值（确保颜色更鲜艳，避免灰暗色难以分辨）
            const hue = Math.floor(Math.random() * 360);
            const saturation = 60 + Math.floor(Math.random() * 25); // 60-85%（更高饱和度，颜色更鲜明）
            const lightness = 45 + Math.floor(Math.random() * 15); // 45-60%（适中亮度，避免过暗或过亮）
            
            // 生成目标颜色（与基础颜色有差异）
            let targetHue, targetSaturation, targetLightness;
            
            // 随机选择一个颜色属性进行变化（Hue, Saturation, Lightness）
            const changeType = Math.floor(Math.random() * 3);
            
            switch (changeType) {
                case 0: // 改变色相（最易分辨，早期级别优先）
                    targetHue = (hue + difficulty) % 360;
                    targetSaturation = saturation;
                    targetLightness = lightness;
                    break;
                case 1: // 改变饱和度（中等难度）
                    targetHue = hue;
                    targetSaturation = Math.max(20, Math.min(100, saturation + difficulty)); // 限制在20-100%，避免无意义差异
                    targetLightness = lightness;
                    break;
                case 2: // 改变亮度（最难分辨，高级别概率增加）
                    targetHue = hue;
                    targetSaturation = saturation;
                    targetLightness = Math.max(20, Math.min(80, lightness + difficulty)); // 限制在20-80%，确保可见性
                    break;
            }
            
            // 生成目标色块的索引
            gameState.targetIndex = Math.floor(Math.random() * gameState.tilesCount);
            
            // 创建颜色方块：增加触摸反馈，适配移动端
            for (let i = 0; i < gameState.tilesCount; i++) {
                const tile = document.createElement('div');
                tile.classList.add('color-tile', 'rounded-lg', 'shadow-md', 'cursor-pointer', 'aspect-square', 'select-none'); // 禁止文本选中
                
                // 设置颜色
                let color;
                if (i === gameState.targetIndex) {
                    color = `hsl(${targetHue}, ${targetSaturation}%, ${targetLightness}%)`;
                } else {
                    color = `hsl(${hue}, ${saturation}%, ${lightness}%)`;
                }
                
                tile.style.backgroundColor = color;
                // 增加触摸反馈样式（针对移动端）
                tile.style.touchAction = 'manipulation';
                tile.style.userSelect = 'none';
                
                // 添加点击事件（预览模式不添加 + 已提交答案时不响应）
                if (!isPreview) {
                    tile.addEventListener('click', () => {
                        if (gameState.isAnswered) return; // 关键：已提交答案则忽略点击
                        checkAnswer(i, tile);
                    });
                    // 移动端触摸事件优化（避免300ms延迟 + 已提交答案时不响应）
                    tile.addEventListener('touchstart', (e) => {
                        if (gameState.isAnswered) return; // 关键：已提交答案则忽略触摸
                        e.preventDefault(); // 阻止默认触摸行为
                        checkAnswer(i, tile);
                    }, { passive: false });
                }
                
                gameBoard.appendChild(tile);
            }
            
            // 添加淡入动画（避免闪烁）
            gameBoard.classList.remove('fade-in');
            setTimeout(() => {
                gameBoard.classList.add('fade-in');
            }, 10);
        }
        
        // 检查答案：优化反馈速度和视觉效果，设置isAnswered锁
        function checkAnswer(index, tile) {
            if (!gameState.isPlaying) return;
            
            // 1. 标记为“已提交答案”，锁定后续交互
            gameState.isAnswered = true;
            
            // 清除计时器
            clearInterval(gameState.timer);
            
            if (index === gameState.targetIndex) {
                // 回答正确：增加成功动画
                tile.classList.add('ring-4', 'ring-success', 'ring-offset-2', 'scale-105');
                setTimeout(() => {
                    tile.classList.remove('scale-105');
                }, 200);
                
                // 计算得分（优化得分逻辑：级别越高、剩余时间越多，得分倍数越高）
                const timeMultiplier = gameState.timeLeft / 30; // 0.33-1倍（基于剩余时间）
                const levelMultiplier = 1 + (gameState.level - 1) * 0.1; // 1-2倍（基于级别，每级+10%）
                const levelScore = Math.floor(100 * timeMultiplier * levelMultiplier);
                gameState.score += levelScore;
                
                // 显示成功消息（带分数动画）
                showMessage(`正确！获得 <span class="font-bold text-success animate-pulse">${levelScore}</span> 分`, 'success');
                
                // 更新分数（增加数字滚动动画）
                updateScoreWithAnimation(gameState.score);
                
                // 显示下一级按钮（延迟显示，提升体验）
                setTimeout(() => {
                    nextLevelBtn.classList.remove('hidden');
                    nextLevelBtn.classList.add('fade-in');
                }, 500);
            } else {
                // 回答错误：显示错误反馈并高亮正确答案
                tile.classList.add('ring-4', 'ring-danger', 'ring-offset-2', 'shake');
                
                // 高亮正确答案（延迟显示，给用户反应时间）
                setTimeout(() => {
                    const tiles = gameBoard.querySelectorAll('.color-tile');
                    tiles[gameState.targetIndex].classList.add('ring-4', 'ring-success', 'ring-offset-2', 'scale-105');
                }, 300);
                
                // 显示错误消息
                showMessage('错误！正确答案已标注', 'danger');
                
                // 游戏结束（延迟跳转，让用户看到正确答案）
                setTimeout(endGame, 1800);
            }
        }
        
        // 显示消息：优化样式和动画
        function showMessage(text, type) {
            messageDisplay.innerHTML = text; // 支持HTML内容（如分数高亮）
            messageDisplay.classList.remove('hidden', 'bg-success/20', 'text-success', 'bg-danger/20', 'text-danger', 'fade-in');
            
            if (type === 'success') {
                messageDisplay.classList.add('bg-success/20', 'text-success', 'fade-in');
            } else {
                messageDisplay.classList.add('bg-danger/20', 'text-danger', 'fade-in');
            }
        }
        
        // 更新分数：增加数字滚动动画（提升视觉体验）
        function updateScoreWithAnimation(targetScore) {
            const currentScore = parseInt(scoreDisplay.textContent);
            if (currentScore === targetScore) return;
            
            const step = Math.ceil(Math.abs(targetScore - currentScore) / 20); // 分20步滚动，速度均匀
            let tempScore = currentScore;
            
            const scoreTimer = setInterval(() => {
                if (tempScore < targetScore) {
                    tempScore = Math.min(tempScore + step, targetScore);
                } else {
                    tempScore = Math.max(tempScore - step, targetScore);
                }
                
                scoreDisplay.textContent = tempScore;
                
                if (tempScore === targetScore) {
                    clearInterval(scoreTimer);
                }
            }, 30);
        }
        
        // 更新游戏信息显示
        function updateGameInfo() {
            updateScoreWithAnimation(gameState.score); // 分数用动画更新
            timeDisplay.textContent = gameState.timeLeft;
            levelDisplay.textContent = gameState.level;
            timeDisplay.classList.remove('text-danger', 'animate-pulse');
            messageDisplay.classList.add('hidden');
        }
        
        // 结束游戏：优化模态框显示逻辑，重置isAnswered状态
        function endGame() {
            gameState.isPlaying = false;
            gameState.isAnswered = false; // 重置状态，避免影响下次游戏
            clearInterval(gameState.timer);
            
            // 更新最终分数和级别
            finalLevelDisplay.textContent = gameState.level;
            finalScoreDisplay.textContent = gameState.score;
            
            // 显示游戏结束模态框（增加淡入动画）
            setTimeout(() => {
                gameOverModal.classList.remove('hidden');
            }, 300);
            
            // 更新按钮状态
            restartBtn.classList.add('hidden');
            nextLevelBtn.classList.add('hidden');
            startBtn.classList.remove('hidden');
        }
        
        // 初始化游戏
        window.addEventListener('DOMContentLoaded', initGame);

        // 窗口大小变化时重新渲染色块（适配移动端旋转屏幕）
        window.addEventListener('resize', () => {
            if (gameState.isPlaying && !gameState.isAnswered) { // 仅在游戏中且未提交答案时重新渲染
                generateColorTiles();
            }
        });
    </script>
</body>
</html>