<!DOCTYPE html>
<html>
    <head>
        <title>登录界面</title>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width,initial-scale=1" />
        <style>
                body{
                    background-color:#f4f4f4;
                    font-family:Arial,sans-serif;
                    height:100vh;
                    color:pink;
                    display : flex;
                    justify-content:center;
                    margin:0;
                    padding:0;
                    align-items:center;
                }
                .container {
                    width:300px;
                    box-shadow: 0 0 10px rgba(0,0,0,0.1);
                    background-color:#fff;
                    margin:10px auto;
                    border-radius:8px;
                    padding : 20px;
                }
                h2{
                    text-align:center;
                    color:#0000004d;
                    margin-bottom:20px
                }
                label {
                    display:block;
                    margin-bottom:5px;
                    font-weight:bold;
                }
                input[type="text"],input[type="password"] {
                    width:100%;
                    padding:10px;
                    margin-bottom:15px;
                    border:1px solid #ccc;
                    border-radius:4px;
                }
                .links a:hover {
                    text-decoration:underline;
                } 
                .checkbox {
                    margin-bottom:15px;
                }
                button {
                    width:100%;
                    padding:10px;
                    background-color:#28a745;
                    color:#fff;
                    border:none;
                    border-radius:4px;
                    cursor:pointer;
                }
                button:hover {
                    background-color:#218838;
                }
                .links{
                    text-align:center;
                    margin-top:15px;
                }
                .links a {
                    color:#007bff;
                    text-decoration:none;
                }            
                .error-message {
                    color: #dc3545;
                    text-align: center;
                    margin: 10px 0;
                    padding: 8px;
                    border: 1px solid #f5c6cb;
                    border-radius: 4px;
                    background-color: #f8d7da;
                    display: none;
                }
        </style>
    </head>
    <body>
        <!-- 加载动画 -->
        <div id="loader-wrapper">
          <div id="loader"></div>
          <p id="loading-text">加载中...</p >
        </div>

        <style>
        #loader-wrapper {
          position: fixed;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          background: #fff;
          display: flex;
          flex-direction: column;
          justify-content: center;
          align-items: center;
          z-index: 9999;
          transition: opacity 0.5s ease-out;
        }

        #loader {
          width: 60px;
          height: 60px;
          border: 5px solid #f3f3f3;
          border-top: 5px solid #3498db;
          border-radius: 50%;
          animation: spin 1s linear infinite;
          margin-bottom: 20px;
        }

        #loading-text {
          color: #333;
          font-family: 'Arial', sans-serif;
          font-size: 16px;
          letter-spacing: 1px;
          animation: fade 1.5s ease-in-out infinite alternate;
        }

        @keyframes spin {
          0% { transform: rotate(0deg); }
          100% { transform: rotate(360deg); }
        }

        @keyframes fade {
          from { opacity: 0.7; }
          to { opacity: 1; }
        }

        .loaded #loader-wrapper {
          opacity: 0;
          pointer-events: none;
        }
        </style>

        <script>
        window.addEventListener('load', function() {
            setTimeout(function() {
            document.body.classList.add('loaded');
            }, 1000);
        });
        </script>
        <div class="container">
            <div class="error-message" id="errorMsg"></div>
            
            <form id="loginForm">
                <h2>登录</h2>
                <label for="username">用户名</label>
                <input type="text" name="username" placeholder="请输入昵称" id="username" required>
                <label for="password">密码</label>
                <input type="password" name="password" placeholder="请输入密码" id="password" required>
                <div class="checkbox">
                    <input type="checkbox" name="rememberMe" id="rememberMe">
                    <label for="rememberMe" >记住我</label>
                </div>
                <button type="submit">登录</button>
            </form>
            <div class='links'>
                <br>
                <a href="REGISTER.html" id="registerLink">注册新账号</a >
                <br>
                <br>
                <a href="#" id="forgotPasswordLink">忘记密码?</a >
            </div>
        </div>
        <script>
            document.getElementById('registerLink').addEventListener('click',function(event) {
                event.preventDefault();
                window.location.href = "REGISTER.html";
            });
            
            document.getElementById('forgotPasswordLink').addEventListener('click',function(event) {
                event.preventDefault();
                alert('跳转到找回密码页面(此功能正在开发中...)');
            });
            
            // 登录表单提交逻辑（核心修改：对接服务器）
            document.getElementById('loginForm').addEventListener('submit', async function(event) {
                event.preventDefault();
                const username = document.getElementById('username').value.trim();
                const password = document.getElementById('password').value;
                const rememberMe = document.getElementById('rememberMe').checked;
                const errorMsg = document.getElementById('errorMsg');
                console.log("前端发送的密码是:",password);
                // 前端基础验证
                if (!username || !password) {
                    showError(errorMsg, '用户名和密码不能为空！');
                    return;
                }

                try {
                    // 发送登录请求到服务器
                    const response = await fetch('/.netlify/functions/login', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            username: username,
                            password: password
                        })
                    });

                    const result = await response.json();

                    // 处理服务器响应
                    if (response.ok) {
                        // 登录成功
                        if (rememberMe) {
                            localStorage.setItem('rememberedUsername', username);
                        } else {
                            localStorage.removeItem('rememberedUsername');
                        }
                        loginSuccess(result);
                    } else {
                        // 登录失败（用户名或密码错误）
                        showError(errorMsg, result.message || '登录失败，请重试');
                    }
                } catch (error) {
                    // 网络错误（服务器未启动等）
                    showError(errorMsg, '无法连接到服务器，请检查服务器是否已启动');
                    console.error('登录请求错误：', error);
                }
            });

            // 登录成功处理
            // 修改loginSuccess函数
            function loginSuccess(userData) {
                // 保存用户信息到本地
                const currentUser = {
                    id: userData.id,  // 确保包含用户ID
                    username: userData.username,
                    token: userData.token,
                    avatar: userData.avatar || '',
                    loginTime: new Date().getTime()
                };
                localStorage.setItem('mainUserInfo', JSON.stringify(currentUser));
    
                // 同步到服务器
                fetch('/.netlify/functions/saveUserInfo', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(currentUser)
                });
    
                alert('登录成功，欢迎回来！');
                window.location.href = `indexdaohang.html?token=${userData.token}&username=${encodeURIComponent(userData.username)}`;
            }



            // 页面加载时填充记住的用户名
            window.onload = function() {
                const rememberedUsername = localStorage.getItem('rememberedUsername');
                if (rememberedUsername) {
                    document.getElementById('username').value = rememberedUsername;
                    document.getElementById('rememberMe').checked = true;
                }
            };

            // 显示错误提示
            function showError(element, message) {
                element.textContent = message;
                element.style.display = 'block';
                setTimeout(() => {
                    element.style.display = 'none';
                }, 3000);
            }
        </script>
    </body>
</html>
