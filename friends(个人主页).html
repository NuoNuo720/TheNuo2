<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>好友聊天系统（修复版）</title>
    <!-- 外部资源 -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.bootcdn.net/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <!-- Tailwind 配置 -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#6366f1',
                        secondary: '#8b5cf6',
                        accent: '#ec4899',
                        success: '#10b981',
                        danger: '#ef4444',
                    }
                }
            }
        }
    </script>
    
    <!-- 自定义样式 -->
    <style type="text/tailwindcss">
        @layer utilities {
            .status-indicator { @apply absolute bottom-0 right-0 w-3 h-3 rounded-full border-2 border-white; }
            .status-online { @apply bg-success; }
            .status-offline { @apply bg-gray-400; }
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .animate-fadeIn { animation: fadeIn 0.3s ease-out forwards; }
    </style>
</head>
<body class="bg-gray-50 min-h-screen p-4 md:p-6">
    <div class="max-w-6xl mx-auto">
        <!-- 标题区域 -->
        <header class="text-center mb-8">
            <h1 class="text-[clamp(1.8rem,5vw,3rem)] font-bold text-transparent bg-clip-text bg-gradient-to-r from-primary to-secondary mb-3">
                <i class="fa fa-comments mr-2"></i>好友聊天系统
            </h1>
        </header>
        
        <!-- 登录/注册区域 -->
        <div id="loginSection" class="max-w-md mx-auto mb-8">
            <div class="bg-white rounded-xl shadow-md p-4">
                <h2 class="text-xl font-bold mb-4 text-center">请登录/注册</h2>
                <input type="text" id="username" placeholder="请输入昵称" 
                       class="w-full px-4 py-3 border border-gray-200 rounded-lg mb-4 focus:outline-none focus:ring-2 focus:ring-primary/50">
                <div class="flex gap-3">
                    <button onclick="handleLogin()" class="flex-1 px-4 py-2 bg-primary text-white rounded-lg hover:bg-primary/90 transition-colors">
                        <i class="fa fa-sign-in mr-1"></i>登录
                    </button>
                    <button onclick="handleRegister()" class="flex-1 px-4 py-2 bg-accent text-white rounded-lg hover:bg-accent/90 transition-colors">
                        <i class="fa fa-user-plus mr-1"></i>注册
                    </button>
                </div>
            </div>
        </div>
        
        <!-- 用户信息区域（登录后显示） -->
        <div id="userInfo" class="hidden text-center mb-6">
            <div class="inline-flex items-center gap-3 bg-white rounded-full px-6 py-3 shadow-md">
                <img id="userAvatar" src="https://picsum.photos/200/200" alt="用户头像" class="w-12 h-12 rounded-full">
                <div class="text-left">
                    <p>当前登录：<span id="currentUsername" class="font-bold text-primary"></span></p>
                </div>
                <button onclick="handleLogout()" class="text-danger hover:underline">
                    <i class="fa fa-sign-out"></i>
                </button>
            </div>
        </div>
        
        <!-- 主功能区（登录后显示） -->
        <div id="mainContent" class="hidden grid grid-cols-1 md:grid-cols-4 gap-6">
            <!-- 左侧：好友管理 -->
            <div class="space-y-6 md:col-span-1">
                <!-- 添加好友 -->
                <div class="bg-white rounded-xl shadow-md p-4">
                    <h3 class="font-bold mb-4 flex items-center">
                        <i class="fa fa-user-plus text-primary mr-2"></i>添加好友
                    </h3>
                    <div class="flex gap-2">
                        <input type="text" id="friendName" placeholder="输入好友昵称" 
                               class="flex-1 px-3 py-2 border border-gray-200 rounded-lg focus:outline-none focus:ring-1 focus:ring-primary">
                        <button onclick="addFriend()" class="px-3 py-2 bg-primary text-white rounded-lg hover:bg-primary/90">
                            <i class="fa fa-paper-plane"></i>
                        </button>
                    </div>
                </div>
                
                <!-- 好友申请 -->
                <div class="bg-white rounded-xl shadow-md p-4">
                    <h3 class="font-bold mb-4 flex items-center">
                        <i class="fa fa-bell text-accent mr-2"></i>好友申请
                        <span id="requestCount" class="ml-2 bg-accent text-white text-xs rounded-full w-5 h-5 flex items-center justify-center hidden">0</span>
                    </h3>
                    <div id="friendRequests" class="space-y-3 max-h-48 overflow-y-auto pr-1">
                        <div class="text-center text-gray-500 py-6">
                            <i class="fa fa-envelope-o text-2xl mb-2 opacity-30"></i>
                            <p class="text-sm italic">暂无好友申请</p>
                        </div>
                    </div>
                </div>
                
                <!-- 好友列表 -->
                <div class="bg-white rounded-xl shadow-md p-4">
                    <h3 class="font-bold mb-4 flex items-center">
                        <i class="fa fa-users text-secondary mr-2"></i>我的好友
                    </h3>
                    <div id="friendsList" class="space-y-3 max-h-[calc(100vh-450px)] overflow-y-auto pr-1">
                        <div class="text-center text-gray-500 py-8">
                            <i class="fa fa-hand-o-down text-2xl mb-2 opacity-30"></i>
                            <p class="text-sm italic">暂无好友，添加几个吧！</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- 右侧：聊天区域 -->
            <div class="md:col-span-3">
                <div class="bg-white rounded-xl shadow-md p-4 h-full flex flex-col">
                    <!-- 聊天标题 -->
                    <div id="chatHeader" class="border-b pb-4 mb-4">
                        <h3 class="font-bold text-xl">
                            <span id="chatWith">选择好友开始聊天</span>
                        </h3>
                    </div>
                    
                    <!-- 聊天内容（固定高度，超出滚动） -->
                    <div id="messages" class="flex-1 overflow-y-auto mb-4 space-y-4 p-3 max-h-[400px] bg-gray-50 rounded-xl">
                        <div class="text-center text-gray-500 py-10">
                            <i class="fa fa-comment text-3xl mb-3 opacity-20"></i>
                            <p class="text-sm italic">请从左侧好友列表中选择一位好友开始聊天</p>
                        </div>
                    </div>
                    
                    <!-- 发送消息区域 -->
                    <div id="messageInputArea" class="flex gap-2 hidden">
                        <textarea id="messageText" rows="2" placeholder="输入消息..." class="flex-1 px-4 py-3 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/50 resize-none"></textarea>
                        <button onclick="sendMessage()" class="px-4 py-3 bg-primary text-white rounded-lg hover:bg-primary/90 transition-colors">发送</button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 加载提示 -->
        <div id="loading" class="hidden fixed inset-0 bg-black/10 flex items-center justify-center z-50">
            <div class="bg-white p-6 rounded-xl shadow-lg flex items-center gap-4">
                <i class="fa fa-circle-o-notch fa-spin text-primary text-2xl"></i>
                <span>处理中...</span>
            </div>
        </div>
    </div>

    <script>
        // 全局变量
        let currentUser = null;
        let selectedFriend = null;
        let supabase = null;
        let chatSubscription = null;
        let messagePollTimer = null; // 轮询定时器
        
        // DOM元素
        const loginSection = document.getElementById('loginSection');
        const userInfo = document.getElementById('userInfo');
        const mainContent = document.getElementById('mainContent');
        const currentUsernameEl = document.getElementById('currentUsername');
        const userAvatarEl = document.getElementById('userAvatar');
        const loading = document.getElementById('loading');
        
        // 初始化Supabase客户端
        function initSupabaseClient() {
            const supabaseUrl = "https://cjoabruloeflhhljjysl.supabase.co";
            const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNqb2FicnVsb2VmbGhobGpqeXNsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk2MTY4MTIsImV4cCI6MjA3NTE5MjgxMn0.CPaMga0gWs9k778kjYEhcOGTYp0Vtku0ZkyKJo-Q6Gg";
            
            return window.supabase.createClient(supabaseUrl, supabaseKey, {
                global: {
                    headers: {
                        'apikey': supabaseKey,
                        'Authorization': `Bearer ${supabaseKey}`
                    }
                }
            });
        }
        
        // 显示/隐藏加载状态
        function showLoading() { loading.classList.remove('hidden'); }
        function hideLoading() { loading.classList.add('hidden'); }
        
        // 页面初始化
        function initApp() {
            try {
                supabase = initSupabaseClient();
                console.log('Supabase客户端初始化成功');
                
                // 检查本地存储的用户
                const savedUser = localStorage.getItem('friendSystemUser');
                if (savedUser) {
                    currentUser = JSON.parse(savedUser);
                    showUserInterface();
                }
            } catch (error) {
                console.error('应用初始化失败:', error);
                alert('初始化失败: ' + error.message);
            }
        }
        
        // 注册新用户
        async function handleRegister() {
            const username = document.getElementById('username').value.trim();
            if (!username) { alert('请输入昵称'); return; }
            
            try {
                showLoading();
                
                // 检查用户是否已存在
                const { data: existingUser } = await supabase
                    .from('users')
                    .select('id')
                    .eq('username', username)
                    .single();
                
                if (existingUser) throw new Error('该昵称已被使用');
                
                // 创建新用户
                const { data: newUser } = await supabase
                    .from('users')
                    .insert([{ 
                        username: username,
                        avatar: `https://picsum.photos/seed/${username}/200`,
                        status: '在线',
                        last_active: new Date()
                    }])
                    .select('*')
                    .single();
                
                currentUser = newUser;
                localStorage.setItem('friendSystemUser', JSON.stringify(newUser));
                alert('注册成功！');
                showUserInterface();
            } catch (error) {
                console.error('注册失败:', error);
                alert('注册失败: ' + error.message);
            } finally {
                hideLoading();
            }
        }
        
        // 用户登录
        async function handleLogin() {
            const username = document.getElementById('username').value.trim();
            if (!username) { alert('请输入昵称'); return; }
            
            try {
                showLoading();
                
                // 查询用户
                const { data: users } = await supabase
                    .from('users')
                    .select('*')
                    .eq('username', username);
                
                if (!users || users.length === 0) throw new Error('用户不存在，请先注册');
                
                const user = users[0];
                // 更新最后活跃时间
                const { data: updatedUser } = await supabase
                    .from('users')
                    .update({ last_active: new Date() })
                    .eq('id', user.id)
                    .select('*')
                    .single();
                
                currentUser = updatedUser;
                localStorage.setItem('friendSystemUser', JSON.stringify(updatedUser));
                alert('登录成功！');
                showUserInterface();
            } catch (error) {
                console.error('登录失败:', error);
                alert('登录失败: ' + error.message);
            } finally {
                hideLoading();
            }
        }
        
        // 用户退出登录
        function handleLogout() {
            // 清除轮询定时器
            if (messagePollTimer) {
                clearInterval(messagePollTimer);
                messagePollTimer = null;
            }
            
            // 清除实时监听
            if (chatSubscription) {
                supabase.removeChannel(chatSubscription);
                chatSubscription = null;
            }
            
            currentUser = null;
            selectedFriend = null;
            localStorage.removeItem('friendSystemUser');
            
            loginSection.classList.remove('hidden');
            userInfo.classList.add('hidden');
            mainContent.classList.add('hidden');
            
            document.getElementById('chatWith').textContent = '选择好友开始聊天';
            document.getElementById('messages').innerHTML = 
                '<div class="text-center text-gray-500 py-10"><i class="fa fa-comment text-3xl mb-3 opacity-20"></i><p class="text-sm italic">请从左侧好友列表中选择一位好友开始聊天</p></div>';
            document.getElementById('messageInputArea').classList.add('hidden');
            
            alert('已退出登录');
        }
        
        // 显示用户主界面
        function showUserInterface() {
            if (!currentUser) return;
            
            currentUsernameEl.textContent = currentUser.username;
            userAvatarEl.src = currentUser.avatar || 'https://picsum.photos/200/200';
            
            loginSection.classList.add('hidden');
            userInfo.classList.remove('hidden');
            mainContent.classList.remove('hidden');
            
            // 启动定时更新活跃状态
            startActiveTimer();
            // 加载好友申请和好友列表
            loadFriendRequests();
            loadFriendsList();
        }
        
        // 定时更新最后活跃时间
        function startActiveTimer() {
            updateLastActive();
            setInterval(updateLastActive, 30000); // 每30秒更新一次
        }
        
        // 更新最后活跃时间
        async function updateLastActive() {
            if (currentUser) {
                try {
                    await supabase
                        .from('users')
                        .update({ last_active: new Date() })
                        .eq('id', currentUser.id);
                } catch (error) {
                    console.error('更新活跃时间失败:', error);
                }
            }
        }
        
        // 判断用户是否在线（5分钟内有活跃）
        function isUserOnline(user) {
            if (!user.last_active) return false;
            
            const lastActive = new Date(user.last_active);
            const now = new Date();
            const diffMinutes = (now - lastActive) / (1000 * 60);
            
            return diffMinutes < 5;
        }
        
        // 加载好友申请（分步查询，避免关联歧义）
        async function loadFriendRequests() {
            if (!currentUser) {
                console.log('当前用户未登录，无法加载好友申请');
                return;
            }
            
            console.log('开始加载好友申请，当前用户ID:', currentUser.id);
            
            try {
                // 第一步：先查询所有发给当前用户的待处理申请（只获取ID和申请人ID）
                const { data: requests, error: requestError } = await supabase
                    .from('friend_relations')
                    .select('id, sender_id')  // 只查询必要字段，不关联用户表
                    .eq('receiver_id', currentUser.id)
                    .eq('status', 'pending')
                    .order('created_at', { ascending: false });

                if (requestError) throw requestError;

                const container = document.getElementById('friendRequests');
                const countEl = document.getElementById('requestCount');

                // 更新申请数量
                const requestCount = requests?.length || 0;
                countEl.textContent = requestCount;
                countEl.classList.toggle('hidden', requestCount === 0);

                // 处理无数据情况
                if (!requests || requests.length === 0) {
                    container.innerHTML = '<div class="text-center text-gray-500 py-6"><i class="fa fa-envelope-o text-2xl mb-2 opacity-30"></i><p class="text-sm italic">暂无好友申请</p></div>';
                    return;
                }

                // 第二步：提取所有申请人ID，批量查询用户信息
                const senderIds = requests.map(req => req.sender_id);
                const { data: senders, error: senderError } = await supabase
                    .from('users')
                    .select('id, username, avatar, last_active')
                    .in('id', senderIds);  // 批量查询所有申请人信息

                if (senderError) throw senderError;

                // 创建用户信息映射表（ID -> 用户信息）
                const senderMap = {};
                senders.forEach(sender => {
                    senderMap[sender.id] = sender;
                });

                // 渲染申请列表
                container.innerHTML = requests.map((req, index) => {
                    // 从映射表中获取申请人信息（带容错）
                    const sender = senderMap[req.sender_id] || {
                        id: req.sender_id,
                        username: '未知用户',
                        avatar: 'https://picsum.photos/200/200'
                    };
                    const isOnline = isUserOnline(sender);
                    
                    return `
                        <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg hover:bg-gray-100 transition-all animate-fadeIn" style="animation-delay: ${index * 0.1}s">
                            <div class="flex items-center gap-3">
                                <div class="relative">
                                    <img src="${sender.avatar}" alt="${sender.username}" 
                                         class="w-10 h-10 rounded-full object-cover">
                                    <span class="status-indicator ${isOnline ? 'status-online' : 'status-offline'}"></span>
                                </div>
                                <span class="font-medium">${sender.username}</span>
                            </div>
                            <div class="flex gap-2">
                                <button onclick="respondToRequest('${req.id}', true)" 
                                        class="px-3 py-1.5 bg-success text-white text-sm rounded-lg hover:bg-success/90">
                                        <i class="fa fa-check mr-1"></i>同意
                                </button>
                                <button onclick="respondToRequest('${req.id}', false)" 
                                        class="px-3 py-1.5 bg-gray-200 text-sm rounded-lg hover:bg-gray-300">
                                        <i class="fa fa-times mr-1"></i>拒绝
                                </button>
                            </div>
                        </div>
                    `;
                }).join('');

            } catch (error) {
                console.error('加载好友申请异常:', error);
                document.getElementById('friendRequests').innerHTML = 
                    `<p class="text-red-500 text-sm text-center py-6">加载失败: ${error.message}</p>`;
            }
        }
        
        // 加载好友列表（分步查询避免关联问题）
        async function loadFriendsList() {
            if (!currentUser) return;
            
            try {
                // 第一步：查询所有已通过的好友关系
                const { data: relations, error: relError } = await supabase
                    .from('friend_relations')
                    .select('id, sender_id, receiver_id')
                    .or(`sender_id.eq.${currentUser.id},receiver_id.eq.${currentUser.id}`)
                    .eq('status', 'accepted')
                    .order('updated_at', { ascending: false });
                
                if (relError) throw relError;
                
                const container = document.getElementById('friendsList');
                
                if (!relations?.length) {
                    container.innerHTML = '<div class="text-center text-gray-500 py-8"><i class="fa fa-hand-o-down text-2xl mb-2 opacity-30"></i><p class="text-sm italic">暂无好友，添加几个吧！</p></div>';
                    return;
                }
                
                // 提取所有好友ID
                const friendIds = new Set();
                relations.forEach(rel => {
                    const friendId = rel.sender_id === currentUser.id ? rel.receiver_id : rel.sender_id;
                    if (friendId !== currentUser.id) {
                        friendIds.add(friendId);
                    }
                });
                
                // 第二步：批量查询好友信息
                const { data: friends, error: friendError } = await supabase
                    .from('users')
                    .select('id, username, avatar, status, last_active')
                    .in('id', Array.from(friendIds));
                
                if (friendError) throw friendError;
                
                // 渲染好友列表
                container.innerHTML = friends.map((friend, index) => {
                    const isOnline = isUserOnline(friend);
                    
                    return `
                        <div class="flex items-center p-3 bg-gray-50 rounded-lg hover:bg-gray-100 cursor-pointer transition-all animate-fadeIn" 
                             style="animation-delay: ${index * 0.1}s"
                             onclick="selectFriendToChat('${friend.id}', '${friend.username}', '${friend.avatar}')">
                            <div class="relative mr-3">
                                <img src="${friend.avatar}" alt="${friend.username}" 
                                     class="w-10 h-10 rounded-full object-cover">
                                <span class="status-indicator ${isOnline ? 'status-online' : 'status-offline'}"></span>
                            </div>
                            <div>
                                <p class="font-medium">${friend.username}</p>
                                <p class="text-xs text-gray-500">
                                    ${isOnline ? '在线' : `最后活跃: ${formatTimeAgo(new Date(friend.last_active))}`}
                                </p>
                            </div>
                        </div>
                    `;
                }).join('');
            } catch (error) {
                console.error('加载好友列表失败:', error);
                document.getElementById('friendsList').innerHTML = 
                    `<p class="text-red-500 text-sm text-center py-6">加载失败: ${error.message}</p>`;
            }
        }
        
        // 格式化时间为"多久前"
        function formatTimeAgo(date) {
            const now = new Date();
            const diffMs = now - date;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMins / 60);
            const diffDays = Math.floor(diffHours / 24);
            
            if (diffMins < 1) return '刚刚';
            if (diffMins < 60) return `${diffMins}分钟前`;
            if (diffHours < 24) return `${diffHours}小时前`;
            return `${diffDays}天前`;
        }
        
        // 添加好友
        async function addFriend() {
            if (!currentUser) return;
            
            const friendName = document.getElementById('friendName').value.trim();
            if (!friendName) { alert('请输入好友昵称'); return; }
            if (friendName === currentUser.username) { alert('不能添加自己为好友'); return; }
            
            try {
                showLoading();
                
                // 查询好友
                const { data: friend } = await supabase
                    .from('users')
                    .select('id, username')
                    .eq('username', friendName)
                    .single();
                
                // 检查是否已发送过申请或已是好友
                const { data: existing } = await supabase
                    .from('friend_relations')
                    .select('id, status')
                    .or(`and(sender_id.eq.${currentUser.id},receiver_id.eq.${friend.id}),and(sender_id.eq.${friend.id},receiver_id.eq.${currentUser.id})`)
                    .single();
                
                if (existing) {
                    if (existing.status === 'pending') throw new Error('已发送好友申请');
                    else if (existing.status === 'accepted') throw new Error('你们已经是好友了');
                    else throw new Error('对方已拒绝你的申请');
                }
                
                // 发送好友申请
                await supabase
                    .from('friend_relations')
                    .insert([{
                        sender_id: currentUser.id,
                        receiver_id: friend.id,
                        status: 'pending'
                    }]);
                
                alert(`好友申请已发送给 ${friend.username}`);
                document.getElementById('friendName').value = '';
            } catch (error) {
                console.error('添加好友失败:', error);
                alert('添加失败: ' + error.message);
            } finally {
                hideLoading();
            }
        }
        
        // 回应好友申请
        async function respondToRequest(requestId, accept) {
            try {
                showLoading();
                
                // 第一步：获取申请信息（包含申请人ID）
                const { data: request } = await supabase
                    .from('friend_relations')
                    .select('sender_id')
                    .eq('id', requestId)
                    .single();
                
                // 第二步：获取申请人信息
                const { data: sender } = await supabase
                    .from('users')
                    .select('username')
                    .eq('id', request.sender_id)
                    .single();
                
                // 更新申请状态
                await supabase
                    .from('friend_relations')
                    .update({ 
                        status: accept ? 'accepted' : 'rejected',
                        updated_at: new Date()
                    })
                    .eq('id', requestId);
                
                alert(accept ? 
                    `已同意 ${sender.username} 的好友申请` : 
                    `已拒绝 ${sender.username} 的好友申请`);
                
                // 刷新列表
                loadFriendRequests();
                loadFriendsList();
            } catch (error) {
                console.error('处理申请失败:', error);
                alert('处理失败: ' + error.message);
            } finally {
                hideLoading();
            }
        }
        
        // 选择好友进行聊天
        function selectFriendToChat(friendId, friendName, friendAvatar) {
            if (friendId === currentUser.id) return;
            
            selectedFriend = { id: friendId, name: friendName, avatar: friendAvatar };
            
            document.getElementById('chatWith').textContent = friendName;
            document.getElementById('messageInputArea').classList.remove('hidden');
            
            // 加载聊天历史
            loadChatHistory();
            // 设置聊天监听（保留原有逻辑）
            setupChatListener();
            // 启动轮询（每3秒刷新一次消息）
            startMessagePolling();
        }
        
        // 启动消息轮询
        function startMessagePolling() {
            // 清除旧定时器，避免重复
            if (messagePollTimer) clearInterval(messagePollTimer);
            
            // 每3秒自动刷新消息
            messagePollTimer = setInterval(() => {
                if (selectedFriend) {
                    loadChatHistory();
                }
            }, 3000);
        }
        
        // 加载聊天历史
        async function loadChatHistory() {
            if (!currentUser || !selectedFriend) return;
            
            try {
                const { data: messages } = await supabase
                    .from('chat_messages')
                    .select('*')
                    .or(`and(sender_id.eq.${currentUser.id},receiver_id.eq.${selectedFriend.id}),and(sender_id.eq.${selectedFriend.id},receiver_id.eq.${currentUser.id})`)
                    .order('created_at', { ascending: true });
                
                renderMessages(messages || []);
                
                // 标记未读消息为已读
                const unreadIds = messages
                    .filter(msg => msg.receiver_id === currentUser.id && !msg.is_read)
                    .map(msg => msg.id);

                if (unreadIds.length > 0) {
                    await supabase
                        .from('chat_messages')
                        .update({ is_read: true })
                        .in('id', unreadIds);
                }
                
            } catch (error) {
                console.error('加载聊天记录失败:', error);
            }
        }
        
        // 渲染消息
        function renderMessages(messages) {
            const container = document.getElementById('messages');
            container.innerHTML = '';

            if (messages.length === 0) {
                container.innerHTML = '<div class="text-center text-gray-500 py-10"><i class="fa fa-comment-o text-3xl mb-3 opacity-20"></i><p class="text-sm italic">暂无聊天记录，开始对话吧！</p></div>';
                return;
            }

            messages.forEach((msg, index) => {
                const isSent = msg.sender_id === currentUser.id;
                const messageEl = document.createElement('div');
                messageEl.className = `flex ${isSent ? 'justify-end' : 'justify-start'} animate-fadeIn`;
                messageEl.style.animationDelay = `${index * 0.05}s`;
                
                messageEl.innerHTML = `
                    <div class="max-w-[80%] px-4 py-2.5 ${isSent ? 'bg-primary text-white rounded-tl-lg rounded-tr-lg rounded-bl-lg' : 'bg-gray-100 text-gray-800 rounded-tl-lg rounded-tr-lg rounded-br-lg'}">
                        ${msg.content}
                        <p class="text-xs mt-1 ${isSent ? 'text-blue-100' : 'text-gray-500'} text-right">
                            ${new Date(msg.created_at).toLocaleTimeString()}
                            ${isSent && msg.is_read ? '<i class="fa fa-check-circle ml-1"></i>' : ''}
                        </p>
                    </div>
                `;
                
                container.appendChild(messageEl);
            });
            
            // 滚动到底部
            container.scrollTop = container.scrollHeight;
        }
        
        // 发送消息
        async function sendMessage() {
            const content = document.getElementById('messageText').value.trim();
            if (!content || !selectedFriend) return;
    
            try {
                // 发送消息到数据库
                const { error } = await supabase
                    .from('chat_messages')
                    .insert([{
                        sender_id: currentUser.id,
                        receiver_id: selectedFriend.id,
                        content: content,
                        is_read: false
                    }]);
        
                if (!error) {
                    document.getElementById('messageText').value = '';
                    // 保底刷新
                    setTimeout(loadChatHistory, 300);
                }
            } catch (error) {
                console.error('发送消息失败:', error);
                alert('发送失败: ' + error.message);
            }
        }
        
        // 设置聊天监听（保留原有逻辑）
        function setupChatListener() {
            // 先取消现有监听
            if (chatSubscription) {
                supabase.removeChannel(chatSubscription);
                chatSubscription = null;
            }
    
            // 创建新的监听通道
            chatSubscription = supabase
                .channel(`chat_${currentUser.id}_${selectedFriend.id}`)
                .on(
                    'postgres_changes',
                    {
                        event: 'INSERT',
                        schema: 'public',
                        table: 'chat_messages',
                        filter: `(sender_id=eq.${currentUser.id} and receiver_id=eq.${selectedFriend.id}) or (sender_id=eq.${selectedFriend.id} and receiver_id=eq.${currentUser.id})`
                    },
                    (payload) => {
                        console.log('收到新消息:', payload);
                        loadChatHistory();
                    }
                )
                .subscribe((status) => {
                    console.log('监听状态:', status);
                });
        }
        
        // 页面加载完成后初始化
        window.onload = initApp;
    </script>
</body>
</html>
