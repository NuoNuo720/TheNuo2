<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>好友系统（含实时聊天）</title>
  <!-- 外部资源引入 -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
  
  <!-- Tailwind 自定义配置 -->
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: '#4f46e5',
            secondary: '#e0e7ff',
            success: '#10b981',
            danger: '#ef4444',
          }
        }
      }
    }
  </script>
  
  <!-- 自定义工具类 -->
  <style type="text/tailwindcss">
    @layer utilities {
      .content-auto { content-visibility: auto; }
      .card-shadow { box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08); }
      .message-in { border-radius: 18px 18px 18px 0; }
      .message-out { border-radius: 18px 18px 0 18px; }
    }
  </style>
  
  <!-- 关键CSS内联 -->
  <style>
    body { font-family: system-ui, sans-serif; background-color: #f9fafb; }
    .fade-in { animation: fadeIn 0.3s ease-in-out; }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
  </style>
</head>
<body class="bg-gray-50 min-h-screen">
  <div class="container mx-auto px-4 py-8 max-w-5xl">
    <!-- 返回导航页按钮 -->
    <div class="mb-6">
      <a href="indexdaohang.html" 
         class="inline-flex items-center gap-1 bg-gray-200 text-gray-800 px-4 py-2 rounded-lg hover:bg-gray-300 transition-colors">
        <i class="fa fa-arrow-left"></i>
        <span>返回导航页</span>
      </a>
    </div>

    <!-- 页面标题 -->
    <header class="text-center mb-8">
      <h1 class="text-[clamp(1.8rem,4vw,2.5rem)] font-bold text-primary mb-2">
        <i class="fa fa-users text-primary"></i> 好友系统
      </h1>
      <p class="text-gray-600">添加好友，实时聊天</p>
    </header>
    
    <!-- 注册/登录区域 -->
    <div id="authArea" class="text-center mb-8">
      <div id="loginForm" class="mb-4">
        <input type="text" id="usernameInput" placeholder="输入你的昵称" 
               class="px-4 py-2 border border-gray-200 rounded-lg mr-2 w-full max-w-xs">
        <div class="flex justify-center gap-2 mt-3">
          <button onclick="loginUser(document.getElementById('usernameInput').value)" 
                  class="bg-primary text-white px-6 py-2 rounded-lg hover:bg-primary/90 transition-colors">
            <i class="fa fa-sign-in mr-1"></i> 登录
          </button>
          <button onclick="registerUser(document.getElementById('usernameInput').value)" 
                  class="bg-gray-200 text-gray-800 px-6 py-2 rounded-lg hover:bg-gray-300 transition-colors">
            <i class="fa fa-user-plus mr-1"></i> 注册
          </button>
        </div>
      </div>
      <div id="userInfo" class="hidden">
        <p class="text-lg">当前登录：<span id="currentUsername" class="font-semibold text-primary"></span></p>
        <button onclick="logoutUser()" 
                class="text-sm text-gray-500 hover:text-danger mt-1 transition-colors">
          <i class="fa fa-sign-out mr-1"></i> 登出
        </button>
      </div>
    </div>
    
    <!-- 好友功能区域（登录后显示） -->
    <div id="friendSystem" class="grid grid-cols-1 lg:grid-cols-3 gap-6 hidden">
      <!-- 左侧：好友申请 + 好友列表 -->
      <div class="lg:col-span-1 space-y-6">
        <!-- 搜索添加好友 -->
        <div class="bg-white p-4 rounded-xl card-shadow">
          <div class="flex gap-2">
            <input type="text" id="friendUsernameInput" placeholder="输入好友昵称搜索" 
                   class="flex-1 px-4 py-2 border border-gray-200 rounded-lg">
            <button onclick="searchAndAddFriend(document.getElementById('friendUsernameInput').value)" 
                    class="bg-primary text-white px-4 py-2 rounded-lg hover:bg-primary/90 transition-colors">
              <i class="fa fa-plus"></i>
            </button>
          </div>
        </div>

        <!-- 好友申请列表 -->
        <div class="bg-white p-4 rounded-xl card-shadow">
          <h3 class="text-lg font-semibold mb-3 flex items-center">
            <i class="fa fa-bell text-primary mr-2"></i> 好友申请
          </h3>
          <div id="friendRequests" class="space-y-2">
            <!-- 加载状态 -->
            <div id="requestsLoader" class="text-center py-4 text-gray-500 hidden">
              <i class="fa fa-circle-o-notch fa-spin"></i> 加载中...
            </div>
          </div>
        </div>

        <!-- 我的好友列表 -->
        <div class="bg-white p-4 rounded-xl card-shadow">
          <h3 class="text-lg font-semibold mb-3 flex items-center">
            <i class="fa fa-user-o text-primary mr-2"></i> 我的好友
          </h3>
          <div id="friendList" class="space-y-2">
            <!-- 加载状态 -->
            <div id="friendsLoader" class="text-center py-4 text-gray-500 hidden">
              <i class="fa fa-circle-o-notch fa-spin"></i> 加载中...
            </div>
          </div>
        </div>
      </div>

      <!-- 右侧：聊天区域（默认隐藏） -->
      <div class="lg:col-span-2">
        <div id="chatArea" class="bg-white p-4 rounded-xl card-shadow h-full hidden">
          <!-- 聊天头部（好友信息 + 关闭按钮） -->
          <h3 class="text-lg font-semibold mb-3 flex items-center">
            <img id="chatFriendAvatar" src="https://picsum.photos/200/200" alt="好友头像" class="w-8 h-8 rounded-full mr-2">
            <span id="chatFriendName"></span>
            <button onclick="closeChat()" class="ml-auto text-gray-500 hover:text-gray-700">
              <i class="fa fa-times"></i>
            </button>
          </h3>
          
          <!-- 聊天消息容器（可滚动） -->
          <div id="messageContainer" class="h-[400px] overflow-y-auto p-3 border border-gray-100 rounded-lg mb-4 space-y-3">
            <!-- 消息加载状态 -->
            <div id="messagesLoader" class="text-center py-4 text-gray-500 hidden">
              <i class="fa fa-circle-o-notch fa-spin"></i> 加载消息中...
            </div>
          </div>
          
          <!-- 发送消息输入框 -->
          <div class="flex gap-2">
            <input type="text" id="messageInput" placeholder="输入消息..." 
                   class="flex-1 px-4 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-primary/50 outline-none">
            <button onclick="sendMessage()" 
                    class="bg-primary text-white px-6 py-2 rounded-lg hover:bg-primary/90 transition-colors">
              发送
            </button>
          </div>
        </div>

        <!-- 未选择好友时的提示 -->
        <div id="chatTip" class="bg-white p-8 rounded-xl card-shadow h-full flex items-center justify-center text-gray-500">
          <i class="fa fa-comments-o text-4xl mr-3"></i>
          <p>选择一位好友开始聊天吧～</p>
        </div>
      </div>
    </div>
  </div>

  <!-- 延迟加载Supabase库 -->
  <script>
    // 动态加载Supabase库
    function loadSupabase() {
      return new Promise((resolve, reject) => {
        const script = document.createElement('script');
        script.src = 'https://unpkg.com/@supabase/supabase-js@2';
        script.onload = () => resolve(window.supabase);
        script.onerror = reject;
        document.body.appendChild(script);
      });
    }

    // 初始化应用
    async function initApp() {
      try {
        // 等待Supabase加载完成
        const supabaseLib = await loadSupabase();
        
        // 初始化Supabase客户端
        const supabaseUrl = "https://csrsbqixmzfdlpqokazr.supabase.co";
        const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNzcnNicWl4bXpmZGxwcW9rYXpyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk1NjA1NTMsImV4cCI6MjA3NTEzNjU1M30.VC6miCQW-tiNVbYNf8KgkCkZ3wQoy2HDERs1-DTdKEw";
        const supabase = supabaseLib.createClient(supabaseUrl, supabaseKey);

        // 全局变量
        let currentUser = JSON.parse(localStorage.getItem("supabase-friend-user")) || null;
        let selectedFriendId = null;
        let selectedFriendName = null;
        let selectedFriendAvatar = null;
        let chatSubscription = null;
        let isLoading = false; // 防止重复请求

        // DOM元素缓存
        const dom = {
          loginForm: document.getElementById('loginForm'),
          userInfo: document.getElementById('userInfo'),
          friendSystem: document.getElementById('friendSystem'),
          currentUsername: document.getElementById('currentUsername'),
          friendRequests: document.getElementById('friendRequests'),
          requestsLoader: document.getElementById('requestsLoader'),
          friendList: document.getElementById('friendList'),
          friendsLoader: document.getElementById('friendsLoader'),
          chatArea: document.getElementById('chatArea'),
          chatTip: document.getElementById('chatTip'),
          chatFriendName: document.getElementById('chatFriendName'),
          chatFriendAvatar: document.getElementById('chatFriendAvatar'),
          messageContainer: document.getElementById('messageContainer'),
          messagesLoader: document.getElementById('messagesLoader'),
          messageInput: document.getElementById('messageInput')
        };

        // 检查DOM元素是否存在
        function checkDomElements() {
          const missingElements = [];
          for (const [key, element] of Object.entries(dom)) {
            if (!element) {
              missingElements.push(key);
            }
          }
          if (missingElements.length > 0) {
            console.warn('缺少以下DOM元素:', missingElements);
          }
        }

        // 页面初始化
        function initPage() {
          checkDomElements();
          
          if (!dom.loginForm || !dom.userInfo || !dom.friendSystem || !dom.currentUsername) {
            console.error('关键DOM元素缺失，无法初始化页面');
            return;
          }

          if (currentUser) {
            dom.loginForm.classList.add('hidden');
            dom.userInfo.classList.remove('hidden');
            dom.friendSystem.classList.remove('hidden');
            dom.currentUsername.textContent = currentUser.username;
            
            // 延迟加载好友数据
            setTimeout(() => {
              loadFriendRequests();
              loadFriendList();
            }, 300);
          } else {
            dom.loginForm.classList.remove('hidden');
            dom.userInfo.classList.add('hidden');
            dom.friendSystem.classList.add('hidden');
          }
        }

        // 用户注册
        window.registerUser = async function(username) {
          if (!username.trim()) return alert("请输入昵称～");
          if (isLoading) return;
          
          isLoading = true;
          try {
            // 生成随机邮箱和密码
            const randomEmail = `${Date.now()}@temp.com`;
            const randomPassword = Math.random().toString(36).slice(-8);
            
            // 1. 先检查用户名是否已存在
            const { data: existingUsers, error: checkErr } = await supabase
              .from("users")
              .select("id")
              .eq("username", username.trim());
              
            if (checkErr) throw new Error("检查用户名失败: " + checkErr.message);
            if (existingUsers && existingUsers.length > 0) {
              throw new Error("昵称已被占用，请换一个～");
            }
            
            // 2. 创建认证用户
            const { data: authData, error: authError } = await supabase.auth.signUp({
              email: randomEmail,
              password: randomPassword
            });

            if (authError) throw new Error("注册失败: " + authError.message);
            if (!authData.user) throw new Error("无法创建用户，请稍后重试");
            
            const authUserId = authData.user.id;
            
            // 3. 创建用户资料
            const { data: newUser, error } = await supabase
              .from("users")
              .insert([{ 
                id: authUserId,
                username: username.trim(),
                avatar: `https://picsum.photos/seed/${authUserId}/200/200`
              }])
              .select()
              .single();

            if (error) {
              // 如果用户资料创建失败，删除认证用户
              await supabase.auth.admin.deleteUser(authUserId);
              throw new Error("创建用户资料失败: " + error.message);
            }

            currentUser = newUser;
            localStorage.setItem("supabase-friend-user", JSON.stringify(newUser));
            alert(`注册成功！欢迎 ${newUser.username}～`);
            initPage();
          } catch (err) {
            alert("注册失败：" + err.message);
            console.error("注册错误详情:", err);
          } finally {
            isLoading = false;
          }
        }

        // 用户登录
        window.loginUser = async function(username) {
          if (!username.trim()) return alert("请输入昵称～");
          if (isLoading) return;
          
          isLoading = true;
          try {
            const { data: user, error } = await supabase
              .from("users")
              .select("*")
              .eq("username", username.trim())
              .single();

            if (error) throw new Error("未找到该用户，请先注册～");

            currentUser = user;
            localStorage.setItem("supabase-friend-user", JSON.stringify(user));
            alert(`欢迎回来，${user.username}～`);
            initPage();
          } catch (err) {
            alert(err.message);
          } finally {
            isLoading = false;
          }
        }

        // 用户登出
        window.logoutUser = async function() {
          try {
            await supabase.auth.signOut();
          } catch (err) {
            console.error("登出时发生错误:", err);
          } finally {
            currentUser = null;
            localStorage.removeItem("supabase-friend-user");
            if (chatSubscription) chatSubscription.unsubscribe();
            alert("已登出～");
            initPage();
          }
        }

        // 搜索添加好友 - 重点修复此函数
        window.searchAndAddFriend = async function(targetUsername) {
          if (!currentUser) return alert("请先登录～");
          if (!targetUsername.trim()) return alert("请输入好友昵称～");
          if (targetUsername.trim() === currentUser.username) return alert("不能加自己为好友哦～");
          if (isLoading) return;
          
          isLoading = true;
          try {
            // 1. 查找目标用户
            const { data: targetUser, error: searchErr } = await supabase
              .from("users")
              .select("id, username, avatar")
              .eq("username", targetUsername.trim())
              .single();

            if (searchErr) throw new Error("未找到这个用户～");
            
            // 2. 检查是否已有好友关系 - 使用更可靠的查询方式
            const { data: existingRelations, error: relationErr } = await supabase
              .from("friend_relations")
              .select("status")
              .or(`and(sender_id.eq.${currentUser.id},receiver_id.eq.${targetUser.id}),and(sender_id.eq.${targetUser.id},receiver_id.eq.${currentUser.id})`);
              
            if (relationErr) throw new Error("查询关系失败: " + relationErr.message);
            
            // 3. 检查关系状态
            if (existingRelations && existingRelations.length > 0) {
              const status = existingRelations[0].status;
              if (status === "pending") {
                // 检查谁是发送者
                const isSender = existingRelations[0].sender_id === currentUser.id;
                throw new Error(isSender ? "已发送过申请，等待对方同意～" : "对方已向你发送申请，请查看好友申请列表～");
              } else if (status === "accepted") {
                throw new Error("你们已经是好友啦～");
              } else if (status === "rejected") {
                throw new Error("对方之前拒绝过你的申请～");
              }
            }

            // 4. 发送好友申请 - 添加完整的日志和错误处理
            console.log("发送好友申请:", {
              sender_id: currentUser.id,
              receiver_id: targetUser.id,
              status: "pending"
            });
            
            const { data: newRelation, error: applyErr } = await supabase
              .from("friend_relations")
              .insert([{
                sender_id: currentUser.id,
                receiver_id: targetUser.id,
                status: "pending"
              }])
              .select()
              .single();

            if (applyErr) {
              console.error("发送申请错误:", applyErr);
              throw new Error("发送申请失败: " + applyErr.message);
            }
            
            console.log("申请发送成功:", newRelation);
            alert(`好友申请已发送给 ${targetUser.username}～`);
            
            // 刷新好友列表
            loadFriendRequests();
          } catch (err) {
            alert(err.message);
            console.error("添加好友错误:", err);
          } finally {
            isLoading = false;
          }
        }

        // 加载好友申请
        async function loadFriendRequests() {
          if (!currentUser) return;
          
          // 检查元素是否存在
          if (!dom.friendRequests || !dom.requestsLoader) {
            console.error('好友申请相关DOM元素缺失');
            return;
          }
          
          dom.requestsLoader.classList.remove('hidden');
          dom.friendRequests.innerHTML = '';
          
          try {
            const { data: requests, error } = await supabase
              .from("friend_relations")
              .select(`
                id,
                sender:users!friend_relations_sender_id_fkey (id, username, avatar)
              `)
              .eq("receiver_id", currentUser.id)
              .eq("status", "pending")
              .order("created_at", { ascending: false });

            if (error) throw new Error(error.message);
            console.log("加载到的好友申请:", requests);

            if (!requests.length) {
              dom.friendRequests.innerHTML = "<p class='text-gray-500 text-sm'>暂无好友申请～</p>";
              return;
            }

            dom.friendRequests.innerHTML = requests.map(req => `
              <div class="flex items-center gap-3 p-2 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors">
                <img src="${req.sender.avatar || 'https://picsum.photos/200/200'}" alt="头像" class="w-8 h-8 rounded-full">
                <div class="flex-1 text-left">
                  <p class="font-medium text-sm">${req.sender.username}</p>
                  <p class="text-xs text-gray-500">请求添加你为好友</p>
                </div>
                <div class="gap-1">
                  <button onclick="handleFriendRequest('${req.id}', true)" class="bg-success text-white px-2 py-1 rounded text-xs">同意</button>
                  <button onclick="handleFriendRequest('${req.id}', false)" class="bg-gray-200 text-gray-800 px-2 py-1 rounded text-xs">拒绝</button>
                </div>
              </div>
            `).join("");
          } catch (err) {
            dom.friendRequests.innerHTML = `<p class='text-red-500 text-sm'>加载失败: ${err.message}</p>`;
          } finally {
            dom.requestsLoader.classList.add('hidden');
          }
        }

        // 处理好友申请
        window.handleFriendRequest = async function(requestId, isAccept) {
          if (isLoading) return;
          
          isLoading = true;
          try {
            const { error } = await supabase
              .from("friend_relations")
              .update({
                status: isAccept ? "accepted" : "rejected",
                updated_at: new Date().toISOString()
              })
              .eq("id", requestId);

            if (error) throw new Error(error.message);
            alert(isAccept ? "已同意好友申请～" : "已拒绝好友申请～");
            loadFriendRequests();
            loadFriendList();
          } catch (err) {
            alert("处理失败：" + err.message);
          } finally {
            isLoading = false;
          }
        }

        // 加载好友列表
        async function loadFriendList() {
          if (!currentUser) return;
          
          // 检查元素是否存在
          if (!dom.friendList || !dom.friendsLoader) {
            console.error('好友列表相关DOM元素缺失');
            return;
          }
          
          dom.friendsLoader.classList.remove('hidden');
          dom.friendList.innerHTML = '';
          
          try {
            const { data: relations, error } = await supabase
              .from("friend_relations")
              .select(`
                id,
                sender:users!friend_relations_sender_id_fkey (id, username, avatar),
                receiver:users!friend_relations_receiver_id_fkey (id, username, avatar),
                sender_id,
                receiver_id
              `)
              .or(`and(sender_id.eq.${currentUser.id},status.eq.accepted),and(receiver_id.eq.${currentUser.id},status.eq.accepted)`)
              .order("updated_at", { ascending: false });

            if (error) throw new Error(error.message);

            const friendList = relations.map(rel => 
              rel.sender_id === currentUser.id ? rel.receiver : rel.sender
            );

            if (!friendList.length) {
              dom.friendList.innerHTML = "<p class='text-gray-500 text-sm'>还没有好友，先添加一个吧～</p>";
              return;
            }

            dom.friendList.innerHTML = friendList.map(friend => `
              <div class="flex items-center gap-3 p-2 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors cursor-pointer" 
                   onclick="selectFriend('${friend.id}', '${friend.username}', '${friend.avatar || 'https://picsum.photos/200/200'}')">
                <img src="${friend.avatar || 'https://picsum.photos/200/200'}" alt="头像" class="w-8 h-8 rounded-full">
                <div class="flex-1 text-left">
                  <p class="font-medium text-sm">${friend.username}</p>
                </div>
                <button onclick="removeFriend('${friend.id}', event)" class="text-xs text-danger hover:text-danger/80">删除</button>
              </div>
            `).join("");
          } catch (err) {
            dom.friendList.innerHTML = `<p class='text-red-500 text-sm'>加载失败: ${err.message}</p>`;
          } finally {
            dom.friendsLoader.classList.add('hidden');
          }
        }

        // 删除好友
        window.removeFriend = async function(friendId, e) {
          e.stopPropagation();
          if (!confirm("确定要删除这个好友吗？")) return;
          if (isLoading) return;
          
          isLoading = true;
          try {
            const { data: relation } = await supabase
              .from("friend_relations")
              .select("id")
              .or(`and(sender_id.eq.${currentUser.id},receiver_id.eq.${friendId},status.eq.accepted),and(receiver_id.eq.${currentUser.id},sender_id.eq.${friendId},status.eq.accepted)`)
              .single();

            if (!relation) throw new Error("未找到好友关系～");

            const { error } = await supabase
              .from("friend_relations")
              .delete()
              .eq("id", relation.id);

            if (error) throw new Error(error.message);
            alert("已删除好友～");
            loadFriendList();
            
            if (friendId === selectedFriendId) {
              closeChat();
            }
          } catch (err) {
            alert("删除失败：" + err.message);
          } finally {
            isLoading = false;
          }
        }

        // 选择好友聊天
        window.selectFriend = function(friendId, friendName, friendAvatar) {
          if (!dom.chatArea || !dom.chatTip || !dom.chatFriendName || !dom.chatFriendAvatar) {
            console.error('聊天区域相关DOM元素缺失');
            return;
          }
          
          selectedFriendId = friendId;
          selectedFriendName = friendName;
          selectedFriendAvatar = friendAvatar;
          
          dom.chatArea.classList.remove('hidden');
          dom.chatTip.classList.add('hidden');
          
          dom.chatFriendName.textContent = friendName;
          dom.chatFriendAvatar.src = friendAvatar;
          
          loadChatHistory();
        }

        // 关闭聊天
        window.closeChat = function() {
          if (!dom.chatArea || !dom.chatTip) {
            console.error('聊天区域相关DOM元素缺失');
            return;
          }
          
          dom.chatArea.classList.add('hidden');
          dom.chatTip.classList.remove('hidden');
          
          selectedFriendId = null;
          selectedFriendName = null;
          selectedFriendAvatar = null;
          
          if (chatSubscription) {
            chatSubscription.unsubscribe();
            chatSubscription = null;
          }
        }

        // 加载聊天记录
        async function loadChatHistory() {
          if (!currentUser || !selectedFriendId) return;
          
          if (!dom.messageContainer || !dom.messagesLoader) {
            console.error('消息容器相关DOM元素缺失');
            return;
          }
          
          dom.messagesLoader.classList.remove('hidden');
          dom.messageContainer.innerHTML = '';
          
          try {
            const { data: messages, error } = await supabase
              .from('chat_messages')
              .select('*')
              .or(`and(sender_id.eq.${currentUser.id},receiver_id.eq.${selectedFriendId}),and(sender_id.eq.${selectedFriendId},receiver_id.eq.${currentUser.id})`)
              .order('created_at', { ascending: true });
          
            if (error) throw new Error(error.message);
            
            dom.messageContainer.innerHTML = messages.map(msg => `
              <div class="flex ${msg.sender_id === currentUser.id ? 'justify-end' : 'justify-start'} fade-in">
                <div class="${msg.sender_id === currentUser.id ? 'bg-primary text-white message-out' : 'bg-gray-100 text-gray-800 message-in'} px-4 py-2 rounded-lg max-w-[80%]">
                  <p>${msg.content}</p>
                  <p class="text-xs mt-1 ${msg.sender_id === currentUser.id ? 'text-primary-100' : 'text-gray-500'}">
                    ${new Date(msg.created_at).toLocaleTimeString()}
                  </p>
                </div>
              </div>
            `).join('');
            
            await markMessagesAsRead();
            initChatListener();
            scrollToBottom();
          } catch (err) {
            dom.messageContainer.innerHTML = `<p class='text-red-500 text-sm text-center'>加载消息失败: ${err.message}</p>`;
          } finally {
            dom.messagesLoader.classList.add('hidden');
          }
        }

        // 发送消息
        window.sendMessage = async function() {
          if (!dom.messageInput) {
            console.error('消息输入框DOM元素缺失');
            return;
          }
          
          const content = dom.messageInput.value.trim();
          
          if (!content || !currentUser || !selectedFriendId) return;
          
          try {
            const { error } = await supabase
              .from('chat_messages')
              .insert([{
                sender_id: currentUser.id,
                receiver_id: selectedFriendId,
                content: content
              }]);
          
            if (error) throw new Error(error.message);
            
            dom.messageInput.value = '';
            loadChatHistory();
          } catch (err) {
            alert('发送失败：' + err.message);
          }
        }

        // 标记消息已读
        async function markMessagesAsRead() {
          if (!currentUser || !selectedFriendId) return;
          
          try {
            const { error } = await supabase
              .from('chat_messages')
              .update({ is_read: true })
              .eq('sender_id', selectedFriendId)
              .eq('receiver_id', currentUser.id)
              .eq('is_read', false);
          
            if (error) console.error('标记已读失败：', error);
          } catch (err) {
            console.error('标记已读异常：', err);
          }
        }

        // 初始化聊天监听
        function initChatListener() {
          if (!currentUser || !selectedFriendId || chatSubscription) return;
          
          chatSubscription = supabase
            .channel('custom-filter-channel')
            .on(
              'postgres_changes',
              {
                event: 'INSERT',
                schema: 'public',
                table: 'chat_messages',
                filter: `or(sender_id=eq.${currentUser.id},receiver_id=eq.${currentUser.id})`
              },
              (payload) => {
                const newMsg = payload.new;
                if (
                  (newMsg.sender_id === currentUser.id && newMsg.receiver_id === selectedFriendId) ||
                  (newMsg.sender_id === selectedFriendId && newMsg.receiver_id === currentUser.id)
                ) {
                  loadChatHistory();
                }
              }
            )
            .subscribe();
        }

        // 滚动到最新消息
        function scrollToBottom() {
          if (!dom.messageContainer) return;
          dom.messageContainer.scrollTop = dom.messageContainer.scrollHeight;
        }

        // 页面关闭时清理
        window.addEventListener('beforeunload', () => {
          if (chatSubscription) {
            chatSubscription.unsubscribe();
          }
        });

        // 初始化页面
        initPage();

      } catch (err) {
        console.error('应用初始化失败:', err);
        alert('加载失败，请刷新页面重试');
      }
    }

    // 页面加载完成后初始化应用
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initApp);
    } else {
      initApp();
    }
  </script>
</body>
</html>