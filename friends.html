<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¥½å‹èŠå¤©</title>
    <!-- å¼•å…¥å¤–éƒ¨èµ„æº -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <!-- å¼•å…¥Socket.ioå®¢æˆ·ç«¯ï¼ˆæ ¸å¿ƒï¼‰ -->
    <script src="https://cdn.socket.io/4.5.1/socket.io.min.js"></script>
    
    <!-- Tailwindé…ç½® -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#3B82F6',
                        secondary: '#10B981',
                        danger: '#EF4444',
                        light: '#F3F4F6',
                        dark: '#1F2937'
                    },
                    fontFamily: {
                        sans: ['Inter', 'system-ui', 'sans-serif']
                    }
                }
            }
        }
    </script>
    
    <style type="text/tailwindcss">
        @layer utilities {
            .content-auto {
                content-visibility: auto;
            }
            .chat-bubble-left {
                border-radius: 1rem 1rem 1rem 0;
            }
            .chat-bubble-right {
                border-radius: 1rem 1rem 0 1rem;
            }
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <!-- é¡µé¢å¤´éƒ¨ -->
    <header class="bg-primary text-white shadow-md">
        <div class="container mx-auto px-4 py-3 flex justify-between items-center">
            <h1 class="text-xl font-bold"><i class="fas fa-comments"></i> å¥½å‹èŠå¤©</h1>
            <div class="flex items-center gap-3" id="userInfo">
                <span class="hidden md:inline" id="usernameDisplay"></span>
                <img src="" alt="ç”¨æˆ·å¤´åƒ" id="avatarDisplay" class="w-8 h-8 rounded-full border-2 border-white">
                <button id="logoutBtn" class="bg-white text-primary px-3 py-1 rounded hover:bg-opacity-90 transition">
                    <i class="fas fa-sign-out-alt"></i> é€€å‡º
                </button>
            </div>
        </div>
    </header>

    <main class="container mx-auto px-4 py-6 flex flex-col md:flex-row gap-6">
        <!-- å¥½å‹åˆ—è¡¨ -->
        <div class="w-full md:w-1/4 bg-white rounded-lg shadow-md p-4 h-[calc(100vh-120px)] overflow-y-auto">
            <h2 class="text-lg font-semibold mb-4 flex items-center">
                <i class="fas fa-users text-primary mr-2"></i> å¥½å‹åˆ—è¡¨
            </h2>
            <div class="relative">
                <input type="text" placeholder="æœç´¢å¥½å‹..." class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-primary">
                <i class="fas fa-search absolute right-3 top-3 text-gray-400"></i>
            </div>
            <ul class="mt-4 space-y-1" id="friendsList">
                <!-- å¥½å‹åˆ—è¡¨ä¼šé€šè¿‡JSåŠ¨æ€ç”Ÿæˆ -->
                <li class="p-2 hover:bg-light rounded cursor-pointer transition flex items-center gap-3">
                    <img src="https://picsum.photos/200/200?random=1" alt="å¥½å‹å¤´åƒ" class="w-10 h-10 rounded-full">
                    <div>
                        <p class="font-medium">å¼ ä¸‰</p>
                        <p class="text-xs text-gray-500">åœ¨çº¿</p>
                    </div>
                </li>
                <li class="p-2 hover:bg-light rounded cursor-pointer transition flex items-center gap-3">
                    <img src="https://picsum.photos/200/200?random=2" alt="å¥½å‹å¤´åƒ" class="w-10 h-10 rounded-full">
                    <div>
                        <p class="font-medium">æå››</p>
                        <p class="text-xs text-gray-500">åˆšåˆšåœ¨çº¿</p>
                    </div>
                </li>
            </ul>
        </div>

        <!-- èŠå¤©çª—å£ -->
        <div class="w-full md:w-3/4 bg-white rounded-lg shadow-md flex flex-col h-[calc(100vh-120px)]" id="chatWindow">
            <!-- èŠå¤©å¤´éƒ¨ -->
            <div class="border-b p-4 flex justify-between items-center">
                <div class="flex items-center gap-3">
                    <img src="https://picsum.photos/200/200?random=1" alt="å½“å‰èŠå¤©å¥½å‹å¤´åƒ" id="currentFriendAvatar" class="w-10 h-10 rounded-full">
                    <h2 class="font-semibold" id="currentFriendName">é€‰æ‹©å¥½å‹å¼€å§‹èŠå¤©</h2>
                </div>
                <div class="flex gap-2">
                    <button class="p-2 hover:bg-light rounded-full transition" title="è¯­éŸ³é€šè¯">
                        <i class="fas fa-phone text-primary"></i>
                    </button>
                    <button class="p-2 hover:bg-light rounded-full transition" title="è§†é¢‘é€šè¯">
                        <i class="fas fa-video text-primary"></i>
                    </button>
                    <button class="p-2 hover:bg-light rounded-full transition" title="æ›´å¤šé€‰é¡¹">
                        <i class="fas fa-ellipsis-v text-gray-500"></i>
                    </button>
                </div>
            </div>

            <!-- èŠå¤©å†…å®¹ -->
            <div class="flex-1 p-4 overflow-y-auto" id="chatMessages">
                <div class="text-center text-gray-500 text-sm my-4">
                    ä»Šå¤© 15:30
                </div>
                <!-- å¯¹æ–¹æ¶ˆæ¯ -->
                <div class="flex items-end gap-2 mb-4">
                    <img src="https://picsum.photos/200/200?random=1" alt="å¯¹æ–¹å¤´åƒ" class="w-8 h-8 rounded-full">
                    <div>
                        <p class="bg-light px-4 py-2 chat-bubble-left max-w-[70%]">ä½ å¥½ï¼æœ€è¿‘æ€ä¹ˆæ ·ï¼Ÿ</p>
                        <p class="text-xs text-gray-500 mt-1">15:32</p>
                    </div>
                </div>
                <!-- è‡ªå·±æ¶ˆæ¯ -->
                <div class="flex items-end gap-2 mb-4 justify-end">
                    <div class="text-right">
                        <p class="bg-primary text-white px-4 py-2 chat-bubble-right max-w-[70%]">æŒºå¥½çš„ï¼Œä½ å‘¢ï¼Ÿ</p>
                        <p class="text-xs text-gray-500 mt-1">15:33</p>
                    </div>
                    <img src="" alt="è‡ªå·±å¤´åƒ" id="myAvatar" class="w-8 h-8 rounded-full">
                </div>
            </div>

            <!-- æ¶ˆæ¯è¾“å…¥æ¡† -->
            <div class="border-t p-4">
                <div class="flex gap-2 mb-2">
                    <button class="p-2 text-gray-500 hover:bg-light rounded-full transition">
                        <i class="fas fa-image"></i>
                    </button>
                    <button class="p-2 text-gray-500 hover:bg-light rounded-full transition">
                        <i class="fas fa-smile"></i>
                    </button>
                    <button class="p-2 text-gray-500 hover:bg-light rounded-full transition">
                        <i class="fas fa-paperclip"></i>
                    </button>
                </div>
                <div class="flex gap-2">
                    <input type="text" id="chatInput" placeholder="è¾“å…¥æ¶ˆæ¯..." class="flex-1 px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-primary">
                    <button id="sendBtn" class="bg-primary text-white px-4 py-2 rounded-lg hover:bg-primary/90 transition">
                        <i class="fas fa-paper-plane"></i> å‘é€
                    </button>
                </div>
            </div>
        </div>
    </main>

    <!-- é€šçŸ¥ç»„ä»¶ -->
    <div id="notification" class="fixed bottom-4 right-4 px-4 py-3 rounded-lg shadow-lg transform translate-y-20 opacity-0 transition-all duration-300 z-50"></div>

    <script>
        // å…¨å±€å˜é‡
        let currentUser = null;         // å½“å‰ç™»å½•ç”¨æˆ·ä¿¡æ¯
        let currentChatFriend = null;   // å½“å‰èŠå¤©çš„å¥½å‹
        let socketIo = null;            // Socket.ioå®ä¾‹

        // DOMåŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            // 1. è¯»å–æœ¬åœ°å­˜å‚¨çš„ç”¨æˆ·ä¿¡æ¯ï¼ˆå‡è®¾ç™»å½•åå·²ä¿å­˜ï¼‰
            loadUserInfo();
            
            // 2. åˆå§‹åŒ–Socket.ioè¿æ¥
            if (currentUser) {
                initSocketIo();
            } else {
                showNotification('è¯·å…ˆç™»å½•', 'error');
                setTimeout(() => {
                    window.location.href = 'login.html'; // è·³è½¬åˆ°ç™»å½•é¡µ
                }, 1000);
            }

            // 3. ç»‘å®šäº‹ä»¶
            document.getElementById('sendBtn').addEventListener('click', sendMessage);
            document.getElementById('chatInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') sendMessage();
            });
            document.getElementById('logoutBtn').addEventListener('click', logout);
            
            // 4. ç»‘å®šå¥½å‹åˆ—è¡¨ç‚¹å‡»äº‹ä»¶
            document.querySelectorAll('#friendsList li').forEach(item => {
                item.addEventListener('click', function() {
                    const friendName = this.querySelector('p:first-child').textContent;
                    const friendAvatar = this.querySelector('img').src;
                    setCurrentChatFriend(friendName, friendAvatar);
                });
            });
        });

        // 1. åŠ è½½ç”¨æˆ·ä¿¡æ¯
        function loadUserInfo() {
            const userStr = localStorage.getItem('userInfo');
            if (userStr) {
                currentUser = JSON.parse(userStr);
                // æ›´æ–°é¡µé¢æ˜¾ç¤º
                document.getElementById('usernameDisplay').textContent = currentUser.username;
                document.getElementById('avatarDisplay').src = currentUser.avatar;
                document.getElementById('myAvatar').src = currentUser.avatar;
                console.log('è¯»å–åˆ°çš„ç”¨æˆ·ä¿¡æ¯ï¼š', currentUser);
            }
        }

        // 2. åˆå§‹åŒ–Socket.ioè¿æ¥ï¼ˆæ ¸å¿ƒï¼‰
        function initSocketIo() {
            // å…³é—­å·²æœ‰è¿æ¥
            if (socketIo) {
                socketIo.disconnect();
            }

            try {
                // è¿æ¥Socket.io Cloudï¼ˆä½¿ç”¨æµ‹è¯•åœ°å€ï¼Œæ­£å¼ç¯å¢ƒæ›¿æ¢ä¸ºè‡ªå·±çš„åœ°å€ï¼‰
                const socketUrl = 'https://socket.io.cloud/proj_123456';
                console.log('æ­£åœ¨è¿æ¥Socket.io Cloudï¼š', socketUrl);
                
                socketIo = io(socketUrl, {
                    query: {
                        username: currentUser.username  // ä¼ é€’ç”¨æˆ·å
                    },
                    auth: {
                        token: currentUser.token        // ä¼ é€’è®¤è¯token
                    },
                    reconnection: true,               // è‡ªåŠ¨é‡è¿
                    reconnectionAttempts: 10          // æœ€å¤§é‡è¿æ¬¡æ•°
                });

                // è¿æ¥æˆåŠŸäº‹ä»¶
                socketIo.on('connect', () => {
                    console.log('âœ… Socket.ioè¿æ¥æˆåŠŸï¼ŒIDï¼š', socketIo.id);
                    showNotification('å®æ—¶èŠå¤©å·²è¿æ¥', 'success');
                    
                    // åŠ å…¥è‡ªå·±çš„"æˆ¿é—´"ï¼ˆç”¨äºç‚¹å¯¹ç‚¹èŠå¤©ï¼‰
                    socketIo.emit('join', currentUser.username);
                });

                // æ”¶åˆ°æ¶ˆæ¯äº‹ä»¶
                socketIo.on('message', (data) => {
                    console.log('ğŸ“¥ æ”¶åˆ°æ¶ˆæ¯ï¼š', data);
                    // æ˜¾ç¤ºæ¶ˆæ¯åˆ°èŠå¤©çª—å£
                    addMessageToChat(data.from, data.content, new Date(data.timestamp), true);
                    
                    // å¦‚æœæ˜¯å½“å‰èŠå¤©å¯¹è±¡çš„æ¶ˆæ¯ï¼Œé«˜äº®æç¤º
                    if (currentChatFriend === data.from) {
                        // æ»šåŠ¨åˆ°æœ€æ–°æ¶ˆæ¯
                        const chatMessages = document.getElementById('chatMessages');
                        chatMessages.scrollTop = chatMessages.scrollHeight;
                    } else {
                        // ä¸æ˜¯å½“å‰èŠå¤©å¯¹è±¡ï¼Œæ˜¾ç¤ºé€šçŸ¥
                        showNotification(`æ”¶åˆ°${data.from}çš„æ¶ˆæ¯ï¼š${data.content}`, 'info');
                    }
                });

                // è¿æ¥é”™è¯¯äº‹ä»¶
                socketIo.on('connect_error', (error) => {
                    console.error('âŒ Socket.ioè¿æ¥é”™è¯¯ï¼š', error.message);
                    showNotification('èŠå¤©è¿æ¥å¤±è´¥ï¼š' + error.message, 'error');
                });

                // æ–­å¼€è¿æ¥äº‹ä»¶
                socketIo.on('disconnect', (reason) => {
                    console.log('ğŸ”Œ Socket.ioæ–­å¼€è¿æ¥ï¼š', reason);
                    if (reason !== 'io client disconnect') {
                        showNotification('èŠå¤©è¿æ¥å·²æ–­å¼€ï¼Œæ­£åœ¨é‡è¯•...', 'error');
                    }
                });

            } catch (e) {
                console.error('åˆå§‹åŒ–Socket.ioå¤±è´¥ï¼š', e);
                showNotification('åˆå§‹åŒ–èŠå¤©å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢', 'error');
                setTimeout(initSocketIo, 3000); // 3ç§’åé‡è¯•
            }
        }

        // 3. è®¾ç½®å½“å‰èŠå¤©å¥½å‹
        function setCurrentChatFriend(name, avatar) {
            currentChatFriend = name;
            document.getElementById('currentFriendName').textContent = name;
            document.getElementById('currentFriendAvatar').src = avatar;
            
            // æ¸…ç©ºèŠå¤©çª—å£ï¼ˆå®é™…é¡¹ç›®ä¸­åº”åŠ è½½å†å²æ¶ˆæ¯ï¼‰
            document.getElementById('chatMessages').innerHTML = `
                <div class="text-center text-gray-500 text-sm my-4">
                    ä¸${name}çš„èŠå¤©
                </div>
            `;
            
            // èšç„¦è¾“å…¥æ¡†
            document.getElementById('chatInput').focus();
        }

        // 4. å‘é€æ¶ˆæ¯
        function sendMessage() {
            if (!currentUser || !currentChatFriend || !socketIo) {
                showNotification('è¯·å…ˆé€‰æ‹©èŠå¤©å¯¹è±¡', 'warning');
                return;
            }

            const inputEl = document.getElementById('chatInput');
            const content = inputEl.value.trim();
            if (!content) return;

            // æ„å»ºæ¶ˆæ¯æ•°æ®
            const messageData = {
                from: currentUser.username,
                to: currentChatFriend,
                content: content,
                timestamp: new Date().toISOString()
            };

            // å‘é€æ¶ˆæ¯åˆ°æœåŠ¡å™¨
            socketIo.emit('sendMessage', messageData);
            
            // æ·»åŠ åˆ°æœ¬åœ°èŠå¤©çª—å£ï¼ˆè‡ªå·±çš„æ¶ˆæ¯ï¼‰
            addMessageToChat(currentUser.username, content, new Date(), false);
            
            // æ¸…ç©ºè¾“å…¥æ¡†
            inputEl.value = '';
        }

        // 5. æ·»åŠ æ¶ˆæ¯åˆ°èŠå¤©çª—å£
        function addMessageToChat(sender, content, time, isOther) {
            const chatMessages = document.getElementById('chatMessages');
            const timeStr = time.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            
            // æ¶ˆæ¯HTMLæ¨¡æ¿
            const messageHtml = isOther 
                ? `
                <div class="flex items-end gap-2 mb-4">
                    <img src="https://picsum.photos/200/200?random=${sender}" alt="${sender}çš„å¤´åƒ" class="w-8 h-8 rounded-full">
                    <div>
                        <p class="bg-light px-4 py-2 chat-bubble-left max-w-[70%]">${content}</p>
                        <p class="text-xs text-gray-500 mt-1">${timeStr}</p>
                    </div>
                </div>
                `
                : `
                <div class="flex items-end gap-2 mb-4 justify-end">
                    <div class="text-right">
                        <p class="bg-primary text-white px-4 py-2 chat-bubble-right max-w-[70%]">${content}</p>
                        <p class="text-xs text-gray-500 mt-1">${timeStr}</p>
                    </div>
                    <img src="${currentUser.avatar}" alt="è‡ªå·±çš„å¤´åƒ" class="w-8 h-8 rounded-full">
                </div>
                `;
            
            // æ·»åŠ åˆ°èŠå¤©çª—å£
            chatMessages.insertAdjacentHTML('beforeend', messageHtml);
            
            // æ»šåŠ¨åˆ°æœ€æ–°æ¶ˆæ¯
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        // 6. æ˜¾ç¤ºé€šçŸ¥
        function showNotification(message, type = 'info') {
            const notification = document.getElementById('notification');
            const bgColors = {
                success: 'bg-secondary text-white',
                error: 'bg-danger text-white',
                info: 'bg-primary text-white',
                warning: 'bg-yellow-500 text-white'
            };

            notification.className = `fixed bottom-4 right-4 px-4 py-3 rounded-lg shadow-lg transform translate-y-0 opacity-100 transition-all duration-300 z-50 ${bgColors[type]}`;
            notification.textContent = message;

            // 3ç§’åéšè—
            setTimeout(() => {
                notification.className = 'fixed bottom-4 right-4 px-4 py-3 rounded-lg shadow-lg transform translate-y-20 opacity-0 transition-all duration-300 z-50';
            }, 3000);
        }

        // 7. é€€å‡ºç™»å½•
        function logout() {
            // æ–­å¼€Socketè¿æ¥
            if (socketIo) {
                socketIo.disconnect();
            }
            // æ¸…é™¤æœ¬åœ°å­˜å‚¨
            localStorage.removeItem('userInfo');
            // è·³è½¬åˆ°ç™»å½•é¡µ
            window.location.href = 'login.html';
        }
    </script>
</body>
</html>
