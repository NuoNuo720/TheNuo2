<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¥½å‹èŠå¤©ç³»ç»Ÿï¼ˆå¢å¼ºç‰ˆï¼‰</title>
    <!-- å¤–éƒ¨èµ„æº -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.bootcdn.net/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <!-- å¼•å…¥è¡¨æƒ…åº“å’ŒPDFå¯¼å‡ºåº“ -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/emoji.css@3.0.1/dist/emoji.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <!-- Tailwind é…ç½® -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#6366f1',
                        secondary: '#8b5cf6',
                        accent: '#ec4899',
                        success: '#10b981',
                        warning: '#f59e0b',
                        danger: '#ef4444',
                        info: '#3b82f6',
                    }
                }
            }
        }
    </script>
    
    <!-- è‡ªå®šä¹‰æ ·å¼ -->
    <style type="text/tailwindcss">
        @layer utilities {
            .status-indicator { @apply absolute bottom-0 right-0 w-3 h-3 rounded-full border-2 border-white; }
            .content-auto { content-visibility: auto; }
            .chat-bubble-left { @apply bg-gray-100 text-gray-800 rounded-tl-lg rounded-tr-lg rounded-br-lg; }
            .chat-bubble-right { @apply bg-primary text-white rounded-tl-lg rounded-tr-lg rounded-bl-lg; }
            .emoji-item { @apply text-2xl cursor-pointer hover:bg-gray-100 rounded p-1 transition-colors; }
            .pulse-animation { animation: pulse 2s infinite; }
            .fade-out { animation: fadeOut 10s forwards; }
            .message-status { @apply text-xs ml-1 opacity-70; }
            .search-highlight { @apply bg-yellow-200 px-0.5 rounded; }
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        
        @keyframes fadeOut {
            from { opacity: 1; }
            to { opacity: 0.3; }
        }
        
        .animate-fadeIn { animation: fadeIn 0.3s ease-out forwards; }
        
        /* çŠ¶æ€æ ‡ç­¾æ ·å¼ */
        .status-tag {
            @apply text-xs px-2 py-0.5 rounded-full font-medium;
        }
        
        /* æ¶ˆæ¯é€šçŸ¥æ ·å¼ */
        .notification {
            @apply fixed bottom-4 right-4 bg-white rounded-lg shadow-lg p-4 max-w-xs z-50 transform translate-y-full opacity-0 transition-all duration-300;
        }
        
        .notification.show {
            @apply transform translate-y-0 opacity-100;
        }
        
        /* æœç´¢ç»“æœé«˜äº® */
        mark {
            @apply bg-yellow-200 px-0.5 rounded;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <div class="max-w-7xl mx-auto">
        <!-- é¡¶éƒ¨å¯¼èˆªæ  -->
        <header class="bg-white shadow-sm py-3 px-4 md:px-6 sticky top-0 z-30">
            <div class="flex justify-between items-center">
                <h1 class="text-xl md:text-2xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-primary to-secondary">
                    <i class="fa fa-comments mr-2"></i>å¥½å‹èŠå¤©ç³»ç»Ÿ
                </h1>
                
                <!-- è¿”å›å¯¼èˆªé¡µé¢æŒ‰é’® -->
                <button onclick="window.location.href='indexdaohang.html'" class="mr-2 px-3 py-1.5 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition-colors hidden md:flex">
                    <i class="fa fa-home mr-1"></i>è¿”å›é¦–é¡µ
                </button>
                
                <div id="headerUserInfo" class="flex items-center gap-4">
                    <button id="statusSelectorBtn" class="hidden items-center gap-1 px-3 py-1.5 rounded-full bg-gray-100 hover:bg-gray-200 transition-colors">
                        <span id="currentStatusText" class="status-tag bg-success text-white">åœ¨çº¿</span>
                        <i class="fa fa-chevron-down text-xs"></i>
                    </button>
                    
                    <button id="dataBoardBtn" class="hidden items-center gap-1 px-3 py-1.5 rounded-full bg-gray-100 hover:bg-gray-200 transition-colors">
                        <i class="fa fa-bar-chart text-gray-600"></i>
                    </button>
                    
                    <button id="profileBtn" class="hidden items-center gap-2 px-3 py-1.5 rounded-full hover:bg-gray-100 transition-colors">
                        <img id="headerAvatar" src="https://picsum.photos/200/200" alt="ç”¨æˆ·å¤´åƒ" class="w-8 h-8 rounded-full">
                        <span id="headerUsername" class="hidden md:inline font-medium"></span>
                    </button>
                    
                    <button id="loginBtn" class="px-4 py-2 bg-primary text-white rounded-lg hover:bg-primary/90 transition-colors">
                        <i class="fa fa-sign-in mr-1"></i>ç™»å½•
                    </button>
                </div>
            </div>
            
            <!-- çŠ¶æ€é€‰æ‹©ä¸‹æ‹‰æ¡† -->
            <div id="statusDropdown" class="hidden absolute right-4 mt-2 w-48 bg-white rounded-lg shadow-lg py-2 z-40">
                <p class="px-4 py-1 text-xs text-gray-500">é€‰æ‹©çŠ¶æ€</p>
                <button onclick="updateStatus('online')" class="w-full text-left px-4 py-2 hover:bg-gray-100 transition-colors">
                    <span class="status-tag bg-success text-white mr-2">åœ¨çº¿</span>åœ¨çº¿
                </button>
                <button onclick="updateStatus('busy')" class="w-full text-left px-4 py-2 hover:bg-gray-100 transition-colors">
                    <span class="status-tag bg-danger text-white mr-2">å¿™ç¢Œ</span>å¿™ç¢Œ
                </button>
                <button onclick="updateStatus('away')" class="w-full text-left px-4 py-2 hover:bg-gray-100 transition-colors">
                    <span class="status-tag bg-warning text-white mr-2">ç¦»å¼€</span>ç¦»å¼€
                </button>
                <button onclick="updateStatus('offline')" class="w-full text-left px-4 py-2 hover:bg-gray-100 transition-colors">
                    <span class="status-tag bg-gray-400 text-white mr-2">ç¦»çº¿</span>ç¦»çº¿
                </button>
            </div>
        </header>
        
        <!-- ä¸»å†…å®¹åŒº -->
        <main class="p-4 md:p-6">
            <!-- ç™»å½•/æ³¨å†ŒåŒºåŸŸ -->
            <div id="loginSection" class="max-w-md mx-auto my-10">
                <div class="bg-white rounded-xl shadow-md p-6">
                    <h2 class="text-xl font-bold mb-6 text-center">è¯·ç™»å½•/æ³¨å†Œ</h2>
                    <input type="text" id="username" placeholder="è¯·è¾“å…¥æ˜µç§°" 
                           class="w-full px-4 py-3 border border-gray-200 rounded-lg mb-4 focus:outline-none focus:ring-2 focus:ring-primary/50">
                    <div class="flex gap-3">
                        <button onclick="handleLogin()" class="flex-1 px-4 py-2 bg-primary text-white rounded-lg hover:bg-primary/90 transition-colors">
                            <i class="fa fa-sign-in mr-1"></i>ç™»å½•
                        </button>
                        <button onclick="handleRegister()" class="flex-1 px-4 py-2 bg-accent text-white rounded-lg hover:bg-accent/90 transition-colors">
                            <i class="fa fa-user-plus mr-1"></i>æ³¨å†Œ
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- ä¸ªäººæ•°æ®çœ‹æ¿ -->
            <div id="dataBoardSection" class="hidden max-w-4xl mx-auto bg-white rounded-xl shadow-md p-6 mb-6">
                <div class="flex justify-between items-start mb-6">
                    <h2 class="text-2xl font-bold">ä¸ªäººæ•°æ®çœ‹æ¿</h2>
                    <button onclick="switchToChatView()" class="px-3 py-1.5 bg-gray-100 rounded-lg hover:bg-gray-200 transition-colors">
                        <i class="fa fa-comments mr-1"></i>è¿”å›èŠå¤©
                    </button>
                </div>
                
                <!-- èŠå¤©ç»Ÿè®¡ -->
                <div class="mb-8">
                    <h3 class="text-xl font-semibold mb-4">èŠå¤©ç»Ÿè®¡</h3>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <p class="text-gray-500 text-sm">æœ¬å‘¨å‘é€æ¶ˆæ¯</p>
                            <p id="weeklyMessageCount" class="text-2xl font-bold text-primary">0</p>
                        </div>
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <p class="text-gray-500 text-sm">æ€»å¥½å‹æ•°</p>
                            <p id="totalFriendsCount" class="text-2xl font-bold text-secondary">0</p>
                        </div>
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <p class="text-gray-500 text-sm">èŠå¤©æœ€é¢‘ç¹å¥½å‹</p>
                            <p id="mostChatFriend" class="text-xl font-bold text-accent">-</p>
                        </div>
                    </div>
                </div>
                
                <!-- å¸¸ç”¨è¡¨æƒ… -->
                <div class="mb-8">
                    <h3 class="text-xl font-semibold mb-4">å¸¸ç”¨è¡¨æƒ…</h3>
                    <div id="frequentEmojis" class="flex gap-3 p-3 bg-gray-50 rounded-lg">
                        <p class="text-gray-500 italic">æš‚æ— æ•°æ®</p>
                    </div>
                </div>
                
                <!-- ä¸ªæ€§åŒ–æ¨è -->
                <div>
                    <h3 class="text-xl font-semibold mb-4">ä¸ªæ€§åŒ–æ¨è</h3>
                    
                    <div class="mb-6">
                        <h4 class="font-medium mb-2">å¯èƒ½è®¤è¯†çš„äºº</h4>
                        <div id="possibleFriends" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-3 p-3 bg-gray-50 rounded-lg">
                            <p class="text-gray-500 italic">æš‚æ— æ¨è</p>
                        </div>
                    </div>
                    
                    <div>
                        <h4 class="font-medium mb-2">çƒ­é—¨è¡¨æƒ…åŒ…</h4>
                        <div id="popularGifs" class="grid grid-cols-3 sm:grid-cols-5 gap-3 p-3 bg-gray-50 rounded-lg">
                            <p class="text-gray-500 italic">åŠ è½½ä¸­...</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- ä¸ªäººä¸»é¡µ -->
            <div id="profileSection" class="hidden max-w-2xl mx-auto bg-white rounded-xl shadow-md p-6 mb-6">
                <div class="flex justify-between items-start mb-6">
                    <h2 class="text-2xl font-bold">ä¸ªäººä¸»é¡µ</h2>
                    <button onclick="switchToChatView()" class="px-3 py-1.5 bg-gray-100 rounded-lg hover:bg-gray-200 transition-colors">
                        <i class="fa fa-comments mr-1"></i>è¿”å›èŠå¤©
                    </button>
                </div>
                
                <div class="flex flex-col md:flex-row gap-6 items-center mb-6">
                    <div class="relative">
                        <img id="profileAvatar" src="https://picsum.photos/200/200" alt="ç”¨æˆ·å¤´åƒ" class="w-32 h-32 rounded-full object-cover">
                        <span id="profileStatusIndicator" class="status-indicator status-online"></span>
                    </div>
                    
                    <div class="text-center md:text-left">
                        <h3 id="profileUsername" class="text-xl font-bold mb-1"></h3>
                        <p id="profileStatusText" class="status-tag bg-success text-white mb-2"></p>
                        <p class="text-gray-500 text-sm">
                            <i class="fa fa-clock-o mr-1"></i>æœ€åæ´»è·ƒ: <span id="profileLastActive"></span>
                        </p>
                    </div>
                </div>
                
                <!-- ä¸ªæ€§ç­¾å -->
                <div class="mb-6">
                    <h4 class="font-bold mb-2">ä¸ªæ€§ç­¾å</h4>
                    <p id="profileSignature" class="text-gray-600 italic border-l-4 border-primary pl-3 py-1"></p>
                </div>
                
                <div class="border-t pt-4">
                    <h4 class="font-bold mb-3">ä¿®æ”¹ä¸ªäººä¿¡æ¯</h4>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm text-gray-600 mb-1">æ˜µç§°</label>
                            <input type="text" id="newUsername" class="w-full px-4 py-2 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/50">
                        </div>
                        
                        <div>
                            <label class="block text-sm text-gray-600 mb-1">ä¸ªæ€§ç­¾å</label>
                            <textarea id="newSignature" rows="2" class="w-full px-4 py-2 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/50 resize-none" placeholder="æ·»åŠ ä¸€å¥ä¸ªæ€§ç­¾å..."></textarea>
                        </div>
                        
                        <div>
                            <label class="block text-sm text-gray-600 mb-1">é€‰æ‹©çŠ¶æ€</label>
                            <select id="profileStatusSelector" class="w-full px-4 py-2 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/50">
                                <option value="online">åœ¨çº¿</option>
                                <option value="busy">å¿™ç¢Œ</option>
                                <option value="away">ç¦»å¼€</option>
                                <option value="offline">ç¦»çº¿</option>
                            </select>
                        </div>
                        
                        <button onclick="saveProfileChanges()" class="px-4 py-2 bg-primary text-white rounded-lg hover:bg-primary/90 transition-colors">
                            <i class="fa fa-save mr-1"></i>ä¿å­˜ä¿®æ”¹
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- å¥½å‹ä¸»é¡µ -->
            <div id="friendProfileSection" class="hidden max-w-2xl mx-auto bg-white rounded-xl shadow-md p-6 mb-6">
                <div class="flex justify-between items-start mb-6">
                    <h2 class="text-2xl font-bold">å¥½å‹èµ„æ–™</h2>
                    <button onclick="switchToChatView()" class="px-3 py-1.5 bg-gray-100 rounded-lg hover:bg-gray-200 transition-colors">
                        <i class="fa fa-comments mr-1"></i>è¿”å›èŠå¤©
                    </button>
                </div>
                
                <div class="flex flex-col md:flex-row gap-6 items-center mb-6">
                    <div class="relative">
                        <img id="friendProfileAvatar" src="https://picsum.photos/200/200" alt="å¥½å‹å¤´åƒ" class="w-32 h-32 rounded-full object-cover">
                        <span id="friendProfileStatusIndicator" class="status-indicator status-online"></span>
                    </div>
                    
                    <div class="text-center md:text-left">
                        <h3 id="friendProfileUsername" class="text-xl font-bold mb-1"></h3>
                        <p id="friendProfileStatusText" class="status-tag bg-success text-white mb-2"></p>
                        <p class="text-gray-500 text-sm">
                            <i class="fa fa-clock-o mr-1"></i>æœ€åæ´»è·ƒ: <span id="friendProfileLastActive"></span>
                        </p>
                    </div>
                </div>
                
                <!-- ä¸ªæ€§ç­¾å -->
                <div class="mb-6">
                    <h4 class="font-bold mb-2">ä¸ªæ€§ç­¾å</h4>
                    <p id="friendProfileSignature" class="text-gray-600 italic border-l-4 border-primary pl-3 py-1"></p>
                </div>
                
                <div class="border-t pt-4">
                    <button id="startChatWithFriendBtn" class="px-4 py-2 bg-primary text-white rounded-lg hover:bg-primary/90 transition-colors">
                        <i class="fa fa-comment mr-1"></i>å¼€å§‹èŠå¤©
                    </button>
                </div>
            </div>
            
            <!-- èŠå¤©ç•Œé¢ -->
            <div id="chatSection" class="hidden grid grid-cols-1 lg:grid-cols-4 gap-6">
                <!-- å·¦ä¾§ï¼šå¥½å‹ç®¡ç† -->
                <div class="space-y-6 lg:col-span-1">
                    <!-- æœç´¢æ¡† -->
                    <div class="relative">
                        <input type="text" placeholder="æœç´¢å¥½å‹..." 
                               class="w-full pl-10 pr-4 py-3 border border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-primary/50">
                        <i class="fa fa-search absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
                    </div>
                    
                    <!-- æ·»åŠ å¥½å‹ -->
                    <div class="bg-white rounded-xl shadow-md p-4">
                        <h3 class="font-bold mb-4 flex items-center">
                            <i class="fa fa-user-plus text-primary mr-2"></i>æ·»åŠ å¥½å‹
                        </h3>
                        <div class="flex gap-2">
                            <input type="text" id="friendName" placeholder="è¾“å…¥å¥½å‹æ˜µç§°" 
                                   class="flex-1 px-3 py-2 border border-gray-200 rounded-lg focus:outline-none focus:ring-1 focus:ring-primary">
                            <button onclick="addFriend()" class="px-3 py-2 bg-primary text-white rounded-lg hover:bg-primary/90">
                                <i class="fa fa-paper-plane"></i>
                            </button>
                        </div>
                    </div>
                    
                    <!-- å¥½å‹ç”³è¯· -->
                    <div class="bg-white rounded-xl shadow-md p-4">
                        <h3 class="font-bold mb-4 flex items-center">
                            <i class="fa fa-bell text-accent mr-2"></i>å¥½å‹ç”³è¯·
                            <span id="requestCount" class="ml-2 bg-accent text-white text-xs rounded-full w-5 h-5 flex items-center justify-center hidden">0</span>
                        </h3>
                        <div id="friendRequests" class="space-y-3 max-h-48 overflow-y-auto pr-1">
                            <div class="text-center text-gray-500 py-6">
                                <i class="fa fa-envelope-o text-2xl mb-2 opacity-30"></i>
                                <p class="text-sm italic">æš‚æ— å¥½å‹ç”³è¯·</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- å¥½å‹åˆ—è¡¨ -->
                    <div class="bg-white rounded-xl shadow-md p-4">
                        <h3 class="font-bold mb-4 flex items-center">
                            <i class="fa fa-users text-secondary mr-2"></i>æˆ‘çš„å¥½å‹
                        </h3>
                        <div id="friendsList" class="space-y-3 max-h-[calc(100vh-450px)] overflow-y-auto pr-1">
                            <div class="text-center text-gray-500 py-8">
                                <i class="fa fa-hand-o-down text-2xl mb-2 opacity-30"></i>
                                <p class="text-sm italic">æš‚æ— å¥½å‹ï¼Œæ·»åŠ å‡ ä¸ªå§ï¼</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- å³ä¾§ï¼šèŠå¤©åŒºåŸŸ -->
                <div class="lg:col-span-3">
                    <div class="bg-white rounded-xl shadow-md h-full flex flex-col">
                        <!-- èŠå¤©æ ‡é¢˜ -->
                        <div id="chatHeader" class="border-b p-4 flex justify-between items-center">
                            <div class="flex items-center gap-3">
                                <div class="relative hidden md:block">
                                    <img id="chatFriendAvatar" src="https://picsum.photos/200/200" alt="å¥½å‹å¤´åƒ" class="w-10 h-10 rounded-full">
                                    <span id="chatFriendStatus" class="status-indicator status-online"></span>
                                </div>
                                <h3 class="font-bold text-xl">
                                    <span id="chatWith">é€‰æ‹©å¥½å‹å¼€å§‹èŠå¤©</span>
                                    <span id="typingIndicator" class="text-xs text-gray-500 ml-2 hidden">æ­£åœ¨è¾“å…¥...</span>
                                </h3>
                            </div>
                            <div class="flex gap-2">
                                <button onclick="switchToProfileView()" class="p-2 rounded-full hover:bg-gray-100 transition-colors">
                                    <i class="fa fa-user text-gray-600"></i>
                                </button>
                                <button id="viewFriendProfileBtn" class="p-2 rounded-full hover:bg-gray-100 transition-colors hidden">
                                    <i class="fa fa-user-circle text-gray-600"></i>
                                </button>
                                <button onclick="handleLogout()" class="p-2 rounded-full hover:bg-gray-100 transition-colors">
                                    <i class="fa fa-sign-out text-gray-600"></i>
                                </button>
                            </div>
                        </div>
                        
                        <!-- èŠå¤©æœç´¢ -->
                        <div id="chatSearchArea" class="p-4 border-b hidden">
                            <div class="relative">
                                <input type="text" id="messageSearchInput" placeholder="æœç´¢èŠå¤©è®°å½•..." 
                                       class="w-full pl-10 pr-4 py-2 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/50">
                                <i class="fa fa-search absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
                                <button id="clearSearchBtn" class="absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 hidden">
                                    <i class="fa fa-times"></i>
                                </button>
                            </div>
                            <div id="searchResultsInfo" class="text-xs text-gray-500 mt-2 hidden">
                                æ‰¾åˆ° <span id="searchCount">0</span> æ¡åŒ¹é…ç»“æœ
                            </div>
                        </div>
                        
                        <!-- èŠå¤©å†…å®¹ï¼ˆå›ºå®šé«˜åº¦ï¼Œè¶…å‡ºæ»šåŠ¨ï¼‰ -->
                        <div id="messages" class="flex-1 overflow-y-auto p-4 space-y-4 max-h-[500px] bg-gray-50">
                            <div class="text-center text-gray-500 py-10">
                                <i class="fa fa-comment text-3xl mb-3 opacity-20"></i>
                                <p class="text-sm italic">è¯·ä»å·¦ä¾§å¥½å‹åˆ—è¡¨ä¸­é€‰æ‹©ä¸€ä½å¥½å‹å¼€å§‹èŠå¤©</p>
                            </div>
                        </div>
                        
                        <!-- å‘é€æ¶ˆæ¯åŒºåŸŸ -->
                        <div id="messageInputArea" class="flex flex-col gap-2 p-4 border-t hidden">
                            <!-- è¡¨æƒ…å’ŒGIFé€‰æ‹©å™¨ -->
                            <div class="flex gap-2">
                                <button id="emojiToggleBtn" class="p-2 bg-gray-100 rounded-lg hover:bg-gray-200 transition-colors">
                                    <i class="fa fa-smile-o text-gray-700"></i>
                                </button>
                                <button id="gifToggleBtn" class="p-2 bg-gray-100 rounded-lg hover:bg-gray-200 transition-colors">
                                    <i class="fa fa-film text-gray-700"></i>
                                </button>
                                
                                <!-- æ¶ˆæ¯è®¾ç½® -->
                                <div class="relative ml-auto">
                                    <button id="messageOptionsBtn" class="p-2 bg-gray-100 rounded-lg hover:bg-gray-200 transition-colors">
                                        <i class="fa fa-cog text-gray-700"></i>
                                    </button>
                                    <div id="messageOptionsMenu" class="hidden absolute right-0 bottom-8 bg-white rounded-lg shadow-lg py-2 w-48 z-10">
                                        <button id="enableBurnAfterReadingBtn" class="w-full text-left px-4 py-2 hover:bg-gray-100 transition-colors">
                                            <i class="fa fa-fire text-orange-500 mr-2"></i>é˜…åå³ç„š
                                        </button>
                                        <div class="border-t my-1"></div>
                                        <button onclick="exportChatHistory()" class="w-full text-left px-4 py-2 hover:bg-gray-100 transition-colors">
                                            <i class="fa fa-download mr-2"></i>å¯¼å‡ºèŠå¤©è®°å½•
                                        </button>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- è¡¨æƒ…åŒ…é¢æ¿ -->
                            <div id="emojiPanel" class="hidden absolute bottom-40 left-4 md:left-auto bg-white rounded-lg shadow-lg p-3 border border-gray-200 w-64 max-h-40 overflow-y-auto z-20">
                                <div class="grid grid-cols-7 gap-1">
                                    <!-- å¸¸ç”¨è¡¨æƒ… -->
                                    <div class="emoji-item" onclick="insertEmoji('ğŸ˜Š')">ğŸ˜Š</div>
                                    <div class="emoji-item" onclick="insertEmoji('ğŸ˜‚')">ğŸ˜‚</div>
                                    <div class="emoji-item" onclick="insertEmoji('ğŸ˜')">ğŸ˜</div>
                                    <div class="emoji-item" onclick="insertEmoji('ğŸ‘')">ğŸ‘</div>
                                    <div class="emoji-item" onclick="insertEmoji('â¤ï¸')">â¤ï¸</div>
                                    <div class="emoji-item" onclick="insertEmoji('ğŸ‰')">ğŸ‰</div>
                                    <div class="emoji-item" onclick="insertEmoji('ğŸ‘')">ğŸ‘</div>
                                    <div class="emoji-item" onclick="insertEmoji('ğŸ˜¢')">ğŸ˜¢</div>
                                    <div class="emoji-item" onclick="insertEmoji('ğŸ˜ ')">ğŸ˜ </div>
                                    <div class="emoji-item" onclick="insertEmoji('ğŸ¤”')">ğŸ¤”</div>
                                    <div class="emoji-item" onclick="insertEmoji('ğŸ˜´')">ğŸ˜´</div>
                                    <div class="emoji-item" onclick="insertEmoji('ğŸ¤©')">ğŸ¤©</div>
                                    <div class="emoji-item" onclick="insertEmoji('ğŸ¤—')">ğŸ¤—</div>
                                    <div class="emoji-item" onclick="insertEmoji('ğŸ˜')">ğŸ˜</div>
                                    <div class="emoji-item" onclick="insertEmoji('ğŸ¤¯')">ğŸ¤¯</div>
                                    <div class="emoji-item" onclick="insertEmoji('ğŸ˜±')">ğŸ˜±</div>
                                    <div class="emoji-item" onclick="insertEmoji('ğŸ™')">ğŸ™</div>
                                    <div class="emoji-item" onclick="insertEmoji('ğŸ‘Œ')">ğŸ‘Œ</div>
                                    <div class="emoji-item" onclick="insertEmoji('ğŸ™„')">ğŸ™„</div>
                                    <div class="emoji-item" onclick="insertEmoji('ğŸ˜˜')">ğŸ˜˜</div>
                                    <div class="emoji-item" onclick="insertEmoji('ğŸ‘‹')">ğŸ‘‹</div>
                                </div>
                            </div>
                            
                            <!-- GIFé¢æ¿ -->
                            <div id="gifPanel" class="hidden absolute bottom-40 left-4 md:left-auto bg-white rounded-lg shadow-lg p-3 border border-gray-200 w-80 max-h-60 overflow-y-auto z-20">
                                <div class="mb-2">
                                    <div class="relative">
                                        <input type="text" id="gifSearchInput" placeholder="æœç´¢GIFåŠ¨å›¾..." 
                                               class="w-full pl-8 pr-4 py-2 border border-gray-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-primary/50">
                                        <i class="fa fa-search absolute left-3 top-1/2 -translate-y-1/2 text-gray-400 text-sm"></i>
                                    </div>
                                </div>
                                <div id="gifResults" class="grid grid-cols-3 gap-2">
                                    <div class="flex items-center justify-center h-24 text-gray-500">
                                        æœç´¢GIFåŠ¨å›¾
                                    </div>
                                </div>
                            </div>
                            
                            <div class="flex gap-2">
                                <textarea id="messageText" rows="2" placeholder="è¾“å…¥æ¶ˆæ¯..." class="flex-1 px-4 py-3 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/50 resize-none"></textarea>
                                <button onclick="sendMessage()" class="px-4 py-3 bg-primary text-white rounded-lg hover:bg-primary/90 transition-colors">å‘é€</button>
                            </div>
                            
                            <!-- é˜…åå³ç„šæç¤º -->
                            <div id="burnAfterReadingNotice" class="text-xs text-orange-500 flex items-center hidden">
                                <i class="fa fa-fire mr-1"></i>å·²å¼€å¯é˜…åå³ç„šæ¨¡å¼ï¼Œæ¶ˆæ¯å°†åœ¨å¯¹æ–¹æŸ¥çœ‹å10ç§’é”€æ¯
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
        
        <!-- æ¶ˆæ¯é€šçŸ¥ç»„ä»¶ -->
        <div id="notification" class="notification">
            <div class="flex items-start gap-3">
                <img id="notificationAvatar" src="" alt="å‘é€è€…å¤´åƒ" class="w-10 h-10 rounded-full">
                <div>
                    <p class="font-medium"><span id="notificationSender"></span></p>
                    <p id="notificationContent" class="text-sm text-gray-600"></p>
                </div>
                <button onclick="document.getElementById('notification').classList.remove('show')" class="text-gray-400 hover:text-gray-600">
                    <i class="fa fa-times"></i>
                </button>
            </div>
        </div>
        
        <!-- åŠ è½½æç¤º -->
        <div id="loading" class="hidden fixed inset-0 bg-black/10 flex items-center justify-center z-50">
            <div class="bg-white p-6 rounded-xl shadow-lg flex items-center gap-4">
                <i class="fa fa-circle-o-notch fa-spin text-primary text-2xl"></i>
                <span>å¤„ç†ä¸­...</span>
            </div>
        </div>
    </div>

    <script>
        // å…¨å±€å˜é‡
        let currentUser = null;
        let selectedFriend = null;
        let viewedFriend = null; // å½“å‰æŸ¥çœ‹çš„å¥½å‹
        let supabase = null;
        let chatSubscription = null;
        let presenceSubscription = null; // ç”¨äºåœ¨çº¿çŠ¶æ€ç›‘å¬
        let messagePollTimer = null; // æ¶ˆæ¯è½®è¯¢å®šæ—¶å™¨
        let friendPollTimer = null; // å¥½å‹åˆ—è¡¨å’Œç”³è¯·è½®è¯¢å®šæ—¶å™¨
        let typingTimer = null; // è¾“å…¥çŠ¶æ€å®šæ—¶å™¨
        let burnAfterReadingEnabled = false; // é˜…åå³ç„šæ¨¡å¼
        let messageSearchTerm = ''; // æ¶ˆæ¯æœç´¢å…³é”®è¯
        
        // çŠ¶æ€æ˜ å°„è¡¨ - ç¡®ä¿æ¯ä¸ªçŠ¶æ€éƒ½æœ‰å®Œæ•´å®šä¹‰
        const statusMap = {
            'online': { text: 'åœ¨çº¿', class: 'bg-success', indicatorClass: 'status-success' },
            'busy': { text: 'å¿™ç¢Œ', class: 'bg-danger', indicatorClass: 'status-danger' },
            'away': { text: 'ç¦»å¼€', class: 'bg-warning', indicatorClass: 'status-warning' },
            'offline': { text: 'ç¦»çº¿', class: 'bg-gray-400', indicatorClass: 'status-gray-400' }
        };
        
        // æ¶ˆæ¯çŠ¶æ€æ˜ å°„
        const messageStatusMap = {
            'pending': '<i class="fa fa-clock-o message-status"></i>',
            'delivered': '<i class="fa fa-check message-status"></i>',
            'read': '<i class="fa fa-check-circle message-status"></i>',
            'recalled': '<span class="text-xs text-gray-500">(æ¶ˆæ¯å·²æ’¤å›)</span>'
        };
        
        // è·å–å®‰å…¨çš„çŠ¶æ€ä¿¡æ¯ï¼ˆå¸¦é»˜è®¤å€¼ï¼‰
        function getSafeStatusInfo(status) {
            // å¦‚æœçŠ¶æ€ä¸å­˜åœ¨æˆ–æœªå®šä¹‰ï¼Œè¿”å›é»˜è®¤çš„åœ¨çº¿çŠ¶æ€
            if (!status || !statusMap[status]) {
                return statusMap['online'];
            }
            return statusMap[status];
        }
        
        // DOMå…ƒç´ 
        const loginSection = document.getElementById('loginSection');
        const chatSection = document.getElementById('chatSection');
        const profileSection = document.getElementById('profileSection');
        const friendProfileSection = document.getElementById('friendProfileSection');
        const dataBoardSection = document.getElementById('dataBoardSection');
        const loading = document.getElementById('loading');
        const notification = document.getElementById('notification');
        
        // åˆå§‹åŒ–Supabaseå®¢æˆ·ç«¯
        function initSupabaseClient() {
            const supabaseUrl = "https://cjoabruloeflhhljjysl.supabase.co";
            const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNqb2FicnVsb2VmbGhobGpqeXNsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk2MTY4MTIsImV4cCI6MjA3NTE5MjgxMn0.CPaMga0gWs9k778kjYEhcOGTYp0Vtku0ZkyKJo-Q6Gg";
            
            return window.supabase.createClient(supabaseUrl, supabaseKey, {
                global: {
                    headers: {
                        'apikey': supabaseKey,
                        'Authorization': `Bearer ${supabaseKey}`
                    }
                }
            });
        }
        
        // æ˜¾ç¤º/éšè—åŠ è½½çŠ¶æ€
        function showLoading() { loading.classList.remove('hidden'); }
        function hideLoading() { loading.classList.add('hidden'); }
        
        // æ˜¾ç¤ºé€šçŸ¥
        function showNotification(sender, content, avatar) {
            document.getElementById('notificationSender').textContent = sender;
            document.getElementById('notificationContent').textContent = content;
            document.getElementById('notificationAvatar').src = avatar;
            
            notification.classList.add('show');
            
            // 5ç§’åè‡ªåŠ¨å…³é—­
            setTimeout(() => {
                notification.classList.remove('show');
            }, 5000);
        }
        
        // é¡µé¢åˆå§‹åŒ–
        function initApp() {
            try {
                supabase = initSupabaseClient();
                console.log('Supabaseå®¢æˆ·ç«¯åˆå§‹åŒ–æˆåŠŸ');
                
                // ç»‘å®šè¡¨æƒ…åŒ…æŒ‰é’®äº‹ä»¶
                document.getElementById('emojiToggleBtn').addEventListener('click', toggleEmojiPanel);
                document.getElementById('gifToggleBtn').addEventListener('click', toggleGifPanel);
                document.getElementById('gifSearchInput').addEventListener('input', searchGifs);
                document.getElementById('messageOptionsBtn').addEventListener('click', toggleMessageOptions);
                document.getElementById('enableBurnAfterReadingBtn').addEventListener('click', toggleBurnAfterReading);
                
                // ç»‘å®šèŠå¤©æœç´¢äº‹ä»¶
                document.getElementById('messageSearchInput').addEventListener('input', handleMessageSearch);
                document.getElementById('clearSearchBtn').addEventListener('click', clearMessageSearch);
                
                // ç‚¹å‡»å¤–éƒ¨å…³é—­é¢æ¿
                document.addEventListener('click', (e) => {
                    const emojiPanel = document.getElementById('emojiPanel');
                    const gifPanel = document.getElementById('gifPanel');
                    const optionsMenu = document.getElementById('messageOptionsMenu');
                    const emojiBtn = document.getElementById('emojiToggleBtn');
                    const gifBtn = document.getElementById('gifToggleBtn');
                    const optionsBtn = document.getElementById('messageOptionsBtn');
                    
                    if (!emojiPanel.contains(e.target) && !emojiBtn.contains(e.target)) {
                        emojiPanel.classList.add('hidden');
                    }
                    
                    if (!gifPanel.contains(e.target) && !gifBtn.contains(e.target)) {
                        gifPanel.classList.add('hidden');
                    }
                    
                    if (!optionsMenu.contains(e.target) && !optionsBtn.contains(e.target)) {
                        optionsMenu.classList.add('hidden');
                    }
                });
                
                // ç»‘å®šæŸ¥çœ‹å¥½å‹èµ„æ–™æŒ‰é’®äº‹ä»¶
                document.getElementById('viewFriendProfileBtn').addEventListener('click', viewSelectedFriendProfile);
                document.getElementById('startChatWithFriendBtn').addEventListener('click', startChatFromProfile);
                document.getElementById('dataBoardBtn').addEventListener('click', switchToDataBoardView);
                
                // ç»‘å®šçŠ¶æ€é€‰æ‹©å™¨äº‹ä»¶
                document.getElementById('statusSelectorBtn').addEventListener('click', toggleStatusDropdown);
                document.addEventListener('click', (e) => {
                    const dropdown = document.getElementById('statusDropdown');
                    const btn = document.getElementById('statusSelectorBtn');
                    if (!dropdown.contains(e.target) && !btn.contains(e.target)) {
                        dropdown.classList.add('hidden');
                    }
                });
                
                // ç›‘å¬è¾“å…¥æ¡†äº‹ä»¶ï¼Œå‘é€"æ­£åœ¨è¾“å…¥"çŠ¶æ€
                document.getElementById('messageText').addEventListener('input', handleTyping);
                
                // æ£€æŸ¥æœ¬åœ°å­˜å‚¨çš„ç”¨æˆ·
                const savedUser = localStorage.getItem('friendSystemUser');
                if (savedUser) {
                    currentUser = JSON.parse(savedUser);
                    showChatInterface();
                    setupPresenceTracking(); // å¯åŠ¨åœ¨çº¿çŠ¶æ€è¿½è¸ª
                    startFriendPolling(); // å¯åŠ¨å¥½å‹åˆ—è¡¨å’Œç”³è¯·è½®è¯¢
                } else {
                    // æ˜¾ç¤ºç™»å½•æŒ‰é’®ï¼Œéšè—å…¶ä»–ç”¨æˆ·ç›¸å…³å…ƒç´ 
                    document.getElementById('loginBtn').classList.remove('hidden');
                    document.getElementById('statusSelectorBtn').classList.add('hidden');
                    document.getElementById('profileBtn').classList.add('hidden');
                    document.getElementById('dataBoardBtn').classList.add('hidden');
                }
            } catch (error) {
                console.error('åº”ç”¨åˆå§‹åŒ–å¤±è´¥:', error);
                alert('åˆå§‹åŒ–å¤±è´¥: ' + error.message);
            }
        }
        
        // åˆ‡æ¢è§†å›¾
        function switchToChatView() {
            profileSection.classList.add('hidden');
            friendProfileSection.classList.add('hidden');
            dataBoardSection.classList.add('hidden');
            chatSection.classList.remove('hidden');
        }
        
        function switchToProfileView() {
            chatSection.classList.add('hidden');
            friendProfileSection.classList.add('hidden');
            dataBoardSection.classList.add('hidden');
            profileSection.classList.remove('hidden');
            loadProfileData();
        }
        
        function switchToDataBoardView() {
            chatSection.classList.add('hidden');
            profileSection.classList.add('hidden');
            friendProfileSection.classList.add('hidden');
            dataBoardSection.classList.remove('hidden');
            loadDataBoard();
        }
        
        // æ˜¾ç¤ºèŠå¤©ç•Œé¢
        function showChatInterface() {
            if (!currentUser) return;
            
            // æ›´æ–°å¤´éƒ¨ç”¨æˆ·ä¿¡æ¯
            document.getElementById('headerAvatar').src = currentUser.avatar || 'https://picsum.photos/200/200';
            document.getElementById('headerUsername').textContent = currentUser.username;
            updateStatusDisplay(currentUser.status || 'online');
            
            // æ›´æ–°ä¸ªäººä¸»é¡µåˆå§‹æ•°æ®
            document.getElementById('profileAvatar').src = currentUser.avatar || 'https://picsum.photos/200/200';
            document.getElementById('newUsername').value = currentUser.username;
            document.getElementById('newSignature').value = currentUser.signature || '';
            document.getElementById('profileStatusSelector').value = currentUser.status || 'online';
            
            // æ˜¾ç¤º/éšè—å…ƒç´ 
            loginSection.classList.add('hidden');
            chatSection.classList.remove('hidden');
            document.getElementById('loginBtn').classList.add('hidden');
            document.getElementById('statusSelectorBtn').classList.remove('hidden');
            document.getElementById('statusSelectorBtn').classList.add('flex');
            document.getElementById('profileBtn').classList.remove('hidden');
            document.getElementById('profileBtn').classList.add('flex');
            document.getElementById('dataBoardBtn').classList.remove('hidden');
            document.getElementById('dataBoardBtn').classList.add('flex');
            
            // æ˜¾ç¤ºèŠå¤©æœç´¢åŒºåŸŸ
            document.getElementById('chatSearchArea').classList.remove('hidden');
            
            // ç»‘å®šä¸ªäººä¸»é¡µæŒ‰é’®äº‹ä»¶
            document.getElementById('profileBtn').addEventListener('click', switchToProfileView);
            
            // å¯åŠ¨å®šæ—¶æ›´æ–°æ´»è·ƒçŠ¶æ€
            startActiveTimer();
            // åŠ è½½å¥½å‹ç”³è¯·å’Œå¥½å‹åˆ—è¡¨
            loadFriendRequests();
            loadFriendsList();
        }
        
        // æ³¨å†Œæ–°ç”¨æˆ·
        async function handleRegister() {
            const username = document.getElementById('username').value.trim();
            if (!username) { alert('è¯·è¾“å…¥æ˜µç§°'); return; }
            
            try {
                showLoading();
                
                // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å·²å­˜åœ¨
                const { data: existingUser } = await supabase
                    .from('users')
                    .select('id')
                    .eq('username', username)
                    .single();
                
                if (existingUser) throw new Error('è¯¥æ˜µç§°å·²è¢«ä½¿ç”¨');
                
                // åˆ›å»ºæ–°ç”¨æˆ·ï¼ˆåŒ…å«é»˜è®¤çŠ¶æ€å’Œä¸ªæ€§ç­¾åå­—æ®µï¼‰
                const { data: newUser } = await supabase
                    .from('users')
                    .insert([{ 
                        username: username,
                        avatar: `https://picsum.photos/seed/${username}/200`,
                        status: 'online', // é»˜è®¤çŠ¶æ€ä¸ºåœ¨çº¿
                        signature: '', // é»˜è®¤ä¸ºç©ºä¸ªæ€§ç­¾å
                        last_active: new Date()
                    }])
                    .select('*')
                    .single();
                
                currentUser = newUser;
                localStorage.setItem('friendSystemUser', JSON.stringify(newUser));
                alert('æ³¨å†ŒæˆåŠŸï¼');
                showChatInterface();
                setupPresenceTracking(); // å¯åŠ¨åœ¨çº¿çŠ¶æ€è¿½è¸ª
                startFriendPolling(); // å¯åŠ¨å¥½å‹è½®è¯¢
            } catch (error) {
                console.error('æ³¨å†Œå¤±è´¥:', error);
                alert('æ³¨å†Œå¤±è´¥: ' + error.message);
            } finally {
                hideLoading();
            }
        }
        
        // ç”¨æˆ·ç™»å½•
        async function handleLogin() {
            const username = document.getElementById('username').value.trim();
            if (!username) { alert('è¯·è¾“å…¥æ˜µç§°'); return; }
            
            try {
                showLoading();
                
                // æŸ¥è¯¢ç”¨æˆ·
                const { data: users } = await supabase
                    .from('users')
                    .select('*')
                    .eq('username', username);
                
                if (!users || users.length === 0) throw new Error('ç”¨æˆ·ä¸å­˜åœ¨ï¼Œè¯·å…ˆæ³¨å†Œ');
                
                const user = users[0];
                // æ›´æ–°æœ€åæ´»è·ƒæ—¶é—´
                const { data: updatedUser } = await supabase
                    .from('users')
                    .update({ 
                        last_active: new Date(),
                        status: user.status || 'online' // ä¿æŒåŸæœ‰çŠ¶æ€æˆ–è®¾ä¸ºåœ¨çº¿
                    })
                    .eq('id', user.id)
                    .select('*')
                    .single();
                
                currentUser = updatedUser;
                localStorage.setItem('friendSystemUser', JSON.stringify(updatedUser));
                alert('ç™»å½•æˆåŠŸï¼');
                showChatInterface();
                setupPresenceTracking(); // å¯åŠ¨åœ¨çº¿çŠ¶æ€è¿½è¸ª
                startFriendPolling(); // å¯åŠ¨å¥½å‹è½®è¯¢
            } catch (error) {
                console.error('ç™»å½•å¤±è´¥:', error);
                alert('ç™»å½•å¤±è´¥: ' + error.message);
            } finally {
                hideLoading();
            }
        }
        
        // ç”¨æˆ·é€€å‡ºç™»å½• - å¼ºåˆ¶è®¾ç½®ä¸ºç¦»çº¿çŠ¶æ€
        async function handleLogout() {
            if (!currentUser) return;
            
            try {
                showLoading();
                
                // å¼ºåˆ¶æ›´æ–°çŠ¶æ€ä¸ºç¦»çº¿
                await updateUserStatus(currentUser.id, 'offline');
                
                // æ¸…é™¤è½®è¯¢å®šæ—¶å™¨
                if (messagePollTimer) {
                    clearInterval(messagePollTimer);
                    messagePollTimer = null;
                }
                
                if (friendPollTimer) {
                    clearInterval(friendPollTimer);
                    friendPollTimer = null;
                }
                
                // æ¸…é™¤å®æ—¶ç›‘å¬
                if (chatSubscription) {
                    supabase.removeChannel(chatSubscription);
                    chatSubscription = null;
                }
                
                if (presenceSubscription) {
                    supabase.removeChannel(presenceSubscription);
                    presenceSubscription = null;
                }
                
                currentUser = null;
                selectedFriend = null;
                viewedFriend = null;
                localStorage.removeItem('friendSystemUser');
                
                // é‡ç½®ç•Œé¢
                loginSection.classList.remove('hidden');
                chatSection.classList.add('hidden');
                profileSection.classList.add('hidden');
                friendProfileSection.classList.add('hidden');
                dataBoardSection.classList.add('hidden');
                document.getElementById('loginBtn').classList.remove('hidden');
                document.getElementById('statusSelectorBtn').classList.add('hidden');
                document.getElementById('profileBtn').classList.add('hidden');
                document.getElementById('dataBoardBtn').classList.add('hidden');
                
                document.getElementById('chatWith').textContent = 'é€‰æ‹©å¥½å‹å¼€å§‹èŠå¤©';
                document.getElementById('messages').innerHTML = 
                    '<div class="text-center text-gray-500 py-10"><i class="fa fa-comment text-3xl mb-3 opacity-20"></i><p class="text-sm italic">è¯·ä»å·¦ä¾§å¥½å‹åˆ—è¡¨ä¸­é€‰æ‹©ä¸€ä½å¥½å‹å¼€å§‹èŠå¤©</p></div>';
                document.getElementById('messageInputArea').classList.add('hidden');
                document.getElementById('viewFriendProfileBtn').classList.add('hidden');
                
                alert('å·²é€€å‡ºç™»å½•');
            } catch (error) {
                console.error('é€€å‡ºç™»å½•å¤±è´¥:', error);
                alert('é€€å‡ºå¤±è´¥: ' + error.message);
            } finally {
                hideLoading();
            }
        }
        
        // åŠ è½½ä¸ªäººä¸»é¡µæ•°æ®
        function loadProfileData() {
            if (!currentUser) return;
            
            document.getElementById('profileUsername').textContent = currentUser.username;
            document.getElementById('newUsername').value = currentUser.username;
            document.getElementById('newSignature').value = currentUser.signature || '';
            document.getElementById('profileStatusSelector').value = currentUser.status || 'online';
            document.getElementById('profileSignature').textContent = currentUser.signature || 'è¿™ä¸ªäººå¾ˆæ‡’ï¼Œä»€ä¹ˆéƒ½æ²¡ç•™ä¸‹';
            updateStatusDisplay(currentUser.status || 'online', 'profileStatusText');
            document.getElementById('profileLastActive').textContent = formatTimeAgo(new Date(currentUser.last_active));
            
            // æ›´æ–°çŠ¶æ€æŒ‡ç¤ºå™¨
            const indicator = document.getElementById('profileStatusIndicator');
            const statusInfo = getSafeStatusInfo(currentUser.status);
            indicator.className = `status-indicator ${statusInfo.indicatorClass}`;
        }
        
        // ä¿å­˜ä¸ªäººä¸»é¡µä¿®æ”¹ - åŒ…å«ä¸ªæ€§ç­¾å
        async function saveProfileChanges() {
            if (!currentUser) return;
            
            const newUsername = document.getElementById('newUsername').value.trim();
            const newSignature = document.getElementById('newSignature').value.trim();
            const newStatus = document.getElementById('profileStatusSelector').value;
            
            if (!newUsername) {
                alert('è¯·è¾“å…¥æ˜µç§°');
                return;
            }
            
            try {
                showLoading();
                
                // æ£€æŸ¥æ˜µç§°æ˜¯å¦å·²è¢«ä½¿ç”¨ï¼ˆæ’é™¤å½“å‰ç”¨æˆ·ï¼‰
                const { data: existingUsers } = await supabase
                    .from('users')
                    .select('id')
                    .eq('username', newUsername)
                    .neq('id', currentUser.id);
                
                if (existingUsers && existingUsers.length > 0) {
                    throw new Error('è¯¥æ˜µç§°å·²è¢«ä½¿ç”¨');
                }
                
                // æ›´æ–°ç”¨æˆ·ä¿¡æ¯ - åŒ…å«ä¸ªæ€§ç­¾å
                const { data: updatedUser } = await supabase
                    .from('users')
                    .update({ 
                        username: newUsername,
                        signature: newSignature,
                        status: newStatus,
                        last_active: new Date()
                    })
                    .eq('id', currentUser.id)
                    .select('*')
                    .single();
                
                currentUser = updatedUser;
                localStorage.setItem('friendSystemUser', JSON.stringify(updatedUser));
                
                // æ›´æ–°ç•Œé¢
                loadProfileData();
                document.getElementById('headerUsername').textContent = newUsername;
                updateStatusDisplay(newStatus);
                
                alert('ä¿¡æ¯æ›´æ–°æˆåŠŸ');
            } catch (error) {
                console.error('æ›´æ–°ä¸ªäººä¿¡æ¯å¤±è´¥:', error);
                alert('æ›´æ–°å¤±è´¥: ' + error.message);
            } finally {
                hideLoading();
            }
        }
        
        // çŠ¶æ€ä¸‹æ‹‰æ¡†åˆ‡æ¢
        function toggleStatusDropdown() {
            const dropdown = document.getElementById('statusDropdown');
            dropdown.classList.toggle('hidden');
        }
        
        // æ›´æ–°çŠ¶æ€æ˜¾ç¤º
        function updateStatusDisplay(status, elementId = 'currentStatusText') {
            const statusInfo = getSafeStatusInfo(status);
            const element = document.getElementById(elementId);
            
            element.className = 'status-tag';
            element.classList.add(statusInfo.class);
            element.classList.add('text-white');
            element.textContent = statusInfo.text;
        }
        
        // æ›´æ–°ç”¨æˆ·çŠ¶æ€
        async function updateUserStatus(userId, status) {
            try {
                await supabase
                    .from('users')
                    .update({ 
                        status: status,
                        last_active: new Date()
                    })
                    .eq('id', userId);
                    
                return true;
            } catch (error) {
                console.error('æ›´æ–°çŠ¶æ€å¤±è´¥:', error);
                return false;
            }
        }
        
        // åˆ‡æ¢ç”¨æˆ·çŠ¶æ€
        async function updateStatus(status) {
            if (!currentUser) return;
            
            const success = await updateUserStatus(currentUser.id, status);
            if (success) {
                currentUser.status = status;
                localStorage.setItem('friendSystemUser', JSON.stringify(currentUser));
                updateStatusDisplay(status);
                document.getElementById('statusDropdown').classList.add('hidden');
                
                // æ›´æ–°å¥½å‹åˆ—è¡¨ä¸­çš„çŠ¶æ€æ˜¾ç¤º
                if (document.getElementById('friendsList').innerHTML) {
                    loadFriendsList();
                }
            }
        }
        
        // å¯åŠ¨åœ¨çº¿çŠ¶æ€è¿½è¸ª
        function setupPresenceTracking() {
            if (!currentUser || presenceSubscription) return;
            
            // åˆ›å»ºåœ¨çº¿çŠ¶æ€ç›‘å¬é€šé“
            presenceSubscription = supabase
                .channel('user_presence')
                .on(
                    'postgres_changes',
                    {
                        event: 'UPDATE',
                        schema: 'public',
                        table: 'users',
                        filter: 'status=neq.offline' // ç›‘å¬çŠ¶æ€å˜åŒ–
                    },
                    (payload) => {
                        console.log('ç”¨æˆ·çŠ¶æ€å˜åŒ–:', payload);
                        // æ›´æ–°å¥½å‹åˆ—è¡¨ä¸­çš„çŠ¶æ€æ˜¾ç¤º
                        if (document.getElementById('friendsList').innerHTML) {
                            loadFriendsList();
                        }
                        
                        // å¦‚æœæ­£åœ¨èŠå¤©çš„å¥½å‹çŠ¶æ€å˜åŒ–ï¼Œæ›´æ–°èŠå¤©å¤´éƒ¨
                        if (selectedFriend && selectedFriend.id === payload.new.id) {
                            updateChatFriendStatus(payload.new.status);
                        }
                        
                        // å¦‚æœæ­£åœ¨æŸ¥çœ‹çš„å¥½å‹çŠ¶æ€å˜åŒ–ï¼Œæ›´æ–°å¥½å‹ä¸»é¡µ
                        if (viewedFriend && viewedFriend.id === payload.new.id) {
                            viewedFriend.status = payload.new.status;
                            viewedFriend.last_active = payload.new.last_active;
                            loadFriendProfileData();
                        }
                    }
                )
                .subscribe((status) => {
                    console.log('åœ¨çº¿çŠ¶æ€ç›‘å¬çŠ¶æ€:', status);
                });
        }
        
        // å¯åŠ¨å¥½å‹åˆ—è¡¨å’Œç”³è¯·è½®è¯¢
        function startFriendPolling() {
            // æ¸…é™¤æ—§å®šæ—¶å™¨ï¼Œé¿å…é‡å¤
            if (friendPollTimer) clearInterval(friendPollTimer);
            
            // æ¯15ç§’è‡ªåŠ¨åˆ·æ–°å¥½å‹åˆ—è¡¨å’Œç”³è¯·
            friendPollTimer = setInterval(() => {
                if (currentUser) {
                    loadFriendRequests();
                    loadFriendsList();
                }
            }, 15000);
        }
        
        // æ›´æ–°èŠå¤©å¯¹è±¡çš„çŠ¶æ€æ˜¾ç¤º
        function updateChatFriendStatus(status) {
            const statusInfo = getSafeStatusInfo(status);
            const indicator = document.getElementById('chatFriendStatus');
            
            indicator.className = `status-indicator ${statusInfo.indicatorClass}`;
        }
        
        // å®šæ—¶æ›´æ–°æœ€åæ´»è·ƒæ—¶é—´
        function startActiveTimer() {
            updateLastActive();
            setInterval(updateLastActive, 30000); // æ¯30ç§’æ›´æ–°ä¸€æ¬¡
        }
        
        // æ›´æ–°æœ€åæ´»è·ƒæ—¶é—´
        async function updateLastActive() {
            if (currentUser) {
                try {
                    // åªæœ‰åœ¨çº¿/å¿™ç¢Œ/ç¦»å¼€çŠ¶æ€æ‰æ›´æ–°æ´»è·ƒæ—¶é—´
                    if (['online', 'busy', 'away'].includes(currentUser.status)) {
                        await supabase
                            .from('users')
                            .update({ last_active: new Date() })
                            .eq('id', currentUser.id);
                    }
                } catch (error) {
                    console.error('æ›´æ–°æ´»è·ƒæ—¶é—´å¤±è´¥:', error);
                }
            }
        }
        
        // åˆ¤æ–­ç”¨æˆ·æ˜¯å¦åœ¨çº¿ï¼ˆç»“åˆçŠ¶æ€å’Œæ´»è·ƒæ—¶é—´ï¼‰
        function isUserOnline(user) {
            // å¦‚æœçŠ¶æ€æ˜ç¡®æ˜¯ç¦»çº¿ï¼Œç›´æ¥è¿”å›false
            if (user.status === 'offline') return false;
            
            // å¦‚æœçŠ¶æ€æ˜¯åœ¨çº¿/å¿™ç¢Œ/ç¦»å¼€ï¼Œè®¤ä¸ºæ˜¯åœ¨çº¿çŠ¶æ€
            if (['online', 'busy', 'away'].includes(user.status)) return true;
            
            // å…¶ä»–æƒ…å†µé€šè¿‡æ´»è·ƒæ—¶é—´åˆ¤æ–­ï¼ˆ5åˆ†é’Ÿå†…ï¼‰
            if (!user.last_active) return false;
            
            const lastActive = new Date(user.last_active);
            const now = new Date();
            const diffMinutes = (now - lastActive) / (1000 * 60);
            
            return diffMinutes < 5;
        }
        
        // åŠ è½½å¥½å‹ç”³è¯·
        async function loadFriendRequests() {
            if (!currentUser) {
                console.log('å½“å‰ç”¨æˆ·æœªç™»å½•ï¼Œæ— æ³•åŠ è½½å¥½å‹ç”³è¯·');
                return;
            }
            
            try {
                // æŸ¥è¯¢æ‰€æœ‰å‘ç»™å½“å‰ç”¨æˆ·çš„å¾…å¤„ç†ç”³è¯·
                const { data: requests, error: requestError } = await supabase
                    .from('friend_relations')
                    .select('id, sender_id')
                    .eq('receiver_id', currentUser.id)
                    .eq('status', 'pending')
                    .order('created_at', { ascending: false });

                if (requestError) throw requestError;

                const container = document.getElementById('friendRequests');
                const countEl = document.getElementById('requestCount');

                // æ›´æ–°ç”³è¯·æ•°é‡
                const requestCount = requests?.length || 0;
                countEl.textContent = requestCount;
                countEl.classList.toggle('hidden', requestCount === 0);

                // å¤„ç†æ— æ•°æ®æƒ…å†µ
                if (!requests || requests.length === 0) {
                    container.innerHTML = '<div class="text-center text-gray-500 py-6"><i class="fa fa-envelope-o text-2xl mb-2 opacity-30"></i><p class="text-sm italic">æš‚æ— å¥½å‹ç”³è¯·</p></div>';
                    return;
                }

                // æå–æ‰€æœ‰ç”³è¯·äººIDï¼Œæ‰¹é‡æŸ¥è¯¢ç”¨æˆ·ä¿¡æ¯
                const senderIds = requests.map(req => req.sender_id);
                const { data: senders, error: senderError } = await supabase
                    .from('users')
                    .select('id, username, avatar, status, last_active, signature')
                    .in('id', senderIds);

                if (senderError) throw senderError;

                // åˆ›å»ºç”¨æˆ·ä¿¡æ¯æ˜ å°„è¡¨
                const senderMap = {};
                senders.forEach(sender => {
                    senderMap[sender.id] = sender;
                });

                // æ¸²æŸ“ç”³è¯·åˆ—è¡¨
                container.innerHTML = requests.map((req, index) => {
                    const sender = senderMap[req.sender_id] || {
                        id: req.sender_id,
                        username: 'æœªçŸ¥ç”¨æˆ·',
                        avatar: 'https://picsum.photos/200/200',
                        status: 'online' // é»˜è®¤çŠ¶æ€
                    };
                    const statusInfo = getSafeStatusInfo(sender.status);
                    
                    return `
                        <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg hover:bg-gray-100 transition-all animate-fadeIn" style="animation-delay: ${index * 0.1}s">
                            <div class="flex items-center gap-3">
                                <div class="relative">
                                    <img src="${sender.avatar}" alt="${sender.username}" 
                                         class="w-10 h-10 rounded-full object-cover">
                                    <span class="status-indicator ${statusInfo.indicatorClass}"></span>
                                </div>
                                <div>
                                    <span class="font-medium">${sender.username}</span>
                                    <p class="text-xs">
                                        <span class="status-tag ${statusInfo.class} text-white">${statusInfo.text}</span>
                                    </p>
                                </div>
                            </div>
                            <div class="flex gap-2">
                                <button onclick="respondToRequest('${req.id}', true)" 
                                        class="px-3 py-1.5 bg-success text-white text-sm rounded-lg hover:bg-success/90">
                                        <i class="fa fa-check mr-1"></i>åŒæ„
                                </button>
                                <button onclick="respondToRequest('${req.id}', false)" 
                                        class="px-3 py-1.5 bg-gray-200 text-sm rounded-lg hover:bg-gray-300">
                                        <i class="fa fa-times mr-1"></i>æ‹’ç»
                                </button>
                            </div>
                        </div>
                    `;
                }).join('');

            } catch (error) {
                console.error('åŠ è½½å¥½å‹ç”³è¯·å¼‚å¸¸:', error);
                document.getElementById('friendRequests').innerHTML = 
                    `<p class="text-red-500 text-sm text-center py-6">åŠ è½½å¤±è´¥: ${error.message}</p>`;
            }
        }
        
        // åŠ è½½å¥½å‹åˆ—è¡¨
        async function loadFriendsList() {
            if (!currentUser) return;
            
            try {
                // æŸ¥è¯¢æ‰€æœ‰å·²é€šè¿‡çš„å¥½å‹å…³ç³»
                const { data: relations, error: relError } = await supabase
                    .from('friend_relations')
                    .select('id, sender_id, receiver_id')
                    .or(`sender_id.eq.${currentUser.id},receiver_id.eq.${currentUser.id}`)
                    .eq('status', 'accepted')
                    .order('updated_at', { ascending: false });
                
                if (relError) throw relError;
                
                const container = document.getElementById('friendsList');
                
                if (!relations?.length) {
                    container.innerHTML = '<div class="text-center text-gray-500 py-8"><i class="fa fa-hand-o-down text-2xl mb-2 opacity-30"></i><p class="text-sm italic">æš‚æ— å¥½å‹ï¼Œæ·»åŠ å‡ ä¸ªå§ï¼</p></div>';
                    return;
                }
                
                // æå–æ‰€æœ‰å¥½å‹ID
                const friendIds = new Set();
                relations.forEach(rel => {
                    const friendId = rel.sender_id === currentUser.id ? rel.receiver_id : rel.sender_id;
                    if (friendId !== currentUser.id) {
                        friendIds.add(friendId);
                    }
                });
                
                // æ‰¹é‡æŸ¥è¯¢å¥½å‹ä¿¡æ¯ - åŒ…å«ä¸ªæ€§ç­¾å
                const { data: friends, error: friendError } = await supabase
                    .from('users')
                    .select('id, username, avatar, status, last_active, signature')
                    .in('id', Array.from(friendIds));
                
                if (friendError) throw friendError;
                
                // æ¸²æŸ“å¥½å‹åˆ—è¡¨
                container.innerHTML = friends.map((friend, index) => {
                    // ç¡®ä¿å¥½å‹ä¿¡æ¯å­˜åœ¨ä¸”çŠ¶æ€æœ‰æ•ˆ
                    if (!friend) {
                        return ''; // è·³è¿‡æ— æ•ˆå¥½å‹æ•°æ®
                    }
                    
                    const isOnline = isUserOnline(friend);
                    // ä½¿ç”¨å®‰å…¨çš„çŠ¶æ€ä¿¡æ¯è·å–æ–¹æ³•
                    const statusInfo = getSafeStatusInfo(friend.status);
                    
                    return `
                        <div class="flex items-center p-3 bg-gray-50 rounded-lg hover:bg-gray-100 cursor-pointer transition-all animate-fadeIn" 
                             style="animation-delay: ${index * 0.1}s">
                            <div class="relative mr-3">
                                <img src="${friend.avatar}" alt="${friend.username}" 
                                     class="w-10 h-10 rounded-full object-cover">
                                <span class="status-indicator ${statusInfo.indicatorClass}"></span>
                            </div>
                            <div class="flex-1">
                                <p class="font-medium">${friend.username}</p>
                                <p class="text-xs">
                                    <span class="status-tag ${statusInfo.class} text-white">${statusInfo.text}</span>
                                    ${!isOnline ? ` Â· æœ€åæ´»è·ƒ: ${formatTimeAgo(new Date(friend.last_active))}` : ''}
                                </p>
                            </div>
                            <div class="flex gap-1">
                                <button onclick="selectFriendToChat('${friend.id}', '${friend.username}', '${friend.avatar}', '${friend.status || 'online'}')" 
                                        class="p-1.5 bg-primary/10 text-primary rounded hover:bg-primary/20 transition-colors">
                                    <i class="fa fa-comment"></i>
                                </button>
                                <button onclick="viewFriendProfile('${friend.id}')" 
                                        class="p-1.5 bg-gray-100 text-gray-600 rounded hover:bg-gray-200 transition-colors">
                                    <i class="fa fa-user"></i>
                                </button>
                            </div>
                        </div>
                    `;
                }).join('');
            } catch (error) {
                console.error('åŠ è½½å¥½å‹åˆ—è¡¨å¤±è´¥:', error);
                document.getElementById('friendsList').innerHTML = 
                    `<p class="text-red-500 text-sm text-center py-6">åŠ è½½å¤±è´¥: ${error.message}</p>`;
            }
        }
        
        // æŸ¥çœ‹å¥½å‹ä¸»é¡µ
        async function viewFriendProfile(friendId) {
            if (!currentUser || !friendId) return;
            
            try {
                showLoading();
                
                // æŸ¥è¯¢å¥½å‹ä¿¡æ¯
                const { data: friend } = await supabase
                    .from('users')
                    .select('id, username, avatar, status, last_active, signature')
                    .eq('id', friendId)
                    .single();
                
                viewedFriend = friend;
                
                // æ˜¾ç¤ºå¥½å‹ä¸»é¡µ
                chatSection.classList.add('hidden');
                profileSection.classList.add('hidden');
                friendProfileSection.classList.remove('hidden');
                
                // åŠ è½½å¥½å‹èµ„æ–™
                loadFriendProfileData();
            } catch (error) {
                console.error('æŸ¥çœ‹å¥½å‹èµ„æ–™å¤±è´¥:', error);
                alert('æŸ¥çœ‹å¤±è´¥: ' + error.message);
            } finally {
                hideLoading();
            }
        }
        
        // åŠ è½½å¥½å‹èµ„æ–™æ•°æ®
        function loadFriendProfileData() {
            if (!viewedFriend) return;
            
            document.getElementById('friendProfileAvatar').src = viewedFriend.avatar || 'https://picsum.photos/200/200';
            document.getElementById('friendProfileUsername').textContent = viewedFriend.username;
            document.getElementById('friendProfileSignature').textContent = viewedFriend.signature || 'è¿™ä¸ªäººå¾ˆæ‡’ï¼Œä»€ä¹ˆéƒ½æ²¡ç•™ä¸‹';
            updateStatusDisplay(viewedFriend.status || 'online', 'friendProfileStatusText');
            document.getElementById('friendProfileLastActive').textContent = formatTimeAgo(new Date(viewedFriend.last_active));
            
            // æ›´æ–°çŠ¶æ€æŒ‡ç¤ºå™¨
            const indicator = document.getElementById('friendProfileStatusIndicator');
            const statusInfo = getSafeStatusInfo(viewedFriend.status);
            indicator.className = `status-indicator ${statusInfo.indicatorClass}`;
        }
        
        // ä»å¥½å‹ä¸»é¡µå¼€å§‹èŠå¤©
        function startChatFromProfile() {
            if (!viewedFriend) return;
            
            selectFriendToChat(
                viewedFriend.id, 
                viewedFriend.username, 
                viewedFriend.avatar, 
                viewedFriend.status || 'online'
            );
            
            switchToChatView();
        }
        
        // æŸ¥çœ‹å½“å‰èŠå¤©å¥½å‹çš„èµ„æ–™
        function viewSelectedFriendProfile() {
            if (selectedFriend) {
                viewFriendProfile(selectedFriend.id);
            }
        }
        
        // æ ¼å¼åŒ–æ—¶é—´ä¸º"å¤šä¹…å‰"
        function formatTimeAgo(date) {
            const now = new Date();
            const diffMs = now - date;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMins / 60);
            const diffDays = Math.floor(diffHours / 24);
            
            if (diffMins < 1) return 'åˆšåˆš';
            if (diffMins < 60) return `${diffMins}åˆ†é’Ÿå‰`;
            if (diffHours < 24) return `${diffHours}å°æ—¶å‰`;
            if (diffDays < 7) return `${diffDays}å¤©å‰`;
            return date.toLocaleDateString();
        }
        
        // æ·»åŠ å¥½å‹
        async function addFriend() {
            if (!currentUser) return;
            
            const friendName = document.getElementById('friendName').value.trim();
            if (!friendName) { alert('è¯·è¾“å…¥å¥½å‹æ˜µç§°'); return; }
            if (friendName === currentUser.username) { alert('ä¸èƒ½æ·»åŠ è‡ªå·±ä¸ºå¥½å‹'); return; }
            
            try {
                showLoading();
                
                // æŸ¥è¯¢å¥½å‹
                const { data: friend } = await supabase
                    .from('users')
                    .select('id, username')
                    .eq('username', friendName)
                    .single();
                
                // æ£€æŸ¥æ˜¯å¦å·²å‘é€è¿‡ç”³è¯·æˆ–å·²æ˜¯å¥½å‹
                const { data: existing } = await supabase
                    .from('friend_relations')
                    .select('id, status')
                    .or(`and(sender_id.eq.${currentUser.id},receiver_id.eq.${friend.id}),and(sender_id.eq.${friend.id},receiver_id.eq.${currentUser.id})`)
                    .single();
                
                if (existing) {
                    if (existing.status === 'pending') throw new Error('å·²å‘é€å¥½å‹ç”³è¯·');
                    else if (existing.status === 'accepted') throw new Error('ä½ ä»¬å·²ç»æ˜¯å¥½å‹äº†');
                    else throw new Error('å¯¹æ–¹å·²æ‹’ç»ä½ çš„ç”³è¯·');
                }
                
                // å‘é€å¥½å‹ç”³è¯·
                await supabase
                    .from('friend_relations')
                    .insert([{
                        sender_id: currentUser.id,
                        receiver_id: friend.id,
                        status: 'pending'
                    }]);
                
                alert(`å¥½å‹ç”³è¯·å·²å‘é€ç»™ ${friend.username}`);
                document.getElementById('friendName').value = '';
            } catch (error) {
                console.error('æ·»åŠ å¥½å‹å¤±è´¥:', error);
                alert('æ·»åŠ å¤±è´¥: ' + error.message);
            } finally {
                hideLoading();
            }
        }
        
        // å›åº”å¥½å‹ç”³è¯·
        async function respondToRequest(requestId, accept) {
            try {
                showLoading();
                
                // è·å–ç”³è¯·ä¿¡æ¯ï¼ˆåŒ…å«ç”³è¯·äººIDï¼‰
                const { data: request } = await supabase
                    .from('friend_relations')
                    .select('sender_id')
                    .eq('id', requestId)
                    .single();
                
                // è·å–ç”³è¯·äººä¿¡æ¯
                const { data: sender } = await supabase
                    .from('users')
                    .select('username')
                    .eq('id', request.sender_id)
                    .single();
                
                // æ›´æ–°ç”³è¯·çŠ¶æ€
                await supabase
                    .from('friend_relations')
                    .update({ 
                        status: accept ? 'accepted' : 'rejected',
                        updated_at: new Date()
                    })
                    .eq('id', requestId);
                
                alert(accept ? 
                    `å·²åŒæ„ ${sender.username} çš„å¥½å‹ç”³è¯·` : 
                    `å·²æ‹’ç» ${sender.username} çš„å¥½å‹ç”³è¯·`);
                
                // åˆ·æ–°åˆ—è¡¨
                loadFriendRequests();
                loadFriendsList();
            } catch (error) {
                console.error('å¤„ç†ç”³è¯·å¤±è´¥:', error);
                alert('å¤„ç†å¤±è´¥: ' + error.message);
            } finally {
                hideLoading();
            }
        }
        
        // é€‰æ‹©å¥½å‹è¿›è¡ŒèŠå¤©
        function selectFriendToChat(friendId, friendName, friendAvatar, friendStatus) {
            if (friendId === currentUser.id) return;
            
            selectedFriend = { 
                id: friendId, 
                name: friendName, 
                avatar: friendAvatar,
                status: friendStatus
            };
            
            // æ˜¾ç¤ºæŸ¥çœ‹å¥½å‹èµ„æ–™æŒ‰é’®
            document.getElementById('viewFriendProfileBtn').classList.remove('hidden');
            
            // æ›´æ–°èŠå¤©å¤´éƒ¨ä¿¡æ¯
            document.getElementById('chatWith').textContent = friendName;
            document.getElementById('chatFriendAvatar').src = friendAvatar;
            updateChatFriendStatus(friendStatus);
            
            document.getElementById('messageInputArea').classList.remove('hidden');
            
            // é‡ç½®æœç´¢
            clearMessageSearch();
            
            // åŠ è½½èŠå¤©å†å²
            loadChatHistory();
            // è®¾ç½®èŠå¤©ç›‘å¬
            setupChatListener();
            // å¯åŠ¨è½®è¯¢
            startMessagePolling();
        }
        
        // å¯åŠ¨æ¶ˆæ¯è½®è¯¢
        function startMessagePolling() {
            // æ¸…é™¤æ—§å®šæ—¶å™¨ï¼Œé¿å…é‡å¤
            if (messagePollTimer) clearInterval(messagePollTimer);
            
            // æ¯3ç§’è‡ªåŠ¨åˆ·æ–°æ¶ˆæ¯
            messagePollTimer = setInterval(() => {
                if (selectedFriend) {
                    loadChatHistory();
                }
            }, 3000);
        }
        
        // åŠ è½½èŠå¤©å†å²
        async function loadChatHistory() {
            if (!currentUser || !selectedFriend) return;
            
            try {
                const { data: messages } = await supabase
                    .from('chat_messages')
                    .select('*')
                    .or(`and(sender_id.eq.${currentUser.id},receiver_id.eq.${selectedFriend.id}),and(sender_id.eq.${selectedFriend.id},receiver_id.eq.${currentUser.id})`)
                    .order('created_at', { ascending: true });
                
                renderMessages(messages || []);
                
                // æ ‡è®°æœªè¯»æ¶ˆæ¯ä¸ºå·²è¯»
                const unreadIds = messages
                    .filter(msg => msg.receiver_id === currentUser.id && !msg.is_read && !msg.is_recalled)
                    .map(msg => msg.id);

                if (unreadIds.length > 0) {
                    await supabase
                        .from('chat_messages')
                        .update({ 
                            is_read: true,
                            delivery_status: 'read'
                        })
                        .in('id', unreadIds);
                }
                
            } catch (error) {
                console.error('åŠ è½½èŠå¤©è®°å½•å¤±è´¥:', error);
            }
        }
        
        // æ¸²æŸ“æ¶ˆæ¯ - æ”¯æŒè¡¨æƒ…åŒ…å’ŒGIFæ˜¾ç¤º
        function renderMessages(messages) {
            const container = document.getElementById('messages');
            container.innerHTML = '';

            if (messages.length === 0) {
                container.innerHTML = '<div class="text-center text-gray-500 py-10"><i class="fa fa-comment-o text-3xl mb-3 opacity-20"></i><p class="text-sm italic">æš‚æ— èŠå¤©è®°å½•ï¼Œå¼€å§‹å¯¹è¯å§ï¼</p></div>';
                return;
            }

            messages.forEach((msg, index) => {
                if (msg.is_recalled) {
                    // å·²æ’¤å›çš„æ¶ˆæ¯
                    const messageEl = document.createElement('div');
                    messageEl.className = `flex justify-center animate-fadeIn`;
                    messageEl.style.animationDelay = `${index * 0.05}s`;
                    
                    messageEl.innerHTML = `
                        <div class="max-w-[80%] px-4 py-2 bg-gray-100 text-gray-500 rounded-lg">
                            ${messageStatusMap['recalled']}
                        </div>
                    `;
                    
                    container.appendChild(messageEl);
                    return;
                }
                
                const isSent = msg.sender_id === currentUser.id;
                const messageEl = document.createElement('div');
                messageEl.className = `flex ${isSent ? 'justify-end' : 'justify-start'} animate-fadeIn`;
                messageEl.style.animationDelay = `${index * 0.05}s`;
                messageEl.dataset.messageId = msg.id;
                
                // å¤„ç†æ¶ˆæ¯å†…å®¹ï¼ŒåŒºåˆ†æ–‡æœ¬å’ŒGIF
                let contentHtml = '';
                if (msg.content.startsWith('[gif]') && msg.content.endsWith('[/gif]')) {
                    const gifUrl = msg.content.replace('[gif]', '').replace('[/gif]', '');
                    contentHtml = `<img src="${gifUrl}" alt="GIFåŠ¨ç”»" class="max-w-full h-auto rounded">`;
                } else {
                    // å¦‚æœæœ‰æœç´¢å…³é”®è¯ï¼Œé«˜äº®æ˜¾ç¤º
                    contentHtml = messageSearchTerm 
                        ? highlightText(msg.content, messageSearchTerm)
                        : msg.content;
                }
                
                // é˜…åå³ç„šæ¶ˆæ¯æ·»åŠ ç‰¹æ®Šæ ·å¼
                const burnClass = msg.burn_after_read ? 'fade-out' : '';
                
                messageEl.innerHTML = `
                    <div class="max-w-[80%] px-4 py-2.5 ${isSent ? 'chat-bubble-right' : 'chat-bubble-left'} ${burnClass}">
                        ${contentHtml}
                        <p class="text-xs mt-1 ${isSent ? 'text-blue-100' : 'text-gray-500'} text-right flex items-center justify-end">
                            ${new Date(msg.created_at).toLocaleTimeString()}
                            ${isSent ? messageStatusMap[msg.delivery_status || 'pending'] : ''}
                            ${!isSent && msg.burn_after_read ? '<i class="fa fa-fire text-orange-500 ml-1"></i>' : ''}
                            ${isSent && !msg.burn_after_read ? 
                                `<button onclick="recallMessage('${msg.id}')" class="ml-2 opacity-0 hover:opacity-100 transition-opacity">
                                    <i class="fa fa-trash-o"></i>
                                </button>` : ''}
                        </p>
                    </div>
                `;
                
                container.appendChild(messageEl);
                
                // å¦‚æœæ˜¯é˜…åå³ç„šæ¶ˆæ¯ä¸”æ˜¯æ¥æ”¶æ–¹ï¼Œ10ç§’ååˆ é™¤
                if (!isSent && msg.burn_after_read && msg.is_read) {
                    setTimeout(() => {
                        const el = document.querySelector(`[data-message-id="${msg.id}"]`);
                        if (el) {
                            el.remove();
                            // ä»æ•°æ®åº“åˆ é™¤
                            deleteBurnedMessage(msg.id);
                        }
                    }, 10000);
                }
            });
            
            // æ»šåŠ¨åˆ°åº•éƒ¨
            container.scrollTop = container.scrollHeight;
        }
        
        // é«˜äº®æœç´¢æ–‡æœ¬
        function highlightText(text, term) {
            if (!term) return text;
            const regex = new RegExp(`(${term})`, 'gi');
            return text.replace(regex, '<mark>$1</mark>');
        }
        
        // å¤„ç†æ¶ˆæ¯æœç´¢
        function handleMessageSearch(e) {
            const term = e.target.value.trim();
            messageSearchTerm = term;
            
            const clearBtn = document.getElementById('clearSearchBtn');
            const resultsInfo = document.getElementById('searchResultsInfo');
            const searchCount = document.getElementById('searchCount');
            
            if (term) {
                clearBtn.classList.remove('hidden');
                
                // é‡æ–°æ¸²æŸ“æ¶ˆæ¯ä»¥æ˜¾ç¤ºé«˜äº®
                loadChatHistory().then(() => {
                    // è®¡ç®—åŒ¹é…æ•°é‡
                    const count = document.querySelectorAll('mark').length;
                    searchCount.textContent = count;
                    resultsInfo.classList.remove('hidden');
                });
            } else {
                clearMessageSearch();
            }
        }
        
        // æ¸…é™¤æœç´¢
        function clearMessageSearch() {
            messageSearchTerm = '';
            document.getElementById('messageSearchInput').value = '';
            document.getElementById('clearSearchBtn').classList.add('hidden');
            document.getElementById('searchResultsInfo').classList.add('hidden');
            
            // é‡æ–°æ¸²æŸ“æ¶ˆæ¯
            loadChatHistory();
        }
        
        // å‘é€æ¶ˆæ¯
        async function sendMessage() {
            const content = document.getElementById('messageText').value.trim();
            if (!content || !selectedFriend) return;
    
            try {
                // å‘é€æ¶ˆæ¯åˆ°æ•°æ®åº“
                const { error } = await supabase
                    .from('chat_messages')
                    .insert([{
                        sender_id: currentUser.id,
                        receiver_id: selectedFriend.id,
                        content: content,
                        is_read: false,
                        delivery_status: 'pending',
                        burn_after_read: burnAfterReadingEnabled
                    }]);
        
                if (!error) {
                    document.getElementById('messageText').value = '';
                    // å…³é—­è¡¨æƒ…åŒ…å’ŒGIFé¢æ¿
                    document.getElementById('emojiPanel').classList.add('hidden');
                    document.getElementById('gifPanel').classList.add('hidden');
                    
                    // å¦‚æœæ˜¯é˜…åå³ç„šæ¨¡å¼ï¼Œå‘é€åå…³é—­
                    if (burnAfterReadingEnabled) {
                        toggleBurnAfterReading();
                    }
                    
                    // ä¿åº•åˆ·æ–°
                    setTimeout(loadChatHistory, 300);
                }
            } catch (error) {
                console.error('å‘é€æ¶ˆæ¯å¤±è´¥:', error);
                alert('å‘é€å¤±è´¥: ' + error.message);
            }
        }
        
        // åˆ‡æ¢è¡¨æƒ…åŒ…é¢æ¿æ˜¾ç¤º
        function toggleEmojiPanel() {
            const panel = document.getElementById('emojiPanel');
            const gifPanel = document.getElementById('gifPanel');
            
            // å…³é—­GIFé¢æ¿
            gifPanel.classList.add('hidden');
            
            // åˆ‡æ¢è¡¨æƒ…é¢æ¿
            panel.classList.toggle('hidden');
        }
        
        // åˆ‡æ¢GIFé¢æ¿æ˜¾ç¤º
        function toggleGifPanel() {
            const panel = document.getElementById('gifPanel');
            const emojiPanel = document.getElementById('emojiPanel');
            
            // å…³é—­è¡¨æƒ…é¢æ¿
            emojiPanel.classList.add('hidden');
            
            // åˆ‡æ¢GIFé¢æ¿
            panel.classList.toggle('hidden');
            
            // å¦‚æœæ˜¯é¦–æ¬¡æ‰“å¼€ï¼ŒåŠ è½½çƒ­é—¨GIF
            if (!panel.classList.contains('hidden') && document.getElementById('gifResults').innerHTML.includes('æœç´¢GIFåŠ¨å›¾')) {
                searchGifs({ target: { value: 'popular' } });
            }
        }
        
        // åˆ‡æ¢æ¶ˆæ¯é€‰é¡¹èœå•
        function toggleMessageOptions() {
            const menu = document.getElementById('messageOptionsMenu');
            menu.classList.toggle('hidden');
        }
        
        // åˆ‡æ¢é˜…åå³ç„šæ¨¡å¼
        function toggleBurnAfterReading() {
            burnAfterReadingEnabled = !burnAfterReadingEnabled;
            const btn = document.getElementById('enableBurnAfterReadingBtn');
            const notice = document.getElementById('burnAfterReadingNotice');
            
            if (burnAfterReadingEnabled) {
                btn.innerHTML = '<i class="fa fa-fire text-orange-500 mr-2"></i>å…³é—­é˜…åå³ç„š';
                notice.classList.remove('hidden');
            } else {
                btn.innerHTML = '<i class="fa fa-fire text-gray-500 mr-2"></i>é˜…åå³ç„š';
                notice.classList.add('hidden');
            }
            
            // å…³é—­é€‰é¡¹èœå•
            document.getElementById('messageOptionsMenu').classList.add('hidden');
        }
        
        // æœç´¢GIFåŠ¨å›¾ï¼ˆä½¿ç”¨GIPHYçš„ç¤ºä¾‹URLï¼Œå®é™…é¡¹ç›®ä¸­éœ€è¦æ›¿æ¢ä¸ºçœŸå®APIï¼‰
        async function searchGifs(e) {
            const query = e.target.value.trim() || 'happy';
            const resultsContainer = document.getElementById('gifResults');
            
            resultsContainer.innerHTML = '<div class="col-span-3 flex items-center justify-center h-24 text-gray-500"><i class="fa fa-circle-o-notch fa-spin mr-2"></i>åŠ è½½ä¸­...</div>';
            
            try {
                // è¿™é‡Œä½¿ç”¨picsumä½œä¸ºç¤ºä¾‹ï¼Œå®é™…é¡¹ç›®ä¸­åº”ä½¿ç”¨GIPHYç­‰GIF API
                const count = 12;
                let html = '';
                
                for (let i = 0; i < count; i++) {
                    // ä½¿ç”¨ä¸åŒçš„ç§å­ç¡®ä¿å›¾ç‰‡ä¸åŒ
                    const seed = `${query}-${i}-${Date.now()}`;
                    const gifUrl = `https://picsum.photos/seed/${seed}/200/150`;
                    html += `
                        <div class="relative aspect-video overflow-hidden rounded-lg cursor-pointer hover:opacity-90 transition-opacity"
                             onclick="insertGif('${gifUrl}')">
                            <img src="${gifUrl}" alt="GIFåŠ¨ç”»" class="w-full h-full object-cover">
                            <div class="absolute inset-0 bg-black/20 opacity-0 hover:opacity-100 transition-opacity flex items-center justify-center">
                                <i class="fa fa-plus text-white text-xl"></i>
                            </div>
                        </div>
                    `;
                }
                
                resultsContainer.innerHTML = html;
            } catch (error) {
                console.error('æœç´¢GIFå¤±è´¥:', error);
                resultsContainer.innerHTML = '<div class="col-span-3 text-center text-red-500 py-6">åŠ è½½å¤±è´¥ï¼Œè¯·é‡è¯•</div>';
            }
        }
        
        // æ’å…¥è¡¨æƒ…åˆ°æ¶ˆæ¯æ¡†
        function insertEmoji(emoji) {
            const textarea = document.getElementById('messageText');
            const cursorPos = textarea.selectionStart;
            const textBefore = textarea.value.substring(0, cursorPos);
            const textAfter = textarea.value.substring(cursorPos);
            
            // æ’å…¥è¡¨æƒ…
            textarea.value = textBefore + emoji + textAfter;
            
            // ç§»åŠ¨å…‰æ ‡åˆ°è¡¨æƒ…åé¢
            textarea.focus();
            textarea.selectionStart = cursorPos + emoji.length;
            textarea.selectionEnd = cursorPos + emoji.length;
        }
        
        // æ’å…¥GIFåˆ°æ¶ˆæ¯æ¡†
        function insertGif(url) {
            const textarea = document.getElementById('messageText');
            
            // æ’å…¥GIFæ ‡è®°
            textarea.value += `[gif]${url}[/gif]`;
            textarea.focus();
            
            // å…³é—­GIFé¢æ¿
            document.getElementById('gifPanel').classList.add('hidden');
        }
        
        // å¤„ç†è¾“å…¥çŠ¶æ€
        function handleTyping() {
            if (!selectedFriend) return;
            
            // æ¸…é™¤ä¹‹å‰çš„å®šæ—¶å™¨
            if (typingTimer) {
                clearTimeout(typingTimer);
            }
            
            // å‘é€"æ­£åœ¨è¾“å…¥"çŠ¶æ€
            sendTypingStatus(true);
            
            // 3ç§’åå‘é€"åœæ­¢è¾“å…¥"çŠ¶æ€
            typingTimer = setTimeout(() => {
                sendTypingStatus(false);
            }, 3000);
        }
        
        // å‘é€è¾“å…¥çŠ¶æ€
        async function sendTypingStatus(isTyping) {
            try {
                // åœ¨å®é™…åº”ç”¨ä¸­ï¼Œè¿™é‡Œåº”è¯¥æ˜¯å‘é€åˆ°æœåŠ¡å™¨çš„é€»è¾‘
                // ä¸ºç®€åŒ–ç¤ºä¾‹ï¼Œæˆ‘ä»¬ç›´æ¥æ›´æ–°æœ¬åœ°å­˜å‚¨çš„çŠ¶æ€
                localStorage.setItem(`typing_${currentUser.id}_${selectedFriend.id}`, isTyping);
                
                // å¦‚æœæ˜¯æ¥æ”¶æ–¹ï¼Œæ›´æ–°UI
                if (isTyping && selectedFriend.id === currentUser.id) {
                    // è¿™éƒ¨åˆ†åº”è¯¥åœ¨æ¥æ”¶æ–¹è§¦å‘ï¼Œè¿™é‡Œä»…åšæ¼”ç¤º
                    document.getElementById('typingIndicator').classList.toggle('hidden', !isTyping);
                }
            } catch (error) {
                console.error('å‘é€è¾“å…¥çŠ¶æ€å¤±è´¥:', error);
            }
        }
        
        // æ’¤å›æ¶ˆæ¯
        async function recallMessage(messageId) {
            if (!confirm('ç¡®å®šè¦æ’¤å›è¿™æ¡æ¶ˆæ¯å—ï¼Ÿ')) return;
            
            try {
                // æ›´æ–°æ¶ˆæ¯ä¸ºå·²æ’¤å›
                await supabase
                    .from('chat_messages')
                    .update({ 
                        is_recalled: true,
                        content: '' // æ¸…ç©ºå†…å®¹
                    })
                    .eq('id', messageId)
                    .eq('sender_id', currentUser.id);
                
                // åˆ·æ–°æ¶ˆæ¯åˆ—è¡¨
                loadChatHistory();
            } catch (error) {
                console.error('æ’¤å›æ¶ˆæ¯å¤±è´¥:', error);
                alert('æ’¤å›å¤±è´¥: ' + error.message);
            }
        }
        
        // åˆ é™¤å·²ç„šæ¯çš„æ¶ˆæ¯
        async function deleteBurnedMessage(messageId) {
            try {
                await supabase
                    .from('chat_messages')
                    .delete()
                    .eq('id', messageId);
            } catch (error) {
                console.error('åˆ é™¤å·²ç„šæ¯æ¶ˆæ¯å¤±è´¥:', error);
            }
        }
        
        // å¯¼å‡ºèŠå¤©è®°å½•
        async function exportChatHistory() {
            if (!selectedFriend) return;
            
            try {
                showLoading();
                
                // è·å–èŠå¤©è®°å½•
                const { data: messages } = await supabase
                    .from('chat_messages')
                    .select('*')
                    .or(`and(sender_id.eq.${currentUser.id},receiver_id.eq.${selectedFriend.id}),and(sender_id.eq.${selectedFriend.id},receiver_id.eq.${currentUser.id})`)
                    .order('created_at', { ascending: true });
                
                if (!messages || messages.length === 0) {
                    alert('æ²¡æœ‰èŠå¤©è®°å½•å¯å¯¼å‡º');
                    hideLoading();
                    return;
                }
                
                // åˆ›å»ºPDFæ–‡æ¡£
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                // æ·»åŠ æ ‡é¢˜
                doc.setFontSize(16);
                doc.text(`ä¸ ${selectedFriend.name} çš„èŠå¤©è®°å½•`, 10, 10);
                doc.setFontSize(10);
                doc.text(`å¯¼å‡ºæ—¶é—´: ${new Date().toLocaleString()}`, 10, 20);
                doc.line(10, 25, 200, 25); // æ°´å¹³çº¿
                
                let yPos = 35;
                const pageHeight = doc.internal.pageSize.height;
                const margin = 10;
                
                // æ·»åŠ æ¯æ¡æ¶ˆæ¯
                messages.forEach((msg, index) => {
                    if (msg.is_recalled) {
                        doc.setFontSize(10);
                        doc.setTextColor(100);
                        doc.text('æ¶ˆæ¯å·²æ’¤å›', 10, yPos);
                        yPos += 10;
                    } else {
                        const sender = msg.sender_id === currentUser.id ? 'æˆ‘' : selectedFriend.name;
                        const time = new Date(msg.created_at).toLocaleString();
                        
                        // æ£€æŸ¥æ˜¯å¦éœ€è¦åˆ†é¡µ
                        if (yPos > pageHeight - margin - 20) {
                            doc.addPage();
                            yPos = margin + 10;
                        }
                        
                        // å‘é€è€…å’Œæ—¶é—´
                        doc.setFontSize(10);
                        doc.setTextColor(0);
                        doc.text(`${sender} (${time})`, 10, yPos);
                        yPos += 10;
                        
                        // æ¶ˆæ¯å†…å®¹
                        doc.setFontSize(11);
                        doc.setTextColor(0);
                        
                        // å¤„ç†GIFå†…å®¹
                        let content = msg.content;
                        if (content.startsWith('[gif]') && content.endsWith('[/gif]')) {
                            content = '[GIFå›¾ç‰‡]';
                        }
                        
                        // è‡ªåŠ¨æ¢è¡Œ
                        const splitText = doc.splitTextToSize(content, 180);
                        doc.text(splitText, 10, yPos);
                        yPos += splitText.length * 10 + 5;
                    }
                });
                
                // ä¿å­˜PDF
                doc.save(`ä¸${selectedFriend.name}çš„èŠå¤©è®°å½•.pdf`);
            } catch (error) {
                console.error('å¯¼å‡ºèŠå¤©è®°å½•å¤±è´¥:', error);
                alert('å¯¼å‡ºå¤±è´¥: ' + error.message);
            } finally {
                hideLoading();
            }
        }
        
        // è®¾ç½®èŠå¤©ç›‘å¬
        function setupChatListener() {
            // å…ˆå–æ¶ˆç°æœ‰ç›‘å¬
            if (chatSubscription) {
                supabase.removeChannel(chatSubscription);
                chatSubscription = null;
            }
    
            // åˆ›å»ºæ–°çš„ç›‘å¬é€šé“
            chatSubscription = supabase
                .channel(`chat_${currentUser.id}_${selectedFriend.id}`)
                .on(
                    'postgres_changes',
                    {
                        event: 'INSERT',
                        schema: 'public',
                        table: 'chat_messages',
                        filter: `(sender_id=eq.${currentUser.id} and receiver_id=eq.${selectedFriend.id}) or (sender_id=eq.${selectedFriend.id} and receiver_id=eq.${currentUser.id})`
                    },
                    (payload) => {
                        console.log('æ”¶åˆ°æ–°æ¶ˆæ¯:', payload);
                        
                        // å¦‚æœæ˜¯æ”¶åˆ°çš„æ–°æ¶ˆæ¯ï¼Œæ˜¾ç¤ºé€šçŸ¥
                        if (payload.new.sender_id !== currentUser.id) {
                            showNotification(
                                selectedFriend.name,
                                payload.new.content.startsWith('[gif]') ? '[GIFå›¾ç‰‡]' : payload.new.content,
                                selectedFriend.avatar
                            );
                        }
                        
                        loadChatHistory();
                    }
                )
                .on(
                    'postgres_changes',
                    {
                        event: 'UPDATE',
                        schema: 'public',
                        table: 'chat_messages',
                        filter: `(sender_id=eq.${currentUser.id} and receiver_id=eq.${selectedFriend.id}) or (sender_id=eq.${selectedFriend.id} and receiver_id=eq.${currentUser.id})`
                    },
                    (payload) => {
                        console.log('æ¶ˆæ¯æ›´æ–°:', payload);
                        loadChatHistory();
                    }
                )
                .subscribe((status) => {
                    console.log('ç›‘å¬çŠ¶æ€:', status);
                });
        }
        
        // åŠ è½½ä¸ªäººæ•°æ®çœ‹æ¿
        async function loadDataBoard() {
            if (!currentUser) return;
            
            try {
                showLoading();
                
                // 1. è·å–æœ¬å‘¨å‘é€æ¶ˆæ¯æ•°é‡
                const weekAgo = new Date();
                weekAgo.setDate(weekAgo.getDate() - 7);
                
                const { data: weeklyMessages } = await supabase
                    .from('chat_messages')
                    .select('id', { count: 'exact', head: true })
                    .eq('sender_id', currentUser.id)
                    .gte('created_at', weekAgo.toISOString());
                
                document.getElementById('weeklyMessageCount').textContent = weeklyMessages.count || 0;
                
                // 2. è·å–æ€»å¥½å‹æ•°
                const { data: friends } = await supabase
                    .from('friend_relations')
                    .select('id', { count: 'exact', head: true })
                    .or(`sender_id.eq.${currentUser.id},receiver_id.eq.${currentUser.id}`)
                    .eq('status', 'accepted');
                
                document.getElementById('totalFriendsCount').textContent = friends.count || 0;
                
                // 3. è·å–èŠå¤©æœ€é¢‘ç¹çš„å¥½å‹
                if (friends.count > 0) {
                    // è·å–æ‰€æœ‰å¥½å‹ID
                    const { data: relations } = await supabase
                        .from('friend_relations')
                        .select('sender_id, receiver_id')
                        .or(`sender_id.eq.${currentUser.id},receiver_id.eq.${currentUser.id}`)
                        .eq('status', 'accepted');
                    
                    const friendIds = new Set();
                    relations.forEach(rel => {
                        const friendId = rel.sender_id === currentUser.id ? rel.receiver_id : rel.sender_id;
                        friendIds.add(friendId);
                    });
                    
                    // ç»Ÿè®¡ä¸æ¯ä¸ªå¥½å‹çš„èŠå¤©æ•°é‡
                    let maxCount = 0;
                    let mostChatFriendId = null;
                    
                    for (const friendId of friendIds) {
                        const { data: messagesCount } = await supabase
                            .from('chat_messages')
                            .select('id', { count: 'exact', head: true })
                            .or(`and(sender_id.eq.${currentUser.id},receiver_id.eq.${friendId}),and(sender_id.eq.${friendId},receiver_id.eq.${currentUser.id})`);
                        
                        if (messagesCount.count > maxCount) {
                            maxCount = messagesCount.count;
                            mostChatFriendId = friendId;
                        }
                    }
                    
                    // è·å–æœ€é¢‘ç¹èŠå¤©å¥½å‹çš„åç§°
                    if (mostChatFriendId) {
                        const { data: friend } = await supabase
                            .from('users')
                            .select('username')
                            .eq('id', mostChatFriendId)
                            .single();
                        
                        document.getElementById('mostChatFriend').textContent = friend.username;
                    } else {
                        document.getElementById('mostChatFriend').textContent = 'æ— ';
                    }
                } else {
                    document.getElementById('mostChatFriend').textContent = 'æ— ';
                }
                
                // 4. è·å–å¸¸ç”¨è¡¨æƒ…
                const { data: allMessages } = await supabase
                    .from('chat_messages')
                    .select('content')
                    .eq('sender_id', currentUser.id);
                
                const emojiCount = {};
                const emojiRegex = /[\u{1F600}-\u{1F64F}\u{1F300}-\u{1F5FF}\u{1F680}-\u{1F6FF}\u{1F1E0}-\u{1F1FF}]/gu;
                
                allMessages.forEach(msg => {
                    if (msg.content) {
                        const emojis = msg.content.match(emojiRegex);
                        if (emojis) {
                            emojis.forEach(emoji => {
                                emojiCount[emoji] = (emojiCount[emoji] || 0) + 1;
                            });
                        }
                    }
                });
                
                // æ’åºå¹¶æ˜¾ç¤ºå‰5ä¸ª
                const frequentEmojis = Object.entries(emojiCount)
                    .sort((a, b) => b[1] - a[1])
                    .slice(0, 5);
                
                const emojiContainer = document.getElementById('frequentEmojis');
                if (frequentEmojis.length > 0) {
                    emojiContainer.innerHTML = frequentEmojis.map(([emoji, count]) => 
                        `<div class="text-2xl flex flex-col items-center">
                            <span>${emoji}</span>
                            <span class="text-xs text-gray-500">${count}æ¬¡</span>
                        </div>`
                    ).join('');
                } else {
                    emojiContainer.innerHTML = '<p class="text-gray-500 italic">æš‚æ— è¡¨æƒ…ä½¿ç”¨è®°å½•</p>';
                }
                
                // 5. å¯èƒ½è®¤è¯†çš„äººï¼ˆå¥½å‹çš„å¥½å‹ï¼‰
                const { data: myFriends } = await supabase
                    .from('friend_relations')
                    .select('sender_id, receiver_id')
                    .or(`sender_id.eq.${currentUser.id},receiver_id.eq.${currentUser.id}`)
                    .eq('status', 'accepted');
                
                const myFriendIds = new Set();
                myFriends.forEach(rel => {
                    const friendId = rel.sender_id === currentUser.id ? rel.receiver_id : rel.sender_id;
                    myFriendIds.add(friendId);
                });
                
                // è·å–å¥½å‹çš„å¥½å‹
                const possibleFriendIds = new Set();
                for (const friendId of myFriendIds) {
                    const { data: friendRelations } = await supabase
                        .from('friend_relations')
                        .select('sender_id, receiver_id')
                        .or(`sender_id.eq.${friendId},receiver_id.eq.${friendId}`)
                        .eq('status', 'accepted');
                    
                    friendRelations.forEach(rel => {
                        const possibleFriendId = rel.sender_id === friendId ? rel.receiver_id : rel.sender_id;
                        // æ’é™¤è‡ªå·±å’Œå·²æœ‰çš„å¥½å‹
                        if (possibleFriendId !== currentUser.id && !myFriendIds.has(possibleFriendId)) {
                            possibleFriendIds.add(possibleFriendId);
                        }
                    });
                }
                
                // è·å–å¯èƒ½è®¤è¯†çš„äººçš„ä¿¡æ¯
                const possibleFriendsContainer = document.getElementById('possibleFriends');
                if (possibleFriendIds.size > 0) {
                    const { data: possibleFriends } = await supabase
                        .from('users')
                        .select('id, username, avatar')
                        .in('id', Array.from(possibleFriendIds))
                        .limit(3);
                    
                    possibleFriendsContainer.innerHTML = possibleFriends.map(friend => `
                        <div class="flex items-center gap-3 p-2 bg-white rounded-lg shadow-sm">
                            <img src="${friend.avatar}" alt="${friend.username}" class="w-10 h-10 rounded-full">
                            <div class="flex-1">
                                <p class="font-medium">${friend.username}</p>
                                <p class="text-xs text-gray-500">å¯èƒ½è®¤è¯†çš„äºº</p>
                            </div>
                            <button onclick="addFriendByName('${friend.username}')" class="px-2 py-1 text-xs bg-primary text-white rounded">
                                <i class="fa fa-user-plus mr-1"></i>æ·»åŠ 
                            </button>
                        </div>
                    `).join('');
                } else {
                    possibleFriendsContainer.innerHTML = '<p class="text-gray-500 italic">æš‚æ— æ¨è</p>';
                }
                
                // 6. çƒ­é—¨è¡¨æƒ…åŒ…
                const gifContainer = document.getElementById('popularGifs');
                const trendingTags = ['happy', 'love', 'funny', 'sad', 'congrats'];
                const randomTag = trendingTags[Math.floor(Math.random() * trendingTags.length)];
                
                // åŠ è½½çƒ­é—¨GIF
                let gifHtml = '';
                for (let i = 0; i < 5; i++) {
                    const seed = `trending-${randomTag}-${i}`;
                    const gifUrl = `https://picsum.photos/seed/${seed}/200/150`;
                    gifHtml += `
                        <div class="relative aspect-video overflow-hidden rounded-lg cursor-pointer hover:opacity-90 transition-opacity"
                             onclick="insertGifFromBoard('${gifUrl}')">
                            <img src="${gifUrl}" alt="çƒ­é—¨GIF" class="w-full h-full object-cover">
                        </div>
                    `;
                }
                
                gifContainer.innerHTML = gifHtml;
                
            } catch (error) {
                console.error('åŠ è½½æ•°æ®çœ‹æ¿å¤±è´¥:', error);
            } finally {
                hideLoading();
            }
        }
        
        // ä»æ•°æ®çœ‹æ¿æ·»åŠ å¥½å‹
        function addFriendByName(username) {
            document.getElementById('friendName').value = username;
            switchToChatView();
            // è‡ªåŠ¨æ»šåŠ¨åˆ°æ·»åŠ å¥½å‹åŒºåŸŸ
            document.querySelector('.bg-white.rounded-xl.shadow-md.p-4').scrollIntoView({ behavior: 'smooth' });
        }
        
        // ä»æ•°æ®çœ‹æ¿æ’å…¥GIF
        function insertGifFromBoard(url) {
            if (!selectedFriend) {
                alert('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªèŠå¤©å¯¹è±¡');
                return;
            }
            
            // æ’å…¥GIFåˆ°æ¶ˆæ¯æ¡†
            document.getElementById('messageText').value += `[gif]${url}[/gif]`;
            
            // åˆ‡æ¢åˆ°èŠå¤©ç•Œé¢
            switchToChatView();
            
            // èšç„¦åˆ°æ¶ˆæ¯æ¡†
            document.getElementById('messageText').focus();
        }
        
        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        window.onload = initApp;
        
        // é¡µé¢å…³é—­æ—¶æ›´æ–°çŠ¶æ€ä¸ºç¦»çº¿
        window.addEventListener('beforeunload', () => {
            if (currentUser && ['online', 'busy', 'away'].includes(currentUser.status)) {
                // å‘é€çŠ¶æ€æ›´æ–°è¯·æ±‚ï¼ˆä½¿ç”¨beaconç¡®ä¿åœ¨é¡µé¢å…³é—­å‰å‘é€ï¼‰
                const url = `${supabase.url}/rest/v1/users?id=eq.${currentUser.id}`;
                const body = JSON.stringify({ status: 'offline', last_active: new Date() });
                
                navigator.sendBeacon(url, body);
            }
        });
    </script>
</body>
</html>
