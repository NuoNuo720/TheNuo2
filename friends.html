<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>好友聊天</title>
    <!-- 引入外部资源 -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <!-- 引入Socket.io客户端（核心） -->
    <script src="https://cdn.socket.io/4.5.1/socket.io.min.js"></script>
    
    <!-- Tailwind配置 -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#3B82F6',
                        secondary: '#10B981',
                        danger: '#EF4444',
                        light: '#F3F4F6',
                        dark: '#1F2937'
                    },
                    fontFamily: {
                        sans: ['Inter', 'system-ui', 'sans-serif']
                    }
                }
            }
        }
    </script>
    
    <style type="text/tailwindcss">
        @layer utilities {
            .content-auto {
                content-visibility: auto;
            }
            .chat-bubble-left {
                border-radius: 1rem 1rem 1rem 0;
            }
            .chat-bubble-right {
                border-radius: 1rem 1rem 0 1rem;
            }
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <!-- 页面头部 -->
    <header class="bg-primary text-white shadow-md">
        <div class="container mx-auto px-4 py-3 flex justify-between items-center">
            <h1 class="text-xl font-bold"><i class="fas fa-comments"></i> 好友聊天</h1>
            <div class="flex items-center gap-3" id="userInfo">
                <span class="hidden md:inline" id="usernameDisplay"></span>
                <img src="" alt="用户头像" id="avatarDisplay" class="w-8 h-8 rounded-full border-2 border-white">
                <button id="logoutBtn" class="bg-white text-primary px-3 py-1 rounded hover:bg-opacity-90 transition">
                    <i class="fas fa-sign-out-alt"></i> 退出
                </button>
            </div>
        </div>
    </header>

    <main class="container mx-auto px-4 py-6 flex flex-col md:flex-row gap-6">
        <!-- 好友列表 -->
        <div class="w-full md:w-1/4 bg-white rounded-lg shadow-md p-4 h-[calc(100vh-120px)] overflow-y-auto">
            <h2 class="text-lg font-semibold mb-4 flex items-center">
                <i class="fas fa-users text-primary mr-2"></i> 好友列表
            </h2>
            <div class="relative">
                <input type="text" placeholder="搜索好友..." class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-primary">
                <i class="fas fa-search absolute right-3 top-3 text-gray-400"></i>
            </div>
            <ul class="mt-4 space-y-1" id="friendsList">
                <!-- 好友列表会通过JS动态生成 -->
                <li class="p-2 hover:bg-light rounded cursor-pointer transition flex items-center gap-3">
                    <img src="https://picsum.photos/200/200?random=1" alt="好友头像" class="w-10 h-10 rounded-full">
                    <div>
                        <p class="font-medium">张三</p>
                        <p class="text-xs text-gray-500">在线</p>
                    </div>
                </li>
                <li class="p-2 hover:bg-light rounded cursor-pointer transition flex items-center gap-3">
                    <img src="https://picsum.photos/200/200?random=2" alt="好友头像" class="w-10 h-10 rounded-full">
                    <div>
                        <p class="font-medium">李四</p>
                        <p class="text-xs text-gray-500">刚刚在线</p>
                    </div>
                </li>
            </ul>
        </div>

        <!-- 聊天窗口 -->
        <div class="w-full md:w-3/4 bg-white rounded-lg shadow-md flex flex-col h-[calc(100vh-120px)]" id="chatWindow">
            <!-- 聊天头部 -->
            <div class="border-b p-4 flex justify-between items-center">
                <div class="flex items-center gap-3">
                    <img src="https://picsum.photos/200/200?random=1" alt="当前聊天好友头像" id="currentFriendAvatar" class="w-10 h-10 rounded-full">
                    <h2 class="font-semibold" id="currentFriendName">选择好友开始聊天</h2>
                </div>
                <div class="flex gap-2">
                    <button class="p-2 hover:bg-light rounded-full transition" title="语音通话">
                        <i class="fas fa-phone text-primary"></i>
                    </button>
                    <button class="p-2 hover:bg-light rounded-full transition" title="视频通话">
                        <i class="fas fa-video text-primary"></i>
                    </button>
                    <button class="p-2 hover:bg-light rounded-full transition" title="更多选项">
                        <i class="fas fa-ellipsis-v text-gray-500"></i>
                    </button>
                </div>
            </div>

            <!-- 聊天内容 -->
            <div class="flex-1 p-4 overflow-y-auto" id="chatMessages">
                <div class="text-center text-gray-500 text-sm my-4">
                    今天 15:30
                </div>
                <!-- 对方消息 -->
                <div class="flex items-end gap-2 mb-4">
                    <img src="https://picsum.photos/200/200?random=1" alt="对方头像" class="w-8 h-8 rounded-full">
                    <div>
                        <p class="bg-light px-4 py-2 chat-bubble-left max-w-[70%]">你好！最近怎么样？</p>
                        <p class="text-xs text-gray-500 mt-1">15:32</p>
                    </div>
                </div>
                <!-- 自己消息 -->
                <div class="flex items-end gap-2 mb-4 justify-end">
                    <div class="text-right">
                        <p class="bg-primary text-white px-4 py-2 chat-bubble-right max-w-[70%]">挺好的，你呢？</p>
                        <p class="text-xs text-gray-500 mt-1">15:33</p>
                    </div>
                    <img src="" alt="自己头像" id="myAvatar" class="w-8 h-8 rounded-full">
                </div>
            </div>

            <!-- 消息输入框 -->
            <div class="border-t p-4">
                <div class="flex gap-2 mb-2">
                    <button class="p-2 text-gray-500 hover:bg-light rounded-full transition">
                        <i class="fas fa-image"></i>
                    </button>
                    <button class="p-2 text-gray-500 hover:bg-light rounded-full transition">
                        <i class="fas fa-smile"></i>
                    </button>
                    <button class="p-2 text-gray-500 hover:bg-light rounded-full transition">
                        <i class="fas fa-paperclip"></i>
                    </button>
                </div>
                <div class="flex gap-2">
                    <input type="text" id="chatInput" placeholder="输入消息..." class="flex-1 px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-primary">
                    <button id="sendBtn" class="bg-primary text-white px-4 py-2 rounded-lg hover:bg-primary/90 transition">
                        <i class="fas fa-paper-plane"></i> 发送
                    </button>
                </div>
            </div>
        </div>
    </main>

    <!-- 通知组件 -->
    <div id="notification" class="fixed bottom-4 right-4 px-4 py-3 rounded-lg shadow-lg transform translate-y-20 opacity-0 transition-all duration-300 z-50"></div>

    <script>
        // 全局变量
        let currentUser = null;         // 当前登录用户信息
        let currentChatFriend = null;   // 当前聊天的好友
        let socketIo = null;            // Socket.io实例

        // DOM加载完成后初始化
        document.addEventListener('DOMContentLoaded', function() {
            // 1. 读取本地存储的用户信息（假设登录后已保存）
            loadUserInfo();
            
            // 2. 初始化Socket.io连接
            if (currentUser) {
                initSocketIo();
            } else {
                showNotification('请先登录', 'error');
                setTimeout(() => {
                    window.location.href = 'login.html'; // 跳转到登录页
                }, 1000);
            }

            // 3. 绑定事件
            document.getElementById('sendBtn').addEventListener('click', sendMessage);
            document.getElementById('chatInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') sendMessage();
            });
            document.getElementById('logoutBtn').addEventListener('click', logout);
            
            // 4. 绑定好友列表点击事件
            document.querySelectorAll('#friendsList li').forEach(item => {
                item.addEventListener('click', function() {
                    const friendName = this.querySelector('p:first-child').textContent;
                    const friendAvatar = this.querySelector('img').src;
                    setCurrentChatFriend(friendName, friendAvatar);
                });
            });
        });

        // 1. 加载用户信息
        function loadUserInfo() {
            const userStr = localStorage.getItem('userInfo');
            if (userStr) {
                currentUser = JSON.parse(userStr);
                // 更新页面显示
                document.getElementById('usernameDisplay').textContent = currentUser.username;
                document.getElementById('avatarDisplay').src = currentUser.avatar;
                document.getElementById('myAvatar').src = currentUser.avatar;
                console.log('读取到的用户信息：', currentUser);
            }
        }

        // 2. 初始化Socket.io连接（核心）
        function initSocketIo() {
            // 关闭已有连接
            if (socketIo) {
                socketIo.disconnect();
            }

            try {
                // 连接Socket.io Cloud（使用测试地址，正式环境替换为自己的地址）
                const socketUrl = 'https://socket.io.cloud/proj_123456';
                console.log('正在连接Socket.io Cloud：', socketUrl);
                
                socketIo = io(socketUrl, {
                    query: {
                        username: currentUser.username  // 传递用户名
                    },
                    auth: {
                        token: currentUser.token        // 传递认证token
                    },
                    reconnection: true,               // 自动重连
                    reconnectionAttempts: 10          // 最大重连次数
                });

                // 连接成功事件
                socketIo.on('connect', () => {
                    console.log('✅ Socket.io连接成功，ID：', socketIo.id);
                    showNotification('实时聊天已连接', 'success');
                    
                    // 加入自己的"房间"（用于点对点聊天）
                    socketIo.emit('join', currentUser.username);
                });

                // 收到消息事件
                socketIo.on('message', (data) => {
                    console.log('📥 收到消息：', data);
                    // 显示消息到聊天窗口
                    addMessageToChat(data.from, data.content, new Date(data.timestamp), true);
                    
                    // 如果是当前聊天对象的消息，高亮提示
                    if (currentChatFriend === data.from) {
                        // 滚动到最新消息
                        const chatMessages = document.getElementById('chatMessages');
                        chatMessages.scrollTop = chatMessages.scrollHeight;
                    } else {
                        // 不是当前聊天对象，显示通知
                        showNotification(`收到${data.from}的消息：${data.content}`, 'info');
                    }
                });

                // 连接错误事件
                socketIo.on('connect_error', (error) => {
                    console.error('❌ Socket.io连接错误：', error.message);
                    showNotification('聊天连接失败：' + error.message, 'error');
                });

                // 断开连接事件
                socketIo.on('disconnect', (reason) => {
                    console.log('🔌 Socket.io断开连接：', reason);
                    if (reason !== 'io client disconnect') {
                        showNotification('聊天连接已断开，正在重试...', 'error');
                    }
                });

            } catch (e) {
                console.error('初始化Socket.io失败：', e);
                showNotification('初始化聊天失败，请刷新页面', 'error');
                setTimeout(initSocketIo, 3000); // 3秒后重试
            }
        }

        // 3. 设置当前聊天好友
        function setCurrentChatFriend(name, avatar) {
            currentChatFriend = name;
            document.getElementById('currentFriendName').textContent = name;
            document.getElementById('currentFriendAvatar').src = avatar;
            
            // 清空聊天窗口（实际项目中应加载历史消息）
            document.getElementById('chatMessages').innerHTML = `
                <div class="text-center text-gray-500 text-sm my-4">
                    与${name}的聊天
                </div>
            `;
            
            // 聚焦输入框
            document.getElementById('chatInput').focus();
        }

        // 4. 发送消息
        function sendMessage() {
            if (!currentUser || !currentChatFriend || !socketIo) {
                showNotification('请先选择聊天对象', 'warning');
                return;
            }

            const inputEl = document.getElementById('chatInput');
            const content = inputEl.value.trim();
            if (!content) return;

            // 构建消息数据
            const messageData = {
                from: currentUser.username,
                to: currentChatFriend,
                content: content,
                timestamp: new Date().toISOString()
            };

            // 发送消息到服务器
            socketIo.emit('sendMessage', messageData);
            
            // 添加到本地聊天窗口（自己的消息）
            addMessageToChat(currentUser.username, content, new Date(), false);
            
            // 清空输入框
            inputEl.value = '';
        }

        // 5. 添加消息到聊天窗口
        function addMessageToChat(sender, content, time, isOther) {
            const chatMessages = document.getElementById('chatMessages');
            const timeStr = time.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            
            // 消息HTML模板
            const messageHtml = isOther 
                ? `
                <div class="flex items-end gap-2 mb-4">
                    <img src="https://picsum.photos/200/200?random=${sender}" alt="${sender}的头像" class="w-8 h-8 rounded-full">
                    <div>
                        <p class="bg-light px-4 py-2 chat-bubble-left max-w-[70%]">${content}</p>
                        <p class="text-xs text-gray-500 mt-1">${timeStr}</p>
                    </div>
                </div>
                `
                : `
                <div class="flex items-end gap-2 mb-4 justify-end">
                    <div class="text-right">
                        <p class="bg-primary text-white px-4 py-2 chat-bubble-right max-w-[70%]">${content}</p>
                        <p class="text-xs text-gray-500 mt-1">${timeStr}</p>
                    </div>
                    <img src="${currentUser.avatar}" alt="自己的头像" class="w-8 h-8 rounded-full">
                </div>
                `;
            
            // 添加到聊天窗口
            chatMessages.insertAdjacentHTML('beforeend', messageHtml);
            
            // 滚动到最新消息
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        // 6. 显示通知
        function showNotification(message, type = 'info') {
            const notification = document.getElementById('notification');
            const bgColors = {
                success: 'bg-secondary text-white',
                error: 'bg-danger text-white',
                info: 'bg-primary text-white',
                warning: 'bg-yellow-500 text-white'
            };

            notification.className = `fixed bottom-4 right-4 px-4 py-3 rounded-lg shadow-lg transform translate-y-0 opacity-100 transition-all duration-300 z-50 ${bgColors[type]}`;
            notification.textContent = message;

            // 3秒后隐藏
            setTimeout(() => {
                notification.className = 'fixed bottom-4 right-4 px-4 py-3 rounded-lg shadow-lg transform translate-y-20 opacity-0 transition-all duration-300 z-50';
            }, 3000);
        }

        // 7. 退出登录
        function logout() {
            // 断开Socket连接
            if (socketIo) {
                socketIo.disconnect();
            }
            // 清除本地存储
            localStorage.removeItem('userInfo');
            // 跳转到登录页
            window.location.href = 'login.html';
        }
    </script>
</body>
</html>
