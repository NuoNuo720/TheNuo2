<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¥½å‹åˆ—è¡¨ - å¤šåŠŸèƒ½å¯¼èˆªä¸­å¿ƒ</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* åŸºç¡€æ ·å¼ç»§æ‰¿ä¸»é¡µé¢é£æ ¼ */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: #f0f4f8;
            color: #333;
            min-height: 100vh;
            padding: 0;
            line-height: 1.6;
        }

        .navbar {
            width: 100%;
            background-color: #333;
            padding: 15px 20px;
            box-sizing: border-box;
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .navbar-title {
            color: white;
            font-size: 1.2em;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 10px;
            text-decoration: none;
        }

        .navbar-title i {
            font-size: 1.4em;
        }

        .user-area {
            display: flex;
            align-items: center;
            gap: 15px;
            color: white;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid white;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .user-avatar:hover {
            transform: scale(1.1);
            box-shadow: 0 0 10px rgba(255,255,255,0.3);
        }

        .username {
            white-space: nowrap;
            font-weight: 500;
        }

        .logout-btn {
            background: #555;
            border: none;
            color: white;
            padding: 5px 10px;
            border-radius: 3px;
            cursor: pointer;
            transition: background 0.2s, transform 0.2s;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .logout-btn:hover {
            background: #777;
            transform: translateY(-2px);
        }

        .login-link {
            color: white;
            text-decoration: none;
            transition: color 0.2s;
        }

        .login-link:hover {
            text-decoration: underline;
            color: #3498db;
        }

        .title-badge {
            background: linear-gradient(135deg, #3498db, #9b59b6);
            color: white;
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 0.8rem;
            margin-left: 10px;
            white-space: nowrap;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }

        header {
            text-align: center;
            margin-bottom: 40px;
            padding: 0 20px;
        }

        h1 {
            color: #2c3e50;
            margin-bottom: 10px;
            font-size: 2.2rem;
            position: relative;
            display: inline-block;
        }

        h1::after {
            content: '';
            position: absolute;
            bottom: -8px;
            left: 10%;
            width: 80%;
            height: 3px;
            background-color: #3498db;
            border-radius: 3px;
        }

        .subtitle {
            color: #667580;
            font-size: 1.1rem;
            max-width: 600px;
            margin: 0 auto;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 0 20px;
        }

        .tabs {
            display: flex;
            background-color: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            margin-bottom: 30px;
        }

        .tab {
            flex: 1;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
            color: #7f8c8d;
            border-bottom: 3px solid transparent;
        }

        .tab.active {
            color: #3498db;
            border-bottom: 3px solid #3498db;
        }

        .tab:hover:not(.active) {
            background-color: #f8f9fa;
            color: #2c3e50;
        }

        .tab i {
            margin-right: 8px;
        }

        .search-bar {
            display: flex;
            margin-bottom: 20px;
        }

        .search-input {
            flex: 1;
            padding: 12px 15px;
            border: 1px solid #ddd;
            border-radius: 6px 0 0 6px;
            font-size: 1rem;
            transition: border 0.3s ease;
        }

        .search-input:focus {
            outline: none;
            border-color: #3498db;
        }

        .search-btn {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 0 20px;
            border-radius: 0 6px 6px 0;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }

        .search-btn:hover {
            background-color: #2980b9;
        }

        .add-friend-btn {
            background-color: #2ecc71;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 20px;
        }

        .add-friend-btn:hover {
            background-color: #27ae60;
            transform: translateY(-2px);
        }

        .friend-list {
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
            overflow: hidden;
        }

        .friend-item {
            display: flex;
            align-items: center;
            padding: 15px 20px;
            border-bottom: 1px solid #f1f1f1;
            transition: background-color 0.2s ease;
        }

        .friend-item:last-child {
            border-bottom: none;
        }

        .friend-item:hover {
            background-color: #f8f9fa;
        }

        .friend-avatar {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            object-fit: cover;
            margin-right: 15px;
            border: 2px solid #eee;
        }

        .friend-info {
            flex: 1;
        }

        .friend-name {
            font-weight: 600;
            font-size: 1.1rem;
            margin-bottom: 3px;
            color: #2c3e50;
        }

        .friend-status {
            font-size: 0.9rem;
            color: #7f8c8d;
        }

        .friend-actions {
            display: flex;
            gap: 10px;
        }

        .action-btn {
            background-color: #f1f5f9;
            border: none;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
            color: #64748b;
        }

        .action-btn:hover {
            background-color: #e2e8f0;
            transform: translateY(-2px);
        }

        .message-btn:hover {
            color: #3498db;
        }

        .remove-btn:hover {
            color: #e74c3c;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #94a3b8;
        }

        .empty-state i {
            font-size: 5rem;
            margin-bottom: 20px;
            color: #cbd5e1;
        }

        .empty-state h3 {
            margin-bottom: 10px;
            font-size: 1.5rem;
            color: #64748b;
        }

        .empty-state p {
            max-width: 400px;
            margin: 0 auto 20px;
        }

        footer {
            text-align: center;
            margin-top: 60px;
            color: #95a5a6;
            font-size: 0.9rem;
            padding: 20px 0;
            border-top: 1px solid #e1e8ed;
        }

        /* æ¨¡æ€æ¡†æ ·å¼ */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .modal.active {
            opacity: 1;
        }

        .modal-content {
            background-color: white;
            padding: 30px;
            border-radius: 10px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            position: relative;
            transform: translateY(20px);
            transition: transform 0.3s ease;
        }

        .modal.active .modal-content {
            transform: translateY(0);
        }

        .close-modal {
            position: absolute;
            top: 15px;
            right: 20px;
            font-size: 1.5rem;
            cursor: pointer;
            color: #666;
            transition: color 0.2s, transform 0.2s;
        }

        .close-modal:hover {
            color: #e74c3c;
            transform: rotate(90deg);
        }

        .modal-title {
            text-align: center;
            margin-bottom: 25px;
            color: #2c3e50;
            font-size: 1.5rem;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #3498db;
        }

        .form-input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 1rem;
        }

        .form-input:focus {
            outline: none;
            border-color: #3498db;
        }

        .modal-btn {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1rem;
            width: 100%;
            transition: background-color 0.2s, transform 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
        }

        .modal-btn:hover {
            background-color: #2980b9;
            transform: translateY(-2px);
        }

        .cancel-btn {
            background-color: #95a5a6;
            margin-top: 10px;
        }

        .cancel-btn:hover {
            background-color: #7f8c8d;
        }

        /* èŠå¤©çª—å£æ ·å¼ */
        .chat-modal {
            max-width: 800px;
            width: 95%;
            max-height: 80vh;
            display: flex;
            flex-direction: column;
        }

        .chat-header {
            padding-bottom: 15px;
            margin-bottom: 15px;
            border-bottom: 1px solid #eee;
            display: flex;
            align-items: center;
        }

        .chat-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            margin-right: 15px;
        }

        .chat-name {
            font-weight: 600;
            font-size: 1.2rem;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
            margin-bottom: 20px;
            background-color: #f9fafb;
            border-radius: 8px;
            min-height: 300px;
        }

        .message {
            margin-bottom: 15px;
            max-width: 70%;
        }

        .message.received {
            margin-right: auto;
        }

        .message.sent {
            margin-left: auto;
        }

        .message-content {
            padding: 10px 15px;
            border-radius: 18px;
            position: relative;
        }

        .received .message-content {
            background-color: #e2e8f0;
            border-top-left-radius: 4px;
        }

        .sent .message-content {
            background-color: #3498db;
            color: white;
            border-top-right-radius: 4px;
        }

        .message-time {
            font-size: 0.75rem;
            color: #94a3b8;
            margin-top: 5px;
            text-align: right;
        }

        .chat-input-area {
            display: flex;
            gap: 10px;
        }

        .chat-input {
            flex: 1;
            padding: 12px 15px;
            border: 1px solid #ddd;
            border-radius: 25px;
            font-size: 1rem;
        }

        .send-btn {
            background-color: #3498db;
            color: white;
            border: none;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .send-btn:hover {
            background-color: #2980b9;
        }

        /* é€šçŸ¥ç»„ä»¶ */
        .notification {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 15px 20px;
            background-color: #3498db;
            color: white;
            border-radius: 5px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.2);
            transform: translateX(120%);
            transition: transform 0.3s ease;
            z-index: 1000;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .notification.show {
            transform: translateX(0);
        }

        .notification.success {
            background-color: #2ecc71;
        }

        .notification.error {
            background-color: #e74c3c;
        }

        /* ä¸ªäººä¿¡æ¯æ¨¡æ€æ¡†æ ·å¼ */
        .profile-modal .modal-content {
            max-width: 500px;
        }

        .profile-title {
            text-align: center;
            margin-bottom: 25px;
            color: #2c3e50;
            font-size: 1.5rem;
        }

        .profile-section {
            margin-bottom: 20px;
        }

        .profile-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #3498db;
        }

        .profile-value {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 1rem;
            background-color: #f9f9f9;
        }

        .error-message {
            color: #dc3545;
            text-align: center;
            padding: 10px;
            margin: 10px 0;
            background-color: #f8d7da;
            border-radius: 5px;
            display: none;
        }

        @media (max-width: 768px) {
            h1 {
                font-size: 1.8rem;
            }

            .navbar-title {
                font-size: 1rem;
            }

            .username {
                display: none;
            }

            .user-area {
                gap: 10px;
            }
            
            .title-badge {
                display: none;
            }

            .friend-actions {
                gap: 5px;
            }

            .action-btn {
                width: 32px;
                height: 32px;
            }

            .message {
                max-width: 85%;
            }
        }

        @media (max-width: 480px) {
            .tabs {
                flex-direction: column;
            }

            .friend-item {
                flex-direction: column;
                align-items: flex-start;
            }

            .friend-avatar {
                margin-bottom: 10px;
            }

            .friend-actions {
                margin-top: 10px;
                align-self: flex-end;
            }

            .chat-modal {
                max-height: 90vh;
            }

            .chat-messages {
                min-height: 200px;
            }
        }
    </style>
</head>
<body>
    <!-- å¯¼èˆªæ ï¼ˆå¤ç”¨ä¸»é¡µé¢æ ·å¼ï¼‰ -->
    <div class="navbar">
        <a href="indexdaohang.html" class="navbar-title">
            <i class="fas fa-compass"></i>
            è¿”å›å¤šåŠŸèƒ½å¯¼èˆªä¸­å¿ƒ 
        </a>
        <div class="user-area" id="userArea">
            <a href="indexlo.html" class="login-link">ç™»å½•/æ³¨å†Œ</a>
        </div>
    </div>

    <header>
        <h1>å¥½å‹åˆ—è¡¨</h1>
        <p class="subtitle">ç®¡ç†æ‚¨çš„å¥½å‹ï¼Œéšæ—¶ä¿æŒè”ç³»</p>
    </header>

    <div class="error-message" id="errorMsg"></div>

    <div class="container">
        <div class="tabs">
            <div class="tab active" data-tab="friends">
                <i class="fas fa-user-friends"></i> æˆ‘çš„å¥½å‹
            </div>
            <div class="tab" data-tab="requests">
                <i class="fas fa-user-plus"></i> å¥½å‹è¯·æ±‚
                <span class="badge" id="requestCount">0</span>
            </div>
        </div>

        <button class="add-friend-btn" id="addFriendBtn">
            <i class="fas fa-plus"></i> æ·»åŠ å¥½å‹
        </button>

        <div class="search-bar">
            <input type="text" class="search-input" placeholder="æœç´¢å¥½å‹...">
            <button class="search-btn">
                <i class="fas fa-search"></i>
            </button>
        </div>

        <div class="friend-list" id="friendList">
            <!-- å¥½å‹åˆ—è¡¨å†…å®¹å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
            <div class="empty-state">
                <i class="fas fa-search"></i>
                <h3>æš‚æ— å¥½å‹</h3>
                <p>æ·»åŠ å¥½å‹ï¼Œå¼€å§‹äº’åŠ¨å§ï¼</p>
                <button class="add-friend-btn">
                    <i class="fas fa-plus"></i> æ·»åŠ ç¬¬ä¸€ä¸ªå¥½å‹
                </button>
            </div>
        </div>
    </div>

    <!-- æ·»åŠ å¥½å‹æ¨¡æ€æ¡† -->
    <div class="modal" id="addFriendModal">
        <div class="modal-content">
            <span class="close-modal" onclick="closeAddFriendModal()">&times;</span>
            <h2 class="modal-title">æ·»åŠ å¥½å‹</h2>
            <div class="form-group">
                <label class="form-label">ç”¨æˆ·å</label>
                <input type="text" class="form-input" id="friendUsername" placeholder="è¯·è¾“å…¥å¥½å‹çš„ç”¨æˆ·å">
            </div>
            <div class="form-group">
                <label class="form-label">éªŒè¯æ¶ˆæ¯</label>
                <input type="text" class="form-input" id="friendMessage" placeholder="è¯·è¾“å…¥éªŒè¯æ¶ˆæ¯ï¼ˆé€‰å¡«ï¼‰" value="ä½ å¥½ï¼Œæˆ‘æƒ³æ·»åŠ ä½ ä¸ºå¥½å‹">
            </div>
            <button class="modal-btn" onclick="sendFriendRequest()">
                <i class="fas fa-paper-plane"></i> å‘é€è¯·æ±‚
            </button>
            <button class="modal-btn cancel-btn" onclick="closeAddFriendModal()">
                <i class="fas fa-times"></i> å–æ¶ˆ
            </button>
        </div>
    </div>

    <!-- èŠå¤©æ¨¡æ€æ¡† -->
    <div class="modal" id="chatModal">
        <div class="modal-content chat-modal">
            <span class="close-modal" onclick="closeChatModal()">&times;</span>
            <div class="chat-header">
                <img src="" alt="å¥½å‹å¤´åƒ" class="chat-avatar" id="chatAvatar">
                <div>
                    <div class="chat-name" id="chatName"></div>
                    <div class="friend-status" id="chatStatus">åœ¨çº¿</div>
                </div>
            </div>
            <div class="chat-messages" id="chatMessages">
                <!-- èŠå¤©æ¶ˆæ¯å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
            </div>
            <div class="chat-input-area">
                <input type="text" class="chat-input" id="chatInput" placeholder="è¾“å…¥æ¶ˆæ¯...">
                <button class="send-btn" onclick="sendMessage()">
                    <i class="fas fa-paper-plane"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- ä¸ªäººä¿¡æ¯æ¨¡æ€æ¡† -->
    <div class="modal profile-modal" id="profileModal">
        <div class="modal-content">
            <span class="close-modal" onclick="closeProfileModal()">&times;</span>
            <h2 class="profile-title">ä¸ªäººä¿¡æ¯</h2>
            
            <div class="profile-section">
                <label class="profile-label">ç”¨æˆ·å</label>
                <div id="usernameDisplay" class="profile-value"></div>
            </div>
            
            <div class="profile-section">
                <label class="profile-label">ç™»å½•æ—¶é—´</label>
                <div id="loginTimeDisplay" class="profile-value"></div>
            </div>
            
            <div class="profile-section">
                <label class="profile-label">è´¦å·çŠ¶æ€</label>
                <div id="accountStatus" class="profile-value">æ­£å¸¸</div>
            </div>
        </div>
    </div>

    <!-- é€šçŸ¥ç»„ä»¶ -->
    <div class="notification" id="notification">
        <i class="fas fa-info-circle"></i>
        <span id="notificationText"></span>
    </div>

    <footer>
        <p>å¤šåŠŸèƒ½å¯¼èˆªä¸­å¿ƒ &copy; 2025 | æŒç»­æ›´æ–°ä¸­</p>
    </footer>

    <script>
        // å½“å‰èŠå¤©å¯¹è±¡
        let currentChatFriend = null;
        // WebSocketè¿æ¥
        let socket = null;
        // å½“å‰ç”¨æˆ·ä¿¡æ¯
        let currentUser = null;
        // é‡è¿å°è¯•æ¬¡æ•°
        let reconnectAttempts = 0;

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        window.onload = function() {
            // å¤ç”¨ä¸»é¡µé¢çš„ç”¨æˆ·éªŒè¯é€»è¾‘
            checkLoginStatus();
            
            // åˆå§‹åŒ–äº‹ä»¶ç›‘å¬
            initEventListeners();
            
            // å¦‚æœç”¨æˆ·å·²ç™»å½•ï¼ŒåŠ è½½å¥½å‹åˆ—è¡¨
            if (currentUser) {
                loadFriends();
                initWebSocket();
            }
        };

        // å¤ç”¨ä¸»é¡µé¢çš„ç”¨æˆ·éªŒè¯é€»è¾‘
        function checkLoginStatus() {
            const userInfoStr = localStorage.getItem('mainUserInfo');
            console.log("è¯»å–åˆ°çš„ç”¨æˆ·ä¿¡æ¯ï¼š", userInfoStr);
            
            if (!userInfoStr) {
                handleUnauthorizedAccess();
                return false;
            }
            
            try {
                let userInfo;
                try {
                    userInfo = JSON.parse(userInfoStr);
                } catch (parseError) {
                    console.error("ç”¨æˆ·ä¿¡æ¯è§£æå¤±è´¥ï¼š", parseError);
                    throw new Error("ç”¨æˆ·ä¿¡æ¯æ ¼å¼é”™è¯¯ï¼Œè¯·é‡æ–°ç™»å½•");
                }
        
                // éªŒè¯å¿…è¦å­—æ®µ
                const requiredFields = ['username', 'loginTime'];
                const missingFields = requiredFields.filter(field => !userInfo[field]);
        
                if (missingFields.length > 0) {
                    if (missingFields.includes('username')) {
                        throw new Error("ç”¨æˆ·èº«ä»½ä¿¡æ¯ä¸å®Œæ•´ï¼Œç¼ºå°‘ç”¨æˆ·åï¼Œè¯·é‡æ–°ç™»å½•");
                    } else {
                        throw new Error(`ç”¨æˆ·ä¿¡æ¯ä¸å®Œæ•´ï¼Œç¼ºå°‘: ${missingFields.join(', ')}ï¼Œè¯·é‡æ–°ç™»å½•`);
                    }
                }
        
                // éªŒè¯ç™»å½•æ—¶é—´æ˜¯å¦æœ‰æ•ˆï¼ˆ1å¤©å†…ï¼‰
                const loginTime = new Date(userInfo.loginTime);
                if (isNaN(loginTime.getTime())) {
                    throw new Error("ç™»å½•æ—¶é—´æ ¼å¼æ— æ•ˆï¼Œè¯·é‡æ–°ç™»å½•");
                }
        
                const oneDayAgo = new Date();
                oneDayAgo.setDate(oneDayAgo.getDate() - 1);
                if (loginTime < oneDayAgo) {
                    throw new Error("ç™»å½•å·²è¶…è¿‡1å¤©ï¼Œè¯·é‡æ–°ç™»å½•");
                }
        
                // ä¿å­˜å½“å‰ç”¨æˆ·ä¿¡æ¯
                currentUser = userInfo;
                
                // æ›´æ–°ç”¨æˆ·æ˜¾ç¤º
                updateUserDisplay(userInfo);
                
                // éªŒè¯ç”¨æˆ·æœ‰æ•ˆæ€§
                checkUserValidity(userInfo);
                
                return true;
            } catch (err) {
                console.error("ç”¨æˆ·ä¿¡æ¯éªŒè¯å¤±è´¥ï¼š", err);
                localStorage.removeItem('mainUserInfo');
                handleUnauthorizedAccess(err.message);
                return false;
            }
        }

        // å¤ç”¨ä¸»é¡µé¢çš„ç”¨æˆ·æœ‰æ•ˆæ€§æ£€æŸ¥
        async function checkUserValidity(userInfo) {
            const isLocalDev = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';
            
            if (isLocalDev) {
                console.log('æœ¬åœ°å¼€å‘æ¨¡å¼ï¼Œè·³è¿‡ç”¨æˆ·éªŒè¯');
                return;
            }
            
            try {
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 10000);
        
                const response = await fetch('/.netlify/functions/verifyUser', {
                    method: 'POST',
                    headers: {
                        'X-Username': userInfo.username,
                        'Content-Type': 'application/json'
                    },
                    signal: controller.signal
                });
        
                clearTimeout(timeoutId);
        
                if (!response.ok) {
                    if (response.status === 401) {
                        throw new Error('ç”¨æˆ·èº«ä»½å·²å¤±æ•ˆï¼Œè¯·é‡æ–°ç™»å½•');
                    }
                    throw new Error(`éªŒè¯å¤±è´¥: ${response.statusText}`);
                }
        
                const result = await response.json();
                if (result.valid) {
                    // æ›´æ–°ç™»å½•æ—¶é—´
                    userInfo.loginTime = new Date().toISOString();
                    localStorage.setItem('mainUserInfo', JSON.stringify(userInfo));
                    currentUser = userInfo;
                }
            } catch (error) {
                console.error('ç”¨æˆ·éªŒè¯å¤±è´¥:', error);
                if (error.name !== 'AbortError') {
                    showNotification(error.message, 'error');
                    setTimeout(() => {
                        if (confirm('ç™»å½•çŠ¶æ€å·²å¤±æ•ˆï¼Œæ˜¯å¦é‡æ–°ç™»å½•ï¼Ÿ')) {
                            localStorage.removeItem('mainUserInfo');
                            window.location.href = 'indexlo.html?sessionExpired=true';
                        }
                    }, 3000);
                }
            }
        }

        // å¤ç”¨ä¸»é¡µé¢çš„ç”¨æˆ·ä¿¡æ¯æ˜¾ç¤º
        function updateUserDisplay(userInfo) {
            const userAreaEl = document.getElementById('userArea');
            const avatarUrl = userInfo.avatar || 'https://picsum.photos/200';
            
            const loginTime = new Date(userInfo.loginTime);
            const formattedTime = loginTime.toLocaleString();
            
            let titleBadge = '';
            if (userInfo.currentTitle) {
                titleBadge = `<span class="title-badge">
                    <i class="fas fa-${userInfo.currentTitle.icon || 'medal'}"></i>
                    ${userInfo.currentTitle.name}
                </span>`;
            }
            
            // æ›´æ–°å¯¼èˆªæ ç”¨æˆ·ä¿¡æ¯
            userAreaEl.innerHTML = `
                <span class="username">${decodeURIComponent(userInfo.username)}</span>
                ${titleBadge}
                <img src="${avatarUrl}" alt="ç”¨æˆ·å¤´åƒ" class="user-avatar" onclick="openProfileModal()">
                <button class="logout-btn" onclick="logout()">
                    <i class="fas fa-sign-out-alt"></i> é€€å‡º
                </button>
            `;
            
            // æ›´æ–°ä¸ªäººä¿¡æ¯æ¨¡æ€æ¡†
            document.getElementById('usernameDisplay').textContent = decodeURIComponent(userInfo.username);
            document.getElementById('loginTimeDisplay').textContent = formattedTime;
        }

        // åˆå§‹åŒ–äº‹ä»¶ç›‘å¬
        function initEventListeners() {
            // æ ‡ç­¾åˆ‡æ¢
            const tabs = document.querySelectorAll('.tab');
            tabs.forEach(tab => {
                tab.addEventListener('click', function() {
                    tabs.forEach(t => t.classList.remove('active'));
                    this.classList.add('active');
                    
                    const tabType = this.getAttribute('data-tab');
                    if (tabType === 'friends') {
                        loadFriends();
                    } else {
                        loadFriendRequests();
                    }
                });
            });
            
            // æ·»åŠ å¥½å‹æŒ‰é’®
            document.getElementById('addFriendBtn').addEventListener('click', openAddFriendModal);
            
            // èŠå¤©è¾“å…¥æ¡†å›è½¦å‘é€
            document.getElementById('chatInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    sendMessage();
                }
            });
        }

        // åˆå§‹åŒ–WebSocketè¿æ¥ï¼ˆå·²ä¿®å¤ï¼‰
        function initWebSocket() {
            if (!currentUser) return; // ç¡®ä¿ç”¨æˆ·å·²ç™»å½•

            // å…³é—­æ—§è¿æ¥ï¼ˆé¿å…é‡å¤è¿æ¥ï¼‰
            if (socket) {
                socket.close(1000, "é‡æ–°è¿æ¥"); // 1000 æ˜¯æ­£å¸¸å…³é—­ä»£ç 
            }

            try {
                // 1. æ„å»º WebSocket è¿æ¥åœ°å€ï¼ˆè·¯å¾„å¿…é¡»æ˜¯ /chatï¼Œå’ŒæœåŠ¡å™¨é…ç½®ä¸€è‡´ï¼‰
                const protocol = window.location.protocol === "https:" ? "wss:" : "ws:";
                const websocketUrl = `${protocol}//${window.location.host}/chat?username=${encodeURIComponent(currentUser.username)}`;

                console.log("æ­£åœ¨è¿æ¥ WebSocketï¼š", websocketUrl);
                socket = new WebSocket(websocketUrl);

                // 2. è¿æ¥æˆåŠŸï¼šæ˜¾ç¤ºé€šçŸ¥ï¼ˆèƒ½èµ°åˆ°è¿™æ­¥å°±ä»£è¡¨é€šäº†ï¼‰
                socket.onopen = function () {
                    console.log("âœ… WebSocket è¿æ¥æˆåŠŸï¼");
                    showNotification("å®æ—¶èŠå¤©å·²è¿æ¥", "success");
                    // æµ‹è¯•å‘é€ä¸€æ¡æ¶ˆæ¯ç»™æœåŠ¡å™¨
                    socket.send(`ä½ å¥½ï¼Œæˆ‘æ˜¯ ${currentUser.username}`);
                };

                // 3. æ”¶åˆ°æœåŠ¡å™¨æ¶ˆæ¯ï¼šæ‰“å°åˆ°æ§åˆ¶å° + æ˜¾ç¤ºé€šçŸ¥
                socket.onmessage = function (event) {
                    const data = JSON.parse(event.data);
                    console.log("ğŸ“¥ æ”¶åˆ°æœåŠ¡å™¨æ¶ˆæ¯ï¼š", data);
      
                    // æ ¹æ®æ¶ˆæ¯ç±»å‹æ˜¾ç¤ºä¸åŒé€šçŸ¥
                    if (data.type === "conn_success") {
                        showNotification(data.msg, "success");
                    } else if (data.type === "msg_echo") {
                        showNotification(`æœåŠ¡å™¨æ”¶åˆ°ï¼š${data.your_msg}`, "info");
                    }
                };

                // 4. è¿æ¥é”™è¯¯ï¼šæ˜¾ç¤ºå…·ä½“é”™è¯¯
                socket.onerror = function (error) {
                    console.error("âŒ WebSocket é”™è¯¯ï¼š", error);
                    showNotification("èŠå¤©è¿æ¥å‡ºé”™ï¼Œæ­£åœ¨é‡è¯•...", "error");
                };

                // 5. è¿æ¥å…³é—­ï¼šåªåœ¨å¼‚å¸¸å…³é—­æ—¶é‡è¯•
                socket.onclose = function (event) {
                    console.log(`ğŸ”Œ è¿æ¥å…³é—­ï¼Œä»£ç ï¼š${event.code}ï¼ŒåŸå› ï¼š${event.reason}`);
                    // 1006 æ˜¯å¼‚å¸¸å…³é—­ï¼Œ2ç§’åé‡è¯•ï¼›1000 æ˜¯æ­£å¸¸å…³é—­ï¼Œä¸é‡è¯•
                    if (event.code === 1006) {
                        setTimeout(initWebSocket, 2000);
                    }
                };
            } catch (e) {
                console.error("åˆå§‹åŒ–è¿æ¥å¤±è´¥ï¼š", e);
                setTimeout(initWebSocket, 2000);
            }
        }

        // å¤„ç†WebSocketæ¶ˆæ¯
        function handleWebSocketMessage(data) {
            console.log('æ”¶åˆ°æ¶ˆæ¯:', data);
            
            switch (data.type) {
                case 'message':
                    // æ”¶åˆ°æ–°æ¶ˆæ¯
                    addMessageToChat(data.sender, data.content, new Date(data.timestamp), data.sender !== currentUser.username);
                    
                    // å¦‚æœèŠå¤©çª—å£æœªæ‰“å¼€ï¼Œæ˜¾ç¤ºé€šçŸ¥
                    if (!document.getElementById('chatModal').classList.contains('active') || currentChatFriend !== data.sender) {
                        showNotification(`æ”¶åˆ°æ¥è‡ª ${data.sender} çš„æ¶ˆæ¯: ${data.content}`, 'info');
                    }
                    break;
                    
                case 'friendRequest':
                    // æ”¶åˆ°å¥½å‹è¯·æ±‚
                    showNotification(`æ”¶åˆ°æ¥è‡ª ${data.sender} çš„å¥½å‹è¯·æ±‚`, 'info');
                    loadFriendRequests(); // åˆ·æ–°è¯·æ±‚åˆ—è¡¨
                    break;
                    
                case 'requestAccepted':
                    // å¥½å‹è¯·æ±‚è¢«æ¥å—
                    showNotification(`${data.sender} æ¥å—äº†ä½ çš„å¥½å‹è¯·æ±‚`, 'success');
                    loadFriends(); // åˆ·æ–°å¥½å‹åˆ—è¡¨
                    break;
                    
                case 'status':
                    // çŠ¶æ€æ›´æ–°
                    updateFriendStatus(data.username, data.status);
                    break;
                    
                case 'error':
                    // é”™è¯¯æ¶ˆæ¯
                    showNotification(`æœåŠ¡å™¨é”™è¯¯: ${data.message}`, 'error');
                    break;
            }
        }

        // åŠ è½½å¥½å‹åˆ—è¡¨
        function loadFriends() {
            if (!currentUser) return;
            
            // ä»æœ¬åœ°å­˜å‚¨è·å–å¥½å‹åˆ—è¡¨ï¼ˆå®é™…åº”ç”¨ä¸­åº”ä»æœåŠ¡å™¨è·å–ï¼‰
            const uniqueKey = `friends_${currentUser.username}`;
            const friends = JSON.parse(localStorage.getItem(uniqueKey) || '[]');
            
            const friendListEl = document.getElementById('friendList');
            
            if (friends.length === 0) {
                friendListEl.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-search"></i>
                        <h3>æš‚æ— å¥½å‹</h3>
                        <p>æ·»åŠ å¥½å‹ï¼Œå¼€å§‹äº’åŠ¨å§ï¼</p>
                        <button class="add-friend-btn" onclick="openAddFriendModal()">
                            <i class="fas fa-plus"></i> æ·»åŠ ç¬¬ä¸€ä¸ªå¥½å‹
                        </button>
                    </div>
                `;
                return;
            }
            
            // ç”Ÿæˆå¥½å‹åˆ—è¡¨HTML
            let friendsHTML = '';
            friends.forEach(friend => {
                friendsHTML += `
                    <div class="friend-item">
                        <img src="${friend.avatar || 'https://picsum.photos/200?random=' + friend.username}" alt="${friend.username}" class="friend-avatar">
                        <div class="friend-info">
                            <div class="friend-name">${friend.username}</div>
                            <div class="friend-status ${friend.status === 'online' ? 'text-success' : ''}">
                                ${friend.status === 'online' ? '<i class="fas fa-circle"></i> åœ¨çº¿' : '<i class="fas fa-circle"></i> ç¦»çº¿'}
                            </div>
                        </div>
                        <div class="friend-actions">
                            <button class="action-btn message-btn" onclick="openChatModal('${friend.username}', '${friend.avatar || ''}')">
                                <i class="fas fa-comment"></i>
                            </button>
                            <button class="action-btn remove-btn" onclick="removeFriend('${friend.username}')">
                                <i class="fas fa-user-minus"></i>
                            </button>
                        </div>
                    </div>
                `;
            });
            
            friendListEl.innerHTML = friendsHTML;
        }

        // åŠ è½½å¥½å‹è¯·æ±‚
        function loadFriendRequests() {
            if (!currentUser) return;
            
            // ä»æœ¬åœ°å­˜å‚¨è·å–å¥½å‹è¯·æ±‚ï¼ˆå®é™…åº”ç”¨ä¸­åº”ä»æœåŠ¡å™¨è·å–ï¼‰
            const uniqueKey = `friendRequests_${currentUser.username}`;
            const requests = JSON.parse(localStorage.getItem(uniqueKey) || '[]');
            
            const friendListEl = document.getElementById('friendList');
            const requestCountEl = document.getElementById('requestCount');
            
            // æ›´æ–°è¯·æ±‚æ•°é‡
            requestCountEl.textContent = requests.length;
            
            if (requests.length === 0) {
                friendListEl.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-envelope-open"></i>
                        <h3>æš‚æ— å¥½å‹è¯·æ±‚</h3>
                        <p>å½“æœ‰æ–°çš„å¥½å‹è¯·æ±‚æ—¶ï¼Œä¼šæ˜¾ç¤ºåœ¨è¿™é‡Œ</p>
                    </div>
                `;
                return;
            }
            
            // ç”Ÿæˆè¯·æ±‚åˆ—è¡¨HTML
            let requestsHTML = '';
            requests.forEach(request => {
                requestsHTML += `
                    <div class="friend-item">
                        <img src="${request.avatar || 'https://picsum.photos/200?random=' + request.username}" alt="${request.username}" class="friend-avatar">
                        <div class="friend-info">
                            <div class="friend-name">${request.username}</div>
                            <div class="friend-status">${request.message || 'æƒ³æ·»åŠ ä½ ä¸ºå¥½å‹'}</div>
                        </div>
                        <div class="friend-actions">
                            <button class="action-btn message-btn" onclick="acceptFriendRequest('${request.username}', '${request.avatar || ''}')">
                                <i class="fas fa-check"></i>
                            </button>
                            <button class="action-btn remove-btn" onclick="declineFriendRequest('${request.username}')">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>
                `;
            });
            
            friendListEl.innerHTML = requestsHTML;
        }

        // å‘é€å¥½å‹è¯·æ±‚
        function sendFriendRequest() {
            if (!currentUser) return;
            
            const friendUsername = document.getElementById('friendUsername').value.trim();
            const message = document.getElementById('friendMessage').value.trim() || 'ä½ å¥½ï¼Œæˆ‘æƒ³æ·»åŠ ä½ ä¸ºå¥½å‹';
            
            if (!friendUsername) {
                showNotification('è¯·è¾“å…¥å¥½å‹ç”¨æˆ·å', 'error');
                return;
            }
            
            if (friendUsername === currentUser.username) {
                showNotification('ä¸èƒ½æ·»åŠ è‡ªå·±ä¸ºå¥½å‹', 'error');
                return;
            }
            
            // æ£€æŸ¥æ˜¯å¦å·²ç»æ˜¯å¥½å‹
            const friendsKey = `friends_${currentUser.username}`;
            const friends = JSON.parse(localStorage.getItem(friendsKey) || '[]');
            const isAlreadyFriend = friends.some(f => f.username === friendUsername);
            
            if (isAlreadyFriend) {
                showNotification('è¯¥ç”¨æˆ·å·²ç»æ˜¯ä½ çš„å¥½å‹', 'error');
                closeAddFriendModal();
                return;
            }
            
            // å®é™…åº”ç”¨ä¸­åº”è¯¥å‘é€åˆ°æœåŠ¡å™¨
            // è¿™é‡Œç®€åŒ–å¤„ç†ï¼Œç›´æ¥ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
            const recipientRequestsKey = `friendRequests_${friendUsername}`;
            const recipientRequests = JSON.parse(localStorage.getItem(recipientRequestsKey) || '[]');
            
            // æ£€æŸ¥æ˜¯å¦å·²ç»å‘é€è¿‡è¯·æ±‚
            const requestExists = recipientRequests.some(r => r.username === currentUser.username);
            if (requestExists) {
                showNotification('å·²ç»å‘è¯¥ç”¨æˆ·å‘é€è¿‡å¥½å‹è¯·æ±‚', 'error');
                return;
            }
            
            // æ·»åŠ è¯·æ±‚
            recipientRequests.push({
                username: currentUser.username,
                avatar: currentUser.avatar,
                message: message,
                timestamp: new Date().toISOString()
            });
            
            localStorage.setItem(recipientRequestsKey, JSON.stringify(recipientRequests));
            
            // å‘é€WebSocketé€šçŸ¥ï¼ˆå¦‚æœè¿æ¥å·²å»ºç«‹ï¼‰
            if (socket && socket.readyState === WebSocket.OPEN) {
                socket.send(JSON.stringify({
                    type: 'friendRequest',
                    recipient: friendUsername,
                    sender: currentUser.username,
                    message: message,
                    timestamp: new Date().toISOString()
                }));
            }
            
            showNotification('å¥½å‹è¯·æ±‚å·²å‘é€', 'success');
            closeAddFriendModal();
            
            // æ¸…ç©ºè¾“å…¥æ¡†
            document.getElementById('friendUsername').value = '';
            document.getElementById('friendMessage').value = 'ä½ å¥½ï¼Œæˆ‘æƒ³æ·»åŠ ä½ ä¸ºå¥½å‹';
        }

        // æ¥å—å¥½å‹è¯·æ±‚
        function acceptFriendRequest(username, avatar) {
            if (!currentUser) return;
            
            // ä»è¯·æ±‚åˆ—è¡¨ä¸­ç§»é™¤
            const requestsKey = `friendRequests_${currentUser.username}`;
            let requests = JSON.parse(localStorage.getItem(requestsKey) || '[]');
            requests = requests.filter(r => r.username !== username);
            localStorage.setItem(requestsKey, JSON.stringify(requests));
            
            // æ·»åŠ åˆ°å¥½å‹åˆ—è¡¨
            const myFriendsKey = `friends_${currentUser.username}`;
            const myFriends = JSON.parse(localStorage.getItem(myFriendsKey) || '[]');
            
            // æ£€æŸ¥æ˜¯å¦å·²ç»åœ¨å¥½å‹åˆ—è¡¨ä¸­
            if (!myFriends.some(f => f.username === username)) {
                myFriends.push({
                    username: username,
                    avatar: avatar,
                    status: 'offline',
                    addedTime: new Date().toISOString()
                });
                localStorage.setItem(myFriendsKey, JSON.stringify(myFriends));
            }
            
            // æ·»åŠ åˆ°å¯¹æ–¹çš„å¥½å‹åˆ—è¡¨
            const theirFriendsKey = `friends_${username}`;
            const theirFriends = JSON.parse(localStorage.getItem(theirFriendsKey) || '[]');
            
            // æ£€æŸ¥æ˜¯å¦å·²ç»åœ¨å¯¹æ–¹å¥½å‹åˆ—è¡¨ä¸­
            if (!theirFriends.some(f => f.username === currentUser.username)) {
                theirFriends.push({
                    username: currentUser.username,
                    avatar: currentUser.avatar,
                    status: 'online',
                    addedTime: new Date().toISOString()
                });
                localStorage.setItem(theirFriendsKey, JSON.stringify(theirFriends));
            }
            
            // å‘é€WebSocketé€šçŸ¥
            if (socket && socket.readyState === WebSocket.OPEN) {
                socket.send(JSON.stringify({
                    type: 'requestAccepted',
                    recipient: username,
                    sender: currentUser.username,
                    timestamp: new Date().toISOString()
                }));
            }
            
            showNotification(`å·²æ·»åŠ  ${username} ä¸ºå¥½å‹`, 'success');
            loadFriendRequests();
            loadFriends();
        }

        // æ‹’ç»å¥½å‹è¯·æ±‚
        function declineFriendRequest(username) {
            if (!currentUser) return;
            
            // ä»è¯·æ±‚åˆ—è¡¨ä¸­ç§»é™¤
            const requestsKey = `friendRequests_${currentUser.username}`;
            let requests = JSON.parse(localStorage.getItem(requestsKey) || '[]');
            requests = requests.filter(r => r.username !== username);
            localStorage.setItem(requestsKey, JSON.stringify(requests));
            
            showNotification(`å·²æ‹’ç» ${username} çš„å¥½å‹è¯·æ±‚`, 'info');
            loadFriendRequests();
        }

        // ç§»é™¤å¥½å‹
        function removeFriend(username) {
            if (!currentUser) return;
            
            if (!confirm(`ç¡®å®šè¦ç§»é™¤å¥½å‹ ${username} å—ï¼Ÿ`)) {
                return;
            }
            
            // ä»æˆ‘çš„å¥½å‹åˆ—è¡¨ä¸­ç§»é™¤
            const myFriendsKey = `friends_${currentUser.username}`;
            let myFriends = JSON.parse(localStorage.getItem(myFriendsKey) || '[]');
            myFriends = myFriends.filter(f => f.username !== username);
            localStorage.setItem(myFriendsKey, JSON.stringify(myFriends));
            
            // ä»å¯¹æ–¹çš„å¥½å‹åˆ—è¡¨ä¸­ç§»é™¤
            const theirFriendsKey = `friends_${username}`;
            let theirFriends = JSON.parse(localStorage.getItem(theirFriendsKey) || '[]');
            theirFriends = theirFriends.filter(f => f.username !== currentUser.username);
            localStorage.setItem(theirFriendsKey, JSON.stringify(theirFriends));
            
            // å¦‚æœæ­£åœ¨å’Œè¯¥å¥½å‹èŠå¤©ï¼Œå…³é—­èŠå¤©çª—å£
            if (currentChatFriend === username) {
                closeChatModal();
            }
            
            showNotification(`å·²ç§»é™¤å¥½å‹ ${username}`, 'info');
            loadFriends();
        }

        // æ‰“å¼€èŠå¤©çª—å£
        function openChatModal(friendUsername, friendAvatar) {
            if (!currentUser) return;
            
            currentChatFriend = friendUsername;
            
            // æ›´æ–°èŠå¤©çª—å£ä¿¡æ¯
            document.getElementById('chatName').textContent = friendUsername;
            document.getElementById('chatAvatar').src = friendAvatar || `https://picsum.photos/200?random=${friendUsername}`;
            
            // åŠ è½½å†å²æ¶ˆæ¯
            loadChatHistory(friendUsername);
            
            // æ˜¾ç¤ºèŠå¤©çª—å£
            const modal = document.getElementById('chatModal');
            modal.style.display = 'flex';
            setTimeout(() => modal.classList.add('active'), 10);
            
            // è‡ªåŠ¨èšç„¦åˆ°è¾“å…¥æ¡†
            document.getElementById('chatInput').focus();
        }

        // å…³é—­èŠå¤©çª—å£
        function closeChatModal() {
            const modal = document.getElementById('chatModal');
            modal.classList.remove('active');
            setTimeout(() => modal.style.display = 'none', 300);
            currentChatFriend = null;
        }

        // å‘é€æ¶ˆæ¯
        function sendMessage() {
            if (!currentUser || !currentChatFriend || !socket || socket.readyState !== WebSocket.OPEN) {
                return;
            }
            
            const inputEl = document.getElementById('chatInput');
            const message = inputEl.value.trim();
            
            if (!message) {
                return;
            }
            
            const timestamp = new Date();
            
            // æ„å»ºæ¶ˆæ¯å¯¹è±¡
            const messageData = {
                type: 'message',
                sender: currentUser.username,
                recipient: currentChatFriend,
                content: message,
                timestamp: timestamp.toISOString()
            };
            
            // å‘é€æ¶ˆæ¯
            socket.send(JSON.stringify(messageData));
            
            // æ·»åŠ åˆ°èŠå¤©çª—å£
            addMessageToChat(currentUser.username, message, timestamp, false);
            
            // ä¿å­˜åˆ°æœ¬åœ°å†å²è®°å½•
            saveMessageToHistory(currentUser.username, currentChatFriend, message, timestamp);
            
            // æ¸…ç©ºè¾“å…¥æ¡†
            inputEl.value = '';
        }

        // æ·»åŠ æ¶ˆæ¯åˆ°èŠå¤©çª—å£
        function addMessageToChat(sender, content, timestamp, isReceived) {
            // å¦‚æœä¸æ˜¯å½“å‰èŠå¤©å¯¹è±¡çš„æ¶ˆæ¯ï¼Œä¸æ·»åŠ åˆ°çª—å£
            if (currentChatFriend && sender !== currentChatFriend && sender !== currentUser.username) {
                return;
            }
            
            const chatMessagesEl = document.getElementById('chatMessages');
            const timeString = timestamp.toLocaleTimeString();
            
            const messageHTML = `
                <div class="message ${isReceived ? 'received' : 'sent'}">
                    <div class="message-content">${content}</div>
                    <div class="message-time">${timeString}</div>
                </div>
            `;
            
            chatMessagesEl.insertAdjacentHTML('beforeend', messageHTML);
            
            // æ»šåŠ¨åˆ°åº•éƒ¨
            chatMessagesEl.scrollTop = chatMessagesEl.scrollHeight;
        }

        // åŠ è½½èŠå¤©å†å²
        function loadChatHistory(friendUsername) {
            if (!currentUser) return;
            
            const chatMessagesEl = document.getElementById('chatMessages');
            chatMessagesEl.innerHTML = ''; // æ¸…ç©ºç°æœ‰æ¶ˆæ¯
            
            const historyKey = `chatHistory_${currentUser.username}_${friendUsername}`;
            const history = JSON.parse(localStorage.getItem(historyKey) || '[]');
            
            // æ·»åŠ å†å²æ¶ˆæ¯
            history.forEach(msg => {
                addMessageToChat(
                    msg.sender,
                    msg.content,
                    new Date(msg.timestamp),
                    msg.sender !== currentUser.username
                );
            });
        }

        // ä¿å­˜æ¶ˆæ¯åˆ°å†å²è®°å½•
        function saveMessageToHistory(sender, recipient, content, timestamp) {
            if (!currentUser) return;
            
            const historyKey = `chatHistory_${currentUser.username}_${recipient}`;
            const history = JSON.parse(localStorage.getItem(historyKey) || '[]');
            
            // æ·»åŠ æ–°æ¶ˆæ¯
            history.push({
                sender: sender,
                content: content,
                timestamp: timestamp.toISOString()
            });
            
            // é™åˆ¶å†å²è®°å½•æ•°é‡ï¼ˆæœ€å¤š100æ¡ï¼‰
            if (history.length > 100) {
                history.splice(0, history.length - 100);
            }
            
            localStorage.setItem(historyKey, JSON.stringify(history));
        }

        // æ›´æ–°å¥½å‹çŠ¶æ€
        function updateFriendStatus(username, status) {
            // æ›´æ–°å¥½å‹åˆ—è¡¨ä¸­çš„çŠ¶æ€
            const friendItems = document.querySelectorAll('.friend-item');
            friendItems.forEach(item => {
                const friendNameEl = item.querySelector('.friend-name');
                if (friendNameEl && friendNameEl.textContent === username) {
                    const statusEl = item.querySelector('.friend-status');
                    if (statusEl) {
                        statusEl.innerHTML = status === 'online' 
                            ? '<i class="fas fa-circle"></i> åœ¨çº¿' 
                            : '<i class="fas fa-circle"></i> ç¦»çº¿';
                        statusEl.className = `friend-status ${status === 'online' ? 'text-success' : ''}`;
                    }
                }
            });
            
            // æ›´æ–°èŠå¤©çª—å£ä¸­çš„çŠ¶æ€
            if (currentChatFriend === username) {
                const chatStatusEl = document.getElementById('chatStatus');
                if (chatStatusEl) {
                    chatStatusEl.textContent = status === 'online' ? 'åœ¨çº¿' : 'ç¦»çº¿';
                }
            }
            
            // æ›´æ–°æœ¬åœ°å­˜å‚¨ä¸­çš„çŠ¶æ€
            const friendsKey = `friends_${currentUser.username}`;
            let friends = JSON.parse(localStorage.getItem(friendsKey) || '[]');
            friends = friends.map(friend => {
                if (friend.username === username) {
                    friend.status = status;
                }
                return friend;
            });
            localStorage.setItem(friendsKey, JSON.stringify(friends));
        }

        // æ‰“å¼€æ·»åŠ å¥½å‹æ¨¡æ€æ¡†
        function openAddFriendModal() {
            const modal = document.getElementById('addFriendModal');
            modal.style.display = 'flex';
            setTimeout(() => modal.classList.add('active'), 10);
            document.getElementById('friendUsername').focus();
        }

        // å…³é—­æ·»åŠ å¥½å‹æ¨¡æ€æ¡†
        function closeAddFriendModal() {
            const modal = document.getElementById('addFriendModal');
            modal.classList.remove('active');
            setTimeout(() => modal.style.display = 'none', 300);
        }

        // æ‰“å¼€ä¸ªäººä¿¡æ¯æ¨¡æ€æ¡†
        function openProfileModal() {
            const modal = document.getElementById('profileModal');
            modal.style.display = 'flex';
            setTimeout(() => modal.classList.add('active'), 10);
        }

        // å…³é—­ä¸ªäººä¿¡æ¯æ¨¡æ€æ¡†
        function closeProfileModal() {
            const modal = document.getElementById('profileModal');
            modal.classList.remove('active');
            setTimeout(() => modal.style.display = 'none', 300);
        }

        // æ˜¾ç¤ºé€šçŸ¥
        function showNotification(message, type = 'info') {
            const notification = document.getElementById('notification');
            const notificationText = document.getElementById('notificationText');
            
            notificationText.textContent = message;
            notification.className = 'notification';
            notification.classList.add(type);
            
            notification.classList.add('show');
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }

        // é€€å‡ºç™»å½•
        function logout() {
            if (confirm('ç¡®å®šè¦é€€å‡ºç™»å½•å—ï¼Ÿ')) {
                // å…³é—­WebSocketè¿æ¥
                if (socket) {
                    socket.close();
                }
                
                localStorage.removeItem('mainUserInfo');
                window.location.href = 'indexlo.html';
            }
        }

        // å¤„ç†æœªæˆæƒè®¿é—®
        function handleUnauthorizedAccess(errorMessage = "è¯·å…ˆç™»å½•") {
            if (window.location.pathname.includes('indexlo.html')) {
                showNotification(errorMessage, 'error');
                return;
            }
    
            localStorage.setItem('redirectUrl', window.location.href);
    
            showNotification(errorMessage + 'ï¼Œå³å°†è·³è½¬åˆ°ç™»å½•é¡µ', 'error');
            setTimeout(() => {
                window.location.href = 'indexlo.html?needLogin=true';
            }, 2000);
        }

        // é¡µé¢å…³é—­æ—¶æ›´æ–°çŠ¶æ€
        window.onbeforeunload = function() {
            if (currentUser && socket && socket.readyState === WebSocket.OPEN) {
                socket.send(JSON.stringify({
                    type: 'status',
                    status: 'offline',
                    username: currentUser.username,
                    timestamp: new Date().toISOString()
                }));
            }
        };
    </script>
</body>
</html>