<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>好友系统（含实时聊天）</title>
  <!-- 外部资源引入 -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
  <!-- 优先加载Supabase库 -->
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  
  <!-- Tailwind 自定义配置 -->
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: '#4f46e5',
            secondary: '#e0e7ff',
            success: '#10b981',
            danger: '#ef4444',
          },
          fontFamily: {
            sans: ['Inter', 'system-ui', 'sans-serif'],
          },
        },
      }
    }
  </script>
  
  <!-- 自定义工具类 -->
  <style type="text/tailwindcss">
    @layer utilities {
      .content-auto { content-visibility: auto; }
      .card-shadow { box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08); }
      .hover-lift { transition: transform 0.2s ease; }
      .hover-lift:hover { transform: translateY(-2px); }
      .message-in { border-radius: 18px 18px 18px 0; }
      .message-out { border-radius: 18px 18px 0 18px; }
    }
  </style>
</head>
<body class="bg-gray-50 min-h-screen font-sans">
  <div class="container mx-auto px-4 py-8 max-w-5xl">
    <!-- 返回导航页按钮 -->
    <div class="mb-6">
      <a href="indexdaohang.html" 
         class="inline-flex items-center gap-1 bg-gray-200 text-gray-800 px-4 py-2 rounded-lg hover:bg-gray-300 transition-colors">
        <i class="fa fa-arrow-left"></i>
        <span>返回导航页</span>
      </a>
    </div>

    <!-- 页面标题 -->
    <header class="text-center mb-8">
      <h1 class="text-[clamp(1.8rem,4vw,2.5rem)] font-bold text-primary mb-2">
        <i class="fa fa-users text-primary"></i> 好友系统
      </h1>
      <p class="text-gray-600">添加好友，实时聊天</p>
    </header>
    
    <!-- 注册/登录区域 -->
    <div id="authArea" class="text-center mb-8">
      <div id="loginForm" class="mb-4">
        <input type="text" id="usernameInput" placeholder="输入你的昵称" 
               class="px-4 py-2 border border-gray-200 rounded-lg mr-2 w-full max-w-xs">
        <div class="flex justify-center gap-2 mt-3">
          <button onclick="loginUser(document.getElementById('usernameInput').value)" 
                  class="bg-primary text-white px-6 py-2 rounded-lg hover:bg-primary/90 transition-colors">
            <i class="fa fa-sign-in mr-1"></i> 登录
          </button>
          <button onclick="registerUser(document.getElementById('usernameInput').value)" 
                  class="bg-gray-200 text-gray-800 px-6 py-2 rounded-lg hover:bg-gray-300 transition-colors">
            <i class="fa fa-user-plus mr-1"></i> 注册
          </button>
        </div>
      </div>
      <div id="userInfo" class="hidden">
        <p class="text-lg">当前登录：<span id="currentUsername" class="font-semibold text-primary"></span></p>
        <button onclick="logoutUser()" 
                class="text-sm text-gray-500 hover:text-danger mt-1 transition-colors">
          <i class="fa fa-sign-out mr-1"></i> 登出
        </button>
      </div>
    </div>
    
    <!-- 好友功能区域（登录后显示） -->
    <div id="friendSystem" class="grid grid-cols-1 lg:grid-cols-3 gap-6 hidden">
      <!-- 左侧：好友申请 + 好友列表 -->
      <div class="lg:col-span-1 space-y-6">
        <!-- 搜索添加好友 -->
        <div class="bg-white p-4 rounded-xl card-shadow">
          <div class="flex gap-2">
            <input type="text" id="friendUsernameInput" placeholder="输入好友昵称搜索" 
                   class="flex-1 px-4 py-2 border border-gray-200 rounded-lg">
            <button onclick="searchAndAddFriend(document.getElementById('friendUsernameInput').value)" 
                    class="bg-primary text-white px-4 py-2 rounded-lg hover:bg-primary/90 transition-colors">
              <i class="fa fa-plus"></i>
            </button>
          </div>
        </div>

        <!-- 好友申请列表 -->
        <div class="bg-white p-4 rounded-xl card-shadow">
          <h3 class="text-lg font-semibold mb-3 flex items-center">
            <i class="fa fa-bell text-primary mr-2"></i> 好友申请
          </h3>
          <div id="friendRequests" class="space-y-2"></div>
        </div>

        <!-- 我的好友列表 -->
        <div class="bg-white p-4 rounded-xl card-shadow">
          <h3 class="text-lg font-semibold mb-3 flex items-center">
            <i class="fa fa-user-o text-primary mr-2"></i> 我的好友
          </h3>
          <div id="friendList" class="space-y-2"></div>
        </div>
      </div>

      <!-- 右侧：聊天区域（默认隐藏） -->
      <div class="lg:col-span-2">
        <div id="chatArea" class="bg-white p-4 rounded-xl card-shadow h-full hidden">
          <!-- 聊天头部（好友信息 + 关闭按钮） -->
          <h3 class="text-lg font-semibold mb-3 flex items-center">
            <img id="chatFriendAvatar" src="https://picsum.photos/200/200" alt="好友头像" class="w-8 h-8 rounded-full mr-2">
            <span id="chatFriendName"></span>
            <button onclick="closeChat()" class="ml-auto text-gray-500 hover:text-gray-700">
              <i class="fa fa-times"></i>
            </button>
          </h3>
          
          <!-- 聊天消息容器（可滚动） -->
          <div id="messageContainer" class="h-[400px] overflow-y-auto p-3 border border-gray-100 rounded-lg mb-4 space-y-3"></div>
          
          <!-- 发送消息输入框 -->
          <div class="flex gap-2">
            <input type="text" id="messageInput" placeholder="输入消息..." 
                   class="flex-1 px-4 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-primary/50 outline-none">
            <button onclick="sendMessage()" 
                    class="bg-primary text-white px-6 py-2 rounded-lg hover:bg-primary/90 transition-colors">
              发送
            </button>
          </div>
        </div>

        <!-- 未选择好友时的提示 -->
        <div id="chatTip" class="bg-white p-8 rounded-xl card-shadow h-full flex items-center justify-center text-gray-500">
          <i class="fa fa-comments-o text-4xl mr-3"></i>
          <p>选择一位好友开始聊天吧～</p>
        </div>
      </div>
    </div>
  </div>

  <!-- 核心修复：将脚本放在页面底部，确保Supabase先加载完成 -->
  <script>
    // --------------------------
    // 1. 优先初始化 Supabase 客户端
    // --------------------------
    const supabaseUrl = "https://csrsbqixmzfdlpqokazr.supabase.co";
    const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNzcnNicWl4bXpmZGxwcW9rYXpyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk1NjA1NTMsImV4cCI6MjA3NTEzNjU1M30.VC6miCQW-tiNVbYNf8KgkCkZ3wQoy2HDERs1-DTdKEw";
    // 确保在这里完成初始化
    const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

    // --------------------------
    // 2. 全局变量定义
    // --------------------------
    let currentUser = JSON.parse(localStorage.getItem("supabase-friend-user")) || null;
    let selectedFriendId = null;
    let selectedFriendName = null;
    let selectedFriendAvatar = null;
    let chatSubscription = null;

    // --------------------------
    // 3. 页面初始化
    // --------------------------
    window.addEventListener('load', () => {
      initPage();
    });

    function initPage() {
      const loginForm = document.getElementById('loginForm');
      const userInfo = document.getElementById('userInfo');
      const friendSystem = document.getElementById('friendSystem');
      const currentUsername = document.getElementById('currentUsername');

      if (currentUser) {
        loginForm.classList.add('hidden');
        userInfo.classList.remove('hidden');
        friendSystem.classList.remove('hidden');
        currentUsername.textContent = currentUser.username;
        
        loadFriendRequests();
        loadFriendList();
      } else {
        loginForm.classList.remove('hidden');
        userInfo.classList.add('hidden');
        friendSystem.classList.add('hidden');
        document.getElementById('chatArea').classList.add('hidden');
        document.getElementById('chatTip').classList.remove('hidden');
      }
    }

    // --------------------------
    // 4. 用户注册/登录/登出功能
    // --------------------------
    async function registerUser(username) {
      if (!username.trim()) return alert("请输入昵称～");

      // 现在supabase已经初始化完成，可以安全使用
      const randomEmail = `${Date.now()}@temp.com`;
      const randomPassword = Math.random().toString(36).slice(-8);
      const { data: authData, error: authError } = await supabase.auth.signUp({
        email: randomEmail,
        password: randomPassword
      });

      if (authError || !authData.user) {
        return alert("注册失败：" + authError?.message || "无法创建用户");
      }
      const authUserId = authData.user.id;

      const { data: existingUser } = await supabase
        .from("users")
        .select("id")
        .eq("username", username.trim())
        .single();

      if (existingUser) {
        await supabase.auth.admin.deleteUser(authUserId);
        return alert("昵称已被占用，请换一个～");
      }

      const { data: newUser, error } = await supabase
        .from("users")
        .insert([{ 
          id: authUserId,
          username: username.trim() 
        }])
        .select()
        .single();

      if (error) {
        await supabase.auth.admin.deleteUser(authUserId);
        return alert("注册失败：" + error.message);
      }

      currentUser = newUser;
      localStorage.setItem("supabase-friend-user", JSON.stringify(newUser));
      alert(`注册成功！欢迎 ${newUser.username}～`);
      initPage();
    }

    async function loginUser(username) {
      if (!username.trim()) return alert("请输入昵称～");

      const { data: user, error } = await supabase
        .from("users")
        .select("*")
        .eq("username", username.trim())
        .single();

      if (error) return alert("未找到该用户，请先注册～");

      const { data: authData, error: sessionError } = await supabase.auth.refreshSession();
      if (sessionError || !authData.session) {
        alert("登录失败：请先注册新账号（旧账号会话已失效）～");
        return;
      }

      console.log("登录时的认证ID：", authData.session.user.id);
      console.log("用户表ID：", user.id);
      if (authData.session.user.id !== user.id) {
        alert("账号异常：认证ID与用户ID不匹配，请重新注册～");
        return;
      }

      currentUser = user;
      localStorage.setItem("supabase-friend-user", JSON.stringify(user));
      alert(`欢迎回来，${user.username}～`);
      initPage();
    }

    async function logoutUser() {
      await supabase.auth.signOut();
      
      currentUser = null;
      localStorage.removeItem("supabase-friend-user");
      
      if (chatSubscription) chatSubscription.unsubscribe();
      alert("已登出～");
      initPage();
    }

    // --------------------------
    // 5. 好友管理功能
    // --------------------------
    async function searchAndAddFriend(targetUsername) {
      if (!currentUser) return alert("请先登录～");
      if (!targetUsername.trim()) return alert("请输入好友昵称～");
      if (targetUsername.trim() === currentUser.username) return alert("不能加自己为好友哦～");

      console.log("当前用户ID（users表）：", currentUser.id);
      const { data: authData } = await supabase.auth.getSession();
      console.log("当前认证ID（Supabase）：", authData.session?.user?.id);

      const { data: targetUser, error: searchErr } = await supabase
        .from("users")
        .select("id, username, avatar")
        .eq("username", targetUsername.trim())
        .single();

      if (searchErr) return alert("未找到这个用户～");

      const { data: sentReq, error: sentErr } = await supabase
        .from("friend_relations")
        .select("status", { count: "exact", head: false })
        .eq("sender_id", currentUser.id)
        .eq("receiver_id", targetUser.id)
        .single();

      const { data: receivedReq, error: receivedErr } = await supabase
        .from("friend_relations")
        .select("status", { count: "exact", head: false })
        .eq("sender_id", targetUser.id)
        .eq("receiver_id", currentUser.id)
        .single();

      const existingRelation = sentErr ? (receivedErr ? null : receivedReq) : sentReq;

      if (existingRelation) {
        if (existingRelation.status === "pending") return alert("已发送过申请，等待对方同意～");
        if (existingRelation.status === "accepted") return alert("你们已经是好友啦～");
        if (existingRelation.status === "rejected") return alert("对方之前拒绝过你的申请～");
      }

      const { error: applyErr } = await supabase
        .from("friend_relations")
        .insert([{
          sender_id: currentUser.id,
          receiver_id: targetUser.id,
          status: "pending"
        }]);

      if (applyErr) {
        console.error("申请失败详情：", applyErr);
        return alert("发送申请失败：" + applyErr.message);
      }
      alert(`好友申请已发送给 ${targetUser.username}～`);
    }

    async function loadFriendRequests() {
      if (!currentUser) return;

      const { data: requests, error } = await supabase
        .from("friend_relations")
        .select(`
          id,
          sender:users!friend_relations_sender_id_fkey (id, username, avatar)
        `)
        .eq("receiver_id", currentUser.id)
        .eq("status", "pending")
        .order("created_at", { ascending: false });

      if (error) return console.error("加载申请失败：", error);

      const requestsContainer = document.getElementById("friendRequests");
      if (!requests.length) {
        requestsContainer.innerHTML = "<p class='text-gray-500 text-sm'>暂无好友申请～</p>";
        return;
      }

      requestsContainer.innerHTML = requests.map(req => `
        <div class="flex items-center gap-3 p-2 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors">
          <img src="${req.sender.avatar}" alt="头像" class="w-8 h-8 rounded-full">
          <div class="flex-1 text-left">
            <p class="font-medium text-sm">${req.sender.username}</p>
            <p class="text-xs text-gray-500">请求添加你为好友</p>
          </div>
          <div class="gap-1">
            <button onclick="handleFriendRequest('${req.id}', true)" class="bg-success text-white px-2 py-1 rounded text-xs">同意</button>
            <button onclick="handleFriendRequest('${req.id}', false)" class="bg-gray-200 text-gray-800 px-2 py-1 rounded text-xs">拒绝</button>
          </div>
        </div>
      `).join("");
    }

    async function handleFriendRequest(requestId, isAccept) {
      const { error } = await supabase
        .from("friend_relations")
        .update({
          status: isAccept ? "accepted" : "rejected",
          updated_at: new Date().toISOString()
        })
        .eq("id", requestId);

      if (error) return alert("处理失败：" + error.message);
      alert(isAccept ? "已同意好友申请～" : "已拒绝好友申请～");
      loadFriendRequests();
      loadFriendList();
    }

    async function loadFriendList() {
      if (!currentUser) return;

      const { data: relations, error } = await supabase
        .from("friend_relations")
        .select(`
          id,
          sender:users!friend_relations_sender_id_fkey (id, username, avatar),
          receiver:users!friend_relations_receiver_id_fkey (id, username, avatar)
        `)
        .or(`and(sender_id.eq.${currentUser.id},status.eq.accepted),and(receiver_id.eq.${currentUser.id},status.eq.accepted)`)
        .order("updated_at", { ascending: false });

      if (error) return console.error("加载好友列表失败：", error);

      const friendList = relations.map(rel => 
        rel.sender_id === currentUser.id ? rel.receiver : rel.sender
      );

      const friendListContainer = document.getElementById("friendList");
      if (!friendList.length) {
        friendListContainer.innerHTML = "<p class='text-gray-500 text-sm'>还没有好友，先添加一个吧～</p>";
        return;
      }

      friendListContainer.innerHTML = friendList.map(friend => `
        <div class="flex items-center gap-3 p-2 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors cursor-pointer hover-lift" 
             onclick="selectFriend('${friend.id}', '${friend.username}', '${friend.avatar}')">
          <img src="${friend.avatar}" alt="头像" class="w-8 h-8 rounded-full">
          <div class="flex-1 text-left">
            <p class="font-medium text-sm">${friend.username}</p>
          </div>
          <button onclick="removeFriend('${friend.id}', event)" class="text-xs text-danger hover:text-danger/80">删除</button>
        </div>
      `).join("");
    }

    async function removeFriend(friendId, e) {
      e.stopPropagation();
      if (!confirm("确定要删除这个好友吗？")) return;

      const { data: relation } = await supabase
        .from("friend_relations")
        .select("id")
        .or(`and(sender_id.eq.${currentUser.id},receiver_id.eq.${friendId},status.eq.accepted),and(receiver_id.eq.${currentUser.id},sender_id.eq.${friendId},status.eq.accepted)`)
        .single();

      if (!relation) return alert("删除失败：未找到好友关系～");

      const { error } = await supabase
        .from("friend_relations")
        .delete()
        .eq("id", relation.id);

      if (error) return alert("删除失败：" + error.message);
      alert("已删除好友～");
      loadFriendList();
      
      if (friendId === selectedFriendId) {
        closeChat();
      }
    }

    // --------------------------
    // 6. 实时聊天功能
    // --------------------------
    function selectFriend(friendId, friendName, friendAvatar) {
      selectedFriendId = friendId;
      selectedFriendName = friendName;
      selectedFriendAvatar = friendAvatar;
      
      document.getElementById('chatArea').classList.remove('hidden');
      document.getElementById('chatTip').classList.add('hidden');
      
      document.getElementById('chatFriendName').textContent = friendName;
      document.getElementById('chatFriendAvatar').src = friendAvatar;
      
      loadChatHistory();
    }

    function closeChat() {
      document.getElementById('chatArea').classList.add('hidden');
      document.getElementById('chatTip').classList.remove('hidden');
      
      selectedFriendId = null;
      selectedFriendName = null;
      selectedFriendAvatar = null;
      
      if (chatSubscription) {
        chatSubscription.unsubscribe();
        chatSubscription = null;
      }
    }

    async function loadChatHistory() {
      if (!currentUser || !selectedFriendId) return;
      
      const { data: messages, error } = await supabase
        .from('chat_messages')
        .select('*')
        .or(`and(sender_id.eq.${currentUser.id},receiver_id.eq.${selectedFriendId}),and(sender_id.eq.${selectedFriendId},receiver_id.eq.${currentUser.id})`)
        .order('created_at', { ascending: true });
      
      if (error) return console.error('加载聊天记录失败：', error);
      
      const messageContainer = document.getElementById('messageContainer');
      messageContainer.innerHTML = messages.map(msg => `
        <div class="flex ${msg.sender_id === currentUser.id ? 'justify-end' : 'justify-start'}">
          <div class="${msg.sender_id === currentUser.id ? 'bg-primary text-white message-out' : 'bg-gray-100 text-gray-800 message-in'} px-4 py-2 rounded-lg max-w-[80%]">
            <p>${msg.content}</p>
            <p class="text-xs mt-1 ${msg.sender_id === currentUser.id ? 'text-primary-100' : 'text-gray-500'}">
              ${new Date(msg.created_at).toLocaleTimeString()}
            </p>
          </div>
        </div>
      `).join('');
      
      await markMessagesAsRead();
      initChatListener();
      scrollToBottom();
    }

    async function sendMessage() {
      const messageInput = document.getElementById('messageInput');
      const content = messageInput.value.trim();
      
      if (!content || !currentUser || !selectedFriendId) return;
      
      const { error } = await supabase
        .from('chat_messages')
        .insert([{
          sender_id: currentUser.id,
          receiver_id: selectedFriendId,
          content: content
        }]);
      
      if (error) return alert('发送失败：' + error.message);
      
      messageInput.value = '';
      loadChatHistory();
    }

    async function markMessagesAsRead() {
      if (!currentUser || !selectedFriendId) return;
      
      const { error } = await supabase
        .from('chat_messages')
        .update({ is_read: true })
        .eq('sender_id', selectedFriendId)
        .eq('receiver_id', currentUser.id)
        .eq('is_read', false);
      
      if (error) console.error('标记已读失败：', error);
    }

    function initChatListener() {
      if (!currentUser || !selectedFriendId || chatSubscription) return;
      
      chatSubscription = supabase
        .channel('custom-filter-channel')
        .on(
          'postgres_changes',
          {
            event: 'INSERT',
            schema: 'public',
            table: 'chat_messages',
            filter: `or(sender_id=eq.${currentUser.id},receiver_id=eq.${currentUser.id})`
          },
          (payload) => {
            const newMsg = payload.new;
            if (
              (newMsg.sender_id === currentUser.id && newMsg.receiver_id === selectedFriendId) ||
              (newMsg.sender_id === selectedFriendId && newMsg.receiver_id === currentUser.id)
            ) {
              loadChatHistory();
            } else {
              showNewMessageNotification(newMsg);
            }
          }
        )
        .subscribe();
    }

    function showNewMessageNotification(msg) {
      alert(`收到新消息：${msg.content.substring(0, 20)}...`);
      loadFriendList();
    }

    function scrollToBottom() {
      const messageContainer = document.getElementById('messageContainer');
      messageContainer.scrollTop = messageContainer.scrollHeight;
    }

    window.addEventListener('beforeunload', () => {
      if (chatSubscription) {
        chatSubscription.unsubscribe();
      }
    });
  </script>
</body>
</html>