<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¶£å‘³å¥½å‹èŠå¤©ç³»ç»Ÿ</title>
    <!-- å¤–éƒ¨èµ„æº -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.bootcdn.net/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <!-- Tailwind é…ç½® -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#6366f1',
                        secondary: '#8b5cf6',
                        accent: '#ec4899',
                        success: '#10b981',
                        warning: '#f59e0b',
                        danger: '#ef4444',
                        dark: '#1e293b',
                        light: '#f8fafc'
                    },
                    fontFamily: {
                        sans: ['Inter', 'system-ui', 'sans-serif'],
                    },
                    boxShadow: {
                        'card': '0 10px 15px -3px rgba(0, 0, 0, 0.05), 0 4px 6px -2px rgba(0, 0, 0, 0.03)',
                        'hover': '0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04)',
                    }
                }
            }
        }
    </script>
    
    <!-- è‡ªå®šä¹‰å·¥å…·ç±» -->
    <style type="text/tailwindcss">
        @layer utilities {
            .content-auto { content-visibility: auto; }
            .card { @apply bg-white rounded-xl shadow-card p-4 transition-all duration-300 hover:shadow-hover; }
            .btn { @apply px-4 py-2 rounded-lg transition-all duration-300 transform hover:scale-105 active:scale-95; }
            .btn-primary { @apply bg-primary text-white hover:bg-primary/90; }
            .btn-secondary { @apply bg-gray-100 hover:bg-gray-200 text-gray-800; }
            .btn-accent { @apply bg-accent text-white hover:bg-accent/90; }
            .message-in { @apply bg-gray-100 text-gray-800 rounded-tl-lg rounded-tr-lg rounded-br-lg; }
            .message-out { @apply bg-primary text-white rounded-tl-lg rounded-tr-lg rounded-bl-lg; }
            .avatar-pulse { @apply relative overflow-hidden; }
            .avatar-pulse::after { @apply content-[''] absolute bottom-0 right-0 w-3 h-3 bg-success rounded-full border-2 border-white; }
            .gradient-bg { @apply bg-gradient-to-br from-primary/5 to-secondary/5; }
            .text-shadow { text-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        }
        
        /* åŠ¨ç”»æ•ˆæœ */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        @keyframes slideIn {
            from { opacity: 0; transform: translateX(-10px); }
            to { opacity: 1; transform: translateX(0); }
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        
        .animate-fadeIn { animation: fadeIn 0.4s ease-out forwards; }
        .animate-slideIn { animation: slideIn 0.3s ease-out forwards; }
        .animate-pulse-slow { animation: pulse 2s infinite; }
        
        /* æ»šåŠ¨æ¡ç¾åŒ– */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 10px; }
        ::-webkit-scrollbar-thumb { background: #d1d5db; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #9ca3af; }
    </style>
</head>
<body class="gradient-bg min-h-screen p-4 md:p-6 font-sans text-dark">
    <div class="max-w-6xl mx-auto">
        <!-- è¿”å›æŒ‰é’® -->
        <div class="mb-6 animate-slideIn">
            <a href="indexdaohang.html" class="btn btn-secondary inline-flex items-center gap-2 text-sm">
                <i class="fa fa-arrow-left"></i> è¿”å›å¯¼èˆªé¡µ
            </a>
        </div>
        
        <!-- æ ‡é¢˜åŒºåŸŸ -->
        <header class="text-center mb-8 animate-fadeIn" style="animation-delay: 0.1s">
            <h1 class="text-[clamp(1.8rem,5vw,3rem)] font-bold text-transparent bg-clip-text bg-gradient-to-r from-primary to-secondary mb-3 text-shadow">
                <i class="fa fa-comments mr-2"></i> è¶£å‘³å¥½å‹èŠå¤©
            </h1>
            <p class="text-gray-600 max-w-md mx-auto">å’ŒåŒå­¦ä»¬ç•…å¿«èŠå¤©ï¼Œåˆ†äº«æ¯ä¸€åˆ»çš„ç²¾å½©</p>
        </header>
        
        <!-- ç™»å½•/æ³¨å†ŒåŒºåŸŸ -->
        <div id="loginSection" class="max-w-md mx-auto mb-8 animate-fadeIn" style="animation-delay: 0.2s">
            <div class="card relative overflow-hidden">
                <div class="absolute -top-10 -right-10 w-32 h-32 bg-primary/10 rounded-full"></div>
                <div class="absolute -bottom-10 -left-10 w-24 h-24 bg-secondary/10 rounded-full"></div>
                
                <h2 class="text-xl font-bold mb-4 text-center text-gray-800 relative z-10">åŠ å…¥èŠå¤©</h2>
                <input type="text" id="username" placeholder="è¯·è¾“å…¥æ˜µç§°ï¼ˆ3-10ä¸ªå­—ç¬¦ï¼‰" 
                       class="w-full px-4 py-3 border border-gray-200 rounded-lg mb-4 focus:outline-none focus:ring-2 focus:ring-primary/50 transition-all relative z-10">
                <div class="flex gap-3 relative z-10">
                    <button onclick="handleLogin()" class="btn btn-primary flex-1">
                        <i class="fa fa-sign-in mr-1"></i> ç™»å½•
                    </button>
                    <button onclick="handleRegister()" class="btn btn-accent flex-1">
                        <i class="fa fa-user-plus mr-1"></i> æ³¨å†Œ
                    </button>
                </div>
            </div>
        </div>
        
        <!-- ç”¨æˆ·ä¿¡æ¯åŒºåŸŸï¼ˆç™»å½•åæ˜¾ç¤ºï¼‰ -->
        <div id="userInfo" class="hidden text-center mb-6 animate-fadeIn">
            <div class="inline-flex items-center gap-3 bg-white rounded-full px-6 py-3 shadow-card">
                <img id="userAvatar" src="https://picsum.photos/200/200" alt="ç”¨æˆ·å¤´åƒ" class="w-12 h-12 rounded-full border-2 border-primary avatar-pulse">
                <div class="text-left">
                    <p class="text-lg font-medium">å½“å‰ç™»å½•ï¼š<span id="currentUser" class="font-bold text-primary"></span></p>
                    <p id="userSignature" class="text-sm text-gray-500 mt-1">ç‚¹å‡»ç¼–è¾‘ä¸ªæ€§ç­¾å</p>
                </div>
                <button id="editProfileBtn" class="ml-2 text-primary hover:text-primary/80">
                    <i class="fa fa-pencil"></i>
                </button>
            </div>
            <button onclick="handleLogout()" class="text-sm text-danger hover:underline mt-3">
                <i class="fa fa-sign-out mr-1"></i> é€€å‡ºç™»å½•
            </button>
        </div>
        
        <!-- ä¸»åŠŸèƒ½åŒºï¼ˆç™»å½•åæ˜¾ç¤ºï¼‰ -->
        <div id="mainContent" class="hidden grid grid-cols-1 md:grid-cols-3 gap-6 animate-fadeIn">
            <!-- å·¦ä¾§ï¼šå¥½å‹ç®¡ç† -->
            <div class="space-y-6">
                <!-- æ·»åŠ å¥½å‹ -->
                <div class="card">
                    <h3 class="font-bold mb-4 flex items-center text-gray-800">
                        <span class="w-8 h-8 rounded-full bg-primary/10 flex items-center justify-center text-primary mr-2">
                            <i class="fa fa-user-plus"></i>
                        </span>
                        æ·»åŠ å¥½å‹
                    </h3>
                    <div class="flex gap-2">
                        <input type="text" id="friendName" placeholder="è¾“å…¥å¥½å‹æ˜µç§°" 
                               class="flex-1 px-3 py-2 border border-gray-200 rounded-lg focus:outline-none focus:ring-1 focus:ring-primary transition-all">
                        <button onclick="addFriend()" class="btn btn-primary p-2">
                            <i class="fa fa-paper-plane"></i>
                        </button>
                    </div>
                </div>
                
                <!-- å¥½å‹ç”³è¯· -->
                <div class="card">
                    <h3 class="font-bold mb-4 flex items-center text-gray-800">
                        <span class="w-8 h-8 rounded-full bg-accent/10 flex items-center justify-center text-accent mr-2">
                            <i class="fa fa-bell"></i>
                        </span>
                        å¥½å‹ç”³è¯·
                        <span id="requestCount" class="ml-2 bg-accent text-white text-xs rounded-full w-5 h-5 flex items-center justify-center hidden animate-pulse-slow">0</span>
                    </h3>
                    <div id="friendRequests" class="space-y-3 max-h-48 overflow-y-auto pr-1">
                        <div class="text-center text-gray-500 py-6">
                            <i class="fa fa-envelope-o text-2xl mb-2 opacity-30"></i>
                            <p class="text-sm italic">æš‚æ— å¥½å‹ç”³è¯·</p>
                        </div>
                    </div>
                </div>
                
                <!-- å¥½å‹åˆ—è¡¨ -->
                <div class="card">
                    <h3 class="font-bold mb-4 flex items-center text-gray-800">
                        <span class="w-8 h-8 rounded-full bg-secondary/10 flex items-center justify-center text-secondary mr-2">
                            <i class="fa fa-users"></i>
                        </span>
                        æˆ‘çš„å¥½å‹
                    </h3>
                    <div id="friendsList" class="space-y-3 max-h-[calc(100vh-450px)] overflow-y-auto pr-1">
                        <div class="text-center text-gray-500 py-8">
                            <i class="fa fa-hand-o-down text-2xl mb-2 opacity-30"></i>
                            <p class="text-sm italic">æš‚æ— å¥½å‹ï¼Œæ·»åŠ å‡ ä¸ªå§ï¼</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- å³ä¾§ï¼šèŠå¤©åŒºåŸŸ -->
            <div class="md:col-span-2">
                <div id="chatSection" class="card h-full flex flex-col">
                    <!-- èŠå¤©æ ‡é¢˜å’Œæœç´¢æ¡† -->
                    <div id="chatHeader" class="border-b pb-4 mb-4">
                        <h3 class="font-bold text-xl flex items-center">
                            <span class="w-10 h-10 rounded-full bg-primary/10 flex items-center justify-center text-primary mr-3">
                                <i class="fa fa-comments"></i>
                            </span>
                            <span id="chatWith">é€‰æ‹©å¥½å‹å¼€å§‹èŠå¤©</span>
                        </h3>
                        <!-- æœç´¢æ¡† -->
                        <div id="searchContainer" class="mt-2 hidden">
                            <div class="relative">
                                <input type="text" id="messageSearch" placeholder="æœç´¢èŠå¤©è®°å½•..." class="w-full px-3 py-2 pl-8 border border-gray-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-primary/50">
                                <i class="fa fa-search absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
                            </div>
                            <p id="searchTip" class="text-xs text-gray-500 mt-1 hidden">æ‰¾åˆ° X æ¡ç»“æœ</p>
                        </div>
                    </div>
                    
                    <!-- èŠå¤©å†…å®¹ -->
                    <div id="messages" class="flex-1 overflow-y-auto mb-4 space-y-4 p-3 min-h-[300px] bg-gray-50 rounded-xl">
                        <div class="text-center text-gray-500 py-10">
                            <i class="fa fa-comment text-3xl mb-3 opacity-20"></i>
                            <p class="text-sm italic">è¯·ä»å·¦ä¾§å¥½å‹åˆ—è¡¨ä¸­é€‰æ‹©ä¸€ä½å¥½å‹å¼€å§‹èŠå¤©</p>
                        </div>
                    </div>
                    
                    <!-- å‘é€æ¶ˆæ¯åŒºåŸŸ -->
                    <div id="messageInputArea" class="flex gap-2 hidden">
                        <textarea id="messageText" rows="2" placeholder="è¾“å…¥æ¶ˆæ¯..." class="flex-1 px-4 py-3 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/50 resize-none"></textarea>
                        <!-- è¡¨æƒ…åŒ…æŒ‰é’® -->
                        <button id="emojiBtn" class="w-10 h-10 rounded-lg bg-gray-100 hover:bg-gray-200 flex items-center justify-center">
                            <i class="fa fa-smile-o text-lg"></i>
                        </button>
                        <button onclick="sendMessage()" class="btn btn-primary">å‘é€</button>
                    </div>
                    
                    <!-- è¡¨æƒ…åŒ…é¢æ¿ -->
                    <div id="emojiPanel" class="hidden absolute bottom-16 left-4 right-4 md:left-auto md:right-4 bg-white rounded-xl shadow-hover p-3 grid grid-cols-8 gap-2 max-h-40 overflow-y-auto">
                        <span class="emoji-item text-xl cursor-pointer hover:scale-125 transition-transform">ğŸ˜‚</span>
                        <span class="emoji-item text-xl cursor-pointer hover:scale-125 transition-transform">ğŸ˜†</span>
                        <span class="emoji-item text-xl cursor-pointer hover:scale-125 transition-transform">ğŸ¥³</span>
                        <span class="emoji-item text-xl cursor-pointer hover:scale-125 transition-transform">ğŸ˜</span>
                        <span class="emoji-item text-xl cursor-pointer hover:scale-125 transition-transform">ğŸ¥º</span>
                        <span class="emoji-item text-xl cursor-pointer hover:scale-125 transition-transform">ğŸ˜œ</span>
                        <span class="emoji-item text-xl cursor-pointer hover:scale-125 transition-transform">ğŸ‘</span>
                        <span class="emoji-item text-xl cursor-pointer hover:scale-125 transition-transform">ğŸ‰</span>
                        <span class="emoji-item text-xl cursor-pointer hover:scale-125 transition-transform">ğŸ¤”</span>
                        <span class="emoji-item text-xl cursor-pointer hover:scale-125 transition-transform">ğŸ˜‹</span>
                        <span class="emoji-item text-xl cursor-pointer hover:scale-125 transition-transform">ğŸ˜¤</span>
                        <span class="emoji-item text-xl cursor-pointer hover:scale-125 transition-transform">ğŸ¥´</span>
                        <span class="emoji-item text-xl cursor-pointer hover:scale-125 transition-transform">ğŸ˜˜</span>
                        <span class="emoji-item text-xl cursor-pointer hover:scale-125 transition-transform">ğŸ¤©</span>
                        <span class="emoji-item text-xl cursor-pointer hover:scale-125 transition-transform">ğŸ™Œ</span>
                        <span class="emoji-item text-xl cursor-pointer hover:scale-125 transition-transform">ğŸ’ª</span>
                        <span class="emoji-item text-xl cursor-pointer hover:scale-125 transition-transform">ğŸ‘</span>
                        <span class="emoji-item text-xl cursor-pointer hover:scale-125 transition-transform">ğŸ˜¢</span>
                        <span class="emoji-item text-xl cursor-pointer hover:scale-125 transition-transform">ğŸ˜±</span>
                        <span class="emoji-item text-xl cursor-pointer hover:scale-125 transition-transform">ğŸ¤¯</span>
                        <span class="emoji-item text-xl cursor-pointer hover:scale-125 transition-transform">ğŸ¥°</span>
                        <span class="emoji-item text-xl cursor-pointer hover:scale-125 transition-transform">ğŸ˜¡</span>
                        <span class="emoji-item text-xl cursor-pointer hover:scale-125 transition-transform">ğŸ¤·</span>
                        <span class="emoji-item text-xl cursor-pointer hover:scale-125 transition-transform">ğŸ™</span>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- ç¼–è¾‘ä¸ªäººèµ„æ–™å¼¹çª— -->
        <div id="profileModal" class="fixed inset-0 bg-black/50 z-50 flex items-center justify-center hidden">
            <div class="bg-white rounded-xl p-6 max-w-md w-full mx-4 animate-fadeIn">
                <h3 class="text-xl font-bold mb-4 text-primary">ç¼–è¾‘ä¸ªäººèµ„æ–™</h3>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-1">ä¸ªæ€§ç­¾å</label>
                    <input type="text" id="editSignature" placeholder="è¾“å…¥ä¸ªæ€§ç­¾åï¼ˆä¸è¶…è¿‡20å­—ï¼‰" class="w-full px-4 py-2 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/50">
                </div>
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-1">å½“å‰çŠ¶æ€</label>
                    <select id="editStatus" class="w-full px-4 py-2 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/50">
                        <option value="åœ¨çº¿">åœ¨çº¿</option>
                        <option value="å­¦ä¹ ä¸­">å­¦ä¹ ä¸­</option>
                        <option value="æ‘¸é±¼ä¸­">æ‘¸é±¼ä¸­</option>
                        <option value="ç¦»çº¿">ç¦»çº¿</option>
                    </select>
                </div>
                <div class="flex justify-end gap-3">
                    <button onclick="closeProfileModal()" class="btn btn-secondary">å–æ¶ˆ</button>
                    <button onclick="saveProfile()" class="btn btn-primary">ä¿å­˜</button>
                </div>
            </div>
        </div>
        
        <!-- åŠ è½½æç¤º -->
        <div id="loading" class="hidden fixed inset-0 bg-black/10 flex items-center justify-center z-50 backdrop-blur-sm">
            <div class="bg-white p-8 rounded-xl shadow-lg flex items-center gap-4 animate-fadeIn">
                <i class="fa fa-circle-o-notch fa-spin text-primary text-2xl"></i>
                <span class="text-lg font-medium">å¤„ç†ä¸­...</span>
            </div>
        </div>
    </div>

    <script>
        // å…¨å±€å˜é‡
        let currentUser = null;
        let selectedFriend = null;
        let supabase = null;
        let chatSubscription = null;
        let currentMessages = []; // å­˜å‚¨å½“å‰èŠå¤©çš„æ‰€æœ‰æ¶ˆæ¯ï¼ˆç”¨äºæœç´¢ï¼‰
        
        // DOMå…ƒç´ 
        const loginSection = document.getElementById('loginSection');
        const userInfo = document.getElementById('userInfo');
        const mainContent = document.getElementById('mainContent');
        const currentUserEl = document.getElementById('currentUser');
        const userAvatarEl = document.getElementById('userAvatar');
        const userSignatureEl = document.getElementById('userSignature');
        const loading = document.getElementById('loading');
        
        // åˆå§‹åŒ–Supabaseå®¢æˆ·ç«¯
        function initSupabaseClient() {
            // æ›¿æ¢ä¸ºä½ çš„Supabaseé¡¹ç›®ä¿¡æ¯
            const supabaseUrl = "https://cjoabruloeflhhljjysl.supabase.co";
            const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNqb2FicnVsb2VmbGhobGpqeXNsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk2MTY4MTIsImV4cCI6MjA3NTE5MjgxMn0.CPaMga0gWs9k778kjYEhcOGTYp0Vtku0ZkyKJo-Q6Gg";
            
            return window.supabase.createClient(supabaseUrl, supabaseKey, {
                global: {
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json',
                        'apikey': supabaseKey,
                        'Authorization': `Bearer ${supabaseKey}`
                    },
                    fetch: (url, options = {}) => {
                        if (!options.method) options.method = 'GET';
                        return fetch(url, options);
                    }
                },
                auth: {
                    persistSession: false,
                    autoRefreshToken: false
                }
            });
        }
        
        // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
        function showLoading() {
            loading.classList.remove('hidden');
        }
        
        // éšè—åŠ è½½çŠ¶æ€
        function hideLoading() {
            loading.classList.add('hidden');
        }
        
        // é¡µé¢åˆå§‹åŒ–
        function initApp() {
            try {
                supabase = initSupabaseClient();
                
                // æ£€æŸ¥æœ¬åœ°å­˜å‚¨çš„ç”¨æˆ·çŠ¶æ€
                const savedUser = localStorage.getItem('friendSystemUser');
                if (savedUser) {
                    currentUser = JSON.parse(savedUser);
                    showUserInterface();
                }
                
                // åˆå§‹åŒ–è¡¨æƒ…åŒ…åŠŸèƒ½
                initEmojiåŠŸèƒ½();
                
                // åˆå§‹åŒ–æœç´¢åŠŸèƒ½
                initSearchåŠŸèƒ½();
                
                // åˆå§‹åŒ–ä¸ªäººèµ„æ–™ç¼–è¾‘åŠŸèƒ½
                initProfileEditåŠŸèƒ½();
            } catch (error) {
                console.error('åº”ç”¨åˆå§‹åŒ–å¤±è´¥:', error);
                alert('åˆå§‹åŒ–å¤±è´¥: ' + error.message);
            }
        }
        
        // åˆå§‹åŒ–è¡¨æƒ…åŒ…åŠŸèƒ½
        function initEmojiåŠŸèƒ½() {
            // è¡¨æƒ…åŒ…é¢æ¿æ˜¾ç¤º/éšè—
            document.getElementById('emojiBtn').addEventListener('click', (e) => {
                e.stopPropagation();
                const panel = document.getElementById('emojiPanel');
                panel.classList.toggle('hidden');
            });
            
            // ç‚¹å‡»è¡¨æƒ…åŒ…æ’å…¥åˆ°è¾“å…¥æ¡†
            document.querySelectorAll('.emoji-item').forEach(item => {
                item.addEventListener('click', () => {
                    const textarea = document.getElementById('messageText');
                    // åœ¨å…‰æ ‡ä½ç½®æ’å…¥è¡¨æƒ…åŒ…
                    const start = textarea.selectionStart;
                    const end = textarea.selectionEnd;
                    const value = textarea.value;
                    textarea.value = value.substring(0, start) + item.textContent + value.substring(end);
                    textarea.focus();
                });
            });
            
            // ç‚¹å‡»é¡µé¢å…¶ä»–åœ°æ–¹å…³é—­è¡¨æƒ…åŒ…é¢æ¿
            document.addEventListener('click', () => {
                document.getElementById('emojiPanel').classList.add('hidden');
            });
        }
        
        // åˆå§‹åŒ–æœç´¢åŠŸèƒ½
        function initSearchåŠŸèƒ½() {
            // æœç´¢æ¡†è¾“å…¥äº‹ä»¶ï¼ˆè¿‡æ»¤æ¶ˆæ¯ï¼‰
            document.getElementById('messageSearch').addEventListener('input', (e) => {
                const keyword = e.target.value.trim().toLowerCase();
                const container = document.getElementById('messages');
                container.innerHTML = '';

                if (!keyword) {
                    // æ— å…³é”®è¯ï¼šæ˜¾ç¤ºæ‰€æœ‰æ¶ˆæ¯
                    renderMessages(currentMessages);
                    document.getElementById('searchTip').classList.add('hidden');
                    return;
                }

                // æœ‰å…³é”®è¯ï¼šè¿‡æ»¤åŒ…å«å…³é”®è¯çš„æ¶ˆæ¯
                const matchedMessages = currentMessages.filter(msg => 
                    msg.content.toLowerCase().includes(keyword)
                );

                // æ˜¾ç¤ºç»“æœ
                renderMessages(matchedMessages);
                // æ˜¾ç¤ºæç¤º
                document.getElementById('searchTip').textContent = `æ‰¾åˆ° ${matchedMessages.length} æ¡ç»“æœ`;
                document.getElementById('searchTip').classList.remove('hidden');
            });
        }
        
        // åˆå§‹åŒ–ä¸ªäººèµ„æ–™ç¼–è¾‘åŠŸèƒ½
        function initProfileEditåŠŸèƒ½() {
            // æ‰“å¼€ç¼–è¾‘å¼¹çª—
            document.getElementById('editProfileBtn').addEventListener('click', () => {
                if (!currentUser) return;
                
                // å¡«å……å½“å‰ç”¨æˆ·çš„ç­¾åå’ŒçŠ¶æ€
                document.getElementById('editSignature').value = currentUser.signature || '';
                document.getElementById('editStatus').value = currentUser.status || 'åœ¨çº¿';
                document.getElementById('profileModal').classList.remove('hidden');
            });
        }
        
        // æ³¨å†Œæ–°ç”¨æˆ·
        async function handleRegister() {
            const username = document.getElementById('username').value.trim();
            
            // éªŒè¯ç”¨æˆ·å
            if (!username) {
                alert('è¯·è¾“å…¥æ˜µç§°');
                return;
            }
            if (username.length < 3 || username.length > 10) {
                alert('æ˜µç§°é•¿åº¦å¿…é¡»åœ¨3-10ä¸ªå­—ç¬¦ä¹‹é—´');
                return;
            }
            if (!/^[a-zA-Z0-9\u4e00-\u9fa5]+$/.test(username)) {
                alert('æ˜µç§°åªèƒ½åŒ…å«æ±‰å­—ã€å­—æ¯å’Œæ•°å­—');
                return;
            }
            
            try {
                showLoading();
                
                // æ£€æŸ¥ç”¨æˆ·åæ˜¯å¦å·²å­˜åœ¨
                const { data: existingUser, error: existError } = await supabase
                    .from('users')
                    .select('id')
                    .eq('username', username)
                    .single();
                
                if (!existError && existingUser) {
                    throw new Error('è¯¥æ˜µç§°å·²è¢«ä½¿ç”¨ï¼Œè¯·æ›´æ¢');
                }
                
                // åˆ›å»ºæ–°ç”¨æˆ·ï¼ˆåŒ…å«é»˜è®¤çš„ç­¾åå’ŒçŠ¶æ€ï¼‰
                const { data: newUser, error } = await supabase
                    .from('users')
                    .insert([{ 
                        username: username,
                        avatar: `https://picsum.photos/seed/${username}/200`,
                        signature: '',
                        status: 'åœ¨çº¿'
                    }])
                    .select('*')
                    .single();
                
                if (error) {
                    console.error('åˆ›å»ºç”¨æˆ·é”™è¯¯:', error);
                    throw new Error('æ³¨å†Œå¤±è´¥: ' + error.message);
                }
                
                currentUser = newUser;
                localStorage.setItem('friendSystemUser', JSON.stringify(newUser));
                
                alert('æ³¨å†ŒæˆåŠŸï¼');
                showUserInterface();
            } catch (error) {
                console.error('æ³¨å†Œå¤±è´¥:', error);
                alert('æ³¨å†Œå¤±è´¥: ' + error.message);
            } finally {
                hideLoading();
            }
        }
        
        // ç”¨æˆ·ç™»å½•
        async function handleLogin() {
            const username = document.getElementById('username').value.trim();
            if (!username) {
                alert('è¯·è¾“å…¥æ˜µç§°');
                return;
            }
            
            try {
                showLoading();
                
                // æŸ¥è¯¢ç”¨æˆ·
                const { data: users, error } = await supabase
                    .from('users')
                    .select('*')
                    .eq('username', username);
                
                if (error) {
                    console.error('æŸ¥è¯¢ç”¨æˆ·é”™è¯¯:', error);
                    throw new Error('æŸ¥è¯¢å¤±è´¥: ' + error.message);
                }
                
                if (!users || users.length === 0) {
                    throw new Error('ç”¨æˆ·ä¸å­˜åœ¨ï¼Œè¯·å…ˆæ³¨å†Œ');
                }
                
                const user = users[0];
                currentUser = user;
                localStorage.setItem('friendSystemUser', JSON.stringify(user));
                
                alert('ç™»å½•æˆåŠŸï¼');
                showUserInterface();
            } catch (error) {
                console.error('ç™»å½•å¤±è´¥:', error);
                alert('ç™»å½•å¤±è´¥: ' + error.message);
            } finally {
                hideLoading();
            }
        }
        
        // ç”¨æˆ·é€€å‡ºç™»å½•
        function handleLogout() {
            currentUser = null;
            selectedFriend = null;
            currentMessages = [];
            localStorage.removeItem('friendSystemUser');
            
            if (chatSubscription) {
                chatSubscription.unsubscribe();
                chatSubscription = null;
            }
            
            loginSection.classList.remove('hidden');
            userInfo.classList.add('hidden');
            mainContent.classList.add('hidden');
            
            document.getElementById('chatWith').textContent = 'é€‰æ‹©å¥½å‹å¼€å§‹èŠå¤©';
            document.getElementById('messages').innerHTML = 
                '<div class="text-center text-gray-500 py-10"><i class="fa fa-comment text-3xl mb-3 opacity-20"></i><p class="text-sm italic">è¯·ä»å·¦ä¾§å¥½å‹åˆ—è¡¨ä¸­é€‰æ‹©ä¸€ä½å¥½å‹å¼€å§‹èŠå¤©</p></div>';
            document.getElementById('messageInputArea').classList.add('hidden');
            document.getElementById('searchContainer').classList.add('hidden');
            
            alert('å·²é€€å‡ºç™»å½•');
        }
        
        // æ˜¾ç¤ºç”¨æˆ·ä¸»ç•Œé¢
        function showUserInterface() {
            if (!currentUser) return;
            
            currentUserEl.textContent = currentUser.username;
            userAvatarEl.src = currentUser.avatar || 'https://picsum.photos/200/200';
            userSignatureEl.textContent = currentUser.signature || 'ç‚¹å‡»ç¼–è¾‘ä¸ªæ€§ç­¾å';
            
            loginSection.classList.add('hidden');
            userInfo.classList.remove('hidden');
            mainContent.classList.remove('hidden');
            
            loadFriendRequests();
            loadFriendsList();
        }
        
        // åŠ è½½å¥½å‹ç”³è¯·
        async function loadFriendRequests() {
            if (!currentUser) return;
            
            try {
                const { data: requests, error } = await supabase
                    .from('friend_relations')
                    .select(`
                        id,
                        sender:users!friend_relations_sender_id_fkey (id, username, avatar)
                    `)
                    .eq('receiver_id', currentUser.id)
                    .eq('status', 'pending')
                    .order('created_at', { ascending: false });
                
                const container = document.getElementById('friendRequests');
                const countEl = document.getElementById('requestCount');
                
                countEl.textContent = requests?.length || 0;
                countEl.classList.toggle('hidden', !requests?.length);
                
                if (error || !requests?.length) {
                    container.innerHTML = '<div class="text-center text-gray-500 py-6"><i class="fa fa-envelope-o text-2xl mb-2 opacity-30"></i><p class="text-sm italic">æš‚æ— å¥½å‹ç”³è¯·</p></div>';
                    return;
                }
                
                container.innerHTML = requests.map((req, index) => `
                    <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg hover:bg-gray-100 transition-all animate-fadeIn" style="animation-delay: ${index * 0.1}s">
                        <div class="flex items-center gap-3">
                            <img src="${req.sender.avatar}" alt="${req.sender.username}" 
                                 class="w-10 h-10 rounded-full object-cover border-2 border-white shadow-sm">
                            <span class="font-medium">${req.sender.username}</span>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="respondToRequest('${req.id}', true)" 
                                    class="px-3 py-1.5 bg-success text-white text-sm rounded-lg hover:bg-success/90 transition-colors">
                                    <i class="fa fa-check mr-1"></i>åŒæ„
                            </button>
                            <button onclick="respondToRequest('${req.id}', false)" 
                                    class="px-3 py-1.5 bg-gray-200 text-sm rounded-lg hover:bg-gray-300 transition-colors">
                                    <i class="fa fa-times mr-1"></i>æ‹’ç»
                            </button>
                        </div>
                    </div>
                `).join('');
            } catch (error) {
                console.error('åŠ è½½å¥½å‹ç”³è¯·å¤±è´¥:', error);
                document.getElementById('friendRequests').innerHTML = 
                    `<p class="text-red-500 text-sm text-center py-6">åŠ è½½å¤±è´¥: ${error.message}</p>`;
            }
        }
        
        // åŠ è½½å¥½å‹åˆ—è¡¨ï¼ˆå¸¦æœªè¯»æç¤ºå’ŒçŠ¶æ€æ˜¾ç¤ºï¼‰
        async function loadFriendsList() {
            if (!currentUser) return;
            
            try {
                const { data: relations, error } = await supabase
                    .from('friend_relations')
                    .select(`
                        id,
                        sender:users!friend_relations_sender_id_fkey (id, username, avatar, status),
                        receiver:users!friend_relations_receiver_id_fkey (id, username, avatar, status)
                    `)
                    .or(`and(sender_id.eq.${currentUser.id},status.eq.accepted),and(receiver_id.eq.${currentUser.id},status.eq.accepted)`)
                    .order('updated_at', { ascending: false });
                
                const container = document.getElementById('friendsList');
                container.innerHTML = '';
                
                if (error || !relations?.length) {
                    container.innerHTML = '<div class="text-center text-gray-500 py-8"><i class="fa fa-hand-o-down text-2xl mb-2 opacity-30"></i><p class="text-sm italic">æš‚æ— å¥½å‹ï¼Œæ·»åŠ å‡ ä¸ªå§ï¼</p></div>';
                    return;
                }
                
                // æå–æ‰€æœ‰å¥½å‹ï¼ˆæ’é™¤è‡ªå·±ï¼‰
                const friends = [];
                const friendIds = new Set();
                
                relations.forEach(rel => {
                    const friend = rel.sender_id === currentUser.id ? rel.receiver : rel.sender;
                    if (friend.id !== currentUser.id && !friendIds.has(friend.id)) {
                        friendIds.add(friend.id);
                        friends.push(friend);
                    }
                });
                
                // æŸ¥è¯¢å½“å‰ç”¨æˆ·çš„æœªè¯»æ¶ˆæ¯ï¼ˆæŒ‰å‘é€æ–¹åˆ†ç»„ï¼‰
                const { data: unreadMsgs, error: unreadError } = await supabase.rpc('exec_sql', {
                    sql: `
                        SELECT sender_id, count(*) as unread_count 
                        FROM chat_messages 
                        WHERE receiver_id = $1 AND is_read = false 
                        GROUP BY sender_id
                    `,
                    params: [currentUser.id]
                });
                
                // æŠŠæœªè¯»æ•°é‡è½¬æˆå¯¹è±¡ï¼ˆæ–¹ä¾¿åŒ¹é…ï¼‰
                const unreadMap = {};
                unreadMsgs?.forEach(msg => {
                    unreadMap[msg.sender_id] = msg.unread_count;
                });
                
                // æ¸²æŸ“å¥½å‹åˆ—è¡¨
                container.innerHTML = friends.map((friend, index) => `
                    <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg hover:bg-gray-100 cursor-pointer transition-all animate-fadeIn" 
                         style="animation-delay: ${index * 0.1}s"
                         onclick="selectFriendToChat('${friend.id}', '${friend.username}', '${friend.avatar}')">
                        <div class="flex items-center gap-3">
                            <img src="${friend.avatar}" alt="${friend.username}" 
                                 class="w-10 h-10 rounded-full object-cover border-2 border-white shadow-sm avatar-pulse">
                            <div>
                                <p class="font-medium">${friend.username}
                                    ${unreadMap[friend.id] ? `<span class="ml-2 inline-block w-2 h-2 bg-danger rounded-full"></span>` : ''}
                                </p>
                                <p class="text-xs text-gray-500">${friend.status || 'åœ¨çº¿'}</p>
                            </div>
                        </div>
                        ${unreadMap[friend.id] ? `<span class="bg-danger/10 text-danger text-xs px-2 py-1 rounded-full">${unreadMap[friend.id]}</span>` : ''}
                    </div>
                `).join('');
            } catch (error) {
                console.error('åŠ è½½å¥½å‹åˆ—è¡¨å¤±è´¥:', error);
                document.getElementById('friendsList').innerHTML = 
                    `<p class="text-red-500 text-sm text-center py-6">åŠ è½½å¤±è´¥: ${error.message}</p>`;
            }
        }
        
        // æ·»åŠ å¥½å‹
        async function addFriend() {
            if (!currentUser) return;
            
            const friendName = document.getElementById('friendName').value.trim();
            if (!friendName) {
                alert('è¯·è¾“å…¥å¥½å‹æ˜µç§°');
                return;
            }
            
            if (friendName === currentUser.username) {
                alert('ä¸èƒ½æ·»åŠ è‡ªå·±ä¸ºå¥½å‹');
                return;
            }
            
            try {
                showLoading();
                
                // æŸ¥æ‰¾ç›®æ ‡ç”¨æˆ·
                const { data: friend, error } = await supabase
                    .from('users')
                    .select('id, username')
                    .eq('username', friendName)
                    .single();
                
                if (error) {
                    throw new Error('æœªæ‰¾åˆ°è¯¥ç”¨æˆ·ï¼Œè¯·ç¡®è®¤æ˜µç§°æ˜¯å¦æ­£ç¡®');
                }
                
                if (friend.id === currentUser.id) {
                    alert('ä¸èƒ½æ·»åŠ è‡ªå·±ä¸ºå¥½å‹');
                    return;
                }
                
                // æ£€æŸ¥æ˜¯å¦å·²æœ‰å¥½å‹å…³ç³»
                const { data: existing, error: existingError } = await supabase
                    .from('friend_relations')
                    .select('id, status')
                    .or(`and(sender_id.eq.${currentUser.id},receiver_id.eq.${friend.id}),and(sender_id.eq.${friend.id},receiver_id.eq.${currentUser.id})`)
                    .single();
                
                if (!existingError) {
                    if (existing.status === 'pending') {
                        throw new Error('å·²å‘é€å¥½å‹ç”³è¯·ï¼Œç­‰å¾…å¯¹æ–¹åŒæ„');
                    } else if (existing.status === 'accepted') {
                        throw new Error('ä½ ä»¬å·²ç»æ˜¯å¥½å‹äº†');
                    } else {
                        throw new Error('å¯¹æ–¹å·²æ‹’ç»ä½ çš„ç”³è¯·');
                    }
                }
                
                // å‘é€å¥½å‹ç”³è¯·
                const { error: requestError } = await supabase
                    .from('friend_relations')
                    .insert([{
                        sender_id: currentUser.id,
                        receiver_id: friend.id,
                        status: 'pending'
                    }]);
                
                if (requestError) throw new Error(requestError.message);
                
                alert(`å¥½å‹ç”³è¯·å·²å‘é€ç»™ ${friend.username}`);
                document.getElementById('friendName').value = '';
            } catch (error) {
                console.error('æ·»åŠ å¥½å‹å¤±è´¥:', error);
                alert('æ·»åŠ å¤±è´¥: ' + error.message);
            } finally {
                hideLoading();
            }
        }
        
        // å›åº”å¥½å‹ç”³è¯·
        async function respondToRequest(requestId, accept) {
            try {
                showLoading();
                
                // è·å–åŸç”³è¯·çš„ä¿¡æ¯
                const { data: request, error: getError } = await supabase
                    .from('friend_relations')
                    .select(`
                        id,
                        sender_id,
                        receiver_id,
                        sender:users!friend_relations_sender_id_fkey (username),
                        receiver:users!friend_relations_receiver_id_fkey (username)
                    `)
                    .eq('id', requestId)
                    .single();
                
                if (getError) throw new Error('è·å–ç”³è¯·ä¿¡æ¯å¤±è´¥');
                
                // æ›´æ–°åŸç”³è¯·çš„çŠ¶æ€
                const { error: updateError } = await supabase
                    .from('friend_relations')
                    .update({ 
                        status: accept ? 'accepted' : 'rejected',
                        updated_at: new Date()
                    })
                    .eq('id', requestId);
                
                if (updateError) throw new Error('æ›´æ–°ç”³è¯·çŠ¶æ€å¤±è´¥');
                
                // å¦‚æœæ˜¯åŒæ„ç”³è¯·ï¼Œæ·»åŠ åå‘å…³ç³»
                if (accept) {
                    // æ£€æŸ¥åå‘å…³ç³»æ˜¯å¦å·²å­˜åœ¨
                    const { data: reverseRel, error: reverseError } = await supabase
                        .from('friend_relations')
                        .select('id')
                        .eq('sender_id', request.receiver_id)
                        .eq('receiver_id', request.sender_id)
                        .single();
                    
                    // å¦‚æœåå‘å…³ç³»ä¸å­˜åœ¨ï¼Œåˆ™åˆ›å»º
                    if (reverseError) {
                        await supabase
                            .from('friend_relations')
                            .insert([{
                                sender_id: request.receiver_id,
                                receiver_id: request.sender_id,
                                status: 'accepted'
                            }]);
                    }
                }
                
                alert(accept ? 
                    `å·²åŒæ„ ${request.sender.username} çš„å¥½å‹ç”³è¯·` : 
                    `å·²æ‹’ç» ${request.sender.username} çš„å¥½å‹ç”³è¯·`);
                
                // åˆ·æ–°åˆ—è¡¨
                loadFriendRequests();
                loadFriendsList();
            } catch (error) {
                console.error('å¤„ç†ç”³è¯·å¤±è´¥:', error);
                alert('å¤„ç†å¤±è´¥: ' + error.message);
            } finally {
                hideLoading();
            }
        }
        
        // é€‰æ‹©å¥½å‹è¿›è¡ŒèŠå¤©
        async function selectFriendToChat(friendId, friendName, friendAvatar) {
            if (friendId === currentUser.id) {
                alert('ä¸èƒ½å’Œè‡ªå·±èŠå¤©');
                return;
            }
            
            selectedFriend = { id: friendId, name: friendName, avatar: friendAvatar };
            
            document.getElementById('chatWith').textContent = `ä¸ ${friendName} èŠå¤©ä¸­`;
            document.getElementById('messageInputArea').classList.remove('hidden');
            document.getElementById('searchContainer').classList.remove('hidden');
            
            loadChatHistory();
            setupChatListener();
        }
        
        // åŠ è½½èŠå¤©å†å²è®°å½•ï¼ˆå¸¦å·²è¯»çŠ¶æ€æ ‡è®°ï¼‰
        async function loadChatHistory() {
            if (!currentUser || !selectedFriend) return;
            
            try {
                const { data: messages, error } = await supabase
                    .from('chat_messages')
                    .select('*')
                    .or(`and(sender_id.eq.${currentUser.id},receiver_id.eq.${selectedFriend.id}),and(sender_id.eq.${selectedFriend.id},receiver_id.eq.${currentUser.id})`)
                    .order('created_at', { ascending: true });
                
                // ä¿å­˜åˆ°å…¨å±€å˜é‡ï¼ˆç”¨äºæœç´¢ï¼‰
                currentMessages = messages || [];
                
                renderMessages(currentMessages);
                
                // æ ‡è®°å·²è¯»ï¼šå½“å‰ç”¨æˆ·æ˜¯æ¥æ”¶æ–¹ï¼Œä¸”æ¶ˆæ¯æœªè¯»
                if (messages.length > 0) {
                    const unreadIds = messages
                        .filter(msg => msg.receiver_id === currentUser.id && !msg.is_read)
                        .map(msg => msg.id); // æ”¶é›†æœªè¯»æ¶ˆæ¯çš„ID

                    if (unreadIds.length > 0) {
                        await supabase
                            .from('chat_messages')
                            .update({ is_read: true })
                            .in('id', unreadIds); // æ‰¹é‡è®¾ä¸ºå·²è¯»
                        
                        // åˆ·æ–°å¥½å‹åˆ—è¡¨çš„æœªè¯»æç¤º
                        loadFriendsList();
                    }
                }
                
            } catch (error) {
                console.error('åŠ è½½èŠå¤©è®°å½•å¤±è´¥:', error);
                document.getElementById('messages').innerHTML = 
                    `<p class="text-red-500 text-sm text-center py-6">åŠ è½½æ¶ˆæ¯å¤±è´¥: ${error.message}</p>`;
            }
        }
        
        // æ¸²æŸ“æ¶ˆæ¯ï¼ˆå¤ç”¨å‡½æ•°ï¼‰
        function renderMessages(messages) {
            const container = document.getElementById('messages');
            container.innerHTML = '';

            if (messages.length === 0) {
                container.innerHTML = '<div class="text-center text-gray-500 py-10"><i class="fa fa-comment-o text-3xl mb-3 opacity-20"></i><p class="text-sm italic">æš‚æ— èŠå¤©è®°å½•ï¼Œå¼€å§‹å¯¹è¯å§ï¼</p></div>';
                return;
            }

            messages.forEach((msg, index) => {
                const isSent = msg.sender_id === currentUser.id;
                const messageEl = document.createElement('div');
                messageEl.className = `flex ${isSent ? 'justify-end' : 'justify-start'} animate-fadeIn`;
                messageEl.style.animationDelay = `${index * 0.05}s`;
                
                // å·²è¯»çŠ¶æ€æ˜¾ç¤ºï¼ˆåªé’ˆå¯¹å‘é€çš„æ¶ˆæ¯ï¼‰
                const readStatus = isSent ? 
                    (msg.is_read ? '<span class="ml-2 text-xs text-gray-400"><i class="fa fa-check-circle"></i></span>' : '') : 
                    '';
                
                messageEl.innerHTML = `
                    <div class="${isSent ? 'message-out' : 'message-in'} px-4 py-3 max-w-[80%] shadow-sm">
                        <p>${msg.content}</p>
                        <div class="flex items-center justify-end mt-1">
                            <p class="text-xs ${isSent ? 'text-blue-100' : 'text-gray-500'}">
                                ${new Date(msg.created_at).toLocaleTimeString()}
                            </p>
                            ${readStatus}
                        </div>
                    </div>
                `;
                container.appendChild(messageEl);
            });

            container.scrollTop = container.scrollHeight;
        }
        
        // å‘é€æ¶ˆæ¯
        async function sendMessage() {
            if (!currentUser || !selectedFriend) return;
            
            const messageText = document.getElementById('messageText').value.trim();
            if (!messageText) return;
            
            try {
                if (selectedFriend.id === currentUser.id) {
                    alert('ä¸èƒ½å‘è‡ªå·±å‘é€æ¶ˆæ¯');
                    return;
                }
                
                const { error } = await supabase
                    .from('chat_messages')
                    .insert([{
                        sender_id: currentUser.id,
                        receiver_id: selectedFriend.id,
                        content: messageText,
                        is_read: false // æ–°æ¶ˆæ¯é»˜è®¤æœªè¯»
                    }]);
                
                if (error) throw new Error(error.message);
                
                // æ¸…ç©ºè¾“å…¥æ¡†
                document.getElementById('messageText').value = '';
                loadChatHistory();
            } catch (error) {
                console.error('å‘é€æ¶ˆæ¯å¤±è´¥:', error);
                alert('å‘é€å¤±è´¥: ' + error.message);
            }
        }
        
        // è®¾ç½®å®æ—¶èŠå¤©ç›‘å¬
        function setupChatListener() {
            if (!currentUser || !selectedFriend || chatSubscription) return;
            
            if (chatSubscription) {
                chatSubscription.unsubscribe();
            }
            
            chatSubscription = supabase
                .channel('chat-channel')
                .on(
                    'postgres_changes',
                    {
                        event: 'INSERT',
                        schema: 'public',
                        table: 'chat_messages',
                        filter: `or(
                            and(sender_id.eq.${currentUser.id},receiver_id.eq.${selectedFriend.id}),
                            and(sender_id.eq.${selectedFriend.id},receiver_id.eq.${currentUser.id})
                        )`
                    },
                    () => loadChatHistory()
                )
                .subscribe();
        }
        
        // åˆ é™¤å¥½å‹
        async function removeFriend(friendId, e) {
            e.stopPropagation();
            
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªå¥½å‹å—ï¼Ÿåˆ é™¤åèŠå¤©è®°å½•ä¹Ÿå°†æ¸…é™¤ã€‚')) return;
            
            try {
                showLoading();
                
                // åˆ é™¤åŒå‘çš„å¥½å‹å…³ç³»
                await supabase
                    .from('friend_relations')
                    .delete()
                    .or(`and(sender_id.eq.${currentUser.id},receiver_id.eq.${friendId}),and(sender_id.eq.${friendId},receiver_id.eq.${currentUser.id})`);
                
                // å¦‚æœæ­£åœ¨å’Œè¯¥å¥½å‹èŠå¤©ï¼Œå…³é—­èŠå¤©ç•Œé¢
                if (selectedFriend && selectedFriend.id === friendId) {
                    selectedFriend = null;
                    currentMessages = [];
                    document.getElementById('chatWith').textContent = 'é€‰æ‹©å¥½å‹å¼€å§‹èŠå¤©';
                    document.getElementById('messages').innerHTML = 
                        '<div class="text-center text-gray-500 py-10"><i class="fa fa-comment text-3xl mb-3 opacity-20"></i><p class="text-sm italic">è¯·ä»å·¦ä¾§å¥½å‹åˆ—è¡¨ä¸­é€‰æ‹©ä¸€ä½å¥½å‹å¼€å§‹èŠå¤©</p></div>';
                    document.getElementById('messageInputArea').classList.add('hidden');
                    document.getElementById('searchContainer').classList.add('hidden');
                    
                    if (chatSubscription) {
                        chatSubscription.unsubscribe();
                        chatSubscription = null;
                    }
                }
                
                alert('å¥½å‹å·²æˆåŠŸåˆ é™¤');
                loadFriendsList();
            } catch (error) {
                console.error('åˆ é™¤å¥½å‹å¤±è´¥:', error);
                alert('åˆ é™¤å¤±è´¥: ' + error.message);
            } finally {
                hideLoading();
            }
        }
        
        // å…³é—­ä¸ªäººèµ„æ–™ç¼–è¾‘å¼¹çª—
        function closeProfileModal() {
            document.getElementById('profileModal').classList.add('hidden');
        }
        
        // ä¿å­˜ä¸ªäººèµ„æ–™
        async function saveProfile() {
            const newSignature = document.getElementById('editSignature').value.trim();
            const newStatus = document.getElementById('editStatus').value;

            // éªŒè¯ç­¾åé•¿åº¦
            if (newSignature.length > 20) {
                alert('ä¸ªæ€§ç­¾åä¸èƒ½è¶…è¿‡20å­—å“¦ï½');
                return;
            }

            try {
                // æ›´æ–°usersè¡¨
                const { data, error } = await supabase
                    .from('users')
                    .update({
                        signature: newSignature,
                        status: newStatus
                    })
                    .eq('id', currentUser.id)
                    .single();

                if (error) throw new Error(error.message);

                // æ›´æ–°æœ¬åœ°ç”¨æˆ·ä¿¡æ¯
                currentUser.signature = newSignature;
                currentUser.status = newStatus;
                // åˆ·æ–°ç•Œé¢æ˜¾ç¤º
                userSignatureEl.textContent = newSignature || 'ç‚¹å‡»ç¼–è¾‘ä¸ªæ€§ç­¾å';
                alert('èµ„æ–™ä¿å­˜æˆåŠŸï¼');
                closeProfileModal();
                
                // åˆ·æ–°å¥½å‹åˆ—è¡¨ä¸­çš„çŠ¶æ€æ˜¾ç¤º
                loadFriendsList();
            } catch (error) {
                console.error('ä¿å­˜èµ„æ–™å¤±è´¥:', error);
                alert('ä¿å­˜å¤±è´¥ï¼Œè¯·ç¨åå†è¯•ï½');
            }
        }
        
        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–åº”ç”¨
        window.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>
</html>
