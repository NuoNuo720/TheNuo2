<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>称号与头衔管理系统</title>
    <!-- 加载Tailwind CSS库 -->
    <link href="https://cdn.tailwindcss.com" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- 自定义样式 -->
    <style type="text/tailwindcss">
        @layer utilities {
            .content-auto {
                content-visibility: auto;
            }
            .title-card {
                @apply bg-white rounded-xl shadow-card overflow-hidden transition-all duration-300 hover:shadow-card-hover hover:-translate-y-1 border border-gray-100;
            }
            .title-card-equipped {
                @apply border-2 border-[#4F46E5] relative;
            }
            .title-card-equipped::before {
                content: "已佩戴";
                @apply absolute top-2 right-2 bg-[#4F46E5] text-white text-xs px-2 py-1 rounded-full;
            }
            .badge-icon {
                @apply w-16 h-16 flex items-center justify-center rounded-full text-2xl mb-3 mx-auto;
            }
            .shine-effect {
                position: relative;
                overflow: hidden;
            }
            .shine-effect::after {
                content: '';
                @apply absolute top-0 left-0 w-full h-full bg-gradient-to-r from-transparent via-white/20 to-transparent;
                transform: skewX(-25deg) translateX(-150%);
                animation: shine 3s infinite;
            }
            @keyframes shine {
                0% { transform: skewX(-25deg) translateX(-150%); }
                100% { transform: skewX(-25deg) translateX(150%); }
            }
            .fade-in {
                animation: fadeIn 0.5s ease-in-out;
            }
            @keyframes fadeIn {
                from { opacity: 0; }
                to { opacity: 1; }
            }
            .loading {
                animation: spin 1s linear infinite;
            }
            @keyframes spin {
                from { transform: rotate(0deg); }
                to { transform: rotate(360deg); }
            }
        }
    </style>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#4F46E5',
                        secondary: '#10B981',
                        accent: '#F59E0B',
                        dark: '#1E293B',
                        light: '#F8FAFC'
                    },
                    boxShadow: {
                        'card': '0 10px 15px -3px rgba(0, 0, 0, 0.05), 0 4px 6px -2px rgba(0, 0, 0, 0.03)',
                        'card-hover': '0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04)',
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-gray-50 min-h-screen font-sans text-gray-800">
    <!-- 导航栏 -->
    <header class="bg-dark text-white shadow-lg sticky top-0 z-50">
        <div class="container mx-auto px-4 py-4 flex justify-between items-center">
            <div class="flex items-center">
                <i class="fas fa-award text-accent text-2xl mr-3"></i>
                <h1 class="text-xl md:text-2xl font-bold">称号与头衔管理系统</h1>
            </div>
            <div id="user-info" class="flex items-center space-x-4">
                <div class="hidden md:flex items-center">
                    <div id="user-avatar" class="w-10 h-10 rounded-full bg-primary/20 flex items-center justify-center mr-2">
                        <i class="fas fa-user text-primary text-lg"></i>
                    </div>
                    <span id="username-display" class="font-medium"></span>
                </div>
                <button id="logout-btn" class="p-2 rounded-full hover:bg-gray-700 transition-colors hidden">
                    <i class="fas fa-sign-out-alt"></i>
                </button>
            </div>
        </div>
    </header>

    <!-- 未登录状态提示 -->
    <div id="not-logged-in" class="hidden container mx-auto px-4 py-16 text-center">
        <div class="bg-white rounded-xl shadow-lg p-8 max-w-md mx-auto fade-in">
            <i class="fas fa-user-lock text-6xl text-gray-400 mb-6"></i>
            <h2 class="text-2xl font-bold text-gray-800 mb-4">未登录状态</h2>
            <p class="text-gray-600 mb-8">您尚未登录系统，请先登录后再访问称号管理功能。</p>
            <div class="flex flex-col sm:flex-row gap-4 justify-center">
                <button id="go-to-login" class="bg-primary hover:bg-primary/90 text-white px-6 py-3 rounded-lg font-medium transition-all shadow-md hover:shadow-lg flex items-center justify-center">
                    <i class="fas fa-sign-in-alt mr-2"></i> 前往登录
                </button>
                <button id="back-home" class="bg-gray-200 hover:bg-gray-300 text-gray-800 px-6 py-3 rounded-lg font-medium transition-all shadow-md hover:shadow-lg flex items-center justify-center">
                    <i class="fas fa-home mr-2"></i> 返回导航页
                </button>
            </div>
        </div>
    </div>

    <!-- 主内容区 - 登录后显示 -->
    <main id="main-content" class="container mx-auto px-4 py-8">
        <!-- 用户信息概览 -->
        <section class="mb-10 bg-white rounded-xl shadow-md p-6 border border-gray-100">
            <div class="flex flex-col md:flex-row justify-between items-center">
                <div class="flex items-center mb-4 md:mb-0">
                    <div class="w-16 h-16 rounded-full bg-primary/20 flex items-center justify-center mr-4">
                        <i class="fas fa-user text-primary text-2xl"></i>
                    </div>
                    <div>
                        <h2 class="text-xl font-bold" id="user-display-name"></h2>
                        <p class="text-gray-500 text-sm">
                            <i class="fas fa-trophy mr-1"></i>
                            <span id="user-titles-count">0</span> 个称号 · 
                            <span id="join-date">2023年1月1日</span> 加入
                        </p>
                    </div>
                </div>
                <div class="flex gap-3">
                    <button id="refresh-titles" class="bg-gray-100 hover:bg-gray-200 text-gray-700 px-4 py-2 rounded-lg font-medium transition-all flex items-center">
                        <i class="fas fa-sync-alt mr-2"></i> 刷新
                    </button>
                    <button id="export-titles" class="bg-secondary hover:bg-secondary/90 text-white px-4 py-2 rounded-lg font-medium transition-all flex items-center">
                        <i class="fas fa-download mr-2"></i> 导出称号
                    </button>
                </div>
            </div>
        </section>

        <!-- 当前佩戴的称号 -->
        <section class="mb-12">
            <h2 class="text-2xl font-bold mb-6 flex items-center text-dark">
                <i class="fas fa-crown text-accent mr-3"></i>
                当前佩戴的称号
            </h2>
            <div id="current-title" class="bg-white rounded-xl shadow-lg p-6 md:p-8 text-center shine-effect">
                <div class="text-gray-500 italic py-12" id="no-current-title">
                    <i class="fas fa-trophy text-gray-300 text-4xl mb-4 block"></i>
                    尚未佩戴任何称号
                </div>
                <div id="current-title-content" class="hidden">
                    <div class="badge-icon bg-primary/10 text-primary mx-auto mb-6">
                        <i id="current-title-icon" class="fas fa-star"></i>
                    </div>
                    <div class="text-3xl font-bold text-primary mb-3" id="current-title-name"></div>
                    <div class="text-gray-600 max-w-2xl mx-auto mb-6" id="current-title-desc"></div>
                    <div class="text-sm text-gray-500">
                        <i class="fas fa-calendar-alt mr-1"></i>
                        获得于 <span id="current-title-date"></span>
                    </div>
                    <button id="remove-current-title" class="mt-4 bg-gray-100 hover:bg-gray-200 text-gray-700 px-4 py-2 rounded-lg font-medium transition-all">
                        <i class="fas fa-times mr-1"></i> 取消佩戴
                    </button>
                </div>
            </div>
        </section>

        <!-- 称号列表 -->
        <section class="mb-12">
            <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 gap-4">
                <h2 class="text-2xl font-bold flex items-center text-dark">
                    <i class="fas fa-trophy text-accent mr-3"></i>
                    我的称号 collection
                </h2>
                <div class="flex items-center gap-3 w-full sm:w-auto">
                    <span id="titles-count" class="bg-gray-200 text-gray-700 px-3 py-1 rounded-full text-sm">
                        0 个称号
                    </span>
                    <div class="relative">
                        <select id="titles-filter" class="appearance-none bg-gray-200 text-gray-700 px-3 py-1 pr-8 rounded-full text-sm focus:outline-none focus:ring-2 focus:ring-primary">
                            <option value="all">全部称号</option>
                            <option value="equipped">已佩戴</option>
                            <option value="admin">管理员授予</option>
                            <option value="custom">自定义</option>
                            <option value="system">系统称号</option>
                        </select>
                        <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-700">
                            <i class="fas fa-chevron-down text-xs"></i>
                        </div>
                    </div>
                </div>
            </div>
            <div id="titles-container" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
                <!-- 加载状态 -->
                <div id="loading-titles" class="col-span-full text-center py-16 hidden">
                    <i class="fas fa-circle-notch text-gray-400 text-5xl mb-4 block loading"></i>
                    <p class="text-gray-500">加载称号中...</p>
                </div>
                
                <!-- 无称号提示 -->
                <div class="col-span-full text-center text-gray-500 py-16" id="no-titles-message">
                    <i class="fas fa-award text-gray-300 text-5xl mb-4 block"></i>
                    暂无称号，继续努力获取吧！
                </div>
            </div>
        </section>

        <!-- 管理员区域 -->
        <section id="admin-section" class="mb-12 hidden">
            <h2 class="text-2xl font-bold mb-6 flex items-center text-dark">
                <i class="fas fa-user-shield text-red-500 mr-3"></i>
                管理员操作
            </h2>
            <div class="bg-white rounded-xl shadow-md p-6 border border-gray-100">
                <h3 class="text-xl font-semibold mb-4 text-gray-800">授予用户称号</h3>
                <form id="grant-title-form" class="space-y-5">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
                        <div>
                            <label for="target-username" class="block text-gray-700 mb-2 font-medium">目标用户名</label>
                            <div class="relative">
                                <span class="absolute inset-y-0 left-0 flex items-center pl-3 text-gray-500">
                                    <i class="fas fa-user"></i>
                                </span>
                                <input type="text" id="target-username" class="w-full pl-10 pr-3 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary transition-all" required>
                            </div>
                        </div>
                        <div>
                            <label for="title-name" class="block text-gray-700 mb-2 font-medium">称号名称</label>
                            <div class="relative">
                                <span class="absolute inset-y-0 left-0 flex items-center pl-3 text-gray-500">
                                    <i class="fas fa-tag"></i>
                                </span>
                                <input type="text" id="title-name" class="w-full pl-10 pr-3 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary transition-all" required>
                            </div>
                        </div>
                    </div>
                    <div>
                        <label for="title-description" class="block text-gray-700 mb-2 font-medium">称号描述</label>
                        <div class="relative">
                            <span class="absolute top-3 left-3 text-gray-500">
                                <i class="fas fa-align-left"></i>
                            </span>
                            <textarea id="title-description" rows="3" class="w-full pl-10 pr-3 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary transition-all"></textarea>
                        </div>
                    </div>
                    <div>
                        <label for="title-icon" class="block text-gray-700 mb-2 font-medium">
                            图标类名 (Font Awesome)
                            <span class="text-sm text-gray-500 ml-2">例如: fas fa-star</span>
                        </label>
                        <div class="relative">
                            <span class="absolute inset-y-0 left-0 flex items-center pl-3 text-gray-500">
                                <i class="fas fa-icons"></i>
                            </span>
                            <input type="text" id="title-icon" placeholder="fas fa-star" class="w-full pl-10 pr-3 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary transition-all">
                            <div class="mt-2 p-3 bg-gray-50 rounded-lg border border-gray-200">
                                <p class="text-sm text-gray-600 mb-2">常用图标参考：</p>
                                <div class="flex flex-wrap gap-4">
                                    <span class="flex items-center"><i class="fas fa-star text-yellow-500 mr-1"></i> fas fa-star</span>
                                    <span class="flex items-center"><i class="fas fa-diamond text-blue-400 mr-1"></i> fas fa-diamond</span>
                                    <span class="flex items-center"><i class="fas fa-heart text-red-500 mr-1"></i> fas fa-heart</span>
                                    <span class="flex items-center"><i class="fas fa-rocket text-purple-500 mr-1"></i> fas fa-rocket</span>
                                    <span class="flex items-center"><i class="fas fa-crown text-yellow-600 mr-1"></i> fas fa-crown</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <button type="submit" class="bg-primary hover:bg-primary/90 text-white px-6 py-3 rounded-lg font-medium transition-all shadow-md hover:shadow-lg flex items-center">
                        <i class="fas fa-gift mr-2"></i> 授予称号
                    </button>
                </form>
            </div>
        </section>

        <!-- 创建自定义称号 -->
        <section>
            <h2 class="text-2xl font-bold mb-6 flex items-center text-dark">
                <i class="fas fa-pencil-alt text-secondary mr-3"></i>
                创建自定义称号
            </h2>
            <div class="bg-white rounded-xl shadow-md p-6 border border-gray-100">
                <form id="create-title-form" class="space-y-5">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
                        <div>
                            <label for="custom-title-name" class="block text-gray-700 mb-2 font-medium">称号名称</label>
                            <div class="relative">
                                <span class="absolute inset-y-0 left-0 flex items-center pl-3 text-gray-500">
                                    <i class="fas fa-tag"></i>
                                </span>
                                <input type="text" id="custom-title-name" class="w-full pl-10 pr-3 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-secondary focus:border-secondary transition-all" required>
                            </div>
                        </div>
                        <div>
                            <label for="custom-title-icon" class="block text-gray-700 mb-2 font-medium">
                                图标类名
                                <span class="text-sm text-gray-500 ml-2">例如: fas fa-heart</span>
                            </label>
                            <div class="relative">
                                <span class="absolute inset-y-0 left-0 flex items-center pl-3 text-gray-500">
                                    <i class="fas fa-icons"></i>
                                </span>
                                <input type="text" id="custom-title-icon" placeholder="fas fa-heart" class="w-full pl-10 pr-3 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-secondary focus:border-secondary transition-all">
                            </div>
                        </div>
                    </div>
                    <div>
                        <label for="custom-title-description" class="block text-gray-700 mb-2 font-medium">称号描述</label>
                        <div class="relative">
                            <span class="absolute top-3 left-3 text-gray-500">
                                <i class="fas fa-align-left"></i>
                            </span>
                            <textarea id="custom-title-description" rows="3" class="w-full pl-10 pr-3 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-secondary focus:border-secondary transition-all"></textarea>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
                        <div>
                            <label for="custom-title-bg" class="block text-gray-700 mb-2 font-medium">
                                背景颜色
                            </label>
                            <div class="grid grid-cols-6 gap-2">
                                <div class="h-10 rounded-full bg-[#4F46E5]/10 cursor-pointer border-2 border-transparent hover:border-[#4F46E5]" data-color="bg-[#4F46E5]/10 text-[#4F46E5]"></div>
                                <div class="h-10 rounded-full bg-[#10B981]/10 cursor-pointer border-2 border-transparent hover:border-[#10B981]" data-color="bg-[#10B981]/10 text-[#10B981]"></div>
                                <div class="h-10 rounded-full bg-[#F59E0B]/10 cursor-pointer border-2 border-transparent hover:border-[#F59E0B]" data-color="bg-[#F59E0B]/10 text-[#F59E0B]"></div>
                                <div class="h-10 rounded-full bg-red-500/10 cursor-pointer border-2 border-transparent hover:border-red-500" data-color="bg-red-500/10 text-red-500"></div>
                                <div class="h-10 rounded-full bg-blue-500/10 cursor-pointer border-2 border-transparent hover:border-blue-500" data-color="bg-blue-500/10 text-blue-500"></div>
                                <div class="h-10 rounded-full bg-purple-500/10 cursor-pointer border-2 border-transparent hover:border-purple-500" data-color="bg-purple-500/10 text-purple-500"></div>
                            </div>
                            <input type="hidden" id="custom-title-color" value="bg-[#4F46E5]/10 text-[#4F46E5]">
                        </div>
                    </div>
                    <button type="submit" class="bg-secondary hover:bg-secondary/90 text-white px-6 py-3 rounded-lg font-medium transition-all shadow-md hover:shadow-lg flex items-center">
                        <i class="fas fa-plus mr-2"></i> 创建称号
                    </button>
                </form>
            </div>
        </section>
    </main>

    <footer class="bg-dark text-white py-8 mt-16">
        <div class="container mx-auto px-4 text-center">
            <div class="flex justify-center items-center mb-4">
                <i class="fas fa-award text-accent text-3xl mr-3"></i>
                <h2 class="text-xl font-bold">称号与头衔管理系统</h2>
            </div>
            <p class="text-gray-400">探索你的成就，展示你的荣誉</p>
        </div>
    </footer>

    <!-- 通知提示 -->
    <div id="notification" class="fixed bottom-6 right-6 px-6 py-4 rounded-lg shadow-2xl transform translate-y-20 opacity-0 transition-all duration-300 z-50"></div>

    <!-- 主功能脚本 -->
    <script>
        // 当前登录用户信息
        let currentUser = null;
        // 用户称号列表
        let userTitles = [];
        
        // API 基础路径 - 实际项目中替换为你的后端API地址
        const API_BASE_URL = '/api';
        
        // 工具函数：显示通知
        function showNotification(message, isError = false) {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = `fixed bottom-6 right-6 px-6 py-4 rounded-lg shadow-2xl transform transition-all duration-300 z-50 ${
                isError ? 'bg-red-500 text-white' : 'bg-green-500 text-white'
            }`;
            
            setTimeout(() => {
                notification.classList.add('translate-y-20', 'opacity-0');
            }, 3000);
        }

        // 工具函数：显示加载状态
        function showLoading(show = true) {
            const loadingEl = document.getElementById('loading-titles');
            const noTitlesEl = document.getElementById('no-titles-message');
            
            if (show) {
                loadingEl.classList.remove('hidden');
                noTitlesEl.classList.add('hidden');
            } else {
                loadingEl.classList.add('hidden');
            }
        }

        // 从MongoDB查询用户信息
        async function getUserByUsername(username) {
            try {
                // 实际项目中调用API查询MongoDB
                const response = await fetch(`${API_BASE_URL}/users?username=${encodeURIComponent(username)}`);
                
                if (!response.ok) {
                    throw new Error('查询用户失败');
                }
                
                const user = await response.json();
                return user;
            } catch (error) {
                console.error('获取用户信息失败:', error);
                showNotification('获取用户信息失败', true);
                return null;
            }
        }

        // 检查用户登录状态并获取当前用户信息
        async function checkAuthStatus() {
            try {
                // 模拟从本地存储获取当前登录用户名
                const storedUsername = localStorage.getItem('currentUsername');
                
                // 如果没有登录信息，显示未登录页面
                if (!storedUsername) {
                    document.getElementById('not-logged-in').classList.remove('hidden');
                    document.getElementById('main-content').classList.add('hidden');
                    return false;
                }
                
                // 从MongoDB查询用户信息
                const user = await getUserByUsername(storedUsername);
                
                if (!user) {
                    document.getElementById('not-logged-in').classList.remove('hidden');
                    document.getElementById('main-content').classList.add('hidden');
                    return false;
                }
                
                // 保存当前用户信息
                currentUser = user;
                
                // 显示用户信息
                document.getElementById('username-display').textContent = user.username;
                document.getElementById('user-display-name').textContent = user.username;
                document.getElementById('join-date').textContent = formatDate(user.joinDate);
                document.getElementById('logout-btn').classList.remove('hidden');
                
                // 如果是管理员，显示管理员区域
                if (user.isAdmin) {
                    document.getElementById('admin-section').classList.remove('hidden');
                }
                
                document.getElementById('not-logged-in').classList.add('hidden');
                document.getElementById('main-content').classList.remove('hidden');
                return true;
            } catch (error) {
                console.error('验证登录状态失败:', error);
                document.getElementById('not-logged-in').classList.remove('hidden');
                document.getElementById('main-content').classList.add('hidden');
                showNotification('验证登录状态失败', true);
                return false;
            }
        }

        // 格式化日期
        function formatDate(dateString) {
            const date = new Date(dateString);
            return `${date.getFullYear()}年${date.getMonth() + 1}月${date.getDate()}日`;
        }

        // 获取用户称号列表
        async function fetchUserTitles() {
            if (!currentUser) return [];
            
            try {
                showLoading();
                
                // 实际项目中调用API获取用户称号
                const response = await fetch(`${API_BASE_URL}/users/${currentUser._id}/titles`);
                
                if (!response.ok) {
                    throw new Error('获取称号列表失败');
                }
                
                const titles = await response.json();
                return titles;
            } catch (error) {
                console.error('获取称号列表失败:', error);
                showNotification('获取称号列表失败', true);
                return [];
            } finally {
                showLoading(false);
            }
        }

        // 获取并显示用户称号
        async function loadUserTitles() {
            try {
                // 从API获取称号数据
                const titles = await fetchUserTitles();
                userTitles = titles;
                
                // 更新称号计数
                document.getElementById('titles-count').textContent = `${titles.length} 个称号`;
                document.getElementById('user-titles-count').textContent = titles.length;
                
                // 显示称号列表
                displayTitles(titles);
                
                // 显示当前佩戴的称号
                const currentTitle = titles.find(title => title.isEquipped);
                displayCurrentTitle(currentTitle);
            } catch (error) {
                console.error('加载称号失败:', error);
                showNotification('加载称号时发生错误', true);
            }
        }

        // 显示称号列表
        function displayTitles(titles) {
            const container = document.getElementById('titles-container');
            const noTitlesMsg = document.getElementById('no-titles-message');
            const filterValue = document.getElementById('titles-filter').value;
            
            // 清空容器
            container.innerHTML = '';
            container.appendChild(document.getElementById('loading-titles'));
            container.appendChild(noTitlesMsg);
            
            // 根据筛选条件过滤称号
            let filteredTitles = titles;
            if (filterValue === 'equipped') {
                filteredTitles = titles.filter(title => title.isEquipped);
            } else if (filterValue === 'admin') {
                filteredTitles = titles.filter(title => title.isAdminGranted);
            } else if (filterValue === 'custom') {
                filteredTitles = titles.filter(title => title.isCustom);
            } else if (filterValue === 'system') {
                filteredTitles = titles.filter(title => !title.isAdminGranted && !title.isCustom);
            }
            
            if (filteredTitles.length === 0) {
                noTitlesMsg.classList.remove('hidden');
                return;
            }
            
            noTitlesMsg.classList.add('hidden');
            
            // 创建称号卡片
            filteredTitles.forEach(title => {
                // 称号颜色类，优先使用自定义颜色
                const badgeColor = title.colorClass || 'bg-gray-100 text-gray-600';
                
                const card = document.createElement('div');
                card.className = `title-card ${title.isEquipped ? 'title-card-equipped' : ''} fade-in`;
                card.innerHTML = `
                    <div class="p-5">
                        <div class="badge-icon ${badgeColor}">
                            <i class="${title.icon || 'fas fa-medal'}"></i>
                        </div>
                        <h3 class="font-bold text-lg text-center mb-2">${title.name}</h3>
                        <p class="text-gray-600 text-sm text-center mb-4 line-clamp-2">${title.description || '无描述'}</p>
                        <div class="text-xs text-gray-500 text-center mb-4">
                            获得于 ${formatDate(title.createdAt)}
                        </div>
                        ${title.isAdminGranted ? 
                            '<div class="text-center mb-4"><span class="bg-[#4F46E5]/10 text-[#4F46E5] text-xs px-2 py-1 rounded-full">管理员授予</span></div>' : ''
                        }
                        ${title.isCustom ? 
                            '<div class="text-center mb-4"><span class="bg-[#10B981]/10 text-[#10B981] text-xs px-2 py-1 rounded-full">自定义</span></div>' : ''
                        }
                        <button class="equip-btn w-full py-2 rounded-lg font-medium transition-all ${title.isEquipped ? 
                            'bg-gray-200 text-gray-500 cursor-not-allowed' : 
                            'bg-[#4F46E5] hover:bg-[#4F46E5]/90 text-white'}" 
                            data-title-id="${title._id}"
                            ${title.isEquipped ? 'disabled' : ''}>
                            ${title.isEquipped ? '已佩戴' : '佩戴此称号'}
                        </button>
                    </div>
                `;
                
                container.appendChild(card);
            });
            
            // 添加佩戴按钮事件监听
            document.querySelectorAll('.equip-btn:not([disabled])').forEach(btn => {
                btn.addEventListener('click', async (e) => {
                    await equipTitle(e.target.dataset.titleId);
                });
            });
        }

        // 显示当前佩戴的称号
        function displayCurrentTitle(title) {
            const noTitleEl = document.getElementById('no-current-title');
            const titleContentEl = document.getElementById('current-title-content');
            
            if (!title) {
                noTitleEl.classList.remove('hidden');
                titleContentEl.classList.add('hidden');
                return;
            }
            
            noTitleEl.classList.add('hidden');
            titleContentEl.classList.remove('hidden');
            
            document.getElementById('current-title-name').textContent = title.name;
            document.getElementById('current-title-desc').textContent = title.description || '无描述';
            document.getElementById('current-title-icon').className = title.icon || 'fas fa-medal';
            document.getElementById('current-title-date').textContent = formatDate(title.createdAt);
        }

        // 佩戴称号
        async function equipTitle(titleId) {
            if (!currentUser) return;
            
            try {
                // 先取消当前佩戴的称号
                const currentEquippedTitle = userTitles.find(title => title.isEquipped);
                if (currentEquippedTitle) {
                    await fetch(`${API_BASE_URL}/titles/${currentEquippedTitle._id}/equip`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ equipped: false, userId: currentUser._id })
                    });
                }
                
                // 佩戴新称号
                const response = await fetch(`${API_BASE_URL}/titles/${titleId}/equip`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ equipped: true, userId: currentUser._id })
                });
                
                if (!response.ok) {
                    throw new Error('佩戴称号失败');
                }
                
                showNotification('成功佩戴称号！');
                // 重新加载称号列表
                await loadUserTitles();
            } catch (error) {
                console.error('佩戴称号失败:', error);
                showNotification('佩戴称号时发生错误', true);
            }
        }

        // 取消佩戴当前称号
        document.getElementById('remove-current-title').addEventListener('click', async () => {
            if (!currentUser) return;
            
            try {
                const currentEquippedTitle = userTitles.find(title => title.isEquipped);
                if (!currentEquippedTitle) return;
                
                const response = await fetch(`${API_BASE_URL}/titles/${currentEquippedTitle._id}/equip`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ equipped: false, userId: currentUser._id })
                });
                
                if (!response.ok) {
                    throw new Error('取消佩戴称号失败');
                }
                
                showNotification('已取消佩戴称号');
                // 重新加载称号列表
                await loadUserTitles();
            } catch (error) {
                console.error('取消佩戴称号失败:', error);
                showNotification('取消佩戴称号时发生错误', true);
            }
        });

        // 刷新称号列表
        document.getElementById('refresh-titles').addEventListener('click', async () => {
            const refreshBtn = document.getElementById('refresh-titles');
            const icon = refreshBtn.querySelector('i');
            
            // 添加加载动画
            icon.classList.add('loading');
            refreshBtn.disabled = true;
            
            try {
                await loadUserTitles();
                showNotification('称号列表已更新');
            } finally {
                // 移除加载动画
                icon.classList.remove('loading');
                refreshBtn.disabled = false;
            }
        });

        // 导出称号
        document.getElementById('export-titles').addEventListener('click', async () => {
            if (!currentUser || userTitles.length === 0) {
                showNotification('没有可导出的称号', true);
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE_URL}/users/${currentUser._id}/titles/export`, {
                    method: 'GET',
                });
                
                if (!response.ok) {
                    throw new Error('导出称号失败');
                }
                
                // 处理导出文件
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `${currentUser.username}_titles.json`;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                
                showNotification('称号数据已导出');
            } catch (error) {
                console.error('导出称号失败:', error);
                showNotification('导出称号时发生错误', true);
            }
        });

        // 筛选称号
        document.getElementById('titles-filter').addEventListener('change', () => {
            displayTitles(userTitles);
        });

        // 选择自定义称号颜色
        document.querySelectorAll('[data-color]').forEach(el => {
            el.addEventListener('click', () => {
                // 移除其他颜色选择的边框
                document.querySelectorAll('[data-color]').forEach(item => {
                    item.classList.remove('border-[#4F46E5]', 'border-[#10B981]', 'border-[#F59E0B]', 'border-red-500', 'border-blue-500', 'border-purple-500');
                    item.classList.add('border-transparent');
                });
                
                // 添加当前选择的边框
                const colorClass = el.dataset.color;
                if (colorClass.includes('#4F46E5')) {
                    el.classList.add('border-[#4F46E5]');
                } else if (colorClass.includes('#10B981')) {
                    el.classList.add('border-[#10B981]');
                } else if (colorClass.includes('#F59E0B')) {
                    el.classList.add('border-[#F59E0B]');
                } else if (colorClass.includes('red')) {
                    el.classList.add('border-red-500');
                } else if (colorClass.includes('blue')) {
                    el.classList.add('border-blue-500');
                } else if (colorClass.includes('purple')) {
                    el.classList.add('border-purple-500');
                }
                
                // 保存选择的颜色
                document.getElementById('custom-title-color').value = colorClass;
            });
        });

        // 管理员授予称号
        document.getElementById('grant-title-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            if (!currentUser || !currentUser.isAdmin) {
                showNotification('没有权限执行此操作', true);
                return;
            }
            
            const targetUsername = document.getElementById('target-username').value;
            const titleName = document.getElementById('title-name').value;
            const titleDescription = document.getElementById('title-description').value;
            const titleIcon = document.getElementById('title-icon').value || 'fas fa-medal';
            
            // 先查询目标用户是否存在
            const targetUser = await getUserByUsername(targetUsername);
            if (!targetUser) {
                showNotification(`用户"${targetUsername}"不存在`, true);
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE_URL}/titles/grant`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        userId: targetUser._id,
                        name: titleName,
                        description: titleDescription,
                        icon: titleIcon,
                        isAdminGranted: true,
                        isCustom: false,
                        colorClass: 'bg-[#4F46E5]/10 text-[#4F46E5]'
                    })
                });
                
                if (!response.ok) {
                    throw new Error('授予称号失败');
                }
                
                showNotification(`成功授予用户"${targetUsername}"称号"${titleName}"！`);
                e.target.reset();
            } catch (error) {
                console.error('授予称号失败:', error);
                showNotification('授予称号时发生错误', true);
            }
        });

        // 创建自定义称号
        document.getElementById('create-title-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            if (!currentUser) return;
            
            const titleName = document.getElementById('custom-title-name').value;
            const titleDescription = document.getElementById('custom-title-description').value;
            const titleIcon = document.getElementById('custom-title-icon').value || 'fas fa-medal';
            const colorClass = document.getElementById('custom-title-color').value;
            
            try {
                const response = await fetch(`${API_BASE_URL}/titles`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        userId: currentUser._id,
                        name: titleName,
                        description: titleDescription,
                        icon: titleIcon,
                        isAdminGranted: false,
                        isCustom: true,
                        colorClass: colorClass
                    })
                });
                
                if (!response.ok) {
                    throw new Error('创建称号失败');
                }
                
                showNotification(`成功创建自定义称号"${titleName}"！`);
                e.target.reset();
                // 重置颜色选择
                document.querySelectorAll('[data-color]').forEach(item => {
                    item.classList.remove('border-[#4F46E5]', 'border-[#10B981]', 'border-[#F59E0B]', 'border-red-500', 'border-blue-500', 'border-purple-500');
                    item.classList.add('border-transparent');
                });
                document.querySelector('[data-color="bg-[#4F46E5]/10 text-[#4F46E5]"]').classList.add('border-[#4F46E5]');
                // 重新加载称号列表
                await loadUserTitles();
            } catch (error) {
                console.error('创建称号失败:', error);
                showNotification('创建称号时发生错误', true);
            }
        });

        // 登出功能
        document.getElementById('logout-btn').addEventListener('click', () => {
            // 清除本地存储的登录信息
            localStorage.removeItem('currentUsername');
            currentUser = null;
            userTitles = [];
            
            showNotification('已成功登出');
            // 登出后重新检查登录状态，显示未登录页面
            checkAuthStatus();
        });

        // 前往登录页面
        document.getElementById('go-to-login').addEventListener('click', () => {
            window.location.href = '/indexlo.html';
        });

        // 返回导航页
        document.getElementById('back-home').addEventListener('click', () => {
            window.location.href = '/indexdaohang.html';
            
        });

        // 页面加载时初始化
        async function init() {
            // 设置默认颜色选择
            document.querySelector('[data-color="bg-[#4F46E5]/10 text-[#4F46E5]"]').classList.add('border-[#4F46E5]');
            
            const isAuthenticated = await checkAuthStatus();
            if (isAuthenticated) {
                await loadUserTitles();
            }
        }

        // 启动应用
        init();
    </script>
</body>
</html>